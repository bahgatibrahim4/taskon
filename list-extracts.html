<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª | Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root { 
      direction: rtl; 
      --primary-color: #2e8ca3;
      --secondary-color: #7a5230;
      --accent-color: #c5d6db;
      --success-color: #388e3c;
      --warning-color: #f9ca24;
      --danger-color: #e53935;
      --dark-color: #2c3e50;
      --light-color: #f8f9fa;
      --card-shadow: 0 5px 15px rgba(0,0,0,0.1);
      --hover-shadow: 0 8px 20px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    [data-theme="dark"] {
      --primary-color: #2e8ca3;
      --secondary-color: #7a5230;
      --accent-color: #c5d6db;
      --dark-color: #1a1a1a;
      --light-color: #2d3436;
      --card-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Cairo', Arial, sans-serif; 
      background: #c5d6db;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    /* Force English numbers */
    .modern-table td,
    .stat-card .value,
    .card-value,
    .search-input {
      font-variant-numeric: lining-nums;
    }
    
    /* Header Styles */
    .header {
      background: #fff;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      padding: 10px 15px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      border: 2px solid #8c969a;
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Theme Toggle */
    .theme-toggle {
      background: var(--primary-color);
      border: none;
      border-radius: 6px;
      width: 30px;
      height: 30px;
      color: white;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    
    .theme-toggle:hover {
      background: #1a3b50;
      transform: scale(1.05);
    }
    
    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .stat-card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 6px 4px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      text-align: center;
      border: 2px solid #8c969a;
    }
    
    .stat-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--hover-shadow);
    }
    
    .stat-card .icon {
      font-size: 1rem;
      color: var(--primary-color);
      margin-bottom: 3px;
    }
    
    .stat-card .value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 2px;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .stat-card .label {
      color: #666;
      font-weight: 600;
      font-size: 0.65rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 5px auto;
      padding: 10px;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 2px solid #8c969a;
    }
    
    /* Main Content Grid */
    .main-content-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    /* Left Panel (Stats + Search) */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Right Panel (Extract List) */
    .right-panel {
      min-height: 350px;
    }
    
    /* Search and Filters */
    .search-filters {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 8px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      border: 2px solid #8c969a;
    }
    
    .search-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 150px;
      padding: 6px 10px;
      border: 2px solid #8c969a;
      border-radius: 6px;
      background: #fff;
      font-size: 0.8rem;
      transition: var(--transition);
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .search-input::placeholder {
      color: #999;
    }
    
    /* Modern Buttons */
    .modern-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-decoration: none;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .modern-btn:hover {
      background: #1a3b50;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .modern-btn.success {
      background: var(--success-color);
    }
    
    .modern-btn.success:hover {
      background: #2e7d32;
    }
    
    .modern-btn.warning {
      background: var(--warning-color);
    }
    
    .modern-btn.warning:hover {
      background: #e17055;
    }
    
    .modern-btn.danger {
      background: var(--danger-color);
    }
    
    .modern-btn.danger:hover {
      background: #d32f2f;
    }
    
    .modern-btn.outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }
    
    .modern-btn.outline:hover {
      background: var(--primary-color);
      color: white;
    }
    
    /* Filter Chips */
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }
    
    .filter-chip {
      background: #fff;
      border: 2px solid var(--primary-color);
      border-radius: 15px;
      padding: 4px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary-color);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 3px;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .filter-chip.active {
      background: var(--primary-color);
      color: white;
    }
    
    .filter-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    /* Modern Table */
    .table-container {
      background: #fff;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 10px;
      border: 2px solid #8c969a;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .modern-table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }
    
    .modern-table th {
      background: var(--primary-color);
      color: white;
      padding: 6px 4px;
      text-align: center;
      font-weight: 600;
      font-size: 0.7rem;
      border: none;
      font-family: 'Cairo', Arial, sans-serif;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .modern-table td {
      padding: 5px 3px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.65rem;
      transition: var(--transition);
      background: transparent;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .modern-table tr:hover td {
      background: #f7fafd;
    }
    
    .modern-table tr:last-child td {
      border-bottom: none;
    }
    
    /* Extract Cards (Alternative View) */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .extract-card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 8px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      border: 2px solid #8c969a;
      position: relative;
    }
    
    .extract-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-color);
    }
    
    .extract-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .card-number {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary-color);
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .card-date {
      color: #666;
      font-size: 0.7rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .card-contractor {
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 6px;
      font-size: 0.8rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .card-value {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--success-color);
      margin-bottom: 8px;
      direction: ltr;
      text-align: center;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .card-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    
    /* View Toggle */
    .view-toggle {
      display: flex;
      background: #fff;
      border-radius: 6px;
      padding: 3px;
      box-shadow: var(--card-shadow);
      margin-bottom: 8px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      border: 2px solid #8c969a;
    }
    
    .view-btn {
      background: transparent;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 0.75rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .view-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fff;
      border-radius: var(--border-radius);
      padding: 15px 20px;
      box-shadow: var(--card-shadow);
      border-right: 4px solid var(--success-color);
      transform: translateX(400px);
      transition: var(--transition);
      z-index: 1000;
      min-width: 280px;
      border: 1px solid #e0e0e0;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      border-right-color: var(--danger-color);
    }
    
    .notification.warning {
      border-right-color: var(--warning-color);
    }
    
    /* Loading Animation */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(46, 140, 163, 0.3);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }
    
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 25px;
      max-width: 450px;
      width: 90%;
      box-shadow: var(--hover-shadow);
      transform: scale(0.8);
      transition: var(--transition);
      border: 2px solid #8c969a;
    }
    
    .modal.show .modal-content {
      transform: scale(1);
    }
    
    /* Responsive Design */
    @media (max-width: 900px) {
      .container { 
        margin: 3px; 
        padding: 8px; 
      }
      
      .main-content-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .left-panel {
        order: 2;
      }
      
      .right-panel {
        order: 1;
        min-height: 250px;
      }
      
      .stats-container {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 4px;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
        padding: 8px;
      }
      
      .header h1 {
        font-size: 1rem;
      }
      
      .stat-card {
        padding: 4px 2px;
      }
      
      .stat-card .icon {
        font-size: 0.8rem;
        margin-bottom: 2px;
      }
      
      .stat-card .value {
        font-size: 0.75rem;
      }
      
      .stat-card .label {
        font-size: 0.6rem;
      }
      
      .search-row {
        flex-direction: column;
      }
      
      .search-input {
        min-width: 100%;
      }
      
      .modern-table th,
      .modern-table td {
        padding: 4px 2px;
        font-size: 0.65rem;
      }
      
      .cards-container {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
    
    @media (max-width: 600px) {
      .container { 
        margin: 1px; 
        padding: 5px; 
      }
      
      .main-content-grid {
        gap: 6px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 3px;
      }
      
      .stat-card {
        padding: 3px 1px;
      }
      
      .stat-card .icon {
        font-size: 0.7rem;
        margin-bottom: 1px;
      }
      
      .stat-card .value {
        font-size: 0.7rem;
      }
      
      .stat-card .label {
        font-size: 0.55rem;
      }
      
      .modern-table th,
      .modern-table td {
        padding: 3px 1px;
        font-size: 0.6rem;
      }
      
      .extract-card {
        padding: 8px;
      }
      
      .notification {
        right: 2px;
        min-width: 150px;
      }
    }
    
    /* Dark Theme Adjustments */
    [data-theme="dark"] {
      background: #2d3436;
    }
    
    [data-theme="dark"] .container,
    [data-theme="dark"] .header,
    [data-theme="dark"] .search-filters,
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .extract-card,
    [data-theme="dark"] .table-container,
    [data-theme="dark"] .notification,
    [data-theme="dark"] .modal-content,
    [data-theme="dark"] .view-toggle {
      background: #2d3436;
      color: #e2e8f0;
      border-color: #4a5568;
    }
    
    [data-theme="dark"] .modern-table td {
      color: #e2e8f0;
    }
    
    [data-theme="dark"] .search-input {
      background: #2d3436;
      color: #e2e8f0;
      border-color: #4a5568;
    }
    
    [data-theme="dark"] .search-input::placeholder {
      color: #a0aec0;
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  
  <!-- Header Section -->
  <div class="container">
    <div class="header">
      <h1>
        <i class="fas fa-file-invoice-dollar"></i>
        Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª
      </h1>
      <div class="header-controls">
        <button class="theme-toggle" id="themeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="main-content-grid">
      <!-- Left Panel: Stats + Search -->
      <div class="left-panel">
        <div class="stats-container">
          <div class="stat-card">
            <div class="icon">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="value" id="totalExtracts">0</div>
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª</div>
          </div>
          <div class="stat-card">
            <div class="icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="value" id="totalValue">0</div>
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
          </div>
          <div class="stat-card">
            <div class="icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="value" id="totalContractors">0</div>
            <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</div>
          </div>
          <div class="stat-card">
            <div class="icon">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="value" id="todayExtracts">0</div>
            <div class="label">Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
        </div>
        
        <!-- Search and Filters -->
        <div class="search-filters">
          <div class="search-row">
            <input type="text" id="quickSearch" class="search-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹...">
            <button class="modern-btn" id="advancedSearchBtn">
              <i class="fas fa-search-plus"></i>
              Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
            </button>
          </div>
          
          <div class="filter-chips">
            <div class="filter-chip active" data-filter="all">
              <i class="fas fa-list"></i>
              Ø§Ù„ÙƒÙ„
            </div>
            <div class="filter-chip" data-filter="today">
              <i class="fas fa-calendar-day"></i>
              Ø§Ù„ÙŠÙˆÙ…
            </div>
            <div class="filter-chip" data-filter="thisWeek">
              <i class="fas fa-calendar-week"></i>
              Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            </div>
            <div class="filter-chip" data-filter="thisMonth">
              <i class="fas fa-calendar-alt"></i>
              Ø§Ù„Ø´Ù‡Ø±
            </div>
            <div class="filter-chip" data-filter="highValue">
              <i class="fas fa-chart-line"></i>
              Ù‚ÙŠÙ…Ø© Ø¹Ø§Ù„ÙŠØ©
            </div>
          </div>
          
          <div style="display: flex; gap: 6px; justify-content: center; margin-top: 8px;">
            <button class="modern-btn success" id="exportBtn">
              <i class="fas fa-download"></i>
              ØªØµØ¯ÙŠØ±
            </button>
            <!-- View Toggle -->
            <div class="view-toggle">
              <button class="view-btn active" data-view="table">
                <i class="fas fa-table"></i>
                Ø¬Ø¯ÙˆÙ„
              </button>
              <button class="view-btn" data-view="cards">
                <i class="fas fa-th-large"></i>
                ÙƒØ§Ø±Ø¯Ø§Øª
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Panel: Extract List -->
      <div class="right-panel">
        <!-- Table View -->
        <div class="table-container" id="tableView">
          <table class="modern-table">
            <thead>
              <tr>
                <th>Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                <th>Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="extractsList"></tbody>
          </table>
        </div>
        
        <!-- Cards View -->
        <div class="cards-container" id="cardsView" style="display: none;"></div>
        
        <!-- Loading -->
        <div class="loading" id="loadingIndicator">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notifications Container -->
  <div id="notificationContainer"></div>
  
  <!-- Advanced Search Modal -->
  <div class="modal" id="advancedSearchModal">
    <div class="modal-content">
      <h3 style="color: var(--primary-color); margin-bottom: 20px;">
        <i class="fas fa-search-plus"></i>
        Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
      </h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</label>
        <input type="text" id="advContractor" class="search-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„...">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
        <input type="text" id="advUsername" class="search-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="advFromDate" class="search-input">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="advToDate" class="search-input">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯Ù†ÙŠØ§:</label>
        <input type="number" id="advMinValue" class="search-input" placeholder="0">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù„ÙŠØ§:</label>
        <input type="number" id="advMaxValue" class="search-input" placeholder="1000000">
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="modern-btn" id="applyAdvancedSearch">
          <i class="fas fa-search"></i>
          Ø¨Ø­Ø«
        </button>
        <button class="modern-btn outline" id="closeAdvancedSearch">
          <i class="fas fa-times"></i>
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="modern-btn warning" id="resetAdvancedSearch">
          <i class="fas fa-undo"></i>
          Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
        </button>
      </div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('user')) {
      window.location.href = 'login.html';
    }
  </script>
  
  <script>
    // Global Variables
    let allExtracts = [];
    let contractorsMap = {};
    let filteredExtracts = [];
    let currentView = 'table';
    let isDarkTheme = localStorage.getItem('darkTheme') === 'true';
    
    // Initialize theme
    if (isDarkTheme) {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Theme Toggle
    document.getElementById('themeToggle').addEventListener('click', function() {
      isDarkTheme = !isDarkTheme;
      localStorage.setItem('darkTheme', isDarkTheme);
      
      if (isDarkTheme) {
        document.documentElement.setAttribute('data-theme', 'dark');
        this.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.documentElement.removeAttribute('data-theme');
        this.innerHTML = '<i class="fas fa-moon"></i>';
      }
      
      showNotification('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    });
    
    // Notification System
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Quick Search
    document.getElementById('quickSearch').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase().trim();
      
      if (searchTerm === '') {
        filteredExtracts = [...allExtracts];
      } else {
        filteredExtracts = allExtracts.filter(extract => {
          const contractorName = (contractorsMap[extract.contractor] || '').toLowerCase();
          const number = (extract.number || '').toLowerCase();
          const date = (extract.date || '').toLowerCase();
          const notes = (extract.notes || '').toLowerCase();
          const username = (extract.username || '').toLowerCase();
          
          return contractorName.includes(searchTerm) ||
                 number.includes(searchTerm) ||
                 date.includes(searchTerm) ||
                 notes.includes(searchTerm) ||
                 username.includes(searchTerm);
        });
      }
      
      renderExtracts(filteredExtracts);
      updateStats(filteredExtracts);
    });
    
    // Filter Chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        // Remove active class from all chips
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.getAttribute('data-filter');
        applyFilter(filter);
      });
    });
    
    function applyFilter(filter) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      
      switch(filter) {
        case 'all':
          filteredExtracts = [...allExtracts];
          break;
          
        case 'today':
          filteredExtracts = allExtracts.filter(e => e.date === todayStr);
          break;
          
        case 'thisWeek':
          const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          const weekAgoStr = weekAgo.toISOString().split('T')[0];
          filteredExtracts = allExtracts.filter(e => e.date >= weekAgoStr);
          break;
          
        case 'thisMonth':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthStartStr = monthStart.toISOString().split('T')[0];
          filteredExtracts = allExtracts.filter(e => e.date >= monthStartStr);
          break;
          
        case 'highValue':
          filteredExtracts = allExtracts.filter(e => calculateExtractValue(e) > 50000);
          break;
          
        default:
          filteredExtracts = [...allExtracts];
      }
      
      renderExtracts(filteredExtracts);
      updateStats(filteredExtracts);
      
      // Get filter name from the active chip
      const activeChip = document.querySelector('.filter-chip.active');
      const filterName = activeChip ? activeChip.textContent.trim() : 'ÙÙ„ØªØ±';
      showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±: ${filterName}`);
    }
    
    // View Toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const view = this.getAttribute('data-view');
        currentView = view;
        
        if (view === 'table') {
          document.getElementById('tableView').style.display = 'block';
          document.getElementById('cardsView').style.display = 'none';
        } else {
          document.getElementById('tableView').style.display = 'none';
          document.getElementById('cardsView').style.display = 'grid';
        }
        
        renderExtracts(filteredExtracts);
      });
    });
    
    // Advanced Search Modal
    document.getElementById('advancedSearchBtn').addEventListener('click', function() {
      document.getElementById('advancedSearchModal').classList.add('show');
    });
    
    document.getElementById('closeAdvancedSearch').addEventListener('click', function() {
      document.getElementById('advancedSearchModal').classList.remove('show');
    });
    
    document.getElementById('resetAdvancedSearch').addEventListener('click', function() {
      document.getElementById('advContractor').value = '';
      document.getElementById('advUsername').value = '';
      document.getElementById('advFromDate').value = '';
      document.getElementById('advToDate').value = '';
      document.getElementById('advMinValue').value = '';
      document.getElementById('advMaxValue').value = '';
    });
    
    document.getElementById('applyAdvancedSearch').addEventListener('click', function() {
      const contractor = document.getElementById('advContractor').value.toLowerCase().trim();
      const username = document.getElementById('advUsername').value.toLowerCase().trim();
      const fromDate = document.getElementById('advFromDate').value;
      const toDate = document.getElementById('advToDate').value;
      const minValue = parseFloat(document.getElementById('advMinValue').value) || 0;
      const maxValue = parseFloat(document.getElementById('advMaxValue').value) || Infinity;
      
      filteredExtracts = allExtracts.filter(extract => {
        const contractorName = (contractorsMap[extract.contractor] || '').toLowerCase();
        const extractUsername = (extract.username || '').toLowerCase();
        const extractValue = calculateExtractValue(extract);
        
        let matches = true;
        
        if (contractor && !contractorName.includes(contractor)) matches = false;
        if (username && !extractUsername.includes(username)) matches = false;
        if (fromDate && extract.date < fromDate) matches = false;
        if (toDate && extract.date > toDate) matches = false;
        if (extractValue < minValue || extractValue > maxValue) matches = false;
        
        return matches;
      });
      
      renderExtracts(filteredExtracts);
      updateStats(filteredExtracts);
      document.getElementById('advancedSearchModal').classList.remove('show');
      showNotification(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filteredExtracts.length.toLocaleString('en-US')} Ù…Ø³ØªØ®Ù„Øµ`);
    });
    
    // Calculate Extract Value
    function calculateExtractValue(extract) {
      let value = 0;
      if (Array.isArray(extract.workItems)) {
        value = extract.workItems.reduce((sum, item) => sum + (parseFloat(item.currentAmount) || 0), 0);
      }
      
      let deductionsValue = 0;
      if (Array.isArray(extract.deductions)) {
        deductionsValue = extract.deductions.reduce((sum, ded) => sum + (parseFloat(ded.total) || 0), 0);
      }
      
      return value - deductionsValue;
    }
    
    // Fetch Data
    async function fetchExtracts() {
      document.getElementById('loadingIndicator').style.display = 'flex';
      
      try {
        // Fetch contractors
        const contractorsRes = await fetch('/contractors');
        const contractors = await contractorsRes.json();
        contractorsMap = {};
        contractors.forEach(c => {
          contractorsMap[c._id] = c.name;
        });
        
        // Fetch extracts
        const res = await fetch('/extracts');
        const extracts = await res.json();
        allExtracts = extracts;
        filteredExtracts = [...extracts];
        
        renderExtracts(filteredExtracts);
        updateStats(filteredExtracts);
        
        showNotification(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${extracts.length.toLocaleString('en-US')} Ù…Ø³ØªØ®Ù„Øµ Ø¨Ù†Ø¬Ø§Ø­!`);
        
      } catch (error) {
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        console.error('Error fetching data:', error);
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }
    
    // Update Statistics
    function updateStats(extracts) {
      const totalExtracts = extracts.length;
      const totalValue = extracts.reduce((sum, e) => sum + calculateExtractValue(e), 0);
      const contractorIds = new Set(extracts.map(e => e.contractor));
      const totalContractors = contractorIds.size;
      
      const today = new Date().toISOString().split('T')[0];
      const todayExtracts = extracts.filter(e => e.date === today).length;
      
      document.getElementById('totalExtracts').textContent = totalExtracts.toLocaleString('en-US');
      document.getElementById('totalValue').textContent = totalValue.toLocaleString('en-US', {maximumFractionDigits: 0});
      document.getElementById('totalContractors').textContent = totalContractors.toLocaleString('en-US');
      document.getElementById('todayExtracts').textContent = todayExtracts.toLocaleString('en-US');
    }
    
    // Render Extracts
    function renderExtracts(extracts) {
      if (currentView === 'table') {
        renderTableView(extracts);
      } else {
        renderCardsView(extracts);
      }
    }
    
    // Render Table View
    function renderTableView(extracts) {
      const list = document.getElementById('extractsList');
      list.innerHTML = '';
      
      // Determine last extract for each contractor
      const contractorLastExtract = {};
      extracts.forEach(e => {
        const contractorId = e.contractor;
        if (!contractorLastExtract[contractorId] || 
            parseInt(e.number) > parseInt(contractorLastExtract[contractorId].number)) {
          contractorLastExtract[contractorId] = e;
        }
      });
      
      extracts.forEach((e, i) => {
        const contractorName = contractorsMap[e.contractor] || e.contractor || '';
        const finalValue = calculateExtractValue(e);
        const valueStr = Number(finalValue).toLocaleString('en-US', {maximumFractionDigits: 2});
        
        const isLastExtract = contractorLastExtract[e.contractor] && 
                             contractorLastExtract[e.contractor]._id === e._id;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><strong>${e.number}</strong></td>
          <td>${contractorName}</td>
          <td>${e.date || ''}</td>
          <td style="direction:ltr; text-align:center; font-weight: 600; color: var(--success-color);">${valueStr}</td>
          <td style="font-weight: 600; color: var(--secondary-color);">${e.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
          <td>
            <a href="extract.html?id=${e._id}" class="modern-btn" style="font-size: 0.65rem; padding: 4px 8px;">
              <i class="fas fa-eye"></i>
              Ø¹Ø±Ø¶
            </a>
          </td>
          <td>
            ${isLastExtract ? 
              `<button class="modern-btn danger btn-delete" data-id="${e._id}" style="font-size: 0.65rem; padding: 4px 8px;">
                <i class="fas fa-trash"></i>
                Ø­Ø°Ù
              </button>` : 
              `<span style="color:#999; font-size:0.65rem;">ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø­Ø°Ù</span>`}
          </td>
        `;
        list.appendChild(tr);
      });
    }
    
    // Render Cards View
    function renderCardsView(extracts) {
      const container = document.getElementById('cardsView');
      container.innerHTML = '';
      
      // Determine last extract for each contractor
      const contractorLastExtract = {};
      extracts.forEach(e => {
        const contractorId = e.contractor;
        if (!contractorLastExtract[contractorId] || 
            parseInt(e.number) > parseInt(contractorLastExtract[contractorId].number)) {
          contractorLastExtract[contractorId] = e;
        }
      });
      
      extracts.forEach((e, i) => {
        const contractorName = contractorsMap[e.contractor] || e.contractor || '';
        const finalValue = calculateExtractValue(e);
        const valueStr = Number(finalValue).toLocaleString('en-US', {maximumFractionDigits: 2});
        
        const isLastExtract = contractorLastExtract[e.contractor] && 
                             contractorLastExtract[e.contractor]._id === e._id;
        
        const card = document.createElement('div');
        card.className = 'extract-card';
        card.innerHTML = `
          <div class="card-header">
            <div class="card-number">#${e.number}</div>
            <div class="card-date">
              <i class="fas fa-calendar"></i>
              ${e.date || ''}
            </div>
          </div>
          <div class="card-contractor">
            <i class="fas fa-user"></i>
            ${contractorName}
          </div>
          <div style="margin-bottom: 5px; color: var(--secondary-color); font-weight: 600; font-size: 0.7rem;">
            <i class="fas fa-user-circle"></i>
            ${e.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
          </div>
          <div class="card-value">
            <i class="fas fa-money-bill-wave"></i>
            ${valueStr} Ø±ÙŠØ§Ù„
          </div>
          <div class="card-actions">
            <a href="extract.html?id=${e._id}" class="modern-btn" style="font-size: 0.7rem; padding: 4px 8px;">
              <i class="fas fa-eye"></i>
              Ø¹Ø±Ø¶
            </a>
            ${isLastExtract ? 
              `<button class="modern-btn danger btn-delete" data-id="${e._id}" style="font-size: 0.7rem; padding: 4px 8px;">
                <i class="fas fa-trash"></i>
                Ø­Ø°Ù
              </button>` : 
              `<span style="color:#999; font-size:0.65rem; padding: 6px;">ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø­Ø°Ù</span>`}
          </div>
        `;
        container.appendChild(card);
      });
    }

    
    // Delete Extract
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete')) {
        const btn = e.target.classList.contains('btn-delete') ? e.target : e.target.closest('.btn-delete');
        const id = btn.getAttribute('data-id');
        
        // Modern confirmation dialog
        if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
          try {
            const res = await fetch(`/extracts/${id}`, { method: 'DELETE' });
            
            if (res.ok) {
              allExtracts = allExtracts.filter(ex => ex._id !== id);
              filteredExtracts = filteredExtracts.filter(ex => ex._id !== id);
              renderExtracts(filteredExtracts);
              updateStats(filteredExtracts);
              showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } else {
              const errorData = await res.json();
              if (res.status === 400) {
                showNotification(errorData.error || 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ. ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø³ØªØ®Ù„Øµ ÙÙ‚Ø· Ù„ÙƒÙ„ Ù…Ù‚Ø§ÙˆÙ„.', 'error');
              } else if (res.status === 404) {
                showNotification('âŒ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
              } else {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
              }
            }
          } catch (error) {
            showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            console.error('Error deleting extract:', error);
          }
        }
      }
    });
    
    // Export Functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
      const exportOptions = [
        { text: 'ØªØµØ¯ÙŠØ± Excel', icon: 'file-excel', action: () => exportToExcel() },
        { text: 'ØªØµØ¯ÙŠØ± PDF', icon: 'file-pdf', action: () => exportToPDF() },
        { text: 'ØªØµØ¯ÙŠØ± CSV', icon: 'file-csv', action: () => exportToCSV() }
      ];
      
      showExportMenu(exportOptions);
    });
    
    function showExportMenu(options) {
      const menu = document.createElement('div');
      menu.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        z-index: 10000;
        border: 1px solid rgba(255, 255, 255, 0.3);
      `;
      
      const title = document.createElement('h3');
      title.textContent = 'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ¯ÙŠØ±';
      title.style.cssText = `
        margin: 0 0 15px 0;
        color: var(--primary-color);
        text-align: center;
      `;
      menu.appendChild(title);
      
      options.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'modern-btn';
        btn.style.cssText = `
          width: 100%;
          margin-bottom: 10px;
          justify-content: center;
        `;
        btn.innerHTML = `<i class="fas fa-${option.icon}"></i> ${option.text}`;
        btn.onclick = () => {
          option.action();
          document.body.removeChild(menu);
          document.body.removeChild(overlay);
        };
        menu.appendChild(btn);
      });
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'modern-btn outline';
      closeBtn.style.cssText = 'width: 100%; justify-content: center;';
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡';
      closeBtn.onclick = () => {
        document.body.removeChild(menu);
        document.body.removeChild(overlay);
      };
      menu.appendChild(closeBtn);
      
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      `;
      overlay.onclick = () => {
        document.body.removeChild(menu);
        document.body.removeChild(overlay);
      };
      
      document.body.appendChild(overlay);
      document.body.appendChild(menu);
    }
    
    function exportToExcel() {
      try {
        const data = filteredExtracts.map((e, i) => ({
          'Ø§Ù„Ø±Ù‚Ù…': i + 1,
          'Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ': e.number,
          'Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„': contractorsMap[e.contractor] || e.contractor || '',
          'Ø§Ù„ØªØ§Ø±ÙŠØ®': e.date || '',
          'Ø§Ù„Ù‚ÙŠÙ…Ø©': calculateExtractValue(e),
          'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': e.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª");
        XLSX.writeFile(wb, `extracts-${new Date().toISOString().split('T')[0]}.xlsx`);
        
        showNotification('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      } catch (error) {
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'error');
      }
    }
    
    function exportToCSV() {
      try {
        const headers = ['Ø§Ù„Ø±Ù‚Ù…', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù‚ÙŠÙ…Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'];
        const rows = filteredExtracts.map((e, i) => [
          i + 1,
          e.number,
          contractorsMap[e.contractor] || e.contractor || '',
          e.date || '',
          calculateExtractValue(e),
          e.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
        ]);
        
        const csvContent = [headers, ...rows]
          .map(row => row.map(field => `"${field}"`).join(','))
          .join('\n');
        
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `extracts-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ù„Ù CSV Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      } catch (error) {
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'error');
      }
    }
    
    function exportToPDF() {
      showNotification('ğŸš§ ØªØµØ¯ÙŠØ± PDF Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±...', 'warning');
    }
    
    // Initialize
    fetchExtracts();
    
  </script>
  
  <!-- Load Navigation and External Scripts -->
  <script>
    // Load main navbar
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(s => s.parentNode.removeChild(s));
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      })
      .catch(error => {
        console.error('Error loading navbar:', error);
        showNotification('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„', 'warning');
      });
  </script>
  
  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Additional Features Script -->
  <script>
    // Keyboard Shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + F for quick search
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('quickSearch').focus();
      }
      
      // Ctrl/Cmd + E for export
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        document.getElementById('exportBtn').click();
      }
      
      // Ctrl/Cmd + D for dark mode toggle
      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        document.getElementById('themeToggle').click();
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.show').forEach(modal => {
          modal.classList.remove('show');
        });
      }
    });
    
    // Auto-save search preferences
    document.getElementById('quickSearch').addEventListener('input', function() {
      localStorage.setItem('lastSearch', this.value);
    });
    
    // Restore last search on page load
    window.addEventListener('load', function() {
      const lastSearch = localStorage.getItem('lastSearch');
      if (lastSearch) {
        document.getElementById('quickSearch').value = lastSearch;
        // Trigger search
        const event = new Event('input');
        document.getElementById('quickSearch').dispatchEvent(event);
      }
    });
    
    // Auto-refresh data every 5 minutes
    setInterval(function() {
      if (document.visibilityState === 'visible') {
        fetchExtracts();
      }
    }, 5 * 60 * 1000);
    
    // Add loading animation to buttons
    function addLoadingToButton(button, duration = 2000) {
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
      button.disabled = true;
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, duration);
    }
    
    // Enhanced click animations
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modern-btn') || e.target.closest('.modern-btn')) {
        const btn = e.target.classList.contains('modern-btn') ? e.target : e.target.closest('.modern-btn');
        
        // Create ripple effect
        const ripple = document.createElement('span');
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
          position: absolute;
          width: ${size}px;
          height: ${size}px;
          left: ${x}px;
          top: ${y}px;
          background: rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          transform: scale(0);
          animation: ripple 0.6s ease-out;
          pointer-events: none;
        `;
        
        // Add CSS for ripple animation if not exists
        if (!document.getElementById('ripple-styles')) {
          const style = document.createElement('style');
          style.id = 'ripple-styles';
          style.textContent = `
            @keyframes ripple {
              to {
                transform: scale(4);
                opacity: 0;
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        btn.style.position = 'relative';
        btn.style.overflow = 'hidden';
        btn.appendChild(ripple);
        
        setTimeout(() => {
          ripple.remove();
        }, 600);
      }
    });
    
    // Print functionality
    function printExtracts() {
      const printWindow = window.open('', '_blank');
      const printContent = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª - Ø·Ø¨Ø§Ø¹Ø©</title>
          <style>
            body { font-family: 'Cairo', Arial, sans-serif; direction: rtl; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
            th { background-color: #667eea; color: white; }
            .header { text-align: center; margin-bottom: 30px; }
            .stats { margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª</h1>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG')}</p>
          </div>
          <div class="stats">
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª:</strong> ${filteredExtracts.length}</p>
            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©:</strong> ${filteredExtracts.reduce((sum, e) => sum + calculateExtractValue(e), 0).toLocaleString('en-US')} Ø±ÙŠØ§Ù„</p>
          </div>
          <table>
            <thead>
              <tr>
                <th>Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              </tr>
            </thead>
            <tbody>
              ${filteredExtracts.map((e, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${e.number}</td>
                  <td>${contractorsMap[e.contractor] || e.contractor || ''}</td>
                  <td>${e.date || ''}</td>
                  <td>${calculateExtractValue(e).toLocaleString('en-US')}</td>
                  <td>${e.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }
    
    // Add print button to export menu
    const originalExportBtn = document.getElementById('exportBtn');
    originalExportBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      
      const exportOptions = [
        { text: 'ØªØµØ¯ÙŠØ± Excel', icon: 'file-excel', action: () => exportToExcel() },
        { text: 'ØªØµØ¯ÙŠØ± CSV', icon: 'file-csv', action: () => exportToCSV() },
        { text: 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', icon: 'print', action: () => printExtracts() },
        { text: 'ØªØµØ¯ÙŠØ± PDF', icon: 'file-pdf', action: () => exportToPDF() }
      ];
      
      showExportMenu(exportOptions);
    });
  </script>
</body>
</html>