<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="permissions-check.js"></script>
  <!-- Ù…ÙƒØªØ¨Ø© SheetJS Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      direction: rtl;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: #c5d6db;
      margin: 0;
      direction: rtl;
    }
    
    /* ØªØ·Ø¨ÙŠÙ‚ Ø®Ø· Cairo Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    * {
      font-family: 'Cairo', Arial, sans-serif !important;
    }
    .navbar {
      background: #1a3b50;
      color: #fff;
      font-size: 1.18rem;
      font-weight: bold;
      box-shadow: 0 2px 12px #0002;
      letter-spacing: 1px;
      min-height: 58px;
      padding: 0 24px;
      border-bottom: 3px solid #2e8ca3;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .navbar .nav-btn {
      background: #fff;
      color: #2e8ca3;
      border: 2px solid #2e8ca3;
      font-size: 1.08rem;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 18px;
      border-radius: 0px;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: 0 2px 10px #0001;
      margin-left: 10px;
      font-family: 'Cairo', Arial, sans-serif;
      letter-spacing: 0.5px;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .navbar .nav-btn:hover {
      background: #1a3b50;
      color: #fff;
      border-color: #2e8ca3;
    }
    .container {
      max-width: 1400px; /* ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹ Ø£ÙƒØ«Ø± */
      margin: 32px auto 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 0 24px #0002;
      padding: 38px 38px 28px 38px;
      border: 2px solid #8c969a;
      position: relative;
    }
    h2 {
      text-align: center;
      margin-bottom: 32px;
      color: #2e8ca3;
      letter-spacing: 1px;
      font-size: 1.35rem;
      font-weight: bold;
      border-bottom: 2px solid #7a5230;
      padding-bottom: 12px;
    }
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }
    .info-table th, .info-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #c5d6db;
      font-size: 1.05rem;
      text-align: right;
    }
    .info-table th {
      background: #e8f5e9;
      color: #2e8ca3;
      width: 160px;
      font-weight: bold;
    }
    .info-table td {
      background: #f7fafd;
      color: #333;
    }
    .back-btn {
      display: inline-block;
      margin: 0 0 18px 0;
      color: #2e8ca3;
      background: #fff;
      border: 2px solid #2e8ca3;
      border-radius: 0px;
      padding: 7px 18px;
      font-weight: bold;
      font-size: 1.08rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .back-btn:hover {
      background: #1a3b50;
      color: #fff;
      border-color: #2e8ca3;
    }
    .section-title {
      color: #7a5230;
      font-size: 1.08rem;
      font-weight: bold;
      margin: 18px 0 8px 0;
      border-bottom: 1px solid #c5d6db;
      padding-bottom: 4px;
    }
    .extracts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .extracts-table th, .extracts-table td {
      padding: 4px 3px;
      border-bottom: 1px solid #c5d6db;
      text-align: right;
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .extracts-table th {
      background: #2e8ca3;
      color: #fff;
      font-weight: bold;
    }
    .extracts-table tr:hover td {
      background: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    .deductions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .deductions-table th, .deductions-table td {
      padding: 4px 3px;
      border-bottom: 1px solid #c5d6db;
      text-align: right;
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .deductions-table th {
      background: #388e3c;
      color: #fff;
      font-weight: bold;
    }
    .deductions-table tr:hover td {
      background: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    .no-data {
      text-align: center;
      color: #888;
      margin: 18px 0;
      font-size: 1.05rem;
    }
    .tables-flex-row {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .table-container {
      flex: 1 1 0;
      min-width: 340px;
      max-width: 100%;
    }
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    .container button#showSummaryBtn,
    .container button#showContractsBtn,
    .container button#showWorksBtn,
    .container button#showExtractsBtn,
    .container button#showDeductionsBtn,
    .container button#showMaterialsBtn {
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 0.93rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: #2e8ca3;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 3px 10px;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 60px;
      height: 28px;
      line-height: 1.2;
    }
    .container button#showSummaryBtn:hover,
    .container button#showContractsBtn:hover,
    .container button#showWorksBtn:hover,
    .container button#showExtractsBtn:hover,
    .container button#showDeductionsBtn:hover,
    .container button#showMaterialsBtn:hover {
      background: #1a3b50;
    }
    
    /* Ø´Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ */
    .building-header {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold !important;
      cursor: pointer !important;
      user-select: none !important;
      transition: background-color 0.3s ease !important;
    }
    
    .building-header:hover {
      background: #e3f2fd !important; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
      color: #000 !important; /* Ù†Øµ Ø£Ø³ÙˆØ¯ ÙˆØ§Ø¶Ø­ */
    }
    
    .building-header td {
      padding: 8px 4px !important;
      font-size: 0.9rem !important;
      text-align: center !important;
    }
    
    .building-works {
      display: none; /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    }
    
    .building-works.visible {
      display: table-row; /* ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ visible */
    }
    
    .building-arrow {
      margin-left: 8px;
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    
    .building-arrow.expanded {
      transform: rotate(90deg);
    }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙˆÙ„ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ */
    #currentWorksListForPull table {
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    #currentWorksListForPull table th {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    #currentWorksListForPull table td {
      padding: 6px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 0.85rem;
    }
    
    #currentWorksListForPull table tr:hover {
      background-color: #f0f8ff !important;
    }
    
    #currentWorksListForPull table tbody tr[style*="background-color: rgb(232, 245, 233)"] {
      background-color: #e8f5e9 !important;
    }
    
    #currentWorksListForPull table tbody tr[style*="background-color: rgb(232, 245, 233)"]:hover {
      background-color: #d4edda !important;
    }
    
    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© */
    .pulled-work {
      background-color: #ffebee !important;
      opacity: 0.8;
      position: relative;
    }
    
    .pulled-work td {
      background-color: #ffebee !important;
      position: relative;
    }
    
    .pulled-work:hover td {
      background-color: #ffcdd2 !important;
    }
    
    .pulled-label {
      background: #f44336;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-bottom: 3px;
      display: inline-block;
    }
    
    .pulled-info {
      font-size: 0.75rem;
      color: #d32f2f;
      font-style: italic;
      margin-top: 2px;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© */
    .pulled-work-info {
      background: #f44336;
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      margin-bottom: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-block;
    }
    
    .pulled-work-description {
      color: #d32f2f;
      font-size: 0.9rem;
      margin-top: 3px;
    }
    
    /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ ØµÙÙˆÙ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ */
    #worksBody tr {
      height: auto;
    }
    
    #worksBody td {
      padding: 3px 4px !important;
      font-size: 0.85rem !important;
      line-height: 1.1 !important;
      vertical-align: middle;
    }
    
    #worksBody th {
      padding: 6px 4px !important;
      font-size: 0.9rem !important;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    #worksBody button {
      padding: 2px 6px !important;
      font-size: 10px !important;
      margin: 1px !important;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ù„ØµÙÙˆÙ */
    #worksBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© */
    #worksBody tr.pulled-work:hover {
      background-color: #ffcdd2 !important;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© */
    #worksBody tr[style*="background-color: rgb(232, 245, 233)"]:hover,
    #worksBody tr[style*="background-color:#e8f5e9"]:hover {
      background-color: #c8e6c9 !important;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ø´Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ */
    .building-header:hover {
      background: #e3f2fd !important; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
      color: #000 !important; /* Ù†Øµ Ø£Ø³ÙˆØ¯ ÙˆØ§Ø¶Ø­ */
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ */
    #contractsBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ */
    #materialsBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* ØªØ£Ø«ÙŠØ± hover Ø¹Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    table tbody tr {
      transition: all 0.2s ease;
    }
    
    table tbody tr:hover {
      box-shadow: 0 2px 8px rgba(46, 140, 163, 0.2);
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ hover */
    button:hover {
      transform: scale(1.05);
      transition: transform 0.1s ease;
    }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ù„Ø®Øµ */
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #2e8ca3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .summary-label {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }
    
    .summary-value {
      font-weight: bold;
      color: #2e8ca3;
      font-size: 1rem;
    }
    
    @media (max-width: 700px) {
      .container { padding: 10px; }
      h2 { font-size: 1.1rem; }
      .info-table th, .info-table td, .extracts-table th, .extracts-table td { font-size: 0.95rem; }
      
      /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
      #summaryContainer > div {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div class="container">
    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ -->
    <div id="contractorDetailsRow" style="display:flex;gap:24px;align-items:center;justify-content:center;margin-bottom:18px;background:#e8f5e9;border-radius:10px;padding:12px 8px;">
      <div><span style="color:#2e8ca3;font-weight:bold;">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</span> <span id="name"></span></div>
      <div><span style="color:#2e8ca3;font-weight:bold;">Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span id="phone"></span></div>
      <div><span style="color:#2e8ca3;font-weight:bold;">Ø§Ù„Ø¨Ù†Ø¯:</span> <span id="workItem"></span></div>
    </div>
    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:18px;">
      <button id="showSummaryBtn" style="background:#388e3c;" data-permission="contractors-view">Ø§Ù„Ù…Ù„Ø®Øµ</button>
      <button id="showContractsBtn" style="background:#2e8ca3;" data-permission="contractors-view">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
      <button id="showWorksBtn" data-permission="contractors-view">Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</button>
      <button id="showExtractsBtn" data-permission="contractors-view">Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª</button>
      <button id="showDeductionsBtn" data-permission="contractors-view">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</button>
      <button id="showMaterialsBtn" data-permission="contractors-view">Ø§Ù„Ù…ÙˆØ§Ø¯</button>
      <button id="showReceiptsBtn" style="background:#f59e0b;" data-permission="vouchers-view-contractor">Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>
    </div>
    <div class="tables-flex-row">
      <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø®Øµ -->
      <div class="table-container" id="summaryContainer" style="display:none;">
        <div class="section-title">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px;background:#f8f9fa;border-radius:8px;">
          <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ -->
          <div style="display:flex;flex-direction:column;gap:15px;">
            <div class="summary-item">
              <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span>
              <span class="summary-value" id="totalContractValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯:</span>
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="summary-value" id="totalSignedWorksValueDisplay">0 Ø±ÙŠØ§Ù„</span>
                <button id="editSignedWorksBtn" onclick="editSignedWorksValue()" 
                        style="background:#2e8ca3;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:0.8rem;"
                        data-permission="contractors-edit">
                  âœï¸ ØªØ¹Ø¯ÙŠÙ„
                </button>
              </div>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</span>
              <span class="summary-value" id="totalRegisteredWorksValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©:</span>
              <span class="summary-value" id="totalPulledWorksValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„:</span>
              <span class="summary-value" id="totalFinalWorksValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
          </div>
          
          <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
          <div style="display:flex;flex-direction:column;gap:15px;">
            <div class="summary-item">
              <span class="summary-label">Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</span>
              <span class="summary-value" id="completionPercentage">0%</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª:</span>
              <span class="summary-value" id="totalExtractsValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
              <span class="summary-value" id="totalDeductionsValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù‚ÙŠÙ…Ø© Ø³Ø­Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯:</span>
              <span class="summary-value" id="totalMaterialsValue">0 Ø±ÙŠØ§Ù„</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-container" id="contractsContainer">
        <div class="section-title">
          Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
          <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ - Ø¬Ø¯ÙŠØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø¹ onclick Ù…Ø¨Ø§Ø´Ø± -->
          <button id="btnAddNewContract" onclick="openNewContractModal()" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:8px 16px; font-size:0.9rem; margin-right:10px; cursor:pointer; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
            <span style="font-size:1.2rem;">+</span> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
          </button>
          <!-- Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ -->
          <button id="exportContractsExcelBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        </div>
        <table class="extracts-table" id="contractsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th>Ø§Ù„ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody id="contractsBody">
            <tr><td colspan="10" class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="worksContainer" style="display:none;">
        <div class="section-title">
          Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
          <!-- Ø²Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰ -->
          <button id="sortByBuildingBtn" style="background:#2e8ca3; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:10px; cursor:pointer;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
          <button id="showAllWorksBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer; display:none;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
          <!-- Ø²Ø± Ø³Ø­Ø¨ Ø£Ø¹Ù…Ø§Ù„ -->
          <button id="pullWorksBtn" style="background:#f44336; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;" data-permission="contractors-edit">Ø³Ø­Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±</button>

          <!-- Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ -->
          <button id="exportExcelBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;" data-permission="contractors-export">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        </div>
        <table class="extracts-table" id="worksTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th>Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
              <th>Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ $</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody id="worksBody">
            <tr><td colspan="11" class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="extractsContainer" style="display:none;">
        <div class="section-title">Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
        <table class="extracts-table" id="extractsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
              <th>Ø¹Ø±Ø¶</th>
            </tr>
          </thead>
          <tbody id="extractsBody">
            <tr><td colspan="5" class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="deductionsContainer" style="display:none;">
        <div class="section-title">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
        <table class="deductions-table" id="deductionsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø¨ÙŠØ§Ù† Ø§Ù„Ø®ØµÙ…</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</th>
            </tr>
          </thead>
          <tbody id="deductionsBody">
            <tr><td colspan="8" class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="materialsContainer" style="display:none;">
        <div class="section-title">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
        <table class="extracts-table" id="contractorMaterialsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>ØªÙ… Ø§Ù„Ø®ØµÙ… ÙÙŠ Ù…Ø³ØªØ®Ù„Øµ</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="materialsBody">
            <tr><td colspan="7" class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Ù‚Ø³Ù… Ø§Ù„Ø³Ù†Ø¯Ø§Øª -->
      <div class="table-container" id="receiptsContainer" style="display:none;">
        <div class="section-title">Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
        <table class="extracts-table" id="contractorReceiptsTable">
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="receiptsBody">
            <tr><td colspan="8" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ -->
  <div id="pullWorksModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:30px; border-radius:12px; max-width:1200px; width:95%; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="text-align:center; color:#f44336; margin-bottom:20px; font-size:1.2rem; font-weight:bold; border-bottom:2px solid #f44336; padding-bottom:10px;">Ø³Ø­Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±</h3>
      
      <!-- Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
      <div id="step1" style="margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
        <div style="background:#f5f5f5; padding:10px; border-radius:4px; margin-bottom:10px; max-height:400px; overflow-y:auto;">
          <div style="margin-bottom:10px;">
            <label style="font-weight:bold;">
              <input type="checkbox" id="selectAllWorks" style="margin-left:5px;"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            </label>
          </div>
          <div id="currentWorksListForPull"></div>
        </div>
        <button id="proceedToStep2Btn" style="background:#388e3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:1rem;" disabled>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù</button>
      </div>

      <!-- Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù -->
      <div id="step2" style="display:none; margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù</h4>
        <select id="targetContractorSelect" style="width:100%; padding:10px; border:1px solid #c5d6db; border-radius:4px; font-size:1rem; margin-bottom:15px;">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù...</option>
        </select>
        <button id="proceedToStep3Btn" style="background:#388e3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:1rem;" disabled>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯</button>
      </div>

      <!-- Ø®Ø·ÙˆØ© 3: ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ -->
      <div id="step3" style="display:none; margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ£ÙƒÙŠØ¯ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h4>
        <div style="background:#e8f5e9; padding:15px; border-radius:4px; margin-bottom:15px;">
          <p><strong>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…ØµØ¯Ø±:</strong> <span id="sourceContractorName"></span></p>
          <p><strong>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù:</strong> <span id="targetContractorName"></span></p>
          <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</strong> <span id="selectedWorksCount"></span></p>
        </div>
        <div style="background:#fff3cd; padding:10px; border-radius:4px; border-left:4px solid #ffc107; margin-bottom:15px;">
          <p style="margin:0; color:#856404;"><strong>ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¹Ù„Ø§Ù…Ø© ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ.</p>
        </div>
        <button id="confirmPullBtn" style="background:#f44336; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-size:1rem; font-weight:bold;">ØªØ£ÙƒÙŠØ¯ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</button>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button id="cancelPullBtn" style="background:#6c757d; color:#fff; border:none; padding:10px 20px; border-radius:4px; font-size:1rem; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- ========== Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ - Ø¬Ø¯ÙŠØ¯ ÙˆØ¨Ø³ÙŠØ· ========== -->
  <div id="newContractModal" class="contract-modal-overlay">
    <div class="contract-modal-content">
      <h3 class="contract-modal-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
      
      <form id="newContractForm" enctype="multipart/form-data">
        <div class="form-row">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
            <input type="text" name="contractNumber" required>
          </div>
          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯:</label>
            <input type="date" name="contractDate" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯:</label>
            <select name="contractType" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
              <option value="ØªÙ†ÙÙŠØ° Ø£Ø¹Ù…Ø§Ù„">ØªÙ†ÙÙŠØ° Ø£Ø¹Ù…Ø§Ù„</option>
              <option value="ØªÙˆØ±ÙŠØ¯">ØªÙˆØ±ÙŠØ¯</option>
              <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:</label>
            <input type="text" name="workItem" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯:</label>
            <input type="number" name="contractValue" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠÙˆÙ…):</label>
            <input type="number" name="executionDuration" min="1">
          </div>
        </div>
        
        <div class="form-group">
          <label>Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯ (PDF):</label>
          <input type="file" name="contractFile" accept=".pdf">
        </div>
        
        <div class="form-group">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
          <textarea name="notes" rows="3"></textarea>
        </div>
        
        <div class="modal-buttons">
          <button type="submit" class="btn-submit">Ø­ÙØ¸</button>
          <button type="button" class="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .contract-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .contract-modal-overlay.active {
      display: flex;
    }
    
    .contract-modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .contract-modal-title {
      text-align: center;
      color: #2e8ca3;
      margin-bottom: 20px;
      font-size: 1.3rem;
      border-bottom: 2px solid #2e8ca3;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #2e8ca3;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2e8ca3;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn-submit {
      background: #2e8ca3;
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .btn-submit:hover {
      background: #1a7a8f;
    }
    
    .btn-cancel {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .btn-cancel:hover {
      background: #5a6268;
    }
  </style>

  <script>
    // Check permissions before loading page
    window.checkPagePermission('contractors');
    
    // ==================== ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ø¨Ø³ÙŠØ· ÙˆÙ…Ø¨Ø§Ø´Ø± ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('âœ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
      
      const modal = document.getElementById('newContractModal');
      const form = document.getElementById('newContractForm');
      const addBtn = document.getElementById('btnAddNewContract');
      
      console.log('ğŸ” Ø§Ù„Ø²Ø±:', addBtn);
      console.log('ğŸ” Ø§Ù„Ù…ÙˆØ¯Ø§Ù„:', modal);
      console.log('ğŸ” Ø§Ù„ÙÙˆØ±Ù…:', form);
      
      if (!modal || !form) {
        console.error('âŒ Ø£Ø­Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙÙ‚ÙˆØ¯!', {modal, form, addBtn});
        return;
      }
      
      const cancelBtn = modal.querySelector('.btn-cancel');
      
      // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ø²Ø± Ù„Ù‡ onclick="openNewContractModal()" ÙÙŠ HTML)
      // Ù„ÙƒÙ† Ø³Ù†Ø¶ÙŠÙ event listener Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      if (addBtn) {
        addBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('ğŸ¯ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯!');
          modal.classList.add('active');
          console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© class active Ù„Ù„Ù…ÙˆØ¯Ø§Ù„');
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('âŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„');
          modal.classList.remove('active');
          form.reset();
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          form.reset();
        }
      });
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù…
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯...');
        
        const formData = new FormData(form);
        
        try {
          const contractorId = new URL(window.location.href).searchParams.get('id');
          const response = await fetch(`/contractors/${contractorId}/contracts`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            modal.classList.remove('active');
            form.reset();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯
            if (typeof fetchContracts === 'function') {
              fetchContracts();
            }
          } else {
            const error = await response.text();
            alert('âŒ Ø®Ø·Ø£: ' + error);
          }
        } catch (err) {
          console.error('âŒ Ø®Ø·Ø£:', err);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
        }
      });
      
      console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¬Ø§Ù‡Ø²!');
    });
    // ==================== Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ====================
  </script>



  <script>
    // ==================== ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… - Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ====================

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ObjectId Ø¨Ø³ÙŠØ· (Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙÙ‚Ø·)
    function generateObjectId() {
      return Math.floor(Date.now() / 1000).toString(16) + 
             Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const contractorId = getQueryParam('id');
    if (!contractorId) {
      document.body.innerHTML = '<div style="text-align:center;margin-top:60px;color:#c00;font-size:1.2rem;">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</div>';
      throw new Error('Contractor id not found');
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
    function calculateAndUpdateTotalWorks() {
      let totalWorks = 0;
      
      // Ø­Ø³Ø§Ø¨ Ù…Ù† Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
      if (originalWorksData && originalWorksData.length > 0) {
        originalWorksData.forEach(item => {
          if (!item.isSeparator && !item.isPulled) { // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
            const quantity = parseFloat(item.quantity) || 0;
            const category = parseFloat(item.category) || 0;
            totalWorks += quantity * category;
          }
        });
      }
      
      console.log('ğŸ’° ØªÙ… Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:', totalWorks);
      return totalWorks;
    }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ (Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¯)
    async function fetchContractor() {
      try {
        const res = await fetch(`/contractors/${contractorId}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await res.text();
          console.error('Response is not JSON:', text);
          throw new Error('Response is not JSON');
        }
        
        const c = await res.json();
        document.getElementById('name').textContent = c.name || '';
        document.getElementById('phone').textContent = c.phone || '';
        document.getElementById('workItem').textContent = c.workItem || '';
        // Ø§Ø¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ c.materials (Ù…ØµÙÙˆÙØ©)
        renderMaterialsTable(Array.isArray(c.materials) ? c.materials : []);
      } catch (error) {
        console.error('Error fetching contractor:', error);
        document.body.innerHTML = '<div style="text-align:center;margin-top:60px;color:#c00;font-size:1.2rem;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</div>';
      }
    }

    // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯
    function renderMaterialsTable(materials) {
      const tbody = document.getElementById('materialsBody');
      if (!Array.isArray(materials) || !materials.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      materials.forEach((mat, i) => {
        const name = mat.name || mat.item || '';
        const quantity = mat.quantity !== undefined ? mat.quantity : '';
        const unitPrice = mat.unitPrice !== undefined ? mat.unitPrice : '';
        const date = mat.date ? new Date(mat.date).toLocaleDateString('ar-EG') : '';
        const username = mat.userName || mat.user || mat.username || '';
        const extractNumber = mat.deductedInExtractNumber || '';
        const extractId = mat.deductedInExtractId || mat.extractId || '';
        let deductedCell = '';
        if (extractNumber) {
          if (extractId) {
            deductedCell = `<a href="extract.html?id=${extractId}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;" data-field="deducted">${extractNumber}</a>`;
          } else {
            deductedCell = `<span data-field="deducted">${extractNumber}</span>`;
          }
        } else {
          deductedCell = `<span data-field="deducted"></span>`;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td data-field="name">${name}</td>
          <td>${quantity}</td>
          <td>${unitPrice}</td>
          <td data-field="date">${date}</td>
          <td>${username}</td>
          <td>${deductedCell}</td>
          <td data-field="delete"></td>
        `;
        // Ø²Ø± Ø§Ù„Ø­Ø°Ù
        const deleteTd = tr.querySelector('[data-field="delete"]');
        if (extractNumber) {
          deleteTd.innerHTML = '<span style="color:#e53935;font-weight:bold;">Ù…Ø®ØµÙˆÙ…Ø©</span>';
        } else {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.style.background = '#e53935';
          delBtn.style.color = '#fff';
          delBtn.style.border = 'none';
          delBtn.style.borderRadius = '5px';
          delBtn.style.padding = '4px 10px';
          delBtn.style.cursor = 'pointer';
          delBtn.onclick = async function() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
            // Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ‡Ø±Ø³
            try {
              const contractorId = getQueryParam('id');
              const res = await fetch(`/contractors/${contractorId}/materials/${i}`, { method: 'DELETE' });
              if (res.ok) {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„Ù…Ø®Ø²Ù†
                await fetch(`/materials/restore/dummy`, { method: 'POST', 
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(mat)
                });
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ù„Ù…Ø®Ø²Ù† Ø¨Ù†Ø¬Ø§Ø­.');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                fetchContractor();
              } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.');
              }
            } catch {
              alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.');
            }
          };
          deleteTd.appendChild(delBtn);
        }
        tbody.appendChild(tr);
      });
    }

    // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯
    let contractsData = [];

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
    async function fetchContracts() {
      const tbody = document.getElementById('contractsBody');
      if (!tbody) return;
      
      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
        const res = await fetch(`/contractors/${contractorId}`);
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯.</td></tr>`;
          return;
        }
        
        const contractor = await res.json();
        contractsData = contractor.contracts || [];
        
        if (!contractsData.length) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
          return;
        }
        
        renderContractsTable();
        
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯.</td></tr>`;
      }
    }

    // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯
    function renderContractsTable() {
      const tbody = document.getElementById('contractsBody');
      tbody.innerHTML = '';
      
      contractsData.forEach((contract, index) => {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù…ÙˆØ¯ Ù…Ù„Ù PDF
        let pdfCell = '';
        if (contract.contractFileName) {
          pdfCell = `<a href="/contracts/${contract.contractFileName}" target="_blank" style="color:#2e8ca3; font-weight:bold; text-decoration:underline;" title="Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„Ø¹Ù‚Ø¯">ğŸ“„ Ø¹Ø±Ø¶</a>`;
        } else {
          pdfCell = '<span style="color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${contract.contractNumber || ''}</td>
          <td>${contract.contractDate ? new Date(contract.contractDate).toLocaleDateString('ar-EG') : ''}</td>
          <td>${contract.contractType || ''}</td>
          <td>${contract.workItem || ''}</td>
          <td>${contract.contractValue ? parseFloat(contract.contractValue).toLocaleString('en-US') : ''}</td>
          <td>${contract.executionDuration ? contract.executionDuration + ' ÙŠÙˆÙ…' : ''}</td>
          <td>${pdfCell}</td>
          <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis;" title="${contract.notes || ''}">${contract.notes || ''}</td>
          <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
            <button onclick="editContract(${index})" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯">âœï¸</button>
            <button onclick="deleteContract(${index})" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯">âœ–</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯
    async function deleteContract(index) {
      if (index < 0 || index >= contractsData.length) return;
      
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ØŸ')) {
        try {
          // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          contractsData.splice(index, 1);
          
          // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
          const response = await fetch(`/contractors/${contractorId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ contracts: contractsData })
          });
          
          if (response.ok) {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            renderContractsTable();
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯');
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯');
        }
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯
    function editContract(index) {
      if (index < 0 || index >= contractsData.length) return;
      
      const contract = contractsData[index];
      
      // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.querySelector('#addContractForm input[name="contractNumber"]').value = contract.contractNumber || '';
      document.querySelector('#addContractForm input[name="contractDate"]').value = contract.contractDate ? contract.contractDate.split('T')[0] : '';
      document.querySelector('#addContractForm select[name="contractType"]').value = contract.contractType || '';
      document.querySelector('#addContractForm input[name="workItem"]').value = contract.workItem || '';
      document.querySelector('#addContractForm input[name="contractValue"]').value = contract.contractValue || '';
      document.querySelector('#addContractForm input[name="executionDuration"]').value = contract.executionDuration || '';
      document.querySelector('#addContractForm textarea[name="notes"]').value = contract.notes || '';
      
      // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ø­ÙØ¸
      document.querySelector('#addContractModal h3').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯';
      document.querySelector('#addContractForm button[type="submit"]').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
      
      // Ø­ÙØ¸ Ø§Ù„ÙÙ‡Ø±Ø³ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      document.getElementById('addContractForm').dataset.editIndex = index;
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.getElementById('addContractModal').style.display = 'flex';
    }

    // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ù„Ù„Ø¹Ù‚ÙˆØ¯
    function exportContractsToExcel() {
      if (!contractsData || contractsData.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚ÙˆØ¯ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!');
        return;
      }

      const contractorName = document.getElementById('name').textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const contractsDataForExport = [];
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
      contractsDataForExport.push([
        'Ù…',
        'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯',
        'Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„',
        'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯',
        'Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠÙˆÙ…)',
        'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
      ]);

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      contractsData.forEach((contract, index) => {
        contractsDataForExport.push([
          index + 1,
          contract.contractNumber || '',
          contract.contractDate ? new Date(contract.contractDate).toLocaleDateString('ar-EG') : '',
          contract.contractType || '',
          contract.workItem || '',
          contract.contractValue ? parseFloat(contract.contractValue).toLocaleString('en-US') : '',
          contract.executionDuration || '',
          contract.notes || ''
        ]);
      });

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
      const worksheet = XLSX.utils.aoa_to_sheet(contractsDataForExport);
      
      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
      const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
      for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[cellAddress]) continue;
        worksheet[cellAddress].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "2e8ca3" } },
          alignment: { horizontal: "center" }
        };
      }
      
      // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      worksheet['!cols'] = [
        { width: 5 },   // Ù…
        { width: 15 },  // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯
        { width: 12 },  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯
        { width: 15 },  // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯
        { width: 20 },  // Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        { width: 15 },  // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯
        { width: 12 },  // Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
        { width: 30 }   // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      ];

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const fileName = `Ø¹Ù‚ÙˆØ¯_${contractorName}_${dateStr}.xlsx`;
      
      // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
      XLSX.writeFile(workbook, fileName);
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
    async function calculateAndDisplaySummary() {
      try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ...');
        console.log('ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:', contractorId);
        
        // 1. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        let totalContractValue = 0;
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:', contractsData);
        contractsData.forEach(contract => {
          const contractValue = parseFloat(contract.contractValue) || 0;
          totalContractValue += contractValue;
          console.log(`ğŸ“‹ Ø¹Ù‚Ø¯: ${contract.contractNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - Ù‚ÙŠÙ…Ø©: ${contractValue}`);
        });
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯:', totalContractValue);
        
        // 2. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„ÙØ¦Ø©)
        let totalRegisteredWorksValue = 0;
        let savedSignedWorksValue = 0;
        
        console.log('ï¿½ Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„...');
        console.log('ï¿½ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©:', originalWorksData);
        
        if (originalWorksData && originalWorksData.length > 0) {
          originalWorksData.forEach((work, index) => {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙÙˆØ§ØµÙ„ ÙÙ‚Ø· (ØªØ´Ù…Ù„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©)
            if (!work.isSeparator) {
              const quantity = parseFloat(work.quantity) || 0;
              const category = parseFloat(work.category) || 0;
              const workValue = quantity * category;
              totalRegisteredWorksValue += workValue;
              const workType = work.isPulled ? '(Ù…Ø³Ø­ÙˆØ¨)' : '(Ø¹Ø§Ø¯ÙŠ)';
              console.log(`ğŸ’° Ø¹Ù…Ù„ ${index + 1}: ${work.workItem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} ${workType} - Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity} Ã— Ø§Ù„ÙØ¦Ø©: ${category} = ${workValue}`);
            }
          });
        } else {
          console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„');
        }
        
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (Ø¹Ø§Ø¯ÙŠØ© + Ù…Ø³Ø­ÙˆØ¨Ø©):', totalRegisteredWorksValue);
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙ‚Ø·
        const extractsResponse = await fetch(`/contractors/${contractorId}/extracts`);
        let extractsData = [];
        
        console.log('ğŸ“¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:', `/contractors/${contractorId}/extracts`);
        
        if (extractsResponse.ok) {
          extractsData = await extractsResponse.json();
          console.log('ğŸ“Š ØªÙ… Ø¬Ù„Ø¨', extractsData.length, 'Ù…Ø³ØªØ®Ù„Øµ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰');
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª:', extractsResponse.status);
        }
        
        // Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
        const contractorResponse = await fetch(`/contractors/${contractorId}`);
        if (contractorResponse.ok) {
          const contractorData = await contractorResponse.json();
          savedSignedWorksValue = parseFloat(contractorData.totalSignedWorksValue) || 0;
        }
        
        // 3. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        let totalPulledWorksValue = 0;
        
        console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ã— Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„ÙØ¦Ø©)...');
        
        if (originalWorksData && originalWorksData.length > 0) {
          originalWorksData.forEach((work, index) => {
            if (work.isPulled) {
              const quantity = parseFloat(work.quantity) || 0;
              const category = parseFloat(work.category) || 0;
              const totalPercent = parseFloat(work.totalPercent) || 0;
              
              // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© = 100% - Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
              const remainingPercent = 100 - totalPercent;
              
              // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ = Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ã— Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø§Ù„ÙØ¦Ø© / 100
              const workValue = (remainingPercent / 100) * quantity * category;
              
              totalPulledWorksValue += workValue;
              console.log(`ğŸ’° Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ ${index + 1}: ${work.workItem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
              console.log(`   Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}, Ø§Ù„ÙØ¦Ø©: ${category}, Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø¬Ø²Ø©: ${totalPercent}%`);
              console.log(`   Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ©: ${remainingPercent}% = ${workValue} Ø±ÙŠØ§Ù„`);
            }
          });
        }
        
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© (Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ©):', totalPulledWorksValue);
        
        // 4. Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ = Ø§Ù„Ù…Ø³Ø¬Ù„Ø© - Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
        const totalFinalWorksValue = totalRegisteredWorksValue - totalPulledWorksValue;
        
        // 6. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª (Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©)
        let totalExtractsValue = 0;
        
        console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª...');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const allExtractsResponse = await fetch('/extracts');
        if (allExtractsResponse.ok) {
          const allExtracts = await allExtractsResponse.json();
          // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø· (Ù†ÙØ³ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª)
          const contractorExtracts = allExtracts.filter(ex => ex.contractor == contractorId);
          
          contractorExtracts.forEach((extract, index) => {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† workItems (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª)
            let extractValue = 0;
            if (Array.isArray(extract.workItems)) {
              extractValue = extract.workItems.reduce((sum, item) => sum + (parseFloat(item.currentAmount) || 0), 0);
            }
            totalExtractsValue += extractValue;
            console.log(`ğŸ“‹ Ù…Ø³ØªØ®Ù„Øµ ${index + 1}: ${extract.extractNumber || extract.number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} = ${extractValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª: ${contractorExtracts.length}`);
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù„Ù„Ù…Ù„Ø®Øµ');
        }
        
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª (Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª):', totalExtractsValue);
        
        // 5. Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² = (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ / Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª)
        const completionPercentage = totalExtractsValue > 0 ? 
          (totalFinalWorksValue / totalExtractsValue).toFixed(2) : 0;
        
        console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: (' + totalFinalWorksValue + ' Ã· ' + totalExtractsValue + ') = ' + completionPercentage);
        
        // 7. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª (Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©)
        let totalDeductionsValue = 0;
        
        console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª...');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)
        const extractsForDeductions = await fetch('/extracts');
        if (extractsForDeductions.ok) {
          const extracts = await extractsForDeductions.json();
          // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø· (Ù†ÙØ³ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
          let allDeductions = [];
          extracts.forEach(extract => {
            if (extract.contractor == contractorId && Array.isArray(extract.deductions)) {
              extract.deductions.forEach(ded => {
                // ÙÙ‚Ø· Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù‚ÙŠÙ…Ø© (Ù†ÙØ³ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
                const hasValue =
                  (ded.total && !isNaN(parseFloat(ded.total)) && parseFloat(ded.total) !== 0) ||
                  (ded.category && !isNaN(parseFloat(ded.category)) && parseFloat(ded.category) !== 0) ||
                  (ded.quantity && !isNaN(parseFloat(ded.quantity)) && parseFloat(ded.quantity) !== 0);
                
                // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
                const isMaterialDeduction = 
                  (ded.statement && (
                    ded.statement.includes('Ø®ØµÙ… Ù…Ø§Ø¯Ø©') ||
                    ded.statement.includes('ØµØ±Ù Ù…Ø§Ø¯Ø©') ||
                    ded.statement.includes('Ø®ØµÙ… Ù…ÙˆØ§Ø¯') ||
                    ded.statement.includes('ØµØ±Ù Ù…ÙˆØ§Ø¯') ||
                    ded.statement.includes('Ù…Ø§Ø¯Ø©') ||
                    ded.statement.includes('Ø­Ø¯ÙŠØ¯') ||
                    ded.statement.includes('Ø£Ø³Ù…Ù†Øª') ||
                    ded.statement.includes('Ø±Ù…Ù„') ||
                    ded.statement.includes('Ø²Ù„Ø·') ||
                    ded.statement.includes('Ø¨Ù„ÙˆÙƒ') ||
                    ded.statement.includes('Ø·ÙˆØ¨')
                  )) ||
                  (ded.type && ded.type === 'material') ||
                  (ded.itemType && ded.itemType === 'material') ||
                  (ded.deductionType && ded.deductionType === 'material') ||
                  (ded.isAutomaticDeduction === true) ||
                  (ded.source && ded.source === 'materials');
                
                // Ø£Ø¶Ù ÙÙ‚Ø· Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (ØºÙŠØ± Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯)
                if (hasValue && !isMaterialDeduction) {
                  allDeductions.push({
                    ...ded,
                    extractId: extract._id,
                    extractNumber: extract.extractNumber || extract.number || ''
                  });
                }
              });
            }
          });
          
          // Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
          allDeductions.forEach((ded, index) => {
            const deductionValue = parseFloat(ded.total) || 0;
            totalDeductionsValue += deductionValue;
            console.log(`ğŸ’° Ø®ØµÙ… ${index + 1}: ${ded.statement || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} = ${deductionValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`ï¿½ Ø¹Ø¯Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: ${allDeductions.length}`);
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù„Ù„Ù…Ù„Ø®Øµ');
        }
        
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª (Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª):', totalDeductionsValue);
        
        // 8. Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©)
        let totalMaterialsValue = 0;
        
        console.log('ï¿½ Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¯...');
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¯)
        const contractorForMaterials = await fetch(`/contractors/${contractorId}`);
        if (contractorForMaterials.ok) {
          const contractorData = await contractorForMaterials.json();
          const materials = Array.isArray(contractorData.materials) ? contractorData.materials : [];
          
          materials.forEach((material, index) => {
            // Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø§Ø¯Ø© = Ø§Ù„ÙƒÙ…ÙŠØ© Ã— Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
            const quantity = parseFloat(material.quantity) || 0;
            const unitPrice = parseFloat(material.unitPrice) || 0;
            const materialValue = quantity * unitPrice;
            totalMaterialsValue += materialValue;
            console.log(`ğŸ’° Ù…Ø§Ø¯Ø© ${index + 1}: ${material.name || material.item || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} (${quantity} Ã— ${unitPrice}) = ${materialValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`ï¿½ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: ${materials.length}`);
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ù„Ø®Øµ');
        }
        
        console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¯):', totalMaterialsValue);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        console.log('ğŸ“ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©...');
        
        document.getElementById('totalContractValue').textContent = 
          totalContractValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯');
          
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©
        document.getElementById('totalSignedWorksValueDisplay').textContent = 
          (savedSignedWorksValue || 0).toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©');
          
        document.getElementById('totalRegisteredWorksValue').textContent = 
          totalRegisteredWorksValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:', totalRegisteredWorksValue);
          
        document.getElementById('totalPulledWorksValue').textContent = 
          totalPulledWorksValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©');
          
        document.getElementById('totalFinalWorksValue').textContent = 
          totalFinalWorksValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø£Ø¹Ù…Ø§Ù„');
          
        document.getElementById('completionPercentage').textContent = 
          completionPercentage + '%';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²');
          
        document.getElementById('totalExtractsValue').textContent = 
          totalExtractsValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª');
          
        document.getElementById('totalDeductionsValue').textContent = 
          totalDeductionsValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª');
          
        document.getElementById('totalMaterialsValue').textContent = 
          totalMaterialsValue.toLocaleString('en-US') + ' Ø±ÙŠØ§Ù„';
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯');
          
        
        console.log('âœ… ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ');
      }
    }

    // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©
    function editSignedWorksValue() {
      const currentValue = document.getElementById('totalSignedWorksValueDisplay').textContent
        .replace(' Ø±ÙŠØ§Ù„', '').replace(/,/g, '');
      document.getElementById('signedWorksValueInput').value = currentValue !== '0' ? currentValue : '';
      document.getElementById('editSignedWorksModal').style.display = 'flex';
    }

    // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function closeSignedWorksModal() {
      document.getElementById('editSignedWorksModal').style.display = 'none';
    }

    // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©
    async function saveSignedWorksValue() {
      try {
        const value = document.getElementById('signedWorksValueInput').value;
        const numericValue = parseFloat(value) || 0;
        
        const response = await fetch(`/contractors/${contractorId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            totalSignedWorksValue: numericValue
          })
        });
        
        if (response.ok) {
          console.log('âœ… ØªÙ… Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©:', numericValue);
          // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          closeSignedWorksModal();
          // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨
          calculateAndDisplaySummary();
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©');
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø©');
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø©');
      }
    }

    // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    let originalWorksData = [];

    let pulledWorksData = []; // Ø£Ø¹Ù…Ø§Ù„ Ù…Ø³Ø­ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    let isSortedByBuilding = false;
    
    // ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…Ø­Ø¯Ø«
    console.log('ğŸ”„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø« - Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©');

    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    async function fetchPulledWorks() {
      try {
        console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„:', contractorId);
        const response = await fetch(`/contractors/${contractorId}/pulled-works`);
        if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©');
        const pulledWorks = await response.json();
        console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©:', pulledWorks);
        return pulledWorks;
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©:', error);
        return [];
      }
    }

    // Ø¬Ù„Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù…Ù† Ø¢Ø®Ø± Ù…Ø³ØªØ®Ù„Øµ + Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
    async function fetchWorks() {
      const tbody = document.getElementById('worksBody');
      if (!tbody) return;
      
      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
        pulledWorksData = await fetchPulledWorks();
        
        // Ø¬Ù„Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù…Ø¹ Ù…Ù†Ø¹ cache
        const timestamp = Date.now();
        const res = await fetch(`/extracts?t=${timestamp}`);
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„.</td></tr>`;
          return;
        }
        
        const extracts = await res.json();
        // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø·
        const filtered = extracts.filter(ex => ex.contractor == contractorId);
        
        if (!filtered.length) {
          tbody.innerHTML = `<tr><td colspan="11" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
          return;
        }
        
        // Ø£Ø®Ø° Ø¢Ø®Ø± Ù…Ø³ØªØ®Ù„Øµ
        const lastExtract = filtered[filtered.length - 1];
        
        if (!lastExtract.workItems || !Array.isArray(lastExtract.workItems) || !lastExtract.workItems.length) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ.</td></tr>`;
          return;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        originalWorksData = lastExtract.workItems;
        
        renderWorksTable(originalWorksData, false);
        
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„.</td></tr>`;
      }
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±




    // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
    function editExtractWork(index) {
      if (index < 0 || index >= originalWorksData.length) return;
      
      const work = originalWorksData[index];
      if (work.isSeparator) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØµÙ„');
        return;
      }
      
      // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ Ù…Ù‚ÙÙˆÙ„ (Ù„Ù‡ Ù†Ø³Ø¨Ø©)
      if (work.totalPercent && work.totalPercent > 0) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
        return;
      }
      
      // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.querySelector('#addWorkForm input[name="buildingNumber"]').value = work.buildingNumber || '';
      document.querySelector('#addWorkForm input[name="workItem"]').value = work.workItem || '';
      document.querySelector('#addWorkForm textarea[name="workDescription"]').value = work.workDescription || '';
      document.querySelector('#addWorkForm input[name="quantity"]').value = work.quantity || '';
      document.querySelector('#addWorkForm input[name="unit"]').value = work.unit || '';
      document.querySelector('#addWorkForm input[name="category"]').value = work.category || '';
      document.querySelector('#addWorkForm input[name="totalPercent"]').value = work.totalPercent || '';
      document.querySelector('#addWorkForm input[name="totalAmount"]').value = work.totalAmount || '';
      
      // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ø­ÙØ¸
      document.querySelector('#addWorkModal h3').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ';
      document.querySelector('#addWorkForm button[type="submit"]').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
      
      // Ø­ÙØ¸ Ø§Ù„ÙÙ‡Ø±Ø³ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      document.getElementById('addWorkForm').dataset.editIndex = index;
      document.getElementById('addWorkForm').dataset.workType = 'extract';
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.getElementById('addWorkModal').style.display = 'flex';
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ (Ù…Ø­Ø³Ù†Ø©)
    async function deleteExtractWork(index) {
      if (index < 0 || index >= originalWorksData.length) {
        console.log('âŒ ÙÙ‡Ø±Ø³ Ø®Ø§Ø·Ø¦:', index, 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰:', originalWorksData.length - 1);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø­Ø°ÙÙ‡');
        return;
      }
      
      const work = originalWorksData[index];
      if (work.isSeparator) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„');
        return;
      }
      
      // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ Ù…Ù‚ÙÙˆÙ„ (Ù„Ù‡ Ù†Ø³Ø¨Ø©)
      if (work.totalPercent && work.totalPercent > 0) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
        return;
      }
      
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØŸ\nØ³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.')) {
        console.log('ğŸ—‘ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:', work.workDescription, 'Ø§Ù„ÙÙ‡Ø±Ø³:', index);
        
        try {
          // Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
          const extractsRes = await fetch(`/extracts`);
          if (!extractsRes.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª');
          
          const extracts = await extractsRes.json();
          const filtered = extracts.filter(ex => ex.contractor == contractorId);
          if (filtered.length === 0) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ù„Øµ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„');
          
          const lastExtract = filtered[filtered.length - 1];
          
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          const deleteResponse = await fetch(`/extracts/${lastExtract._id}/work-items/${index}`, {
            method: 'DELETE'
          });

          if (deleteResponse.ok) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            originalWorksData.splice(index, 1);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ indices
            renderWorksTable(originalWorksData, isSortedByBuilding);
            
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ÙˆØ­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
          } else {
            const error = await deleteResponse.json();
            console.error('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ: ' + (error.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        }
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
    function renderWorksTable(workItems, sortedByBuilding = false) {
      const tbody = document.getElementById('worksBody');
      tbody.innerHTML = '';
      
      console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:', workItems ? workItems.length : 0);
      
      if (sortedByBuilding) {
        renderSortedByBuilding(workItems);
      } else {
        renderNormalTable(workItems);
      }
      
      // Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      setTimeout(() => {
        calculateAndUpdateTotalWorks();
      }, 100);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    function renderNormalTable(workItems) {
      const tbody = document.getElementById('worksBody');
      let workRowNum = 1;
      let cumulativePercent = 0; // Ù…ØªØºÙŠØ± Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
      
      console.log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:', workItems ? workItems.length : 0);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
      if (workItems && workItems.length > 0) {
        workItems.forEach((item, index) => {
          console.log(`ğŸ” Ø§Ù„Ø¹Ù…Ù„ ${index}:`, item.workDescription, 'Ù…Ø³Ø­ÙˆØ¨ØŸ', item.isPulled);
          
          if (item.isSeparator) {
            // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØµÙ„
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="10" style="background:#2e8ca3;color:#fff;font-weight:bold;text-align:center;">${item.separatorName || 'ÙØ§ØµÙ„'}</td>`;
            tbody.appendChild(tr);
          } else {
            // Ø¹Ø±Ø¶ Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù…Ù„
            const tr = document.createElement('tr');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
            let workDescription = item.workDescription || '';
            let isPulled = item.isPulled || false;
            
            console.log(`ğŸ” Ø§Ù„Ø¹Ù…Ù„ "${item.workDescription}" - Ù…Ø³Ø­ÙˆØ¨ØŸ`, isPulled, 'Ø¥Ù„Ù‰:', item.pulledToContractorName);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (ÙÙ‚Ø· Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©)
            if (!isPulled && (item.totalPercent !== undefined && item.totalPercent !== null)) {
              cumulativePercent += parseFloat(item.totalPercent) || 0;
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„
            let statusText = '';
            let statusStyle = '';
            if (isPulled) {
              statusText = `Ø³ÙØ­Ø¨ Ø¥Ù„Ù‰: ${item.pulledToContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±'}`;
              statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
              console.log('ğŸ”´ Ø¹Ø±Ø¶ Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:', item.workDescription);
              tr.className = 'pulled-work';
              tr.style.backgroundColor = '#ffebee'; // Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ø®ÙÙŠÙØ©
              tr.style.opacity = '0.8'; // Ø´ÙØ§ÙÙŠØ© Ø®ÙÙŠÙØ©
            } else {
              statusText = 'Ø£ØµÙ„ÙŠ';
              statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
            }
            
            tr.innerHTML = `
              <td>${workRowNum++}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.buildingNumber || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.workItem || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.workDescription || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.quantity || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.unit || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.category || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${isPulled ? (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '') : (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '0%')}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : ''}</td>
              <td style="${statusStyle}">${statusText}</td>
              <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
                ${isPulled ? 
                  `<span style="color:#f44336; font-size:10px; font-weight:bold; text-align:center;">Ù…Ø³Ø­ÙˆØ¨</span>` :
                  (item.totalPercent && item.totalPercent > 0) ?
                    `<span style="color:#ff9800; font-size:10px; font-weight:bold; text-align:center; background:#fff3e0; padding:2px 4px; border-radius:3px;">Ù…Ù‚ÙÙˆÙ„</span>` :
                    `<button onclick="editExtractWork(${index})" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„">âœï¸</button>
                     <button onclick="deleteExtractWork(${index})" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„">âœ–</button>`
                }
              </td>
            `;
            tbody.appendChild(tr);
          }
        });
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰
    function renderSortedByBuilding(workItems) {
      const tbody = document.getElementById('worksBody');
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ÙÙ‚Ø·)
      const buildingsMap = new Map();
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
      if (workItems && workItems.length > 0) {
        workItems.forEach((item, originalIndex) => {
          if (!item.isSeparator) {
            const buildingNum = item.buildingNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            if (!buildingsMap.has(buildingNum)) {
              buildingsMap.set(buildingNum, []);
            }
            buildingsMap.get(buildingNum).push({...item, originalIndex, source: 'extract'});
          }
        });
      }

      // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚
      if (buildingsMap.size === 0) {
        tbody.innerHTML = `<tr><td colspan="11" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
        return;
      }

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…
      const sortedBuildings = Array.from(buildingsMap.keys()).sort((a, b) => {
        if (a === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') return 1;
        if (b === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') return -1;
        return parseInt(a) - parseInt(b);
      });

      let globalRowNum = 1;

      sortedBuildings.forEach((buildingNum) => {
        const items = buildingsMap.get(buildingNum);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¨Ù†Ù‰
        const buildingHeader = document.createElement('tr');
        buildingHeader.className = 'building-header';
        buildingHeader.setAttribute('data-building', buildingNum);
        buildingHeader.innerHTML = `
          <td colspan="11" style="text-align:center;">
            <span class="building-arrow">â—„</span>
            Ù…Ø¨Ù†Ù‰ Ø±Ù‚Ù… ${buildingNum} (${items.length} Ø¨Ù†Ø¯)
          </td>
        `;
        tbody.appendChild(buildingHeader);

        // Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ØªØ­Øª ÙƒÙ„ Ù…Ø¨Ù†Ù‰ (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
        items.forEach((item) => {
          const tr = document.createElement('tr');
          tr.className = 'building-works'; // Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
          tr.setAttribute('data-building', buildingNum);
          
          // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ ÙˆÙ…Ø¹Ø±ÙÙ‡
          const isPulled = item.source === 'pulled';
          const workIndex = isPulled ? item.pulledIndex : item.originalIndex;
          const isManual = item.source === 'manual' || !item.source; // Ø¹Ù…Ù„ ÙŠØ¯ÙˆÙŠ
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¸Ù‡Ø±
          let workDescription = item.workDescription || '';
          let isWorkPulled = item.isPulled || false;
          let pulledInfo = '';
          
          console.log(`ğŸ” [Building View] Ø§Ù„Ø¹Ù…Ù„ "${item.workDescription}" - Ù†ÙˆØ¹: ${item.source} - Ù…Ø³Ø­ÙˆØ¨ØŸ`, isWorkPulled);
          
          if (isPulled) {
            // Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ (Ù…Ù† endpoint pulled-works)
            tr.style.backgroundColor = '#ffebee'; // Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ø®ÙÙŠÙØ©
            tr.style.opacity = '0.8'; // Ø´ÙØ§ÙÙŠØ© Ø®ÙÙŠÙØ©
          } else if (isWorkPulled) {
            // Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ø¥Ù„Ù‰ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± (Ø³ÙˆØ§Ø¡ ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ù…Ù† Ù…Ø³ØªØ®Ù„Øµ)
            console.log('ğŸ”´ [Building View] Ø¹Ø±Ø¶ Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨:', item.workDescription, 'Ù†ÙˆØ¹:', item.source);
            tr.classList.add('pulled-work');
            tr.style.backgroundColor = '#ffebee'; // Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ø®ÙÙŠÙØ©
            tr.style.opacity = '0.8'; // Ø´ÙØ§ÙÙŠØ© Ø®ÙÙŠÙØ©
          } else if (isManual) {
            tr.style.backgroundColor = '#e8f5e9'; // Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
          }
          
          // ØªØ­Ø¯ÙŠØ¯ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„
          let actionsColumn = '';
          if (isPulled || isWorkPulled) {
            // Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡
            actionsColumn = `<td style="text-align:center; color:#f44336; font-weight:bold; font-size:10px;">Ø³ÙØ­Ø¨</td>`;
          } else if (item.totalPercent && item.totalPercent > 0) {
            // Ø¹Ù…Ù„ Ù…Ù‚ÙÙˆÙ„ (Ù„Ù‡ Ù†Ø³Ø¨Ø©) - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡
            actionsColumn = `<td style="text-align:center;"><span style="color:#ff9800; font-size:10px; font-weight:bold; background:#fff3e0; padding:2px 4px; border-radius:3px;">Ù…Ù‚ÙÙˆÙ„</span></td>`;
          } else {
            const editFunction = `editExtractWork(${workIndex})`;
            const deleteFunction = `deleteExtractWork(${workIndex})`;
            actionsColumn = `
              <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
                <button onclick="${editFunction}" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„">âœï¸</button>
                <button onclick="${deleteFunction}" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„">âœ–</button>
              </td>
            `;
          }
          
          // Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶Ù‡Ø§
          const grayStyle = (isPulled || isWorkPulled) ? 'color:#999;' : '';
          
          // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„
          let statusText = '';
          let statusStyle = '';
          if (isPulled) {
            statusText = `Ø³ÙØ­Ø¨ Ø¥Ù„Ù‰: ${item.pulledToContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±'}`;
            statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
          } else if (isWorkPulled) {
            statusText = `Ø³ÙØ­Ø¨ Ø¥Ù„Ù‰: ${item.pulledToContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±'}`;
            statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
          } else if (isManual && item.pulledFromContractorName) {
            statusText = `Ù…Ø¬Ù„ÙˆØ¨ Ù…Ù†: ${item.pulledFromContractorName}`;
            statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
          } else if (isManual) {
            statusText = 'ÙŠØ¯ÙˆÙŠ';
            statusStyle = 'color:#388e3c; font-weight:bold; font-size:0.75rem;';
          } else {
            statusText = 'Ø£ØµÙ„ÙŠ';
            statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
          }
          
          tr.innerHTML = `
            <td>${globalRowNum++}</td>
            <td style="${grayStyle}">${item.buildingNumber || ''}</td>
            <td style="${grayStyle}">${item.workItem || ''}</td>
            <td style="${grayStyle}">${item.workDescription || ''}</td>
            <td style="${grayStyle}">${item.quantity || ''}</td>
            <td style="${grayStyle}">${item.unit || ''}</td>
            <td style="${grayStyle}">${item.category || ''}</td>
            <td style="${grayStyle}">${item.totalPercent || ''}${item.totalPercent ? '%' : ''}</td>
            <td style="${grayStyle}">${item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : ''}</td>
            <td style="${statusStyle}">${statusText}</td>
            ${actionsColumn}
          `;
          tbody.appendChild(tr);
        });
      });

      // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·ÙŠ ÙˆØ§Ù„ÙØªØ­
      addBuildingToggleEvents();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø·ÙŠ ÙˆØ§Ù„ÙØªØ­ Ù„Ù„Ù…Ø¨Ø§Ù†ÙŠ
    function addBuildingToggleEvents() {
      document.querySelectorAll('.building-header').forEach(header => {
        header.addEventListener('click', function() {
          const buildingNum = this.getAttribute('data-building');
          const arrow = this.querySelector('.building-arrow');
          const buildingWorks = document.querySelectorAll(`.building-works[data-building="${buildingNum}"]`);
          
          buildingWorks.forEach(row => {
            if (row.classList.contains('visible')) {
              // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯
              row.classList.remove('visible');
              arrow.textContent = 'â—„';
              arrow.classList.remove('expanded');
            } else {
              // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯
              row.classList.add('visible');
              arrow.textContent = 'â–¼';
              arrow.classList.add('expanded');
            }
          });
        });
      });
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    async function fetchExtracts() {
      const res = await fetch(`/extracts`);
      const tbody = document.getElementById('extractsBody');
      if (!tbody) return; // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø·Ø£
      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª.</td></tr>`;
        return;
      }
      const extracts = await res.json();
      // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø·
      const filtered = extracts.filter(ex => ex.contractor == contractorId);
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      filtered.forEach((ex, i) => {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† workItems (Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª)
        let value = 0;
        if (Array.isArray(ex.workItems)) {
          value = ex.workItems.reduce((sum, item) => sum + (parseFloat(item.currentAmount) || 0), 0);
        }
        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù…Ø¹ ÙÙˆØ§ØµÙ„ (Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª)
        const valueStr = Number(value).toLocaleString('en-US', {maximumFractionDigits: 2});
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${ex.extractNumber || ex.number || ''}</td>
          <td>${ex.extractDate ? new Date(ex.extractDate).toLocaleDateString('ar-EG') : (ex.date ? new Date(ex.date).toLocaleDateString('ar-EG') : '')}</td>
          <td style="direction:ltr; text-align:center;">${valueStr}</td>
          <td>
            <a href="extract.html?id=${ex._id}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;">Ø¹Ø±Ø¶</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    async function fetchDeductions() {
      const res = await fetch(`/extracts`);
      const tbody = document.getElementById('deductionsBody');
      if (!tbody) return;
      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª.</td></tr>`;
        return;
      }
      const extracts = await res.json();
      // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† Ù…Ø³ØªØ®Ù„ØµØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø·
      let allDeductions = [];
      extracts.forEach(extract => {
        if (extract.contractor == contractorId && Array.isArray(extract.deductions)) {
          extract.deductions.forEach(ded => {
            // ÙÙ‚Ø· Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù‚ÙŠÙ…Ø© (total Ø£Ùˆ category Ø£Ùˆ quantity ÙÙŠÙ‡Ø§ Ø±Ù‚Ù…)
            const hasValue =
              (ded.total && !isNaN(parseFloat(ded.total)) && parseFloat(ded.total) !== 0) ||
              (ded.category && !isNaN(parseFloat(ded.category)) && parseFloat(ded.category) !== 0) ||
              (ded.quantity && !isNaN(parseFloat(ded.quantity)) && parseFloat(ded.quantity) !== 0);
            
            // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø®ØµÙ… Ù„ÙŠØ³ Ø®ØµÙ… Ù…Ø§Ø¯Ø©
            const isMaterialDeduction = 
              (ded.statement && (
                ded.statement.includes('Ø®ØµÙ… Ù…Ø§Ø¯Ø©') ||
                ded.statement.includes('ØµØ±Ù Ù…Ø§Ø¯Ø©') ||
                ded.statement.includes('Ø®ØµÙ… Ù…ÙˆØ§Ø¯') ||
                ded.statement.includes('ØµØ±Ù Ù…ÙˆØ§Ø¯') ||
                ded.statement.includes('Ù…Ø§Ø¯Ø©') ||
                ded.statement.includes('Ø­Ø¯ÙŠØ¯') ||
                ded.statement.includes('Ø£Ø³Ù…Ù†Øª') ||
                ded.statement.includes('Ø±Ù…Ù„') ||
                ded.statement.includes('Ø²Ù„Ø·') ||
                ded.statement.includes('Ø¨Ù„ÙˆÙƒ') ||
                ded.statement.includes('Ø·ÙˆØ¨')
              )) ||
              (ded.type && ded.type === 'material') ||
              (ded.itemType && ded.itemType === 'material') ||
              (ded.deductionType && ded.deductionType === 'material') ||
              (ded.isAutomaticDeduction === true) ||
              (ded.source && ded.source === 'materials');
            
            // Ø£Ø¶Ù ÙÙ‚Ø· Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (ØºÙŠØ± Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯)
            if (hasValue && !isMaterialDeduction) {
              allDeductions.push({
                ...ded,
                extractId: extract._id,
                extractNumber: extract.extractNumber || extract.number || ''
              });
            } else if (hasValue && isMaterialDeduction) {
              // ØªØ´Ø®ÙŠØµ: Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
              console.log('ğŸš« ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø®ØµÙ… Ù…Ø§Ø¯Ø©:', ded.statement, ded);
            }
          });
        }
      });
      if (!allDeductions.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      allDeductions.forEach((ded, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${ded.statement || ''}</td>
          <td>${ded.date ? new Date(ded.date).toLocaleDateString('ar-EG') : ''}</td>
          <td>${ded.quantity || ''}</td>
          <td>${ded.category || ''}</td>
          <td>${ded.total || ''}</td>
          <td>${ded.user || ''}</td>
          <td>
            ${ded.extractId ? `<a href="extract.html?id=${ded.extractId}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;">${ded.extractNumber}</a>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„
    function exportToExcel() {
      if (!originalWorksData || originalWorksData.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¹Ù…Ø§Ù„ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!');
        return;
      }

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
      const contractorName = document.getElementById('name').textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const workData = [];
      let cumulativePercent = 0; // Ù…ØªØºÙŠØ± Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
      workData.push([
        'Ù…',
        'Ø§Ù„Ù…Ø¨Ù†Ù‰',
        'Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„',
        'Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„',
        'Ø§Ù„ÙƒÙ…ÙŠØ©',
        'Ø§Ù„ÙˆØ­Ø¯Ø©',
        'Ø§Ù„ÙØ¦Ø©',
        'Ø§Ù„Ù†Ø³Ø¨Ø© %',
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ $',
        'Ø§Ù„Ø­Ø§Ù„Ø©'
      ]);

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let rowNum = 1;
      originalWorksData.forEach(item => {
        if (item.isSeparator) {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØµÙ„
          workData.push([
            '',
            `--- ${item.separatorName || 'ÙØ§ØµÙ„'} ---`,
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ]);
        } else {
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (ÙÙ‚Ø· Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©)
          if (!item.isPulled && (item.totalPercent !== undefined && item.totalPercent !== null)) {
            cumulativePercent += parseFloat(item.totalPercent) || 0;
          }
          
          // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„ØªØµØ¯ÙŠØ±
          let statusText = '';
          if (item.isPulled) {
            statusText = `Ø³ÙØ­Ø¨ Ø¥Ù„Ù‰: ${item.pulledToContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±'}`;
          } else {
            statusText = 'Ø£ØµÙ„ÙŠ';
          }
          
          workData.push([
            rowNum++,
            item.buildingNumber || '',
            item.workItem || '',
            item.workDescription || '',
            item.quantity || '',
            item.unit || '',
            item.category || '',
            item.isPulled ? 
              (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '') : 
              (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '0%'),
            item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : '',
            statusText
          ]);
        }
      });

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
      const worksheet = XLSX.utils.aoa_to_sheet(workData);
      
      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
      const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
      for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[cellAddress]) continue;
        worksheet[cellAddress].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "2e8ca3" } },
          alignment: { horizontal: "center" }
        };
      }
      
      // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      worksheet['!cols'] = [
        { width: 5 },   // Ù…
        { width: 10 },  // Ø§Ù„Ù…Ø¨Ù†Ù‰
        { width: 15 },  // Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        { width: 30 },  // Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        { width: 10 },  // Ø§Ù„ÙƒÙ…ÙŠØ©
        { width: 10 },  // Ø§Ù„ÙˆØ­Ø¯Ø©
        { width: 10 },  // Ø§Ù„ÙØ¦Ø©
        { width: 12 },  // Ø§Ù„Ù†Ø³Ø¨Ø© %
        { width: 15 },  // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ $
        { width: 15 }   // Ø§Ù„Ø­Ø§Ù„Ø©
      ];

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const fileName = `Ø£Ø¹Ù…Ø§Ù„_${contractorName}_${dateStr}.xlsx`;
      
      // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
      XLSX.writeFile(workbook, fileName);
    }

    // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯
    function openAddContractModal() {
      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© openAddContractModal ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§!');
      const modal = document.getElementById('addContractModal');
      console.log('ğŸ” Ø§Ù„Ù…ÙˆØ¯Ø§Ù„:', modal);
      if (modal) {
        modal.style.display = 'flex';
        console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ - display:', modal.style.display);
      } else {
        console.error('âŒ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
        alert('Ø®Ø·Ø£: Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©!');
      }
    }

    // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯
    function closeAddContractModal() {
      console.log('ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„');
      const modal = document.getElementById('addContractModal');
      const form = document.getElementById('addContractForm');
      if (modal) modal.style.display = 'none';
      if (form) form.reset();
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ - Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±
    let allContractors = [];
    let currentContractorWorks = [];
    let selectedWorkIds = [];

    // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
    async function openPullWorksModal() {
      try {
        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†
        const response = await fetch('/contractors');
        if (response.ok) {
          allContractors = await response.json();
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          allContractors = allContractors.filter(c => c._id.toString() !== contractorId);
          
          // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø§Ù„Ù‡Ø¯Ù
          const targetSelect = document.getElementById('targetContractorSelect');
          targetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù...</option>';
          
          allContractors.forEach(contractor => {
            const option = document.createElement('option');
            option.value = contractor._id;
            option.textContent = `${contractor.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${contractor.workItem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            targetSelect.appendChild(option);
          });
          
          // ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
          await loadCurrentContractorWorks();
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          document.getElementById('pullWorksModal').style.display = 'flex';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:', error);
        alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†.');
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    async function loadCurrentContractorWorks() {
      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª
        const extractsResponse = await fetch(`/extracts`);
        let extractWorks = [];
        if (extractsResponse.ok) {
          const extracts = await extractsResponse.json();
          const contractorExtracts = extracts.filter(ex => ex.contractor == contractorId);
          
          if (contractorExtracts.length > 0) {
            const lastExtract = contractorExtracts[contractorExtracts.length - 1];
            if (lastExtract.workItems && Array.isArray(lastExtract.workItems)) {
              extractWorks = lastExtract.workItems.filter(item => !item.isSeparator);
            }
          }
        }

        // Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª ÙÙ‚Ø·
        currentContractorWorks = [
          ...extractWorks.map((work, index) => ({...work, source: 'extract', extractIndex: index}))
        ];
        
        displayCurrentWorks(currentContractorWorks);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ:', error);
        currentContractorWorks = [];
        displayCurrentWorks([]);
      }
    }

    function displayCurrentWorks(works) {
      const worksList = document.getElementById('currentWorksListForPull');
      worksList.innerHTML = '';
      
      if (!works || works.length === 0) {
        worksList.innerHTML = '<p style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ù„Ø³Ø­Ø¨</p>';
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
      const table = document.createElement('table');
      table.style.cssText = 'width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem;';
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr style="background:#2e8ca3; color:#fff;">
          <th style="padding:8px; border:1px solid #ddd; text-align:center; width:40px;">
            <input type="checkbox" id="selectAllWorksInTable" style="margin:0;">
          </th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„Ù…ØµØ¯Ø±</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„ÙØ¦Ø©</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const tbody = document.createElement('tbody');
      
      works.forEach((work, index) => {
        const row = document.createElement('tr');
        row.style.cssText = 'border-bottom:1px solid #ddd;';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
        const isPulled = work.isPulled || false;
        const isDisabled = isPulled;
        
        if (isPulled) {
          row.style.backgroundColor = '#ffebee';
          row.style.opacity = '0.6';
        } else if (work.source === 'manual') {
          row.style.backgroundColor = '#e8f5e9'; // Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        const quantity = parseFloat(work.quantity) || 0;
        const category = parseFloat(work.category) || 0;
        const totalPercent = parseFloat(work.totalPercent) || 100;
        const total = (quantity * category * totalPercent) / 100;
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù…Ù„
        const workId = work._id || `extract_${work.extractIndex}`;
        let sourceText = work.source === 'manual' ? 'ÙŠØ¯ÙˆÙŠ' : 'Ù…Ø³ØªØ®Ù„Øµ';
        const sourceColor = work.source === 'manual' ? '#388e3c' : '#2e8ca3';
        
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©
        if (isPulled) {
          sourceText += ' (Ù…Ø³Ø­ÙˆØ¨)';
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        let workDescription = work.workDescription || '';
        if (isPulled) {
          const pulledToName = work.pulledToContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±';
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙ‚Ø·
          workDescription = `<span style="color:#d32f2f; font-size:0.8rem;">${workDescription}</span>`;
        }
        
        row.innerHTML = `
          <td style="padding:6px; border:1px solid #ddd; text-align:center;">
            <input type="checkbox" 
                   value="${workId}" 
                   data-source="${work.source}" 
                   data-index="${index}" 
                   class="work-checkbox" 
                   style="margin:0;" 
                   ${isDisabled ? 'disabled' : ''}>
          </td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; color:${isPulled ? '#d32f2f' : sourceColor}; font-weight:bold;">${sourceText}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.buildingNumber || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.workItem || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:right; max-width:200px; overflow:hidden; text-overflow:ellipsis; ${isPulled ? 'color:#d32f2f;' : ''}" title="${work.workDescription || ''}">${workDescription}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.quantity || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.unit || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.category || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:bold; ${isPulled ? 'color:#d32f2f;' : ''}">${total ? total.toLocaleString('en-US') : ''}</td>
        `;
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      worksList.appendChild(table);
      
      // Ø¥Ø¶Ø§ÙØ© event listener Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      document.getElementById('selectAllWorksInTable').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.work-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedWorks();
      });
      
      // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
      document.querySelectorAll('.work-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedWorks);
      });
      
      // ØªØ­Ø¯ÙŠØ« checkbox Ø§Ù„ÙƒÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const selectAllWorks = document.getElementById('selectAllWorks');
      if (selectAllWorks) {
        selectAllWorks.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.work-checkbox');
          const selectAllInTable = document.getElementById('selectAllWorksInTable');
          checkboxes.forEach(cb => cb.checked = this.checked);
          if (selectAllInTable) selectAllInTable.checked = this.checked;
          updateSelectedWorks();
        });
      }
    }

    function updateSelectedWorks() {
      const checkedBoxes = Array.from(document.querySelectorAll('.work-checkbox:checked'));
      selectedWorkIds = checkedBoxes.map(cb => ({
        id: cb.value,
        source: cb.dataset.source,
        index: parseInt(cb.dataset.index)
      }));
      
      const proceedBtn = document.getElementById('proceedToStep2Btn');
      
      if (selectedWorkIds.length > 0) {
        proceedBtn.disabled = false;
        proceedBtn.textContent = `Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (${selectedWorkIds.length} Ø¹Ù…Ù„ Ù…Ø®ØªØ§Ø±)`;
      } else {
        proceedBtn.disabled = true;
        proceedBtn.textContent = 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù';
      }
    }

    // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
    document.getElementById('targetContractorSelect').addEventListener('change', function() {
      const targetContractorId = this.value;
      const proceedBtn = document.getElementById('proceedToStep3Btn');
      
      if (targetContractorId && selectedWorkIds.length > 0) {
        proceedBtn.disabled = false;
      } else {
        proceedBtn.disabled = true;
      }
    });

    document.getElementById('proceedToStep2Btn').addEventListener('click', function() {
      if (selectedWorkIds.length > 0) {
        document.getElementById('step2').style.display = 'block';
      }
    });

    document.getElementById('proceedToStep3Btn').addEventListener('click', function() {
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©
      const targetContractorName = document.getElementById('targetContractorSelect').selectedOptions[0].textContent;
      const sourceContractorName = document.getElementById('name').textContent;
      
      document.getElementById('sourceContractorName').textContent = sourceContractorName;
      document.getElementById('targetContractorName').textContent = targetContractorName;
      document.getElementById('selectedWorksCount').textContent = selectedWorkIds.length;
      
      document.getElementById('step3').style.display = 'block';
    });

    document.getElementById('confirmPullBtn').addEventListener('click', async function() {
      try {
        const targetContractorId = document.getElementById('targetContractorSelect').value;
        const currentContractorName = document.getElementById('name').textContent;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù
        const targetContractor = allContractors.find(c => c._id === targetContractorId);
        const targetContractorName = targetContractor ? targetContractor.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±
        const extractWorks = [];
        
        selectedWorkIds.forEach(workSelection => {
          const sourceWork = currentContractorWorks[workSelection.index];
          if (sourceWork) {
            if (workSelection.source === 'extract') {
              extractWorks.push({...sourceWork, originalIndex: sourceWork.extractIndex});
            }
          }
        });
        
        if (extractWorks.length === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ù…Ø³ØªØ®Ù„Øµ Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø³Ø­Ø¨.');
          return;
        }

        // Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø³Ø­Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:', extractWorks);
        
        // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const worksToAdd = extractWorks.map(workData => ({
          buildingNumber: workData.buildingNumber,
          workItem: workData.workItem,
          workDescription: workData.workDescription,
          quantity: workData.quantity,
          unit: workData.unit,
          category: workData.category,
          prevPercent: workData.totalPercent || 0, // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
          currentPercent: 0, // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© = 0 ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          totalPercent: workData.totalPercent || 0, // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          prevAmount: workData.totalAmount || 0, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø§Ø¨Ù‚ = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
          currentAmount: 0, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ = 0 ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          totalAmount: workData.totalAmount || 0, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ù†ÙØ³ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø§Ø¨Ù‚
          pulledFromContractorId: contractorId,
          pulledFromContractorName: currentContractorName,
          pulledAt: new Date()
        }));
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const addWorksResponse = await fetch(`/contractors/${targetContractorId}/add-pulled-works`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            pulledWorks: worksToAdd
          })
        });
        
        if (!addWorksResponse.ok) {
          throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
        }
        
        // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ÙƒÙ…Ø³Ø­ÙˆØ¨Ø©
        for (const workData of extractWorks) {
          const markResponse = await fetch(`/extracts/mark-work-pulled/${contractorId}/${workData.originalIndex}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              isPulled: true,
              pulledTo: targetContractorId,
              pulledToContractorName: targetContractorName,
              pulledAt: new Date()
            })
          });
          
          if (!markResponse.ok) {
            console.warn(`âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù…Ù„ ${workData.originalIndex} ÙƒÙ…Ø³Ø­ÙˆØ¨`);
          }
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('pullWorksModal').style.display = 'none';
        
        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨...');

        await fetchWorks(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        console.log('ğŸ“Š originalWorksData Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨:', originalWorksData);
        
        renderWorksTable(originalWorksData, isSortedByBuilding);
        
        const totalPulled = extractWorks.length;
        alert(`ØªÙ… Ø³Ø­Ø¨ ${totalPulled} Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ "${targetContractorName}"!\n- Ø£Ø¹Ù…Ø§Ù„ Ù…Ù† Ù…Ø³ØªØ®Ù„ØµØ§Øª: ${extractWorks.length}\n\nØ§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ø³ØªØ¸Ù‡Ø± Ø¨Ù„ÙˆÙ† Ø£Ø­Ù…Ø± ÙˆØ³ØªØ¸Ù‡Ø± ÙÙŠ Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙÙŠ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚.`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        resetPullModal();
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„: ' + error.message);
      }
    });

    document.getElementById('cancelPullBtn').addEventListener('click', function() {
      document.getElementById('pullWorksModal').style.display = 'none';
      resetPullModal();
    });

    function resetPullModal() {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'none';
      selectedWorkIds = [];
      document.getElementById('selectAllWorks').checked = false;
      document.getElementById('proceedToStep2Btn').disabled = true;
      document.getElementById('proceedToStep2Btn').textContent = 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù';
      document.getElementById('proceedToStep3Btn').disabled = true;
      document.getElementById('targetContractorSelect').value = '';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡
    document.getElementById('pullWorksModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        resetPullModal();
      }
    });



    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
    
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    async function fetchReceipts() {
      try {
        const response = await fetch('https://taskon-production.up.railway.app/receipts');
        const allReceipts = await response.json();
        
        // Ù„Ù„ØªØ´Ø®ÙŠØµ
        console.log('contractorId Ù…Ù† Ø§Ù„ØµÙØ­Ø©:', contractorId, typeof contractorId);
        console.log('Ø¹Ø¯Ø¯ ÙƒÙ„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª:', allReceipts.length);
        console.log('Ø£ÙˆÙ„ Ø³Ù†Ø¯:', allReceipts[0]);
        
        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø· - Ø§Ø³ØªØ®Ø¯Ø§Ù… == Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† === Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        const contractorReceipts = allReceipts.filter(receipt => {
          console.log('Ù…Ù‚Ø§Ø±Ù†Ø©:', receipt.contractorId, 'Ù…Ø¹', contractorId);
          return receipt.contractorId && receipt.contractorId.toString() === contractorId.toString();
        });
        
        console.log('Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', contractorReceipts.length);
        
        const receiptsBody = document.getElementById('receiptsBody');
        
        if (contractorReceipts.length === 0) {
          receiptsBody.innerHTML = '<tr><td colspan="8" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</td></tr>';
          return;
        }
        
        receiptsBody.innerHTML = contractorReceipts.map((receipt, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${receipt.receiptNumber || ''}</td>
            <td>${receipt.receiptDate ? new Date(receipt.receiptDate).toLocaleDateString('ar-EG') : ''}</td>
            <td>${receipt.receiverName || ''}</td>
            <td>${receipt.serviceDescription || ''}</td>
            <td>${parseFloat(receipt.amount || 0).toFixed(2)}</td>
            <td>${receipt.amountInWords || ''}</td>
            <td>${receipt.notes || ''}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù†Ø¯Ø§Øª:', error);
        document.getElementById('receiptsBody').innerHTML = '<tr><td colspan="8" class="no-data">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
      }
    }
    
    async function initializeContractorPage() {
      try {
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let pageUser = JSON.parse(localStorage.getItem('user') || '{}');
        if (!pageUser.username) window.location.href = 'login.html';
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = function() {
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        };
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ù†ÙØ³ Ø§Ù„Ø®Ø·
        document.addEventListener('DOMContentLoaded', function() {
          // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
          setTimeout(function() {
            const usernameEl = document.getElementById('username');
            if (usernameEl && pageUser.username) {
              usernameEl.textContent = pageUser.username;
              usernameEl.style.fontFamily = "'Cairo', Arial, sans-serif";
            }
          }, 200);
        });

        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const showContractsBtn = document.getElementById('showContractsBtn');
        const showWorksBtn = document.getElementById('showWorksBtn');
        const showExtractsBtn = document.getElementById('showExtractsBtn');
        const showDeductionsBtn = document.getElementById('showDeductionsBtn');
        const showMaterialsBtn = document.getElementById('showMaterialsBtn');
        const showReceiptsBtn = document.getElementById('showReceiptsBtn');
        
        const summaryContainer = document.getElementById('summaryContainer');
        const contractsContainer = document.getElementById('contractsContainer');
        const worksContainer = document.getElementById('worksContainer');
        const extractsContainer = document.getElementById('extractsContainer');
        const deductionsContainer = document.getElementById('deductionsContainer');
        const materialsContainer = document.getElementById('materialsContainer');
        const receiptsContainer = document.getElementById('receiptsContainer');

        showSummaryBtn.onclick = function() {
          summaryContainer.style.display = '';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          updateButtonColors(showSummaryBtn);
          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù‚Ø¨Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ
          if (!originalWorksData || originalWorksData.length === 0) {
            console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù‚Ø¨Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ...');
            fetchWorks().then(() => {
              calculateAndDisplaySummary(); // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
            });
          } else {
            calculateAndDisplaySummary(); // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ø¨Ø§Ø´Ø±Ø©
          }
        };

        showContractsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = '';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          updateButtonColors(showContractsBtn);
          fetchContracts(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        };
        
        showWorksBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = '';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showWorksBtn);
          fetchWorks(); // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        };
        
        showExtractsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = '';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showExtractsBtn);
          fetchExtracts();
        };
        
        showDeductionsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = '';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showDeductionsBtn);
          fetchDeductions();
        };
        
        showMaterialsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = '';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showMaterialsBtn);
          // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¹Ù†Ø¯ ÙƒÙ„ ÙØªØ­ Ù„Ù„Ù†Ø§ÙØ°Ø©
          fetchContractor();
        };

        showReceiptsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = '';
          updateButtonColors(showReceiptsBtn);
          fetchReceipts();
        };

        function updateButtonColors(activeBtn) {
          [showSummaryBtn, showContractsBtn, showWorksBtn, showExtractsBtn, showDeductionsBtn, showMaterialsBtn, showReceiptsBtn].forEach(btn => {
            if (btn === activeBtn) {
              btn.style.background = '#1a3b50';
            } else {
              btn.style.background = '#2e8ca3';
            }
          });
        }

        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ø£Ø¸Ù‡Ø± ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù„Ø®Øµ ÙƒØªØ¨ÙˆÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        summaryContainer.style.display = '';
        contractsContainer.style.display = 'none';
        worksContainer.style.display = 'none';
        extractsContainer.style.display = 'none';
        deductionsContainer.style.display = 'none';
        materialsContainer.style.display = 'none';
        updateButtonColors(showSummaryBtn);
        
        console.log('ğŸ” Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù„...');

        // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ù†Ù‚Ù„Ù‡Ø§ Ù‡Ù†Ø§ Ù‚Ø¨Ù„ await
        const sortByBuildingBtn = document.getElementById('sortByBuildingBtn');
        const showAllWorksBtn = document.getElementById('showAllWorksBtn');
        
        if (sortByBuildingBtn) {
          sortByBuildingBtn.onclick = function() {
            isSortedByBuilding = true;
            renderWorksTable(originalWorksData, true);
            sortByBuildingBtn.style.display = 'none';
            if (showAllWorksBtn) {
              showAllWorksBtn.style.display = 'inline-block';
            }
            console.log('âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰');
          };
        }

        if (showAllWorksBtn) {
          showAllWorksBtn.onclick = function() {
            isSortedByBuilding = false;
            renderWorksTable(originalWorksData, false);
            if (sortByBuildingBtn) {
              sortByBuildingBtn.style.display = 'inline-block';
            }
            showAllWorksBtn.style.display = 'none';
            console.log('âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„');
          };
        }

        // Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„
        try {
          const exportExcelBtn = document.getElementById('exportExcelBtn');
          if (exportExcelBtn) {
            exportExcelBtn.onclick = function() {
              exportToExcel();
            };
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„');
          }
        } catch(e) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„:', e);
        }

        // Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯
        try {
          const exportContractsExcelBtn = document.getElementById('exportContractsExcelBtn');
          if (exportContractsExcelBtn) {
            exportContractsExcelBtn.onclick = function() {
              exportContractsToExcel();
            };
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯');
          }
        } catch(e) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯:', e);
        }

        // Ø±Ø¨Ø· Ø²Ø± Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        try {
          const pullWorksBtn = document.getElementById('pullWorksBtn');
          if (pullWorksBtn) {
            pullWorksBtn.onclick = function() {
              openPullWorksModal();
            };
            console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„');
          }
        } catch(e) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø²Ø± Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:', e);
        }

        console.log('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯...');

        // Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯
        try {
          const addContractBtn = document.getElementById('btnAddNewContract');
          console.log('ğŸ” Ø§Ù„Ø²Ø± btnAddNewContract:', addContractBtn);
          if (addContractBtn) {
            // Ø§Ù„Ø²Ø± Ù„Ù‡ onclick="openNewContractModal()" ÙÙŠ HTML
            console.log('âœ… Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø±Ø¨ÙˆØ· Ù…Ù† Ø®Ù„Ø§Ù„ onclick ÙÙŠ HTML');
          } else {
            console.error('âŒ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©!');
          }
        } catch(e) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯:', e);
        }

        // ========== ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… - Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù…Ù†ÙØµÙ„ ==========

        console.log('ğŸ‰ Ø§Ù†ØªÙ‡Ù‰ Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        
        await fetchContractor();
        await fetchContracts(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        await fetchWorks(); // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        await fetchExtracts();
        await fetchDeductions();
        
        // Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        calculateAndUpdateTotalWorks();
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        await calculateAndDisplaySummary();
        
        // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await calculateAndDisplaySummary();

      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©:', error);
      }
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    initializeContractorPage();
  </script>
  <script>
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ù…Ù† Ø§Ù„Ù†Øµ
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        // Ø¬Ù…Ø¹ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª
        const scripts = tempDiv.querySelectorAll('script');
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ù…Ù† Ø§Ù„Ù€ html Ù‚Ø¨Ù„ ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        scripts.forEach(s => s.parentNode.removeChild(s));
        // ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© -->
  <div id="editSignedWorksModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;z-index:1000;justify-content:center;align-items:center;">
    <div style="background:white;padding:30px;border-radius:10px;width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="text-align:center;color:#2e8ca3;margin-bottom:20px;">ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø©</h3>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„:</label>
        <input type="number" id="signedWorksValueInput" 
               style="width:100%;padding:10px;border:2px solid #2e8ca3;border-radius:5px;font-size:1rem;text-align:center;" 
               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„"
               onkeypress="if(event.key==='Enter') saveSignedWorksValue()">
      </div>
      
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="saveSignedWorksValue()" 
                style="background:#2e8ca3;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-weight:bold;">
          Ø­ÙØ¸
        </button>
        <button onclick="closeSignedWorksModal()" 
                style="background:#ccc;color:#333;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">
          Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ - Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© ==================== -->
  <script>
    function openNewContractModal() {
      console.log('ğŸ¯ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
      const modal = document.getElementById('newContractModal');
      if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„');
      } else {
        console.error('âŒ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
        alert('Ø®Ø·Ø£: Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
      }
    }

    function closeNewContractModal() {
      console.log('âŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„');
      const modal = document.getElementById('newContractModal');
      const form = document.getElementById('newContractForm');
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
      }
      if (form) {
        form.reset();
      }
    }
  </script>

  <!-- ==================== ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ÙÙŠ Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø© ==================== -->
  <script>
    (function() {
      console.log('ğŸš€ğŸš€ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
      
      // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initContractSystem);
      } else {
        // Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„
        initContractSystem();
      }
      
      function initContractSystem() {
        console.log('âœ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
        
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
        setTimeout(function() {
          const modal = document.getElementById('newContractModal');
          const form = document.getElementById('newContractForm');
          
          console.log('ğŸ” Ø§Ù„Ù…ÙˆØ¯Ø§Ù„:', modal);
          console.log('ğŸ” Ø§Ù„ÙÙˆØ±Ù…:', form);
          
          if (!modal) {
            console.error('âŒ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
          }
          if (!form) {
            console.error('âŒ Ø§Ù„ÙÙˆØ±Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
          }
          
          const cancelBtn = modal.querySelector('.btn-cancel');
          
          // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
              e.preventDefault();
              closeNewContractModal();
            });
          }
          
          // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              closeNewContractModal();
            }
          });
          
          // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù…
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯...');
            
            const formData = new FormData(form);
            
            try {
              const contractorId = new URL(window.location.href).searchParams.get('id');
              const response = await fetch(`/contractors/${contractorId}/contracts`, {
                method: 'POST',
                body: formData
              });
              
              if (response.ok) {
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                  const result = await response.json();
                  console.log('âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­ÙØ¸:', result);
                }
                
                alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                closeNewContractModal();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯
                if (typeof fetchContracts === 'function') {
                  fetchContracts();
                } else {
                  // Reload page if function not available
                  window.location.reload();
                }
              } else {
                const text = await response.text();
                let errorMsg = 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                try {
                  const error = JSON.parse(text);
                  errorMsg = error.error || error.message || text;
                } catch (e) {
                  errorMsg = text || `Ø®Ø·Ø£ ${response.status}`;
                }
                alert('âŒ Ø®Ø·Ø£: ' + errorMsg);
              }
            } catch (err) {
              console.error('âŒ Ø®Ø·Ø£:', err);
              alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
            }
          });
          
          console.log('âœ…âœ…âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø¬Ø§Ù‡Ø² ÙˆÙŠØ¹Ù…Ù„!');
        }, 500);
      }
    })();
  </script>
  <!-- ==================== Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ==================== -->

</body>
</html>