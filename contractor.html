<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>بيانات المقاول</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="permissions-check.js"></script>
  <!-- مكتبة SheetJS لتصدير الإكسل -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      direction: rtl;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: #c5d6db;
      margin: 0;
      direction: rtl;
    }
    
    /* تطبيق خط Cairo على جميع العناصر */
    * {
      font-family: 'Cairo', Arial, sans-serif !important;
    }
    .navbar {
      background: #1a3b50;
      color: #fff;
      font-size: 1.18rem;
      font-weight: bold;
      box-shadow: 0 2px 12px #0002;
      letter-spacing: 1px;
      min-height: 58px;
      padding: 0 24px;
      border-bottom: 3px solid #2e8ca3;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .navbar .nav-btn {
      background: #fff;
      color: #2e8ca3;
      border: 2px solid #2e8ca3;
      font-size: 1.08rem;
      font-weight: bold;
      cursor: pointer;
      padding: 7px 18px;
      border-radius: 0px;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: 0 2px 10px #0001;
      margin-left: 10px;
      font-family: 'Cairo', Arial, sans-serif;
      letter-spacing: 0.5px;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .navbar .nav-btn:hover {
      background: #1a3b50;
      color: #fff;
      border-color: #2e8ca3;
    }
    .container {
      max-width: 1400px; /* تم التوسيع أكثر */
      margin: 32px auto 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 0 24px #0002;
      padding: 38px 38px 28px 38px;
      border: 2px solid #8c969a;
      position: relative;
    }
    h2 {
      text-align: center;
      margin-bottom: 32px;
      color: #2e8ca3;
      letter-spacing: 1px;
      font-size: 1.35rem;
      font-weight: bold;
      border-bottom: 2px solid #7a5230;
      padding-bottom: 12px;
    }
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }
    .info-table th, .info-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #c5d6db;
      font-size: 1.05rem;
      text-align: right;
    }
    .info-table th {
      background: #e8f5e9;
      color: #2e8ca3;
      width: 160px;
      font-weight: bold;
    }
    .info-table td {
      background: #f7fafd;
      color: #333;
    }
    .back-btn {
      display: inline-block;
      margin: 0 0 18px 0;
      color: #2e8ca3;
      background: #fff;
      border: 2px solid #2e8ca3;
      border-radius: 0px;
      padding: 7px 18px;
      font-weight: bold;
      font-size: 1.08rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .back-btn:hover {
      background: #1a3b50;
      color: #fff;
      border-color: #2e8ca3;
    }
    .section-title {
      color: #7a5230;
      font-size: 1.08rem;
      font-weight: bold;
      margin: 18px 0 8px 0;
      border-bottom: 1px solid #c5d6db;
      padding-bottom: 4px;
    }
    .extracts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .extracts-table th, .extracts-table td {
      padding: 4px 3px;
      border-bottom: 1px solid #c5d6db;
      text-align: right;
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .extracts-table th {
      background: #2e8ca3;
      color: #fff;
      font-weight: bold;
    }
    .extracts-table tr:hover td {
      background: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    .deductions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .deductions-table th, .deductions-table td {
      padding: 4px 3px;
      border-bottom: 1px solid #c5d6db;
      text-align: right;
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .deductions-table th {
      background: #388e3c;
      color: #fff;
      font-weight: bold;
    }
    .deductions-table tr:hover td {
      background: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    .no-data {
      text-align: center;
      color: #888;
      margin: 18px 0;
      font-size: 1.05rem;
    }
    .tables-flex-row {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .table-container {
      flex: 1 1 0;
      min-width: 340px;
      max-width: 100%;
    }
    /* أزرار التبديل بين الجداول */
    .container button#showSummaryBtn,
    .container button#showContractsBtn,
    .container button#showWorksBtn,
    .container button#showExtractsBtn,
    .container button#showDeductionsBtn,
    .container button#showMaterialsBtn {
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 0.93rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: #2e8ca3;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 3px 10px;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 60px;
      height: 28px;
      line-height: 1.2;
    }
    .container button#showSummaryBtn:hover,
    .container button#showContractsBtn:hover,
    .container button#showWorksBtn:hover,
    .container button#showExtractsBtn:hover,
    .container button#showDeductionsBtn:hover,
    .container button#showMaterialsBtn:hover {
      background: #1a3b50;
    }
    
    /* شرائط المباني القابلة للطي */
    .building-header {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold !important;
      cursor: pointer !important;
      user-select: none !important;
      transition: background-color 0.3s ease !important;
    }
    
    .building-header:hover {
      background: #e3f2fd !important; /* خلفية فاتحة */
      color: #000 !important; /* نص أسود واضح */
    }
    
    .building-header td {
      padding: 8px 4px !important;
      font-size: 0.9rem !important;
      text-align: center !important;
    }
    
    .building-works {
      display: none; /* مخفية افتراضياً */
    }
    
    .building-works.visible {
      display: table-row; /* تظهر عند إضافة كلاس visible */
    }
    
    .building-arrow {
      margin-left: 8px;
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    
    .building-arrow.expanded {
      transform: rotate(90deg);
    }
    
    /* أنماط جدول سحب الأعمال */
    #currentWorksListForPull table {
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    #currentWorksListForPull table th {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    
    #currentWorksListForPull table td {
      padding: 6px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 0.85rem;
    }
    
    #currentWorksListForPull table tr:hover {
      background-color: #f0f8ff !important;
    }
    
    #currentWorksListForPull table tbody tr[style*="background-color: rgb(232, 245, 233)"] {
      background-color: #e8f5e9 !important;
    }
    
    #currentWorksListForPull table tbody tr[style*="background-color: rgb(232, 245, 233)"]:hover {
      background-color: #d4edda !important;
    }
    
    /* أنماط للأعمال المسحوبة */
    .pulled-work {
      background-color: #ffebee !important;
      opacity: 0.8;
      position: relative;
    }
    
    .pulled-work td {
      background-color: #ffebee !important;
      position: relative;
    }
    
    .pulled-work:hover td {
      background-color: #ffcdd2 !important;
    }
    
    .pulled-label {
      background: #f44336;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-bottom: 3px;
      display: inline-block;
    }
    
    .pulled-info {
      font-size: 0.75rem;
      color: #d32f2f;
      font-style: italic;
      margin-top: 2px;
    }
    
    /* تحسين عرض المعلومات المسحوبة */
    .pulled-work-info {
      background: #f44336;
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      margin-bottom: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-block;
    }
    
    .pulled-work-description {
      color: #d32f2f;
      font-size: 0.9rem;
      margin-top: 3px;
    }
    
    /* تقليل ارتفاع صفوف جدول الأعمال */
    #worksBody tr {
      height: auto;
    }
    
    #worksBody td {
      padding: 3px 4px !important;
      font-size: 0.85rem !important;
      line-height: 1.1 !important;
      vertical-align: middle;
    }
    
    #worksBody th {
      padding: 6px 4px !important;
      font-size: 0.9rem !important;
    }
    
    /* تحسين عرض الأزرار في الجدول */
    #worksBody button {
      padding: 2px 6px !important;
      font-size: 10px !important;
      margin: 1px !important;
    }
    
    /* تأثير hover للصفوف */
    #worksBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* تأثير hover للصفوف المسحوبة */
    #worksBody tr.pulled-work:hover {
      background-color: #ffcdd2 !important;
    }
    
    /* تأثير hover للأعمال اليدوية */
    #worksBody tr[style*="background-color: rgb(232, 245, 233)"]:hover,
    #worksBody tr[style*="background-color:#e8f5e9"]:hover {
      background-color: #c8e6c9 !important;
    }
    
    /* تأثير hover لشرائط المباني */
    .building-header:hover {
      background: #e3f2fd !important; /* خلفية فاتحة */
      color: #000 !important; /* نص أسود واضح */
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* تأثير hover لجدول العقود */
    #contractsBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* تأثير hover لجدول المواد */
    #materialsBody tr:hover {
      background-color: #e3f2fd !important;
      cursor: pointer;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* تأثير hover عام لكل الجداول */
    table tbody tr {
      transition: all 0.2s ease;
    }
    
    table tbody tr:hover {
      box-shadow: 0 2px 8px rgba(46, 140, 163, 0.2);
    }
    
    /* تحسين شكل الأزرار عند hover */
    button:hover {
      transform: scale(1.05);
      transition: transform 0.1s ease;
    }
    
    /* أنماط الملخص */
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #2e8ca3;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .summary-label {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }
    
    .summary-value {
      font-weight: bold;
      color: #2e8ca3;
      font-size: 1rem;
    }
    
    @media (max-width: 700px) {
      .container { padding: 10px; }
      h2 { font-size: 1.1rem; }
      .info-table th, .info-table td, .extracts-table th, .extracts-table td { font-size: 0.95rem; }
      
      /* تحسين الملخص على الجوال */
      #summaryContainer > div {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div class="container">
    <!-- تفاصيل المقاول في سطر واحد -->
    <div id="contractorDetailsRow" style="display:flex;gap:24px;align-items:center;justify-content:center;margin-bottom:18px;background:#e8f5e9;border-radius:10px;padding:12px 8px;">
      <div><span style="color:#2e8ca3;font-weight:bold;">اسم المقاول:</span> <span id="name"></span></div>
      <div><span style="color:#2e8ca3;font-weight:bold;">الجوال:</span> <span id="phone"></span></div>
      <div><span style="color:#2e8ca3;font-weight:bold;">البند:</span> <span id="workItem"></span></div>
    </div>
    <!-- الأزرار تحت التفاصيل -->
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:18px;">
      <button id="showSummaryBtn" style="background:#388e3c;" data-permission="contractors-view">الملخص</button>
      <button id="showContractsBtn" style="background:#2e8ca3;" data-permission="contractors-view">العقود</button>
      <button id="showWorksBtn" data-permission="contractors-view">الأعمال</button>
      <button id="showExtractsBtn" data-permission="contractors-view">المستخلصات</button>
      <button id="showDeductionsBtn" data-permission="contractors-view">الخصومات</button>
      <button id="showMaterialsBtn" data-permission="contractors-view">المواد</button>
      <button id="showReceiptsBtn" style="background:#f59e0b;" data-permission="vouchers-view-contractor">السندات</button>
    </div>
    <div class="tables-flex-row">
      <!-- قسم الملخص -->
      <div class="table-container" id="summaryContainer" style="display:none;">
        <div class="section-title">ملخص المقاول</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px;background:#f8f9fa;border-radius:8px;">
          <!-- العمود الأول -->
          <div style="display:flex;flex-direction:column;gap:15px;">
            <div class="summary-item">
              <span class="summary-label">إجمالي قيمة العقد الموقع:</span>
              <span class="summary-value" id="totalContractValue">0 ريال</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">إجمالي قيمة الأعمال الموقعة بالعقد:</span>
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="summary-value" id="totalSignedWorksValueDisplay">0 ريال</span>
                <button id="editSignedWorksBtn" onclick="editSignedWorksValue()" 
                        style="background:#2e8ca3;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:0.8rem;"
                        data-permission="contractors-edit">
                  ✏️ تعديل
                </button>
              </div>
            </div>
            <div class="summary-item">
              <span class="summary-label">إجمالي قيمة الأعمال المسجلة:</span>
              <span class="summary-value" id="totalRegisteredWorksValue">0 ريال</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">إجمالي قيمة الأعمال المسحوبة:</span>
              <span class="summary-value" id="totalPulledWorksValue">0 ريال</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">الإجمالي النهائي للأعمال:</span>
              <span class="summary-value" id="totalFinalWorksValue">0 ريال</span>
            </div>
          </div>
          
          <!-- العمود الثاني -->
          <div style="display:flex;flex-direction:column;gap:15px;">
            <div class="summary-item">
              <span class="summary-label">نسبة إنجاز المقاول:</span>
              <span class="summary-value" id="completionPercentage">0%</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">قيمة المستخلصات:</span>
              <span class="summary-value" id="totalExtractsValue">0 ريال</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">قيمة الخصومات:</span>
              <span class="summary-value" id="totalDeductionsValue">0 ريال</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">قيمة سحب المواد:</span>
              <span class="summary-value" id="totalMaterialsValue">0 ريال</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-container" id="contractsContainer">
        <div class="section-title">
          عقود المقاول
          <!-- زر إضافة عقد - جديد تماماً مع onclick مباشر -->
          <button id="btnAddNewContract" onclick="openNewContractModal()" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:8px 16px; font-size:0.9rem; margin-right:10px; cursor:pointer; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
            <span style="font-size:1.2rem;">+</span> إضافة عقد جديد
          </button>
          <!-- زر تصدير إكسل العقود -->
          <button id="exportContractsExcelBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;">تصدير إكسل</button>
        </div>
        <table class="extracts-table" id="contractsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>رقم العقد</th>
              <th>تاريخ العقد</th>
              <th>نوع العقد</th>
              <th>بند الأعمال</th>
              <th>قيمة العقد</th>
              <th>مدة التنفيذ</th>
              <th>ملف العقد</th>
              <th>ملاحظات</th>
              <th>التحكم</th>
            </tr>
          </thead>
          <tbody id="contractsBody">
            <tr><td colspan="10" class="no-data">جاري التحميل...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="worksContainer" style="display:none;">
        <div class="section-title">
          أعمال المقاول
          <!-- زر الترتيب حسب المبنى -->
          <button id="sortByBuildingBtn" style="background:#2e8ca3; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:10px; cursor:pointer;">ترتيب حسب المبنى</button>
          <button id="showAllWorksBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer; display:none;">عرض الكل</button>
          <!-- زر سحب أعمال -->
          <button id="pullWorksBtn" style="background:#f44336; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;" data-permission="contractors-edit">سحب أعمال لمقاول آخر</button>

          <!-- زر تصدير إكسل -->
          <button id="exportExcelBtn" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:0.8rem; margin-right:5px; cursor:pointer;" data-permission="contractors-export">تصدير إكسل</button>
        </div>
        <table class="extracts-table" id="worksTable">
          <thead>
            <tr>
              <th>م</th>
              <th>المبنى</th>
              <th>بند الأعمال</th>
              <th>بيان الأعمال</th>
              <th>الكمية</th>
              <th>الوحدة</th>
              <th>الفئة</th>
              <th>النسبة %</th>
              <th>الإجمالي $</th>
              <th>الحالة</th>
              <th>التحكم</th>
            </tr>
          </thead>
          <tbody id="worksBody">
            <tr><td colspan="11" class="no-data">جاري التحميل...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="extractsContainer" style="display:none;">
        <div class="section-title">المستخلصات المرتبطة بهذا المقاول</div>
        <table class="extracts-table" id="extractsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>رقم المستخلص</th>
              <th>تاريخ المستخلص</th>
              <th>قيمة المستخلص</th>
              <th>عرض</th>
            </tr>
          </thead>
          <tbody id="extractsBody">
            <tr><td colspan="5" class="no-data">جاري التحميل...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="deductionsContainer" style="display:none;">
        <div class="section-title">الخصومات الخاصة بهذا المقاول</div>
        <table class="deductions-table" id="deductionsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>بيان الخصم</th>
              <th>التاريخ</th>
              <th>الكمية</th>
              <th>الفئة</th>
              <th>الإجمالي</th>
              <th>اسم المستخدم</th>
              <th>المستخلص</th>
            </tr>
          </thead>
          <tbody id="deductionsBody">
            <tr><td colspan="8" class="no-data">جاري التحميل...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="table-container" id="materialsContainer" style="display:none;">
        <div class="section-title">المواد المصروفة لهذا المقاول</div>
        <table class="extracts-table" id="contractorMaterialsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>اسم المادة</th>
              <th>الكمية</th>
              <th>الفئة</th>
              <th>تاريخ الصرف</th>
              <th>اسم المستخدم</th>
              <th>تم الخصم في مستخلص</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="materialsBody">
            <tr><td colspan="7" class="no-data">جاري التحميل...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- قسم السندات -->
      <div class="table-container" id="receiptsContainer" style="display:none;">
        <div class="section-title">السندات المرتبطة بهذا المقاول</div>
        <table class="extracts-table" id="contractorReceiptsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>رقم السند</th>
              <th>التاريخ</th>
              <th>المستلم</th>
              <th>البيان</th>
              <th>المبلغ</th>
              <th>المبلغ بالحروف</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody id="receiptsBody">
            <tr><td colspan="8" class="no-data">لا توجد سندات</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- مودال سحب الأعمال -->
  <div id="pullWorksModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:30px; border-radius:12px; max-width:1200px; width:95%; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="text-align:center; color:#f44336; margin-bottom:20px; font-size:1.2rem; font-weight:bold; border-bottom:2px solid #f44336; padding-bottom:10px;">سحب أعمال إلى مقاول آخر</h3>
      
      <!-- خطوة 1: اختيار الأعمال من المقاول الحالي -->
      <div id="step1" style="margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">الخطوة 1: اختر الأعمال المراد سحبها من المقاول الحالي</h4>
        <div style="background:#f5f5f5; padding:10px; border-radius:4px; margin-bottom:10px; max-height:400px; overflow-y:auto;">
          <div style="margin-bottom:10px;">
            <label style="font-weight:bold;">
              <input type="checkbox" id="selectAllWorks" style="margin-left:5px;"> تحديد الكل
            </label>
          </div>
          <div id="currentWorksListForPull"></div>
        </div>
        <button id="proceedToStep2Btn" style="background:#388e3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:1rem;" disabled>المتابعة لاختيار المقاول الهدف</button>
      </div>

      <!-- خطوة 2: اختيار المقاول الهدف -->
      <div id="step2" style="display:none; margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">الخطوة 2: اختر المقاول الهدف</h4>
        <select id="targetContractorSelect" style="width:100%; padding:10px; border:1px solid #c5d6db; border-radius:4px; font-size:1rem; margin-bottom:15px;">
          <option value="">اختر المقاول الهدف...</option>
        </select>
        <button id="proceedToStep3Btn" style="background:#388e3c; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:1rem;" disabled>المتابعة للتأكيد</button>
      </div>

      <!-- خطوة 3: تأكيد السحب -->
      <div id="step3" style="display:none; margin-bottom:20px;">
        <h4 style="color:#2e8ca3; margin-bottom:10px;">الخطوة 3: تأكيد سحب الأعمال</h4>
        <div style="background:#e8f5e9; padding:15px; border-radius:4px; margin-bottom:15px;">
          <p><strong>المقاول المصدر:</strong> <span id="sourceContractorName"></span></p>
          <p><strong>المقاول الهدف:</strong> <span id="targetContractorName"></span></p>
          <p><strong>عدد الأعمال المختارة:</strong> <span id="selectedWorksCount"></span></p>
        </div>
        <div style="background:#fff3cd; padding:10px; border-radius:4px; border-left:4px solid #ffc107; margin-bottom:15px;">
          <p style="margin:0; color:#856404;"><strong>تحذير:</strong> سيتم نقل الأعمال المختارة من المقاول الحالي إلى المقاول المختار مع الاحتفاظ بعلامة تدل على المصدر الأصلي.</p>
        </div>
        <button id="confirmPullBtn" style="background:#f44336; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-size:1rem; font-weight:bold;">تأكيد سحب الأعمال</button>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button id="cancelPullBtn" style="background:#6c757d; color:#fff; border:none; padding:10px 20px; border-radius:4px; font-size:1rem; cursor:pointer;">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- ========== مودال إضافة عقد - جديد وبسيط ========== -->
  <div id="newContractModal" class="contract-modal-overlay">
    <div class="contract-modal-content">
      <h3 class="contract-modal-title">إضافة عقد جديد</h3>
      
      <form id="newContractForm" enctype="multipart/form-data">
        <div class="form-row">
          <div class="form-group">
            <label>رقم العقد:</label>
            <input type="text" name="contractNumber" required>
          </div>
          <div class="form-group">
            <label>تاريخ العقد:</label>
            <input type="date" name="contractDate" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>نوع العقد:</label>
            <select name="contractType" required>
              <option value="">اختر النوع</option>
              <option value="تنفيذ أعمال">تنفيذ أعمال</option>
              <option value="توريد">توريد</option>
              <option value="صيانة">صيانة</option>
            </select>
          </div>
          <div class="form-group">
            <label>بند الأعمال:</label>
            <input type="text" name="workItem" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>قيمة العقد:</label>
            <input type="number" name="contractValue" step="0.01" required>
          </div>
          <div class="form-group">
            <label>مدة التنفيذ (يوم):</label>
            <input type="number" name="executionDuration" min="1">
          </div>
        </div>
        
        <div class="form-group">
          <label>ملف العقد (PDF):</label>
          <input type="file" name="contractFile" accept=".pdf">
        </div>
        
        <div class="form-group">
          <label>ملاحظات:</label>
          <textarea name="notes" rows="3"></textarea>
        </div>
        
        <div class="modal-buttons">
          <button type="submit" class="btn-submit">حفظ</button>
          <button type="button" class="btn-cancel">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .contract-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .contract-modal-overlay.active {
      display: flex;
    }
    
    .contract-modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .contract-modal-title {
      text-align: center;
      color: #2e8ca3;
      margin-bottom: 20px;
      font-size: 1.3rem;
      border-bottom: 2px solid #2e8ca3;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #2e8ca3;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: 'Cairo', Arial, sans-serif;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2e8ca3;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn-submit {
      background: #2e8ca3;
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .btn-submit:hover {
      background: #1a7a8f;
    }
    
    .btn-cancel {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .btn-cancel:hover {
      background: #5a6268;
    }
  </style>

  <script>
    // Check permissions before loading page
    window.checkPagePermission('contractors');
    
    // ==================== كود المودال الجديد - بسيط ومباشر ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('✅ تحميل نظام العقود الجديد...');
      
      const modal = document.getElementById('newContractModal');
      const form = document.getElementById('newContractForm');
      const addBtn = document.getElementById('btnAddNewContract');
      
      console.log('🔍 الزر:', addBtn);
      console.log('🔍 المودال:', modal);
      console.log('🔍 الفورم:', form);
      
      if (!modal || !form) {
        console.error('❌ أحد العناصر مفقود!', {modal, form, addBtn});
        return;
      }
      
      const cancelBtn = modal.querySelector('.btn-cancel');
      
      // فتح المودال (الزر له onclick="openNewContractModal()" في HTML)
      // لكن سنضيف event listener احتياطي
      if (addBtn) {
        addBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('🎯 تم الضغط على زر إضافة عقد!');
          modal.classList.add('active');
          console.log('✅ تم إضافة class active للمودال');
        });
      }
      
      // إغلاق المودال
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('❌ إغلاق المودال');
          modal.classList.remove('active');
          form.reset();
        });
      }
      
      // إغلاق عند الضغط خارج المودال
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
          form.reset();
        }
      });
      
      // إرسال الفورم
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('📤 إرسال بيانات العقد...');
        
        const formData = new FormData(form);
        
        try {
          const contractorId = new URL(window.location.href).searchParams.get('id');
          const response = await fetch(`/contractors/${contractorId}/contracts`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            alert('✅ تم إضافة العقد بنجاح!');
            modal.classList.remove('active');
            form.reset();
            
            // إعادة تحميل العقود
            if (typeof fetchContracts === 'function') {
              fetchContracts();
            }
          } else {
            const error = await response.text();
            alert('❌ خطأ: ' + error);
          }
        } catch (err) {
          console.error('❌ خطأ:', err);
          alert('حدث خطأ في الاتصال بالسيرفر');
        }
      });
      
      console.log('✅ نظام العقود جاهز!');
    });
    // ==================== نهاية كود المودال ====================
  </script>



  <script>
    // ==================== تم حذف الكود القديم - الكود الجديد موجود مع المودال ====================

    // دالة لإنشاء ObjectId بسيط (للواجهة الأمامية فقط)
    function generateObjectId() {
      return Math.floor(Date.now() / 1000).toString(16) + 
             Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
    }

    // استخراج id من الرابط
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const contractorId = getQueryParam('id');
    if (!contractorId) {
      document.body.innerHTML = '<div style="text-align:center;margin-top:60px;color:#c00;font-size:1.2rem;">لم يتم تحديد المقاول بشكل صحيح.</div>';
      throw new Error('Contractor id not found');
    }

    // دالة حساب وتحديث إجمالي قيمة الأعمال
    function calculateAndUpdateTotalWorks() {
      let totalWorks = 0;
      
      // حساب من أعمال المستخلص
      if (originalWorksData && originalWorksData.length > 0) {
        originalWorksData.forEach(item => {
          if (!item.isSeparator && !item.isPulled) { // استبعاد الفواصل والأعمال المسحوبة
            const quantity = parseFloat(item.quantity) || 0;
            const category = parseFloat(item.category) || 0;
            totalWorks += quantity * category;
          }
        });
      }
      
      console.log('💰 تم حساب إجمالي قيمة الأعمال:', totalWorks);
      return totalWorks;
    }

    // جلب بيانات المقاول (مع المواد)
    async function fetchContractor() {
      try {
        const res = await fetch(`/contractors/${contractorId}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await res.text();
          console.error('Response is not JSON:', text);
          throw new Error('Response is not JSON');
        }
        
        const c = await res.json();
        document.getElementById('name').textContent = c.name || '';
        document.getElementById('phone').textContent = c.phone || '';
        document.getElementById('workItem').textContent = c.workItem || '';
        // اعتمد فقط على c.materials (مصفوفة)
        renderMaterialsTable(Array.isArray(c.materials) ? c.materials : []);
      } catch (error) {
        console.error('Error fetching contractor:', error);
        document.body.innerHTML = '<div style="text-align:center;margin-top:60px;color:#c00;font-size:1.2rem;">تعذر تحميل بيانات المقاول.</div>';
      }
    }

    // عرض جدول المواد
    function renderMaterialsTable(materials) {
      const tbody = document.getElementById('materialsBody');
      if (!Array.isArray(materials) || !materials.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">لا يوجد مواد لهذا المقاول.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      materials.forEach((mat, i) => {
        const name = mat.name || mat.item || '';
        const quantity = mat.quantity !== undefined ? mat.quantity : '';
        const unitPrice = mat.unitPrice !== undefined ? mat.unitPrice : '';
        const date = mat.date ? new Date(mat.date).toLocaleDateString('ar-EG') : '';
        const username = mat.userName || mat.user || mat.username || '';
        const extractNumber = mat.deductedInExtractNumber || '';
        const extractId = mat.deductedInExtractId || mat.extractId || '';
        let deductedCell = '';
        if (extractNumber) {
          if (extractId) {
            deductedCell = `<a href="extract.html?id=${extractId}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;" data-field="deducted">${extractNumber}</a>`;
          } else {
            deductedCell = `<span data-field="deducted">${extractNumber}</span>`;
          }
        } else {
          deductedCell = `<span data-field="deducted"></span>`;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td data-field="name">${name}</td>
          <td>${quantity}</td>
          <td>${unitPrice}</td>
          <td data-field="date">${date}</td>
          <td>${username}</td>
          <td>${deductedCell}</td>
          <td data-field="delete"></td>
        `;
        // زر الحذف
        const deleteTd = tr.querySelector('[data-field="delete"]');
        if (extractNumber) {
          deleteTd.innerHTML = '<span style="color:#e53935;font-weight:bold;">مخصومة</span>';
        } else {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'حذف';
          delBtn.style.background = '#e53935';
          delBtn.style.color = '#fff';
          delBtn.style.border = 'none';
          delBtn.style.borderRadius = '5px';
          delBtn.style.padding = '4px 10px';
          delBtn.style.cursor = 'pointer';
          delBtn.onclick = async function() {
            if (!confirm('هل تريد حذف هذه المادة؟')) return;
            // حذف المادة من المقاول في قاعدة البيانات باستخدام الفهرس
            try {
              const contractorId = getQueryParam('id');
              const res = await fetch(`/contractors/${contractorId}/materials/${i}`, { method: 'DELETE' });
              if (res.ok) {
                // إعادة المادة للمخزن
                await fetch(`/materials/restore/dummy`, { method: 'POST', 
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(mat)
                });
                alert('تم حذف المادة وإعادتها للمخزن بنجاح.');
                // إعادة تحميل بيانات المقاول من السيرفر
                fetchContractor();
              } else {
                alert('حدث خطأ أثناء حذف المادة من المقاول.');
              }
            } catch {
              alert('حدث خطأ في الاتصال بالسيرفر.');
            }
          };
          deleteTd.appendChild(delBtn);
        }
        tbody.appendChild(tr);
      });
    }

    // متغير لحفظ بيانات العقود
    let contractsData = [];

    // جلب العقود للمقاول
    async function fetchContracts() {
      const tbody = document.getElementById('contractsBody');
      if (!tbody) return;
      
      try {
        // جلب العقود من بيانات المقاول
        const res = await fetch(`/contractors/${contractorId}`);
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">تعذر تحميل العقود.</td></tr>`;
          return;
        }
        
        const contractor = await res.json();
        contractsData = contractor.contracts || [];
        
        if (!contractsData.length) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">لا يوجد عقود لهذا المقاول.</td></tr>`;
          return;
        }
        
        renderContractsTable();
        
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">حدث خطأ أثناء تحميل العقود.</td></tr>`;
      }
    }

    // عرض جدول العقود
    function renderContractsTable() {
      const tbody = document.getElementById('contractsBody');
      tbody.innerHTML = '';
      
      contractsData.forEach((contract, index) => {
        // إعداد عمود ملف PDF
        let pdfCell = '';
        if (contract.contractFileName) {
          pdfCell = `<a href="/contracts/${contract.contractFileName}" target="_blank" style="color:#2e8ca3; font-weight:bold; text-decoration:underline;" title="عرض ملف العقد">📄 عرض</a>`;
        } else {
          pdfCell = '<span style="color:#888;">لا يوجد</span>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${contract.contractNumber || ''}</td>
          <td>${contract.contractDate ? new Date(contract.contractDate).toLocaleDateString('ar-EG') : ''}</td>
          <td>${contract.contractType || ''}</td>
          <td>${contract.workItem || ''}</td>
          <td>${contract.contractValue ? parseFloat(contract.contractValue).toLocaleString('en-US') : ''}</td>
          <td>${contract.executionDuration ? contract.executionDuration + ' يوم' : ''}</td>
          <td>${pdfCell}</td>
          <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis;" title="${contract.notes || ''}">${contract.notes || ''}</td>
          <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
            <button onclick="editContract(${index})" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="تعديل العقد">✏️</button>
            <button onclick="deleteContract(${index})" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="حذف العقد">✖</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // دالة حذف العقد
    async function deleteContract(index) {
      if (index < 0 || index >= contractsData.length) return;
      
      if (confirm('هل أنت متأكد من حذف هذا العقد؟')) {
        try {
          // حذف من المصفوفة المحلية
          contractsData.splice(index, 1);
          
          // حفظ في السيرفر
          const response = await fetch(`/contractors/${contractorId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ contracts: contractsData })
          });
          
          if (response.ok) {
            // إعادة عرض الجدول
            renderContractsTable();
            alert('تم حذف العقد بنجاح!');
          } else {
            alert('حدث خطأ أثناء حذف العقد');
          }
        } catch (error) {
          console.error('خطأ في حذف العقد:', error);
          alert('حدث خطأ أثناء حذف العقد');
        }
      }
    }

    // دالة تعديل العقد
    function editContract(index) {
      if (index < 0 || index >= contractsData.length) return;
      
      const contract = contractsData[index];
      
      // ملء الحقول في المودال
      document.querySelector('#addContractForm input[name="contractNumber"]').value = contract.contractNumber || '';
      document.querySelector('#addContractForm input[name="contractDate"]').value = contract.contractDate ? contract.contractDate.split('T')[0] : '';
      document.querySelector('#addContractForm select[name="contractType"]').value = contract.contractType || '';
      document.querySelector('#addContractForm input[name="workItem"]').value = contract.workItem || '';
      document.querySelector('#addContractForm input[name="contractValue"]').value = contract.contractValue || '';
      document.querySelector('#addContractForm input[name="executionDuration"]').value = contract.executionDuration || '';
      document.querySelector('#addContractForm textarea[name="notes"]').value = contract.notes || '';
      
      // تغيير عنوان المودال وزر الحفظ
      document.querySelector('#addContractModal h3').textContent = 'تعديل العقد';
      document.querySelector('#addContractForm button[type="submit"]').textContent = 'حفظ التعديل';
      
      // حفظ الفهرس للتعديل
      document.getElementById('addContractForm').dataset.editIndex = index;
      
      // إظهار المودال
      document.getElementById('addContractModal').style.display = 'flex';
    }

    // دالة تصدير إكسل للعقود
    function exportContractsToExcel() {
      if (!contractsData || contractsData.length === 0) {
        alert('لا توجد بيانات عقود لتصديرها!');
        return;
      }

      const contractorName = document.getElementById('name').textContent || 'غير محدد';
      
      // تحضير البيانات
      const contractsDataForExport = [];
      
      // إضافة العناوين
      contractsDataForExport.push([
        'م',
        'رقم العقد',
        'تاريخ العقد',
        'نوع العقد',
        'بند الأعمال',
        'قيمة العقد',
        'مدة التنفيذ (يوم)',
        'ملاحظات'
      ]);

      // إضافة البيانات
      contractsData.forEach((contract, index) => {
        contractsDataForExport.push([
          index + 1,
          contract.contractNumber || '',
          contract.contractDate ? new Date(contract.contractDate).toLocaleDateString('ar-EG') : '',
          contract.contractType || '',
          contract.workItem || '',
          contract.contractValue ? parseFloat(contract.contractValue).toLocaleString('en-US') : '',
          contract.executionDuration || '',
          contract.notes || ''
        ]);
      });

      // إنشاء ملف الإكسل
      const worksheet = XLSX.utils.aoa_to_sheet(contractsDataForExport);
      
      // تنسيق العناوين
      const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
      for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[cellAddress]) continue;
        worksheet[cellAddress].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "2e8ca3" } },
          alignment: { horizontal: "center" }
        };
      }
      
      // تعديل عرض الأعمدة
      worksheet['!cols'] = [
        { width: 5 },   // م
        { width: 15 },  // رقم العقد
        { width: 12 },  // تاريخ العقد
        { width: 15 },  // نوع العقد
        { width: 20 },  // بند الأعمال
        { width: 15 },  // قيمة العقد
        { width: 12 },  // مدة التنفيذ
        { width: 30 }   // ملاحظات
      ];

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'عقود المقاول');
      
      // تحديد اسم الملف
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const fileName = `عقود_${contractorName}_${dateStr}.xlsx`;
      
      // تصدير الملف
      XLSX.writeFile(workbook, fileName);
    }

    // دالة حساب وعرض الملخص
    async function calculateAndDisplaySummary() {
      try {
        console.log('🔄 بدء حساب الملخص...');
        console.log('🆔 معرف المقاول:', contractorId);
        
        // 1. إجمالي قيمة العقد الموقع
        let totalContractValue = 0;
        console.log('📊 بيانات العقود المتاحة:', contractsData);
        contractsData.forEach(contract => {
          const contractValue = parseFloat(contract.contractValue) || 0;
          totalContractValue += contractValue;
          console.log(`📋 عقد: ${contract.contractNumber || 'غير محدد'} - قيمة: ${contractValue}`);
        });
        console.log('💰 إجمالي قيمة العقود:', totalContractValue);
        
        // 2. حساب قيمة الأعمال المسجلة من تبويب الأعمال (الكمية × الفئة)
        let totalRegisteredWorksValue = 0;
        let savedSignedWorksValue = 0;
        
        console.log('� حساب قيمة الأعمال المسجلة من تبويب الأعمال...');
        console.log('� بيانات الأعمال المتاحة:', originalWorksData);
        
        if (originalWorksData && originalWorksData.length > 0) {
          originalWorksData.forEach((work, index) => {
            // تجاهل الفواصل فقط (تشمل الأعمال العادية والمسحوبة)
            if (!work.isSeparator) {
              const quantity = parseFloat(work.quantity) || 0;
              const category = parseFloat(work.category) || 0;
              const workValue = quantity * category;
              totalRegisteredWorksValue += workValue;
              const workType = work.isPulled ? '(مسحوب)' : '(عادي)';
              console.log(`💰 عمل ${index + 1}: ${work.workItem || 'غير محدد'} ${workType} - الكمية: ${quantity} × الفئة: ${category} = ${workValue}`);
            }
          });
        } else {
          console.log('⚠️ لا توجد أعمال في تبويب الأعمال');
        }
        
        console.log('💰 إجمالي قيمة الأعمال المسجلة (عادية + مسحوبة):', totalRegisteredWorksValue);
        
        // جلب المستخلصات للحسابات الأخرى فقط
        const extractsResponse = await fetch(`/contractors/${contractorId}/extracts`);
        let extractsData = [];
        
        console.log('📡 جلب المستخلصات للحسابات الأخرى:', `/contractors/${contractorId}/extracts`);
        
        if (extractsResponse.ok) {
          extractsData = await extractsResponse.json();
          console.log('📊 تم جلب', extractsData.length, 'مستخلص للحسابات الأخرى');
        } else {
          console.error('❌ فشل في جلب المستخلصات:', extractsResponse.status);
        }
        
        // جلب قيمة الأعمال الموقعة المحفوظة من المقاول
        const contractorResponse = await fetch(`/contractors/${contractorId}`);
        if (contractorResponse.ok) {
          const contractorData = await contractorResponse.json();
          savedSignedWorksValue = parseFloat(contractorData.totalSignedWorksValue) || 0;
        }
        
        // 3. حساب قيمة الأعمال المسحوبة من تبويب الأعمال
        let totalPulledWorksValue = 0;
        
        console.log('📊 حساب قيمة الأعمال المسحوبة (النسبة الباقية × الكمية × الفئة)...');
        
        if (originalWorksData && originalWorksData.length > 0) {
          originalWorksData.forEach((work, index) => {
            if (work.isPulled) {
              const quantity = parseFloat(work.quantity) || 0;
              const category = parseFloat(work.category) || 0;
              const totalPercent = parseFloat(work.totalPercent) || 0;
              
              // النسبة الباقية = 100% - النسبة المنجزة
              const remainingPercent = 100 - totalPercent;
              
              // قيمة العمل المسحوب = النسبة الباقية × الكمية × الفئة / 100
              const workValue = (remainingPercent / 100) * quantity * category;
              
              totalPulledWorksValue += workValue;
              console.log(`💰 عمل مسحوب ${index + 1}: ${work.workItem || 'غير محدد'}`);
              console.log(`   الكمية: ${quantity}, الفئة: ${category}, النسبة المنجزة: ${totalPercent}%`);
              console.log(`   النسبة الباقية: ${remainingPercent}% = ${workValue} ريال`);
            }
          });
        }
        
        console.log('💰 إجمالي قيمة الأعمال المسحوبة (النسبة الباقية):', totalPulledWorksValue);
        
        // 4. الإجمالي النهائي للأعمال = المسجلة - المسحوبة
        const totalFinalWorksValue = totalRegisteredWorksValue - totalPulledWorksValue;
        
        // 6. حساب قيمة المستخلصات من تبويب المستخلصات (نفس الطريقة)
        let totalExtractsValue = 0;
        
        console.log('📊 حساب قيمة المستخلصات من تبويب المستخلصات...');
        
        // جلب المستخلصات مرة أخرى للتأكد من الحصول على نفس البيانات
        const allExtractsResponse = await fetch('/extracts');
        if (allExtractsResponse.ok) {
          const allExtracts = await allExtractsResponse.json();
          // فلترة المستخلصات الخاصة بهذا المقاول فقط (نفس تبويب المستخلصات)
          const contractorExtracts = allExtracts.filter(ex => ex.contractor == contractorId);
          
          contractorExtracts.forEach((extract, index) => {
            // حساب القيمة من workItems (نفس طريقة تبويب المستخلصات)
            let extractValue = 0;
            if (Array.isArray(extract.workItems)) {
              extractValue = extract.workItems.reduce((sum, item) => sum + (parseFloat(item.currentAmount) || 0), 0);
            }
            totalExtractsValue += extractValue;
            console.log(`📋 مستخلص ${index + 1}: ${extract.extractNumber || extract.number || 'غير محدد'} = ${extractValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`📋 عدد المستخلصات: ${contractorExtracts.length}`);
        } else {
          console.error('❌ فشل في جلب المستخلصات للملخص');
        }
        
        console.log('💰 إجمالي قيمة المستخلصات (من تبويب المستخلصات):', totalExtractsValue);
        
        // 5. نسبة الإنجاز = (الإجمالي النهائي للأعمال / قيمة المستخلصات)
        const completionPercentage = totalExtractsValue > 0 ? 
          (totalFinalWorksValue / totalExtractsValue).toFixed(2) : 0;
        
        console.log('📊 حساب نسبة الإنجاز: (' + totalFinalWorksValue + ' ÷ ' + totalExtractsValue + ') = ' + completionPercentage);
        
        // 7. حساب قيمة الخصومات من تبويب الخصومات (نفس الطريقة)
        let totalDeductionsValue = 0;
        
        console.log('📊 حساب قيمة الخصومات من تبويب الخصومات...');
        
        // جلب المستخلصات لاستخراج الخصومات (نفس طريقة تبويب الخصومات)
        const extractsForDeductions = await fetch('/extracts');
        if (extractsForDeductions.ok) {
          const extracts = await extractsForDeductions.json();
          // جمع كل الخصومات من مستخلصات هذا المقاول فقط (نفس التبويب)
          let allDeductions = [];
          extracts.forEach(extract => {
            if (extract.contractor == contractorId && Array.isArray(extract.deductions)) {
              extract.deductions.forEach(ded => {
                // فقط الخصومات التي لها قيمة (نفس شروط التبويب)
                const hasValue =
                  (ded.total && !isNaN(parseFloat(ded.total)) && parseFloat(ded.total) !== 0) ||
                  (ded.category && !isNaN(parseFloat(ded.category)) && parseFloat(ded.category) !== 0) ||
                  (ded.quantity && !isNaN(parseFloat(ded.quantity)) && parseFloat(ded.quantity) !== 0);
                
                // استبعاد خصومات المواد (نفس منطق التبويب)
                const isMaterialDeduction = 
                  (ded.statement && (
                    ded.statement.includes('خصم مادة') ||
                    ded.statement.includes('صرف مادة') ||
                    ded.statement.includes('خصم مواد') ||
                    ded.statement.includes('صرف مواد') ||
                    ded.statement.includes('مادة') ||
                    ded.statement.includes('حديد') ||
                    ded.statement.includes('أسمنت') ||
                    ded.statement.includes('رمل') ||
                    ded.statement.includes('زلط') ||
                    ded.statement.includes('بلوك') ||
                    ded.statement.includes('طوب')
                  )) ||
                  (ded.type && ded.type === 'material') ||
                  (ded.itemType && ded.itemType === 'material') ||
                  (ded.deductionType && ded.deductionType === 'material') ||
                  (ded.isAutomaticDeduction === true) ||
                  (ded.source && ded.source === 'materials');
                
                // أضف فقط الخصومات اليدوية (غير خصومات المواد)
                if (hasValue && !isMaterialDeduction) {
                  allDeductions.push({
                    ...ded,
                    extractId: extract._id,
                    extractNumber: extract.extractNumber || extract.number || ''
                  });
                }
              });
            }
          });
          
          // حساب مجموع الخصومات
          allDeductions.forEach((ded, index) => {
            const deductionValue = parseFloat(ded.total) || 0;
            totalDeductionsValue += deductionValue;
            console.log(`💰 خصم ${index + 1}: ${ded.statement || 'غير محدد'} = ${deductionValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`� عدد الخصومات: ${allDeductions.length}`);
        } else {
          console.error('❌ فشل في جلب الخصومات للملخص');
        }
        
        console.log('💰 إجمالي قيمة الخصومات (من تبويب الخصومات):', totalDeductionsValue);
        
        // 8. حساب قيمة المواد من تبويب المواد (نفس الطريقة)
        let totalMaterialsValue = 0;
        
        console.log('� حساب قيمة المواد من تبويب المواد...');
        
        // جلب بيانات المقاول للحصول على المواد (نفس طريقة تبويب المواد)
        const contractorForMaterials = await fetch(`/contractors/${contractorId}`);
        if (contractorForMaterials.ok) {
          const contractorData = await contractorForMaterials.json();
          const materials = Array.isArray(contractorData.materials) ? contractorData.materials : [];
          
          materials.forEach((material, index) => {
            // حساب قيمة المادة = الكمية × سعر الوحدة (نفس منطق التبويب)
            const quantity = parseFloat(material.quantity) || 0;
            const unitPrice = parseFloat(material.unitPrice) || 0;
            const materialValue = quantity * unitPrice;
            totalMaterialsValue += materialValue;
            console.log(`💰 مادة ${index + 1}: ${material.name || material.item || 'غير محدد'} (${quantity} × ${unitPrice}) = ${materialValue.toLocaleString('en-US', {maximumFractionDigits: 2})}`);
          });
          
          console.log(`� عدد المواد: ${materials.length}`);
        } else {
          console.error('❌ فشل في جلب المواد للملخص');
        }
        
        console.log('💰 إجمالي قيمة المواد (من تبويب المواد):', totalMaterialsValue);
        
        // تحديث العرض
        console.log('📝 تحديث العرض بالقيم المحسوبة...');
        
        document.getElementById('totalContractValue').textContent = 
          totalContractValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة العقود');
          
        // تحديث عرض قيمة الأعمال الموقعة
        document.getElementById('totalSignedWorksValueDisplay').textContent = 
          (savedSignedWorksValue || 0).toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة الأعمال الموقعة');
          
        document.getElementById('totalRegisteredWorksValue').textContent = 
          totalRegisteredWorksValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة الأعمال المسجلة:', totalRegisteredWorksValue);
          
        document.getElementById('totalPulledWorksValue').textContent = 
          totalPulledWorksValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة الأعمال المسحوبة');
          
        document.getElementById('totalFinalWorksValue').textContent = 
          totalFinalWorksValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث القيمة النهائية للأعمال');
          
        document.getElementById('completionPercentage').textContent = 
          completionPercentage + '%';
        console.log('✅ تم تحديث نسبة الإنجاز');
          
        document.getElementById('totalExtractsValue').textContent = 
          totalExtractsValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة المستخلصات');
          
        document.getElementById('totalDeductionsValue').textContent = 
          totalDeductionsValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة الخصومات');
          
        document.getElementById('totalMaterialsValue').textContent = 
          totalMaterialsValue.toLocaleString('en-US') + ' ريال';
        console.log('✅ تم تحديث قيمة المواد');
          
        
        console.log('✅ تم حساب الملخص بنجاح');
        
      } catch (error) {
        console.error('❌ خطأ في حساب الملخص:', error);
        alert('حدث خطأ أثناء حساب الملخص');
      }
    }

    // دالة فتح مودال تعديل الأعمال الموقعة
    function editSignedWorksValue() {
      const currentValue = document.getElementById('totalSignedWorksValueDisplay').textContent
        .replace(' ريال', '').replace(/,/g, '');
      document.getElementById('signedWorksValueInput').value = currentValue !== '0' ? currentValue : '';
      document.getElementById('editSignedWorksModal').style.display = 'flex';
    }

    // دالة إغلاق المودال
    function closeSignedWorksModal() {
      document.getElementById('editSignedWorksModal').style.display = 'none';
    }

    // دالة حفظ قيمة الأعمال الموقعة
    async function saveSignedWorksValue() {
      try {
        const value = document.getElementById('signedWorksValueInput').value;
        const numericValue = parseFloat(value) || 0;
        
        const response = await fetch(`/contractors/${contractorId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            totalSignedWorksValue: numericValue
          })
        });
        
        if (response.ok) {
          console.log('✅ تم حفظ قيمة الأعمال الموقعة:', numericValue);
          // إغلاق المودال
          closeSignedWorksModal();
          // إعادة حساب الملخص لتحديث النسب
          calculateAndDisplaySummary();
        } else {
          console.error('❌ فشل في حفظ قيمة الأعمال الموقعة');
          alert('حدث خطأ أثناء حفظ القيمة');
        }
      } catch (error) {
        console.error('❌ خطأ في حفظ قيمة الأعمال الموقعة:', error);
        alert('حدث خطأ أثناء حفظ القيمة');
      }
    }

    // متغير لحفظ بيانات الأعمال الأصلية
    let originalWorksData = [];

    let pulledWorksData = []; // أعمال مسحوبة من المقاول
    let isSortedByBuilding = false;
    
    // تأكيد أن الكود محدث
    console.log('🔄 تم تحميل الكود المحدث - نسخة الأعمال المسحوبة');

    // جلب الأعمال المسحوبة من المقاول الحالي
    async function fetchPulledWorks() {
      try {
        console.log('🔍 جاري جلب الأعمال المسحوبة للمقاول:', contractorId);
        const response = await fetch(`/contractors/${contractorId}/pulled-works`);
        if (!response.ok) throw new Error('فشل في جلب الأعمال المسحوبة');
        const pulledWorks = await response.json();
        console.log('✅ تم جلب الأعمال المسحوبة:', pulledWorks);
        return pulledWorks;
      } catch (error) {
        console.error('❌ خطأ في جلب الأعمال المسحوبة:', error);
        return [];
      }
    }

    // جلب أعمال المقاول من آخر مستخلص + الأعمال اليدوية
    async function fetchWorks() {
      const tbody = document.getElementById('worksBody');
      if (!tbody) return;
      
      try {
        // جلب الأعمال المسحوبة
        pulledWorksData = await fetchPulledWorks();
        
        // جلب أعمال المستخلصات مع منع cache
        const timestamp = Date.now();
        const res = await fetch(`/extracts?t=${timestamp}`);
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">تعذر تحميل الأعمال.</td></tr>`;
          return;
        }
        
        const extracts = await res.json();
        // فلترة المستخلصات الخاصة بهذا المقاول فقط
        const filtered = extracts.filter(ex => ex.contractor == contractorId);
        
        if (!filtered.length) {
          tbody.innerHTML = `<tr><td colspan="11" class="no-data">لا يوجد أعمال لهذا المقاول.</td></tr>`;
          return;
        }
        
        // أخذ آخر مستخلص
        const lastExtract = filtered[filtered.length - 1];
        
        if (!lastExtract.workItems || !Array.isArray(lastExtract.workItems) || !lastExtract.workItems.length) {
          tbody.innerHTML = `<tr><td colspan="10" class="no-data">لا يوجد بنود أعمال في المستخلص.</td></tr>`;
          return;
        }
        
        // حفظ البيانات الأصلية
        originalWorksData = lastExtract.workItems;
        
        renderWorksTable(originalWorksData, false);
        
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="10" class="no-data">حدث خطأ أثناء تحميل الأعمال.</td></tr>`;
      }
    }

    // جلب الأعمال اليدوية من السيرفر




    // دالة فتح مودال تعديل العمل من المستخلص
    function editExtractWork(index) {
      if (index < 0 || index >= originalWorksData.length) return;
      
      const work = originalWorksData[index];
      if (work.isSeparator) {
        alert('لا يمكن تعديل الفواصل');
        return;
      }
      
      // فحص إذا كان العمل مقفول (له نسبة)
      if (work.totalPercent && work.totalPercent > 0) {
        alert('لا يمكن تعديل هذا العمل لأنه يحتوي على نسبة إجمالي');
        return;
      }
      
      // ملء الحقول في المودال
      document.querySelector('#addWorkForm input[name="buildingNumber"]').value = work.buildingNumber || '';
      document.querySelector('#addWorkForm input[name="workItem"]').value = work.workItem || '';
      document.querySelector('#addWorkForm textarea[name="workDescription"]').value = work.workDescription || '';
      document.querySelector('#addWorkForm input[name="quantity"]').value = work.quantity || '';
      document.querySelector('#addWorkForm input[name="unit"]').value = work.unit || '';
      document.querySelector('#addWorkForm input[name="category"]').value = work.category || '';
      document.querySelector('#addWorkForm input[name="totalPercent"]').value = work.totalPercent || '';
      document.querySelector('#addWorkForm input[name="totalAmount"]').value = work.totalAmount || '';
      
      // تغيير عنوان المودال وزر الحفظ
      document.querySelector('#addWorkModal h3').textContent = 'تعديل العمل من المستخلص';
      document.querySelector('#addWorkForm button[type="submit"]').textContent = 'حفظ التعديل';
      
      // حفظ الفهرس للتعديل
      document.getElementById('addWorkForm').dataset.editIndex = index;
      document.getElementById('addWorkForm').dataset.workType = 'extract';
      
      // إظهار المودال
      document.getElementById('addWorkModal').style.display = 'flex';
    }

    // دالة حذف عمل من المستخلص (محسنة)
    async function deleteExtractWork(index) {
      if (index < 0 || index >= originalWorksData.length) {
        console.log('❌ فهرس خاطئ:', index, 'الحد الأقصى:', originalWorksData.length - 1);
        alert('خطأ في تحديد العمل المطلوب حذفه');
        return;
      }
      
      const work = originalWorksData[index];
      if (work.isSeparator) {
        alert('لا يمكن حذف الفواصل');
        return;
      }
      
      // فحص إذا كان العمل مقفول (له نسبة)
      if (work.totalPercent && work.totalPercent > 0) {
        alert('لا يمكن حذف هذا العمل لأنه يحتوي على نسبة إجمالي');
        return;
      }
      
      if (confirm('هل أنت متأكد من حذف هذا العمل من المستخلص؟\nسيتم حذفه نهائياً من قاعدة البيانات.')) {
        console.log('🗑️ محاولة حذف العمل من المستخلص:', work.workDescription, 'الفهرس:', index);
        
        try {
          // جلب معرف المستخلص
          const extractsRes = await fetch(`/extracts`);
          if (!extractsRes.ok) throw new Error('فشل في جلب المستخلصات');
          
          const extracts = await extractsRes.json();
          const filtered = extracts.filter(ex => ex.contractor == contractorId);
          if (filtered.length === 0) throw new Error('لم يتم العثور على مستخلص للمقاول');
          
          const lastExtract = filtered[filtered.length - 1];
          
          // استخدام API حذف العمل الواحد الجديد
          const deleteResponse = await fetch(`/extracts/${lastExtract._id}/work-items/${index}`, {
            method: 'DELETE'
          });

          if (deleteResponse.ok) {
            // إزالة العمل من القائمة المحلية
            originalWorksData.splice(index, 1);
            
            // إعادة عرض الجدول مع إعادة حساب الـ indices
            renderWorksTable(originalWorksData, isSortedByBuilding);
            
            alert('تم حذف العمل من المستخلص وحفظ التغيير في قاعدة البيانات بنجاح!');
          } else {
            const error = await deleteResponse.json();
            console.error('❌ خطأ من السيرفر:', error);
            alert('خطأ في حذف العمل من المستخلص: ' + (error.error || 'خطأ غير معروف'));
          }
        } catch (error) {
          console.error('خطأ في حذف العمل:', error);
          alert('حدث خطأ أثناء حذف العمل من قاعدة البيانات: ' + error.message);
        }
      }
    }

    // دالة لعرض جدول الأعمال
    function renderWorksTable(workItems, sortedByBuilding = false) {
      const tbody = document.getElementById('worksBody');
      tbody.innerHTML = '';
      
      console.log('🔄 إعادة رسم الجدول - أعمال المستخلص:', workItems ? workItems.length : 0);
      
      if (sortedByBuilding) {
        renderSortedByBuilding(workItems);
      } else {
        renderNormalTable(workItems);
      }
      
      // حساب وتحديث إجمالي قيمة الأعمال بعد عرض الجدول
      setTimeout(() => {
        calculateAndUpdateTotalWorks();
      }, 100);
    }

    // عرض الجدول العادي
    function renderNormalTable(workItems) {
      const tbody = document.getElementById('worksBody');
      let workRowNum = 1;
      let cumulativePercent = 0; // متغير للنسبة التراكمية
      
      console.log('📋 عرض الجدول العادي - عدد الأعمال:', workItems ? workItems.length : 0);
      
      // عرض الأعمال من المستخلص أولاً (إذا وجدت)
      if (workItems && workItems.length > 0) {
        workItems.forEach((item, index) => {
          console.log(`🔍 العمل ${index}:`, item.workDescription, 'مسحوب؟', item.isPulled);
          
          if (item.isSeparator) {
            // عرض الفاصل
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="10" style="background:#2e8ca3;color:#fff;font-weight:bold;text-align:center;">${item.separatorName || 'فاصل'}</td>`;
            tbody.appendChild(tr);
          } else {
            // عرض بند العمل
            const tr = document.createElement('tr');
            
            // التحقق من حالة السحب
            let workDescription = item.workDescription || '';
            let isPulled = item.isPulled || false;
            
            console.log(`🔍 العمل "${item.workDescription}" - مسحوب؟`, isPulled, 'إلى:', item.pulledToContractorName);
            
            // حساب النسبة التراكمية (فقط للأعمال غير المسحوبة)
            if (!isPulled && (item.totalPercent !== undefined && item.totalPercent !== null)) {
              cumulativePercent += parseFloat(item.totalPercent) || 0;
            }
            
            // تحديد حالة العمل
            let statusText = '';
            let statusStyle = '';
            if (isPulled) {
              statusText = `سُحب إلى: ${item.pulledToContractorName || 'مقاول آخر'}`;
              statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
              console.log('🔴 عرض عمل مسحوب من المستخلص:', item.workDescription);
              tr.className = 'pulled-work';
              tr.style.backgroundColor = '#ffebee'; // خلفية حمراء خفيفة
              tr.style.opacity = '0.8'; // شفافية خفيفة
            } else {
              statusText = 'أصلي';
              statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
            }
            
            tr.innerHTML = `
              <td>${workRowNum++}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.buildingNumber || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.workItem || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.workDescription || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.quantity || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.unit || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.category || ''}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${isPulled ? (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '') : (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '0%')}</td>
              <td style="${isPulled ? 'color:#999;' : ''}">${item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : ''}</td>
              <td style="${statusStyle}">${statusText}</td>
              <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
                ${isPulled ? 
                  `<span style="color:#f44336; font-size:10px; font-weight:bold; text-align:center;">مسحوب</span>` :
                  (item.totalPercent && item.totalPercent > 0) ?
                    `<span style="color:#ff9800; font-size:10px; font-weight:bold; text-align:center; background:#fff3e0; padding:2px 4px; border-radius:3px;">مقفول</span>` :
                    `<button onclick="editExtractWork(${index})" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="تعديل العمل">✏️</button>
                     <button onclick="deleteExtractWork(${index})" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="حذف العمل">✖</button>`
                }
              </td>
            `;
            tbody.appendChild(tr);
          }
        });
      }
    }

    // عرض الجدول مرتب حسب المبنى
    function renderSortedByBuilding(workItems) {
      const tbody = document.getElementById('worksBody');
      
      // تجميع البيانات حسب المبنى (أعمال المستخلص فقط)
      const buildingsMap = new Map();
      
      // إضافة أعمال المستخلص إذا وجدت
      if (workItems && workItems.length > 0) {
        workItems.forEach((item, originalIndex) => {
          if (!item.isSeparator) {
            const buildingNum = item.buildingNumber || 'غير محدد';
            if (!buildingsMap.has(buildingNum)) {
              buildingsMap.set(buildingNum, []);
            }
            buildingsMap.get(buildingNum).push({...item, originalIndex, source: 'extract'});
          }
        });
      }

      // إذا لم تكن هناك أعمال على الإطلاق
      if (buildingsMap.size === 0) {
        tbody.innerHTML = `<tr><td colspan="11" class="no-data">لا يوجد أعمال لهذا المقاول.</td></tr>`;
        return;
      }

      // ترتيب المباني حسب الرقم
      const sortedBuildings = Array.from(buildingsMap.keys()).sort((a, b) => {
        if (a === 'غير محدد') return 1;
        if (b === 'غير محدد') return -1;
        return parseInt(a) - parseInt(b);
      });

      let globalRowNum = 1;

      sortedBuildings.forEach((buildingNum) => {
        const items = buildingsMap.get(buildingNum);
        
        // إنشاء شريط المبنى
        const buildingHeader = document.createElement('tr');
        buildingHeader.className = 'building-header';
        buildingHeader.setAttribute('data-building', buildingNum);
        buildingHeader.innerHTML = `
          <td colspan="11" style="text-align:center;">
            <span class="building-arrow">◄</span>
            مبنى رقم ${buildingNum} (${items.length} بند)
          </td>
        `;
        tbody.appendChild(buildingHeader);

        // إضافة بنود الأعمال تحت كل مبنى (مخفية افتراضياً)
        items.forEach((item) => {
          const tr = document.createElement('tr');
          tr.className = 'building-works'; // مخفية افتراضياً
          tr.setAttribute('data-building', buildingNum);
          
          // تحديد نوع العمل ومعرفه
          const isPulled = item.source === 'pulled';
          const workIndex = isPulled ? item.pulledIndex : item.originalIndex;
          const isManual = item.source === 'manual' || !item.source; // عمل يدوي
          
          // التحقق من حالة السحب وتحديد المظهر
          let workDescription = item.workDescription || '';
          let isWorkPulled = item.isPulled || false;
          let pulledInfo = '';
          
          console.log(`🔍 [Building View] العمل "${item.workDescription}" - نوع: ${item.source} - مسحوب؟`, isWorkPulled);
          
          if (isPulled) {
            // عمل مسحوب من هذا المقاول (من endpoint pulled-works)
            tr.style.backgroundColor = '#ffebee'; // خلفية حمراء خفيفة
            tr.style.opacity = '0.8'; // شفافية خفيفة
          } else if (isWorkPulled) {
            // عمل مسحوب إلى مقاول آخر (سواء يدوي أو من مستخلص)
            console.log('🔴 [Building View] عرض عمل مسحوب:', item.workDescription, 'نوع:', item.source);
            tr.classList.add('pulled-work');
            tr.style.backgroundColor = '#ffebee'; // خلفية حمراء خفيفة
            tr.style.opacity = '0.8'; // شفافية خفيفة
          } else if (isManual) {
            tr.style.backgroundColor = '#e8f5e9'; // خلفية خضراء للأعمال اليدوية غير المسحوبة
          }
          
          // تحديد دالة التعديل والحذف حسب نوع العمل
          let actionsColumn = '';
          if (isPulled || isWorkPulled) {
            // عمل مسحوب - لا يمكن تعديله أو حذفه
            actionsColumn = `<td style="text-align:center; color:#f44336; font-weight:bold; font-size:10px;">سُحب</td>`;
          } else if (item.totalPercent && item.totalPercent > 0) {
            // عمل مقفول (له نسبة) - لا يمكن تعديله أو حذفه
            actionsColumn = `<td style="text-align:center;"><span style="color:#ff9800; font-size:10px; font-weight:bold; background:#fff3e0; padding:2px 4px; border-radius:3px;">مقفول</span></td>`;
          } else {
            const editFunction = `editExtractWork(${workIndex})`;
            const deleteFunction = `deleteExtractWork(${workIndex})`;
            actionsColumn = `
              <td style="display:flex; gap:5px; align-items:center; justify-content:center;">
                <button onclick="${editFunction}" style="background:#2e8ca3; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="تعديل العمل">✏️</button>
                <button onclick="${deleteFunction}" style="background:#388e3c; color:#fff; border:none; padding:4px 8px; cursor:pointer; border-radius:3px; font-size:11px;" title="حذف العمل">✖</button>
              </td>
            `;
          }
          
          // إضافة لون رمادي للبيانات المسحوبة مع الحفاظ على عرضها
          const grayStyle = (isPulled || isWorkPulled) ? 'color:#999;' : '';
          
          // تحديد حالة العمل
          let statusText = '';
          let statusStyle = '';
          if (isPulled) {
            statusText = `سُحب إلى: ${item.pulledToContractorName || 'مقاول آخر'}`;
            statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
          } else if (isWorkPulled) {
            statusText = `سُحب إلى: ${item.pulledToContractorName || 'مقاول آخر'}`;
            statusStyle = 'color:#f44336; font-weight:bold; font-size:0.75rem;';
          } else if (isManual && item.pulledFromContractorName) {
            statusText = `مجلوب من: ${item.pulledFromContractorName}`;
            statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
          } else if (isManual) {
            statusText = 'يدوي';
            statusStyle = 'color:#388e3c; font-weight:bold; font-size:0.75rem;';
          } else {
            statusText = 'أصلي';
            statusStyle = 'color:#2e8ca3; font-weight:bold; font-size:0.75rem;';
          }
          
          tr.innerHTML = `
            <td>${globalRowNum++}</td>
            <td style="${grayStyle}">${item.buildingNumber || ''}</td>
            <td style="${grayStyle}">${item.workItem || ''}</td>
            <td style="${grayStyle}">${item.workDescription || ''}</td>
            <td style="${grayStyle}">${item.quantity || ''}</td>
            <td style="${grayStyle}">${item.unit || ''}</td>
            <td style="${grayStyle}">${item.category || ''}</td>
            <td style="${grayStyle}">${item.totalPercent || ''}${item.totalPercent ? '%' : ''}</td>
            <td style="${grayStyle}">${item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : ''}</td>
            <td style="${statusStyle}">${statusText}</td>
            ${actionsColumn}
          `;
          tbody.appendChild(tr);
        });
      });

      // إضافة وظائف الطي والفتح
      addBuildingToggleEvents();
    }

    // إضافة أحداث الطي والفتح للمباني
    function addBuildingToggleEvents() {
      document.querySelectorAll('.building-header').forEach(header => {
        header.addEventListener('click', function() {
          const buildingNum = this.getAttribute('data-building');
          const arrow = this.querySelector('.building-arrow');
          const buildingWorks = document.querySelectorAll(`.building-works[data-building="${buildingNum}"]`);
          
          buildingWorks.forEach(row => {
            if (row.classList.contains('visible')) {
              // إخفاء البنود
              row.classList.remove('visible');
              arrow.textContent = '◄';
              arrow.classList.remove('expanded');
            } else {
              // إظهار البنود
              row.classList.add('visible');
              arrow.textContent = '▼';
              arrow.classList.add('expanded');
            }
          });
        });
      });
    }

    // جلب المستخلصات الخاصة بالمقاول
    async function fetchExtracts() {
      const res = await fetch(`/extracts`);
      const tbody = document.getElementById('extractsBody');
      if (!tbody) return; // حماية من الخطأ
      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">تعذر تحميل المستخلصات.</td></tr>`;
        return;
      }
      const extracts = await res.json();
      // فلترة المستخلصات الخاصة بهذا المقاول فقط
      const filtered = extracts.filter(ex => ex.contractor == contractorId);
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="no-data">لا يوجد مستخلصات لهذا المقاول.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      filtered.forEach((ex, i) => {
        // حساب القيمة من workItems (نفس طريقة صفحة المستخلصات)
        let value = 0;
        if (Array.isArray(ex.workItems)) {
          value = ex.workItems.reduce((sum, item) => sum + (parseFloat(item.currentAmount) || 0), 0);
        }
        // عرض القيمة بالإنجليزي مع فواصل (نفس صفحة المستخلصات)
        const valueStr = Number(value).toLocaleString('en-US', {maximumFractionDigits: 2});
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${ex.extractNumber || ex.number || ''}</td>
          <td>${ex.extractDate ? new Date(ex.extractDate).toLocaleDateString('ar-EG') : (ex.date ? new Date(ex.date).toLocaleDateString('ar-EG') : '')}</td>
          <td style="direction:ltr; text-align:center;">${valueStr}</td>
          <td>
            <a href="extract.html?id=${ex._id}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;">عرض</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // جلب الخصومات الخاصة بالمقاول
    async function fetchDeductions() {
      const res = await fetch(`/extracts`);
      const tbody = document.getElementById('deductionsBody');
      if (!tbody) return;
      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">تعذر تحميل الخصومات.</td></tr>`;
        return;
      }
      const extracts = await res.json();
      // جمع كل الخصومات من مستخلصات هذا المقاول فقط
      let allDeductions = [];
      extracts.forEach(extract => {
        if (extract.contractor == contractorId && Array.isArray(extract.deductions)) {
          extract.deductions.forEach(ded => {
            // فقط الخصومات التي لها قيمة (total أو category أو quantity فيها رقم)
            const hasValue =
              (ded.total && !isNaN(parseFloat(ded.total)) && parseFloat(ded.total) !== 0) ||
              (ded.category && !isNaN(parseFloat(ded.category)) && parseFloat(ded.category) !== 0) ||
              (ded.quantity && !isNaN(parseFloat(ded.quantity)) && parseFloat(ded.quantity) !== 0);
            
            // استبعاد خصومات المواد - تحقق من أن الخصم ليس خصم مادة
            const isMaterialDeduction = 
              (ded.statement && (
                ded.statement.includes('خصم مادة') ||
                ded.statement.includes('صرف مادة') ||
                ded.statement.includes('خصم مواد') ||
                ded.statement.includes('صرف مواد') ||
                ded.statement.includes('مادة') ||
                ded.statement.includes('حديد') ||
                ded.statement.includes('أسمنت') ||
                ded.statement.includes('رمل') ||
                ded.statement.includes('زلط') ||
                ded.statement.includes('بلوك') ||
                ded.statement.includes('طوب')
              )) ||
              (ded.type && ded.type === 'material') ||
              (ded.itemType && ded.itemType === 'material') ||
              (ded.deductionType && ded.deductionType === 'material') ||
              (ded.isAutomaticDeduction === true) ||
              (ded.source && ded.source === 'materials');
            
            // أضف فقط الخصومات اليدوية (غير خصومات المواد)
            if (hasValue && !isMaterialDeduction) {
              allDeductions.push({
                ...ded,
                extractId: extract._id,
                extractNumber: extract.extractNumber || extract.number || ''
              });
            } else if (hasValue && isMaterialDeduction) {
              // تشخيص: اطبع الخصومات المستبعدة
              console.log('🚫 تم استبعاد خصم مادة:', ded.statement, ded);
            }
          });
        }
      });
      if (!allDeductions.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-data">لا يوجد خصومات لهذا المقاول.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      allDeductions.forEach((ded, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${ded.statement || ''}</td>
          <td>${ded.date ? new Date(ded.date).toLocaleDateString('ar-EG') : ''}</td>
          <td>${ded.quantity || ''}</td>
          <td>${ded.category || ''}</td>
          <td>${ded.total || ''}</td>
          <td>${ded.user || ''}</td>
          <td>
            ${ded.extractId ? `<a href="extract.html?id=${ded.extractId}" style="color:#2e8ca3;font-weight:bold;text-decoration:underline;">${ded.extractNumber}</a>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // دالة تصدير إكسل للأعمال
    function exportToExcel() {
      if (!originalWorksData || originalWorksData.length === 0) {
        alert('لا توجد بيانات أعمال لتصديرها!');
        return;
      }

      // إعداد البيانات للتصدير
      const contractorName = document.getElementById('name').textContent || 'غير محدد';
      
      // تحضير البيانات
      const workData = [];
      let cumulativePercent = 0; // متغير للنسبة التراكمية
      
      // إضافة العناوين
      workData.push([
        'م',
        'المبنى',
        'بند الأعمال',
        'بيان الأعمال',
        'الكمية',
        'الوحدة',
        'الفئة',
        'النسبة %',
        'الإجمالي $',
        'الحالة'
      ]);

      // إضافة البيانات
      let rowNum = 1;
      originalWorksData.forEach(item => {
        if (item.isSeparator) {
          // إضافة الفاصل
          workData.push([
            '',
            `--- ${item.separatorName || 'فاصل'} ---`,
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ]);
        } else {
          // حساب النسبة التراكمية (فقط للأعمال غير المسحوبة)
          if (!item.isPulled && (item.totalPercent !== undefined && item.totalPercent !== null)) {
            cumulativePercent += parseFloat(item.totalPercent) || 0;
          }
          
          // تحديد حالة العمل للتصدير
          let statusText = '';
          if (item.isPulled) {
            statusText = `سُحب إلى: ${item.pulledToContractorName || 'مقاول آخر'}`;
          } else {
            statusText = 'أصلي';
          }
          
          workData.push([
            rowNum++,
            item.buildingNumber || '',
            item.workItem || '',
            item.workDescription || '',
            item.quantity || '',
            item.unit || '',
            item.category || '',
            item.isPulled ? 
              (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '') : 
              (item.totalPercent !== undefined && item.totalPercent !== null ? item.totalPercent + '%' : '0%'),
            item.totalAmount ? parseFloat(item.totalAmount).toLocaleString('en-US') : '',
            statusText
          ]);
        }
      });

      // إنشاء ملف الإكسل
      const worksheet = XLSX.utils.aoa_to_sheet(workData);
      
      // تنسيق العناوين
      const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
      for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[cellAddress]) continue;
        worksheet[cellAddress].s = {
          font: { bold: true },
          fill: { fgColor: { rgb: "2e8ca3" } },
          alignment: { horizontal: "center" }
        };
      }
      
      // تعديل عرض الأعمدة
      worksheet['!cols'] = [
        { width: 5 },   // م
        { width: 10 },  // المبنى
        { width: 15 },  // بند الأعمال
        { width: 30 },  // بيان الأعمال
        { width: 10 },  // الكمية
        { width: 10 },  // الوحدة
        { width: 10 },  // الفئة
        { width: 12 },  // النسبة %
        { width: 15 },  // الإجمالي $
        { width: 15 }   // الحالة
      ];

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'أعمال المقاول');
      
      // تحديد اسم الملف
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const fileName = `أعمال_${contractorName}_${dateStr}.xlsx`;
      
      // تصدير الملف
      XLSX.writeFile(workbook, fileName);
    }

    // دالة فتح مودال إضافة عقد
    function openAddContractModal() {
      console.log('🔥🔥🔥 دالة openAddContractModal تم استدعائها!');
      const modal = document.getElementById('addContractModal');
      console.log('🔍 المودال:', modal);
      if (modal) {
        modal.style.display = 'flex';
        console.log('✅ تم فتح المودال بنجاح - display:', modal.style.display);
      } else {
        console.error('❌ المودال غير موجود!');
        alert('خطأ: المودال غير موجود في الصفحة!');
      }
    }

    // دالة إغلاق مودال إضافة عقد
    function closeAddContractModal() {
      console.log('🔥 إغلاق المودال');
      const modal = document.getElementById('addContractModal');
      const form = document.getElementById('addContractForm');
      if (modal) modal.style.display = 'none';
      if (form) form.reset();
    }

    // وظائف سحب الأعمال - المحدثة لسحب من المقاول الحالي إلى مقاول آخر
    let allContractors = [];
    let currentContractorWorks = [];
    let selectedWorkIds = [];

    // فتح مودال سحب الأعمال
    async function openPullWorksModal() {
      try {
        // جلب قائمة جميع المقاولين
        const response = await fetch('/contractors');
        if (response.ok) {
          allContractors = await response.json();
          // إزالة المقاول الحالي من القائمة
          allContractors = allContractors.filter(c => c._id.toString() !== contractorId);
          
          // ملء قائمة المقاولين الهدف
          const targetSelect = document.getElementById('targetContractorSelect');
          targetSelect.innerHTML = '<option value="">اختر المقاول الهدف...</option>';
          
          allContractors.forEach(contractor => {
            const option = document.createElement('option');
            option.value = contractor._id;
            option.textContent = `${contractor.name || 'غير محدد'} - ${contractor.workItem || 'غير محدد'}`;
            targetSelect.appendChild(option);
          });
          
          // تحميل أعمال المقاول الحالي
          await loadCurrentContractorWorks();
          
          // إظهار المودال
          document.getElementById('pullWorksModal').style.display = 'flex';
        }
      } catch (error) {
        console.error('خطأ في فتح مودال سحب الأعمال:', error);
        alert('تعذر تحميل قائمة المقاولين.');
      }
    }

    // تحميل أعمال المقاول الحالي
    async function loadCurrentContractorWorks() {
      try {
        // جلب الأعمال من المستخلصات
        const extractsResponse = await fetch(`/extracts`);
        let extractWorks = [];
        if (extractsResponse.ok) {
          const extracts = await extractsResponse.json();
          const contractorExtracts = extracts.filter(ex => ex.contractor == contractorId);
          
          if (contractorExtracts.length > 0) {
            const lastExtract = contractorExtracts[contractorExtracts.length - 1];
            if (lastExtract.workItems && Array.isArray(lastExtract.workItems)) {
              extractWorks = lastExtract.workItems.filter(item => !item.isSeparator);
            }
          }
        }

        // الأعمال من المستخلصات فقط
        currentContractorWorks = [
          ...extractWorks.map((work, index) => ({...work, source: 'extract', extractIndex: index}))
        ];
        
        displayCurrentWorks(currentContractorWorks);
      } catch (error) {
        console.error('خطأ في تحميل أعمال المقاول الحالي:', error);
        currentContractorWorks = [];
        displayCurrentWorks([]);
      }
    }

    function displayCurrentWorks(works) {
      const worksList = document.getElementById('currentWorksListForPull');
      worksList.innerHTML = '';
      
      if (!works || works.length === 0) {
        worksList.innerHTML = '<p style="color:#666;">لا توجد أعمال لهذا المقاول للسحب</p>';
        return;
      }
      
      // إنشاء جدول لعرض الأعمال
      const table = document.createElement('table');
      table.style.cssText = 'width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem;';
      
      // إنشاء رأس الجدول
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr style="background:#2e8ca3; color:#fff;">
          <th style="padding:8px; border:1px solid #ddd; text-align:center; width:40px;">
            <input type="checkbox" id="selectAllWorksInTable" style="margin:0;">
          </th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">المصدر</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">المبنى</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">بند الأعمال</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">بيان الأعمال</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">الكمية</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">الوحدة</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">الفئة</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:center;">الإجمالي</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // إنشاء جسم الجدول
      const tbody = document.createElement('tbody');
      
      works.forEach((work, index) => {
        const row = document.createElement('tr');
        row.style.cssText = 'border-bottom:1px solid #ddd;';
        
        // التحقق من حالة السحب
        const isPulled = work.isPulled || false;
        const isDisabled = isPulled;
        
        if (isPulled) {
          row.style.backgroundColor = '#ffebee';
          row.style.opacity = '0.6';
        } else if (work.source === 'manual') {
          row.style.backgroundColor = '#e8f5e9'; // خلفية خضراء للأعمال اليدوية غير المسحوبة
        }
        
        // حساب الإجمالي
        const quantity = parseFloat(work.quantity) || 0;
        const category = parseFloat(work.category) || 0;
        const totalPercent = parseFloat(work.totalPercent) || 100;
        const total = (quantity * category * totalPercent) / 100;
        
        // تحديد معرف فريد للعمل
        const workId = work._id || `extract_${work.extractIndex}`;
        let sourceText = work.source === 'manual' ? 'يدوي' : 'مستخلص';
        const sourceColor = work.source === 'manual' ? '#388e3c' : '#2e8ca3';
        
        // إضافة علامة للأعمال المسحوبة
        if (isPulled) {
          sourceText += ' (مسحوب)';
        }
        
        // إعداد بيان الأعمال
        let workDescription = work.workDescription || '';
        if (isPulled) {
          const pulledToName = work.pulledToContractorName || 'مقاول آخر';
          // إزالة الشريط الأحمر والاحتفاظ بالنص الأصلي فقط
          workDescription = `<span style="color:#d32f2f; font-size:0.8rem;">${workDescription}</span>`;
        }
        
        row.innerHTML = `
          <td style="padding:6px; border:1px solid #ddd; text-align:center;">
            <input type="checkbox" 
                   value="${workId}" 
                   data-source="${work.source}" 
                   data-index="${index}" 
                   class="work-checkbox" 
                   style="margin:0;" 
                   ${isDisabled ? 'disabled' : ''}>
          </td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; color:${isPulled ? '#d32f2f' : sourceColor}; font-weight:bold;">${sourceText}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.buildingNumber || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.workItem || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:right; max-width:200px; overflow:hidden; text-overflow:ellipsis; ${isPulled ? 'color:#d32f2f;' : ''}" title="${work.workDescription || ''}">${workDescription}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.quantity || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.unit || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; ${isPulled ? 'color:#d32f2f;' : ''}">${work.category || ''}</td>
          <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:bold; ${isPulled ? 'color:#d32f2f;' : ''}">${total ? total.toLocaleString('en-US') : ''}</td>
        `;
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      worksList.appendChild(table);
      
      // إضافة event listener لتحديد الكل في الجدول
      document.getElementById('selectAllWorksInTable').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.work-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedWorks();
      });
      
      // إضافة event listeners للاختيارات الفردية
      document.querySelectorAll('.work-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedWorks);
      });
      
      // تحديث checkbox الكل الأصلي ليعمل مع الجدول
      const selectAllWorks = document.getElementById('selectAllWorks');
      if (selectAllWorks) {
        selectAllWorks.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.work-checkbox');
          const selectAllInTable = document.getElementById('selectAllWorksInTable');
          checkboxes.forEach(cb => cb.checked = this.checked);
          if (selectAllInTable) selectAllInTable.checked = this.checked;
          updateSelectedWorks();
        });
      }
    }

    function updateSelectedWorks() {
      const checkedBoxes = Array.from(document.querySelectorAll('.work-checkbox:checked'));
      selectedWorkIds = checkedBoxes.map(cb => ({
        id: cb.value,
        source: cb.dataset.source,
        index: parseInt(cb.dataset.index)
      }));
      
      const proceedBtn = document.getElementById('proceedToStep2Btn');
      
      if (selectedWorkIds.length > 0) {
        proceedBtn.disabled = false;
        proceedBtn.textContent = `المتابعة (${selectedWorkIds.length} عمل مختار)`;
      } else {
        proceedBtn.disabled = true;
        proceedBtn.textContent = 'المتابعة لاختيار المقاول الهدف';
      }
    }

    // إضافة event listeners للمودال
    document.getElementById('targetContractorSelect').addEventListener('change', function() {
      const targetContractorId = this.value;
      const proceedBtn = document.getElementById('proceedToStep3Btn');
      
      if (targetContractorId && selectedWorkIds.length > 0) {
        proceedBtn.disabled = false;
      } else {
        proceedBtn.disabled = true;
      }
    });

    document.getElementById('proceedToStep2Btn').addEventListener('click', function() {
      if (selectedWorkIds.length > 0) {
        document.getElementById('step2').style.display = 'block';
      }
    });

    document.getElementById('proceedToStep3Btn').addEventListener('click', function() {
      // تحديث معلومات الخطوة الثالثة
      const targetContractorName = document.getElementById('targetContractorSelect').selectedOptions[0].textContent;
      const sourceContractorName = document.getElementById('name').textContent;
      
      document.getElementById('sourceContractorName').textContent = sourceContractorName;
      document.getElementById('targetContractorName').textContent = targetContractorName;
      document.getElementById('selectedWorksCount').textContent = selectedWorkIds.length;
      
      document.getElementById('step3').style.display = 'block';
    });

    document.getElementById('confirmPullBtn').addEventListener('click', async function() {
      try {
        const targetContractorId = document.getElementById('targetContractorSelect').value;
        const currentContractorName = document.getElementById('name').textContent;
        
        // الحصول على اسم المقاول الهدف
        const targetContractor = allContractors.find(c => c._id === targetContractorId);
        const targetContractorName = targetContractor ? targetContractor.name : 'غير معروف';
        
        // تجميع الأعمال حسب المصدر
        const extractWorks = [];
        
        selectedWorkIds.forEach(workSelection => {
          const sourceWork = currentContractorWorks[workSelection.index];
          if (sourceWork) {
            if (workSelection.source === 'extract') {
              extractWorks.push({...sourceWork, originalIndex: sourceWork.extractIndex});
            }
          }
        });
        
        if (extractWorks.length === 0) {
          alert('لا توجد أعمال مستخلص محددة للسحب.');
          return;
        }

        // سحب الأعمال من المستخلصات بالطريقة الجديدة
        console.log('🔄 بدء سحب أعمال المستخلص:', extractWorks);
        
        // تحضير بيانات الأعمال للإضافة للمقاول الجديد
        const worksToAdd = extractWorks.map(workData => ({
          buildingNumber: workData.buildingNumber,
          workItem: workData.workItem,
          workDescription: workData.workDescription,
          quantity: workData.quantity,
          unit: workData.unit,
          category: workData.category,
          prevPercent: workData.totalPercent || 0, // النسبة السابقة = الإجمالي الحالي
          currentPercent: 0, // النسبة الحالية = 0 في البداية
          totalPercent: workData.totalPercent || 0, // الإجمالي = نفس النسبة السابقة
          prevAmount: workData.totalAmount || 0, // المبلغ السابق = الإجمالي الحالي
          currentAmount: 0, // المبلغ الحالي = 0 في البداية
          totalAmount: workData.totalAmount || 0, // المبلغ الإجمالي = نفس المبلغ السابق
          pulledFromContractorId: contractorId,
          pulledFromContractorName: currentContractorName,
          pulledAt: new Date()
        }));
        
        // إضافة الأعمال للمقاول الجديد
        const addWorksResponse = await fetch(`/contractors/${targetContractorId}/add-pulled-works`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            pulledWorks: worksToAdd
          })
        });
        
        if (!addWorksResponse.ok) {
          throw new Error('فشل في إضافة الأعمال للمقاول الجديد');
        }
        
        // تمييز الأعمال في المستخلص كمسحوبة
        for (const workData of extractWorks) {
          const markResponse = await fetch(`/extracts/mark-work-pulled/${contractorId}/${workData.originalIndex}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              isPulled: true,
              pulledTo: targetContractorId,
              pulledToContractorName: targetContractorName,
              pulledAt: new Date()
            })
          });
          
          if (!markResponse.ok) {
            console.warn(`⚠️ فشل في تمييز العمل ${workData.originalIndex} كمسحوب`);
          }
        }
        
        // إخفاء المودال وإعادة تحميل البيانات
        document.getElementById('pullWorksModal').style.display = 'none';
        
        console.log('🔄 إعادة تحميل البيانات بعد السحب...');

        await fetchWorks(); // إعادة تحميل الأعمال
        console.log('✅ تم إعادة تحميل البيانات');
        console.log('📊 originalWorksData بعد السحب:', originalWorksData);
        
        renderWorksTable(originalWorksData, isSortedByBuilding);
        
        const totalPulled = extractWorks.length;
        alert(`تم سحب ${totalPulled} عمل بنجاح إلى المقاول "${targetContractorName}"!\n- أعمال من مستخلصات: ${extractWorks.length}\n\nالأعمال المسحوبة ستظهر بلون أحمر وستظهر في مستخلص المقاول الجديد بنفس النسب والإجماليات في عمود السابق.`);
        
        // إعادة تعيين المودال
        resetPullModal();
        
      } catch (error) {
        console.error('خطأ في سحب الأعمال:', error);
        alert('حدث خطأ أثناء سحب الأعمال: ' + error.message);
      }
    });

    document.getElementById('cancelPullBtn').addEventListener('click', function() {
      document.getElementById('pullWorksModal').style.display = 'none';
      resetPullModal();
    });

    function resetPullModal() {
      // إعادة تعيين المودال
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'none';
      selectedWorkIds = [];
      document.getElementById('selectAllWorks').checked = false;
      document.getElementById('proceedToStep2Btn').disabled = true;
      document.getElementById('proceedToStep2Btn').textContent = 'المتابعة لاختيار المقاول الهدف';
      document.getElementById('proceedToStep3Btn').disabled = true;
      document.getElementById('targetContractorSelect').value = '';
    }

    // إغلاق المودال عند الضغط خارجه
    document.getElementById('pullWorksModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        resetPullModal();
      }
    });



    // تحديث الكود في نهاية الملف
    
    // دالة جلب السندات الخاصة بالمقاول
    async function fetchReceipts() {
      try {
        const response = await fetch('https://taskon-production.up.railway.app/receipts');
        const allReceipts = await response.json();
        
        // للتشخيص
        console.log('contractorId من الصفحة:', contractorId, typeof contractorId);
        console.log('عدد كل السندات:', allReceipts.length);
        console.log('أول سند:', allReceipts[0]);
        
        // فلترة السندات الخاصة بهذا المقاول فقط - استخدام == بدلاً من === للسماح بتحويل الأنواع
        const contractorReceipts = allReceipts.filter(receipt => {
          console.log('مقارنة:', receipt.contractorId, 'مع', contractorId);
          return receipt.contractorId && receipt.contractorId.toString() === contractorId.toString();
        });
        
        console.log('سندات المقاول المفلترة:', contractorReceipts.length);
        
        const receiptsBody = document.getElementById('receiptsBody');
        
        if (contractorReceipts.length === 0) {
          receiptsBody.innerHTML = '<tr><td colspan="8" class="no-data">لا توجد سندات مرتبطة بهذا المقاول</td></tr>';
          return;
        }
        
        receiptsBody.innerHTML = contractorReceipts.map((receipt, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${receipt.receiptNumber || ''}</td>
            <td>${receipt.receiptDate ? new Date(receipt.receiptDate).toLocaleDateString('ar-EG') : ''}</td>
            <td>${receipt.receiverName || ''}</td>
            <td>${receipt.serviceDescription || ''}</td>
            <td>${parseFloat(receipt.amount || 0).toFixed(2)}</td>
            <td>${receipt.amountInWords || ''}</td>
            <td>${receipt.notes || ''}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('خطأ في جلب السندات:', error);
        document.getElementById('receiptsBody').innerHTML = '<tr><td colspan="8" class="no-data">خطأ في تحميل البيانات</td></tr>';
      }
    }
    
    async function initializeContractorPage() {
      try {
        // عرض اسم المستخدم
        let pageUser = JSON.parse(localStorage.getItem('user') || '{}');
        if (!pageUser.username) window.location.href = 'login.html';
        
        // تسجيل الخروج
        window.logout = function() {
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        };
        
        // إضافة اسم المستخدم إلى الشريط العلوي بنفس الخط
        document.addEventListener('DOMContentLoaded', function() {
          // انتظر حتى يتم تحميل الشريط العلوي
          setTimeout(function() {
            const usernameEl = document.getElementById('username');
            if (usernameEl && pageUser.username) {
              usernameEl.textContent = pageUser.username;
              usernameEl.style.fontFamily = "'Cairo', Arial, sans-serif";
            }
          }, 200);
        });

        // ربط أزرار التبويبات
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const showContractsBtn = document.getElementById('showContractsBtn');
        const showWorksBtn = document.getElementById('showWorksBtn');
        const showExtractsBtn = document.getElementById('showExtractsBtn');
        const showDeductionsBtn = document.getElementById('showDeductionsBtn');
        const showMaterialsBtn = document.getElementById('showMaterialsBtn');
        const showReceiptsBtn = document.getElementById('showReceiptsBtn');
        
        const summaryContainer = document.getElementById('summaryContainer');
        const contractsContainer = document.getElementById('contractsContainer');
        const worksContainer = document.getElementById('worksContainer');
        const extractsContainer = document.getElementById('extractsContainer');
        const deductionsContainer = document.getElementById('deductionsContainer');
        const materialsContainer = document.getElementById('materialsContainer');
        const receiptsContainer = document.getElementById('receiptsContainer');

        showSummaryBtn.onclick = function() {
          summaryContainer.style.display = '';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          // تحديث ألوان الأزرار
          updateButtonColors(showSummaryBtn);
          // التأكد من تحميل الأعمال قبل حساب الملخص
          if (!originalWorksData || originalWorksData.length === 0) {
            console.log('🔄 تحميل الأعمال قبل حساب الملخص...');
            fetchWorks().then(() => {
              calculateAndDisplaySummary(); // حساب وعرض الملخص بعد تحميل الأعمال
            });
          } else {
            calculateAndDisplaySummary(); // حساب وعرض الملخص مباشرة
          }
        };

        showContractsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = '';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          // تحديث ألوان الأزرار
          updateButtonColors(showContractsBtn);
          fetchContracts(); // جلب العقود عند النقر
        };
        
        showWorksBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = '';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showWorksBtn);
          fetchWorks(); // جلب الأعمال عند النقر
        };
        
        showExtractsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = '';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showExtractsBtn);
          fetchExtracts();
        };
        
        showDeductionsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = '';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showDeductionsBtn);
          fetchDeductions();
        };
        
        showMaterialsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = '';
          receiptsContainer.style.display = 'none';
          updateButtonColors(showMaterialsBtn);
          // إعادة جلب المواد عند كل فتح للنافذة
          fetchContractor();
        };

        showReceiptsBtn.onclick = function() {
          summaryContainer.style.display = 'none';
          contractsContainer.style.display = 'none';
          worksContainer.style.display = 'none';
          extractsContainer.style.display = 'none';
          deductionsContainer.style.display = 'none';
          materialsContainer.style.display = 'none';
          receiptsContainer.style.display = '';
          updateButtonColors(showReceiptsBtn);
          fetchReceipts();
        };

        function updateButtonColors(activeBtn) {
          [showSummaryBtn, showContractsBtn, showWorksBtn, showExtractsBtn, showDeductionsBtn, showMaterialsBtn, showReceiptsBtn].forEach(btn => {
            if (btn === activeBtn) {
              btn.style.background = '#1a3b50';
            } else {
              btn.style.background = '#2e8ca3';
            }
          });
        }

        // عند تحميل الصفحة: أظهر تبويب الملخص كتبويب افتراضي
        summaryContainer.style.display = '';
        contractsContainer.style.display = 'none';
        worksContainer.style.display = 'none';
        extractsContainer.style.display = 'none';
        deductionsContainer.style.display = 'none';
        materialsContainer.style.display = 'none';
        updateButtonColors(showSummaryBtn);
        
        console.log('🔍 بدء ربط أزرار العقود والأعمال...');

        // إضافة أحداث الأزرار - نقلها هنا قبل await
        const sortByBuildingBtn = document.getElementById('sortByBuildingBtn');
        const showAllWorksBtn = document.getElementById('showAllWorksBtn');
        
        if (sortByBuildingBtn) {
          sortByBuildingBtn.onclick = function() {
            isSortedByBuilding = true;
            renderWorksTable(originalWorksData, true);
            sortByBuildingBtn.style.display = 'none';
            if (showAllWorksBtn) {
              showAllWorksBtn.style.display = 'inline-block';
            }
            console.log('✅ تم التبديل إلى الترتيب حسب المبنى');
          };
        }

        if (showAllWorksBtn) {
          showAllWorksBtn.onclick = function() {
            isSortedByBuilding = false;
            renderWorksTable(originalWorksData, false);
            if (sortByBuildingBtn) {
              sortByBuildingBtn.style.display = 'inline-block';
            }
            showAllWorksBtn.style.display = 'none';
            console.log('✅ تم التبديل إلى عرض الكل');
          };
        }

        // ربط زر تصدير الإكسل
        try {
          const exportExcelBtn = document.getElementById('exportExcelBtn');
          if (exportExcelBtn) {
            exportExcelBtn.onclick = function() {
              exportToExcel();
            };
            console.log('✅ تم ربط زر تصدير الإكسل');
          }
        } catch(e) {
          console.error('❌ خطأ في ربط زر تصدير الإكسل:', e);
        }

        // ربط زر تصدير إكسل العقود
        try {
          const exportContractsExcelBtn = document.getElementById('exportContractsExcelBtn');
          if (exportContractsExcelBtn) {
            exportContractsExcelBtn.onclick = function() {
              exportContractsToExcel();
            };
            console.log('✅ تم ربط زر تصدير إكسل العقود');
          }
        } catch(e) {
          console.error('❌ خطأ في ربط زر تصدير إكسل العقود:', e);
        }

        // ربط زر سحب الأعمال
        try {
          const pullWorksBtn = document.getElementById('pullWorksBtn');
          if (pullWorksBtn) {
            pullWorksBtn.onclick = function() {
              openPullWorksModal();
            };
            console.log('✅ تم ربط زر سحب الأعمال');
          }
        } catch(e) {
          console.error('❌ خطأ في ربط زر سحب الأعمال:', e);
        }

        console.log('🔍 محاولة ربط زر إضافة عقد...');

        // ربط زر إضافة عقد
        try {
          const addContractBtn = document.getElementById('btnAddNewContract');
          console.log('🔍 الزر btnAddNewContract:', addContractBtn);
          if (addContractBtn) {
            // الزر له onclick="openNewContractModal()" في HTML
            console.log('✅ زر إضافة عقد موجود ومربوط من خلال onclick في HTML');
          } else {
            console.error('❌ زر إضافة عقد غير موجود في الصفحة!');
          }
        } catch(e) {
          console.error('❌ خطأ في ربط زر إضافة عقد:', e);
        }

        // ========== تم حذف الكود القديم - الكود الجديد موجود في السكريبت المنفصل ==========

        console.log('🎉 انتهى ربط جميع الأزرار - الآن سيتم جلب البيانات');
        
        await fetchContractor();
        await fetchContracts(); // جلب العقود عند تحميل الصفحة
        await fetchWorks(); // جلب الأعمال عند تحميل الصفحة
        await fetchExtracts();
        await fetchDeductions();
        
        // حساب وتحديث إجمالي قيمة الأعمال بعد تحميل جميع البيانات
        calculateAndUpdateTotalWorks();
        
        // حساب الملخص مرة واحدة عند تحميل الصفحة
        await calculateAndDisplaySummary();
        
        // حساب وعرض الملخص بعد تحميل جميع البيانات
        await calculateAndDisplaySummary();

      } catch (error) {
        console.error('خطأ في تهيئة الصفحة:', error);
      }
    }

    // استدعاء دالة التهيئة
    initializeContractorPage();
  </script>
  <script>
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        // استخراج السكريبتات من النص
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        // جمع السكريبتات
        const scripts = tempDiv.querySelectorAll('script');
        // إزالة السكريبتات من الـ html قبل وضعه في الصفحة
        scripts.forEach(s => s.parentNode.removeChild(s));
        // وضع الشريط العلوي بدون السكريبتات
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        // تنفيذ السكريبتات يدويًا
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>

  <!-- مودال تعديل قيمة الأعمال الموقعة -->
  <div id="editSignedWorksModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;z-index:1000;justify-content:center;align-items:center;">
    <div style="background:white;padding:30px;border-radius:10px;width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="text-align:center;color:#2e8ca3;margin-bottom:20px;">تعديل قيمة الأعمال الموقعة</h3>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">القيمة بالريال:</label>
        <input type="number" id="signedWorksValueInput" 
               style="width:100%;padding:10px;border:2px solid #2e8ca3;border-radius:5px;font-size:1rem;text-align:center;" 
               placeholder="أدخل القيمة بالريال"
               onkeypress="if(event.key==='Enter') saveSignedWorksValue()">
      </div>
      
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="saveSignedWorksValue()" 
                style="background:#2e8ca3;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-weight:bold;">
          حفظ
        </button>
        <button onclick="closeSignedWorksModal()" 
                style="background:#ccc;color:#333;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">
          إلغاء
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== دوال المودال - بسيطة ومباشرة ==================== -->
  <script>
    function openNewContractModal() {
      console.log('🎯 فتح مودال العقد الجديد...');
      const modal = document.getElementById('newContractModal');
      if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        console.log('✅ تم فتح المودال');
      } else {
        console.error('❌ المودال غير موجود!');
        alert('خطأ: المودال غير موجود!');
      }
    }

    function closeNewContractModal() {
      console.log('❌ إغلاق المودال');
      const modal = document.getElementById('newContractModal');
      const form = document.getElementById('newContractForm');
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
      }
      if (form) {
        form.reset();
      }
    }
  </script>

  <!-- ==================== كود المودال الجديد - في آخر الصفحة ==================== -->
  <script>
    (function() {
      console.log('🚀🚀🚀 بدء تحميل نظام العقود الجديد...');
      
      // الانتظار حتى يتم تحميل الصفحة بالكامل
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initContractSystem);
      } else {
        // الصفحة محملة بالفعل
        initContractSystem();
      }
      
      function initContractSystem() {
        console.log('✅ تحميل نظام العقود الجديد...');
        
        // الانتظار قليلاً للتأكد من تحميل كل شيء
        setTimeout(function() {
          const modal = document.getElementById('newContractModal');
          const form = document.getElementById('newContractForm');
          
          console.log('🔍 المودال:', modal);
          console.log('🔍 الفورم:', form);
          
          if (!modal) {
            console.error('❌ المودال غير موجود!');
            return;
          }
          if (!form) {
            console.error('❌ الفورم غير موجود!');
            return;
          }
          
          const cancelBtn = modal.querySelector('.btn-cancel');
          
          // إغلاق المودال
          if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
              e.preventDefault();
              closeNewContractModal();
            });
          }
          
          // إغلاق عند الضغط خارج المودال
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              closeNewContractModal();
            }
          });
          
          // إرسال الفورم
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('📤 إرسال بيانات العقد...');
            
            const formData = new FormData(form);
            
            try {
              const contractorId = new URL(window.location.href).searchParams.get('id');
              const response = await fetch(`/contractors/${contractorId}/contracts`, {
                method: 'POST',
                body: formData
              });
              
              if (response.ok) {
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                  const result = await response.json();
                  console.log('✅ نتيجة الحفظ:', result);
                }
                
                alert('✅ تم إضافة العقد بنجاح!');
                closeNewContractModal();
                
                // إعادة تحميل العقود
                if (typeof fetchContracts === 'function') {
                  fetchContracts();
                } else {
                  // Reload page if function not available
                  window.location.reload();
                }
              } else {
                const text = await response.text();
                let errorMsg = 'خطأ غير معروف';
                try {
                  const error = JSON.parse(text);
                  errorMsg = error.error || error.message || text;
                } catch (e) {
                  errorMsg = text || `خطأ ${response.status}`;
                }
                alert('❌ خطأ: ' + errorMsg);
              }
            } catch (err) {
              console.error('❌ خطأ:', err);
              alert('حدث خطأ في الاتصال بالسيرفر');
            }
          });
          
          console.log('✅✅✅ نظام العقود جاهز ويعمل!');
        }, 500);
      }
    })();
  </script>
  <!-- ==================== نهاية كود المودال الجديد ==================== -->

</body>
</html>