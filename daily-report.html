<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تفاصيل التقرير</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;background:#f1f6f8;color:#213140;padding:1rem}
    .container{max-width:1100px;margin:0 auto}
    .card{background:#fff;padding:1rem;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:0.6rem;border-bottom:1px solid #eef5f7;text-align:center}
    thead th{background:#f8fbfc;font-weight:800}
    .small{font-size:0.85rem;color:#6c7a80}
    .actions{display:flex;gap:0.4rem;justify-content:center}
    .icon-btn{padding:0.35rem 0.5rem;border-radius:6px;border:none;background:#f3f8f9;cursor:pointer}
    .equipment-table td{text-align:right}
    .work-items-table th, .work-items-table td{text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>تفاصيل التقرير</h2>
      <div><a href="daily-reports.html" class="small link">العودة لقائمة التقارير</a></div>
    </div>

    <div class="card" id="reportCard">
      <div id="reportHeader" style="display:flex;justify-content:space-between;align-items:center"></div>

      <h4 class="small">جدول المعدات (ثابت)</h4>
      <table class="equipment-table" id="equipmentTable"></table>

      <h4 class="small" style="margin-top:1rem">بيان الأعمال</h4>
      <table class="work-items-table" id="workItemsTable">
        <thead>
          <tr><th>م</th><th>رقم المبني / الدور</th><th>بيان الاعمال</th><th>الصور</th><th>حذف</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center">
        <input id="newBuilding" placeholder="رقم المبني / الدور" />
        <input id="newDesc" placeholder="بيان الاعمال" />
        <input id="newPhotos" type="file" accept="image/*" multiple />
        <button id="addWorkBtn" class="btn">أضف بند</button>
      </div>

      <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:0.5rem">
        <button id="saveBtn" class="btn btn-primary">حفظ التغييرات</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://taskon-production.up.railway.app';
    const equipmentList = [
      'سيارة','سيارة موقع','بوكلين','كرين','قلاب','مقص حديد','ثناية حديد','صاروخ تقطيع','رصاصه','جريدر','وايت مياه','سطحة ونش','موتور لرفع المياه','ماكينة لحام','هزاز','بوب كات','مولد كهرباء','غطاس','رافعة','كومبروسر هواء','شيول','بلدوزر','جى سى بى'
    ];

    const query = new URLSearchParams(window.location.search);
    const reportId = query.get('id');
    const equipmentTable = document.getElementById('equipmentTable');
    const workItemsTbody = document.querySelector('#workItemsTable tbody');
    const newBuilding = document.getElementById('newBuilding');
    const newDesc = document.getElementById('newDesc');
    const newPhotos = document.getElementById('newPhotos');
    const addWorkBtn = document.getElementById('addWorkBtn');
    const saveBtn = document.getElementById('saveBtn');

    let report = null;

    function renderEquipment(){
      equipmentTable.innerHTML = equipmentList.map(e=>`<tr><td style=\"padding:0.35rem 0.8rem;text-align:right\">${e}</td></tr>`).join('');
    }

    function renderWorkItems(){
      workItemsTbody.innerHTML = (report.workItems||[]).map((it,i)=>`<tr>
        <td>${i+1}</td>
        <td>${it.building||''}</td>
        <td style=\"text-align:right\">${it.desc}</td>
        <td>${(it.photos||[]).length ? it.photos.map(p=>`<a href=\"${API_BASE_URL}${p.path}\" target=\"_blank\">صورة</a>`).join(' ') : '-'}</td>
        <td><button class=\"icon-btn del-item\" data-index=\"${i}\">حذف</button></td>
      </tr>`).join('');

      document.querySelectorAll('.del-item').forEach(b=>b.addEventListener('click',e=>{
        const idx = +e.currentTarget.dataset.index; report.workItems.splice(idx,1); renderWorkItems();
      }));
    }

    addWorkBtn.addEventListener('click', ()=>{
      const building = newBuilding.value.trim(); const desc = newDesc.value.trim();
      if(!desc){ alert('أدخل البيان'); return; }
      const files = Array.from(newPhotos.files || []);
      // Temporarily store files in memory for upload on save
      (report.workItems = report.workItems || []).push({ building, desc, photosFiles: files, photos: [] });
      newBuilding.value=''; newDesc.value=''; newPhotos.value=''; renderWorkItems();
    });

    saveBtn.addEventListener('click', async ()=>{
      try{
        // build formData
        const fd = new FormData();
        fd.append('title', report.title || 'تقرير');
        fd.append('date', report.date || new Date().toISOString());
        // workItems meta and files grouping
        const itemsMeta = (report.workItems||[]).map((it,idx)=>({ building: it.building, desc: it.desc, photoFieldPrefix:`photos_${idx}_` }));
        fd.append('workItems', JSON.stringify(itemsMeta));
        report.workItems.forEach((it,idx)=>{ (it.photosFiles||[]).forEach((f,fi)=> fd.append(`photos_${idx}_`+fi, f)); });

        const res = await fetch(`${API_BASE_URL}/daily-reports/${report._id}`, { method:'PUT', body: fd });
        if(res.ok){ alert('تم الحفظ'); const updated = await res.json(); report = updated; renderWorkItems(); }
        else{ alert('خطأ في الحفظ'); }
      }catch(e){ console.error(e); alert('خطأ في الاتصال'); }
    });

    async function load(){
      renderEquipment();
      if(!reportId){ document.getElementById('reportCard').innerHTML = '<div class="empty">لم يتم تحديد تقرير</div>'; return; }
      try{
        const res = await fetch(`${API_BASE_URL}/daily-reports/${reportId}`);
        if(!res.ok){ document.getElementById('reportCard').innerHTML = '<div class="empty">تعذر تحميل التقرير</div>'; return; }
        report = await res.json();
        document.getElementById('reportHeader').innerHTML = `<div><strong>${report.title||''}</strong></div><div class=\"small\">${new Date(report.date).toLocaleDateString('ar-EG')}</div>`;
        renderWorkItems();
      }catch(e){ console.error(e); document.getElementById('reportCard').innerHTML = '<div class="empty">خطأ في الاتصال</div>'; }
    }

    load();
  </script>
</body>
</html>