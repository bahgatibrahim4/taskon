<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تفاصيل التقرير</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="permissions-check.js"></script>
  <style>
    * {
      font-family: 'Cairo', Arial, sans-serif !important;
    }
    body{font-family:'Cairo',sans-serif;background:#f1f6f8;color:#213140;padding:0;margin:0}
    .container{max-width:1200px;margin:2rem auto;padding:0 1rem}
    .card{background:#fff;padding:2rem;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid #e1ecf4}
    table{width:100%;border-collapse:collapse;margin-top:1rem;background:#fff;border-radius:8px;overflow:hidden;font-family:'Cairo',sans-serif}
    th,td{padding:0.8rem;border-bottom:1px solid #f0f7fa;text-align:center;font-family:'Cairo',sans-serif}
    thead th{background:linear-gradient(135deg, #f8fbfc 0%, #e8f4f8 100%);font-weight:800;color:#1a3b50;font-size:0.95rem;font-family:'Cairo',sans-serif}
    tbody tr:hover{background:#f8fbfc;transition:background 0.2s}
    .small{font-size:0.9rem;color:#6c7a80;margin-bottom:0.5rem;font-weight:600;font-family:'Cairo',sans-serif}
    .actions{display:flex;gap:0.6rem;justify-content:center}
    .icon-btn{padding:0.4rem 0.8rem;border-radius:8px;border:none;cursor:pointer;font-size:0.85rem;transition:all 0.2s;font-family:'Cairo',sans-serif}
    .icon-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .equipment-table td{vertical-align:middle;border-bottom:1px solid #f0f7fa;font-family:'Cairo',sans-serif}
    .equipment-table td:nth-child(odd){text-align:right;font-weight:600;background:#fafcfd}
    .equipment-table td:nth-child(even){text-align:center;background:#fff}
    .equipment-table input[type="number"]{width:90px;text-align:center;border:2px solid #e1ecf4;border-radius:6px;padding:0.4rem;transition:border-color 0.2s;font-family:'Cairo',sans-serif}
    .equipment-table input[type="number"]:focus{border-color:#197c91;outline:none;box-shadow:0 0 0 3px rgba(25,124,145,0.1)}
    .work-items-table th, .work-items-table td{text-align:center;font-family:'Cairo',sans-serif}
    .work-items-table td:nth-child(3){text-align:right;max-width:200px}
    .btn{padding:0.6rem 1.2rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;font-family:'Cairo',sans-serif}
    .btn-primary{background:linear-gradient(135deg, #197c91 0%, #1565c0 100%);color:#fff;box-shadow:0 4px 12px rgba(25,124,145,0.3)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(25,124,145,0.4)}
    .btn:hover{transform:translateY(-1px)}
    input[type="text"], input[type="file"], input[type="number"]{padding:0.6rem;border:2px solid #e1ecf4;border-radius:8px;transition:all 0.2s;font-family:'Cairo',sans-serif}
    input[type="text"]:focus, input[type="file"]:focus{border-color:#197c91;outline:none;box-shadow:0 0 0 3px rgba(25,124,145,0.1)}
    input[type="file"]:hover{border-color:#197c91;background:#f8fbfc}
    .link{color:#197c91;text-decoration:none;font-weight:600;font-family:'Cairo',sans-serif}
    .link:hover{text-decoration:underline}
    .navbar{margin-bottom:0}
    label{font-family:'Cairo',sans-serif}
    h1,h2,h3,h4,h5,h6{font-family:'Cairo',sans-serif}
    #addWorkBtn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 6px 20px rgba(25,124,145,0.4)}
    
    /* Responsive design for add work form */
    @media (max-width: 1000px) {
      .add-work-form {
        grid-template-columns: 1fr 1fr !important;
      }
      .add-work-form button {
        grid-column: span 2 !important;
        justify-self: center !important;
      }
    }
    @media (max-width: 600px) {
      .add-work-form {
        grid-template-columns: 1fr !important;
      }
      .add-work-form button {
        grid-column: 1 !important;
      }
    }
  </style>
</head>
<body>
  <div id="mainNavbarContainer"></div>
  <script>
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('mainNavbarContainer').innerHTML = html;
        Array.from(document.getElementById('mainNavbarContainer').querySelectorAll('script')).forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>
  
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>تفاصيل التقرير</h2>
      <div><a href="daily-reports.html" class="small link">العودة لقائمة التقارير</a></div>
    </div>

    <div class="card" id="reportCard">
      <div id="reportHeader" style="display:flex;justify-content:space-between;align-items:center"></div>

      <h4 class="small">جدول المعدات</h4>
      <table class="equipment-table" id="equipmentTable" style="table-layout:fixed">
        <thead>
          <tr>
            <th style="text-align:right;width:16.66%">المعدة</th>
            <th style="text-align:center;width:16.66%">العدد</th>
            <th style="text-align:right;width:16.66%">المعدة</th>
            <th style="text-align:center;width:16.66%">العدد</th>
            <th style="text-align:right;width:16.66%">المعدة</th>
            <th style="text-align:center;width:16.66%">العدد</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h4 class="small" style="margin-top:1rem">بيان الأعمال</h4>
      <table class="work-items-table" id="workItemsTable">
        <thead>
          <tr>
            <th>م</th>
            <th>رقم المبني / الدور</th>
            <th>بيان الاعمال</th>
            <th>الصور</th>
            <th>اسم المستخدم</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:1.5rem;background:linear-gradient(135deg, #f8fbfc 0%, #e8f4f8 100%);padding:1.2rem;border-radius:12px;border:2px solid #e1ecf4;box-shadow:0 4px 15px rgba(0,0,0,0.06)">
        <div style="display:flex;align-items:center;margin-bottom:1rem">
          <div style="background:#197c91;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;margin-left:10px;font-size:1rem">➕</div>
          <h5 style="margin:0;color:#1a3b50;font-weight:700;font-size:1rem;font-family:'Cairo',sans-serif">إضافة بند عمل جديد</h5>
        </div>
        
        <div class="add-work-form" style="display:grid;grid-template-columns:1fr 2fr 1fr auto;gap:1rem;align-items:end">
          <div>
            <label style="display:block;margin-bottom:0.3rem;color:#1a3b50;font-weight:600;font-family:'Cairo',sans-serif;font-size:0.85rem">رقم المبني</label>
            <input id="newBuilding" 
                   placeholder="مثال: A-2" 
                   style="width:100%;padding:0.6rem;border:2px solid #e1ecf4;border-radius:8px;font-family:'Cairo',sans-serif;transition:all 0.3s;background:#fff;font-size:0.9rem" />
          </div>
          <div>
            <label style="display:block;margin-bottom:0.3rem;color:#1a3b50;font-weight:600;font-family:'Cairo',sans-serif;font-size:0.85rem">بيان الأعمال *</label>
            <input id="newDesc" 
                   placeholder="وصف العمل المنجز..." 
                   style="width:100%;padding:0.6rem;border:2px solid #e1ecf4;border-radius:8px;font-family:'Cairo',sans-serif;transition:all 0.3s;background:#fff;font-size:0.9rem" />
          </div>
          <div>
            <label style="display:block;margin-bottom:0.3rem;color:#1a3b50;font-weight:600;font-family:'Cairo',sans-serif;font-size:0.85rem">الصور</label>
            <input id="newPhotos" 
                   type="file" 
                   accept="image/*" 
                   multiple 
                   style="width:100%;padding:0.6rem;border:2px dashed #197c91;border-radius:8px;font-family:'Cairo',sans-serif;background:#fff;cursor:pointer;font-size:0.85rem" />
          </div>
          <button id="addWorkBtn" 
                  class="btn btn-primary" 
                  style="padding:0.6rem 1.2rem;font-size:0.9rem;font-weight:700;border-radius:8px;background:linear-gradient(135deg, #197c91 0%, #1565c0 100%);color:#fff;border:none;cursor:pointer;font-family:'Cairo',sans-serif;box-shadow:0 4px 12px rgba(25,124,145,0.3);transition:all 0.3s;white-space:nowrap">
            ✓ إضافة
          </button>
        </div>
      </div>

      <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:0.5rem">
        <button id="saveBtn" class="btn btn-primary">حفظ التغييرات</button>
      </div>

      <div style="margin-top:2rem;padding-top:1rem;border-top:1px solid #eef5f7;text-align:left">
        <div class="small">إعداد: <span id="currentUser">جاري التحميل...</span></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://taskon-production.up.railway.app';
    const equipmentList = [
      'سيارة','سيارة موقع','بوكلين','كرين','قلاب','مقص حديد','ثناية حديد','صاروخ تقطيع','رصاصه','جريدر','وايت مياه','سطحة ونش','موتور لرفع المياه','ماكينة لحام','هزاز','بوب كات','مولد كهرباء','غطاس','رافعة','كومبروسر هواء','شيول','بلدوزر','جى سى بى'
    ];

    const query = new URLSearchParams(window.location.search);
    const reportId = query.get('id');
    const equipmentTable = document.getElementById('equipmentTable');
    const workItemsTbody = document.querySelector('#workItemsTable tbody');
    const newBuilding = document.getElementById('newBuilding');
    const newDesc = document.getElementById('newDesc');
    const newPhotos = document.getElementById('newPhotos');
    const addWorkBtn = document.getElementById('addWorkBtn');
    const saveBtn = document.getElementById('saveBtn');

    let report = null;

    function renderEquipment(){
      const equipmentData = report?.equipment || {};
      const equipmentRows = [];
      
      // تقسيم المعدات إلى صفوف، كل صف 3 معدات
      for (let i = 0; i < equipmentList.length; i += 3) {
        const rowEquipment = equipmentList.slice(i, i + 3);
        equipmentRows.push(rowEquipment);
      }
      
      equipmentTable.querySelector('tbody').innerHTML = equipmentRows.map(row => `<tr>
        ${row.map(e => `
          <td style="padding:0.5rem 0.8rem;text-align:right;width:16.66%">${e}</td>
          <td style="text-align:center;width:16.66%">
            <input type="number" 
                   min="0" 
                   value="${equipmentData[e] || ''}" 
                   style="width:80px;text-align:center;border:1px solid #ddd;border-radius:4px;padding:0.3rem"
                   onchange="updateEquipmentCount('${e}', this.value)"
                   placeholder="0"/>
          </td>
        `).join('')}
        ${row.length < 3 ? '<td colspan="' + (6 - row.length * 2) + '"></td>' : ''}
      </tr>`).join('');
    }

    function updateEquipmentCount(equipmentName, count) {
      if (!report.equipment) report.equipment = {};
      report.equipment[equipmentName] = count || '';
    }

    function renderWorkItems(){
      workItemsTbody.innerHTML = (report.workItems||[]).map((it,i)=>`<tr>
        <td style="font-weight:600">${i+1}</td>
        <td style="padding:0.7rem">${it.building||''}</td>
        <td style="text-align:right;padding:0.7rem">${it.desc}</td>
        <td style="padding:0.5rem">${(it.photos||[]).length ? it.photos.map(p=>`<a href="${API_BASE_URL}${p.path}" target="_blank" style="color:#197c91;text-decoration:none;margin:0 3px">📷</a>`).join('') : '-'}</td>
        <td style="color:#6c7a80;font-size:0.9rem">${it.addedBy || 'غير محدد'}</td>
        <td><button class="icon-btn del-item" data-index="${i}" style="background:#ffe6e6;color:#d32f2f">حذف</button></td>
      </tr>`).join('');

      document.querySelectorAll('.del-item').forEach(b=>b.addEventListener('click',e=>{
        const idx = +e.currentTarget.dataset.index; report.workItems.splice(idx,1); renderWorkItems();
      }));
    }

    addWorkBtn.addEventListener('click', ()=>{
      const building = newBuilding.value.trim(); 
      const desc = newDesc.value.trim();
      if(!desc){ alert('أدخل البيان'); return; }
      
      // Get current user name
      let currentUser = 'غير محدد';
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        currentUser = user.username || 'غير محدد';
      } catch (e) {}
      
      const files = Array.from(newPhotos.files || []);
      // Temporarily store files in memory for upload on save
      (report.workItems = report.workItems || []).push({ 
        building, 
        desc, 
        photosFiles: files, 
        photos: [],
        addedBy: currentUser,
        addedAt: new Date().toISOString()
      });
      newBuilding.value=''; newDesc.value=''; newPhotos.value=''; 
      renderWorkItems();
    });

    saveBtn.addEventListener('click', async ()=>{
      try{
        // build formData
        const fd = new FormData();
        fd.append('title', report.title || 'تقرير');
        fd.append('date', report.date || new Date().toISOString());
        fd.append('reportNumber', report.reportNumber || '');
        fd.append('equipment', JSON.stringify(report.equipment || {}));
        
        // workItems meta and files grouping
        const itemsMeta = (report.workItems||[]).map((it,idx)=>({ building: it.building, desc: it.desc, photoFieldPrefix:`photos_${idx}_` }));
        fd.append('workItems', JSON.stringify(itemsMeta));
        report.workItems.forEach((it,idx)=>{ (it.photosFiles||[]).forEach((f,fi)=> fd.append(`photos_${idx}_`+fi, f)); });

        const res = await fetch(`${API_BASE_URL}/daily-reports/${report._id}`, { method:'PUT', body: fd });
        if(res.ok){ alert('تم الحفظ'); const updated = await res.json(); report = updated; renderWorkItems(); renderEquipment(); }
        else{ alert('خطأ في الحفظ'); }
      }catch(e){ console.error(e); alert('خطأ في الاتصال'); }
    });

    async function load(){
      renderEquipment();
      if(!reportId){ document.getElementById('reportCard').innerHTML = '<div class="empty">لم يتم تحديد تقرير</div>'; return; }
      try{
        const res = await fetch(`${API_BASE_URL}/daily-reports/${reportId}`);
        if(!res.ok){ document.getElementById('reportCard').innerHTML = '<div class="empty">تعذر تحميل التقرير</div>'; return; }
        report = await res.json();
        document.getElementById('reportHeader').innerHTML = `<div><strong>${report.reportNumber || 'غير محدد'}</strong> - ${report.title||'تقرير يومي'}</div><div class=\"small\">${new Date(report.date).toLocaleDateString('ar-EG')}</div>`;
        renderWorkItems();
      }catch(e){ console.error(e); document.getElementById('reportCard').innerHTML = '<div class="empty">خطأ في الاتصال</div>'; }
    }

    load();

    // Display current user
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('currentUser').textContent = user.username || 'غير معرف';
    } catch (e) {
      document.getElementById('currentUser').textContent = 'غير معرف';
    }
  </script>
</body>
</html>