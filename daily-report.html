<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ุชูุงุตูู ุงูุชูุฑูุฑ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="permissions-check.js"></script>
  <style>
    * {
      font-family: 'Cairo', Arial, sans-serif !important;
    }
    body{font-family:'Cairo',sans-serif;background:#f1f6f8;color:#213140;padding:0;margin:0}
    .container{max-width:1200px;margin:2rem auto;padding:0 1rem}
    .card{background:#fff;padding:2rem;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid #e1ecf4}
    table{width:100%;border-collapse:collapse;margin-top:1rem;background:#fff;border-radius:8px;overflow:hidden;font-family:'Cairo',sans-serif}
    th,td{padding:0.8rem;border-bottom:1px solid #f0f7fa;text-align:center;font-family:'Cairo',sans-serif}
    thead th{background:linear-gradient(135deg, #f8fbfc 0%, #e8f4f8 100%);font-weight:800;color:#1a3b50;font-size:0.95rem;font-family:'Cairo',sans-serif}
    tbody tr:hover{background:#f8fbfc;transition:background 0.2s}
    .small{font-size:0.9rem;color:#6c7a80;margin-bottom:0.5rem;font-weight:600;font-family:'Cairo',sans-serif}
    .actions{display:flex;gap:0.6rem;justify-content:center}
    .icon-btn{padding:0.4rem 0.8rem;border-radius:8px;border:none;cursor:pointer;font-size:0.85rem;transition:all 0.2s;font-family:'Cairo',sans-serif}
    .icon-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .equipment-table td{vertical-align:middle;border-bottom:1px solid #f0f7fa;font-family:'Cairo',sans-serif}
    .equipment-table td:nth-child(1){text-align:right;font-weight:600;background:#fafcfd;padding:0.6rem}
    .equipment-table td:nth-child(2){text-align:center;background:#fff;padding:0.4rem}
    .equipment-table input[type="number"]{width:80px;text-align:center;border:2px solid #e1ecf4;border-radius:6px;padding:0.4rem;transition:border-color 0.2s;font-family:'Cairo',sans-serif}
    .equipment-table input[type="number"]:focus{border-color:#197c91;outline:none;box-shadow:0 0 0 3px rgba(25,124,145,0.1)}
    .work-items-table th, .work-items-table td{text-align:center;font-family:'Cairo',sans-serif;font-size:0.85rem;padding:0.5rem}
    .work-items-table td:nth-child(3){text-align:right}
    .btn{padding:0.6rem 1.2rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;font-family:'Cairo',sans-serif}
    .btn-primary{background:linear-gradient(135deg, #197c91 0%, #1565c0 100%);color:#fff;box-shadow:0 4px 12px rgba(25,124,145,0.3)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(25,124,145,0.4)}
    .btn:hover{transform:translateY(-1px)}
    input[type="text"], input[type="file"], input[type="number"]{padding:0.6rem;border:2px solid #e1ecf4;border-radius:8px;transition:all 0.2s;font-family:'Cairo',sans-serif}
    input[type="text"]:focus, input[type="file"]:focus{border-color:#197c91;outline:none;box-shadow:0 0 0 3px rgba(25,124,145,0.1)}
    input[type="file"]:hover{border-color:#197c91;background:#f8fbfc}
    .link{color:#197c91;text-decoration:none;font-weight:600;font-family:'Cairo',sans-serif}
    .link:hover{text-decoration:underline}
    .navbar{margin-bottom:0}
    label{font-family:'Cairo',sans-serif}
    h1,h2,h3,h4,h5,h6{font-family:'Cairo',sans-serif}
    #addWorkBtn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 6px 20px rgba(25,124,145,0.4)}
    
    /* Responsive design for split layout */
    @media (max-width: 1000px) {
      .card > div[style*="grid-template-columns:1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body>
  <div id="mainNavbarContainer"></div>
  <script>
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('mainNavbarContainer').innerHTML = html;
        Array.from(document.getElementById('mainNavbarContainer').querySelectorAll('script')).forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>
  
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <h2>ุชูุงุตูู ุงูุชูุฑูุฑ</h2>
      <div><a href="daily-reports.html" class="small link">ุงูุนูุฏุฉ ููุงุฆูุฉ ุงูุชูุงุฑูุฑ</a></div>
    </div>

    <div class="card" id="reportCard">
      <div id="reportHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:3px solid #e1ecf4"></div>

      <!-- Split layout: Equipment on left, Work Items on right -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem">
        
        <!-- Left Section: Equipment -->
        <div style="background:linear-gradient(135deg, #f8fbfc 0%, #ffffff 100%);padding:1.5rem;border-radius:12px;border:2px solid #e1ecf4">
          <div style="display:flex;align-items:center;margin-bottom:1rem">
            <div style="background:#197c91;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;margin-left:10px;font-size:1rem">๐</div>
            <h4 style="margin:0;color:#1a3b50;font-weight:700;font-size:1.1rem;font-family:'Cairo',sans-serif">ุฌุฏูู ุงููุนุฏุงุช</h4>
          </div>
          <table class="equipment-table" id="equipmentTable" style="table-layout:auto">
            <thead>
              <tr>
                <th style="text-align:right">ุงููุนุฏุฉ</th>
                <th style="text-align:center">ุงูุนุฏุฏ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Right Section: Work Items -->
        <div style="background:linear-gradient(135deg, #f8fbfc 0%, #ffffff 100%);padding:1.5rem;border-radius:12px;border:2px solid #e1ecf4">
          <div style="display:flex;align-items:center;margin-bottom:1rem">
            <div style="background:#197c91;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;margin-left:10px;font-size:1rem">๐</div>
            <h4 style="margin:0;color:#1a3b50;font-weight:700;font-size:1.1rem;font-family:'Cairo',sans-serif">ุจูุงู ุงูุฃุนูุงู</h4>
          </div>
          <div style="max-height:400px;overflow-y:auto;margin-bottom:1rem">
            <table class="work-items-table" id="workItemsTable">
              <thead>
                <tr>
                  <th>ู</th>
                  <th>ุงููุจูู</th>
                  <th>ุจูุงู ุงูุงุนูุงู</th>
                  <th>ุงูุตูุฑ</th>
                  <th>ุงููุณุชุฎุฏู</th>
                  <th>ุญุฐู</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- Add Work Item Form -->
          <div style="background:#f8fbfc;padding:1rem;border-radius:8px;border:2px dashed #197c91;margin-top:1rem">
            <div style="display:flex;align-items:center;margin-bottom:0.8rem">
              <div style="background:#197c91;color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;margin-left:8px;font-size:0.85rem">โ</div>
              <span style="color:#1a3b50;font-weight:600;font-size:0.9rem;font-family:'Cairo',sans-serif">ุฅุถุงูุฉ ุจูุฏ ุฌุฏูุฏ</span>
            </div>
            <div style="display:grid;gap:0.8rem">
              <input id="newBuilding" 
                     placeholder="ุฑูู ุงููุจูู (ูุซุงู: A-2)" 
                     style="width:100%;padding:0.5rem;border:2px solid #e1ecf4;border-radius:6px;font-family:'Cairo',sans-serif;font-size:0.85rem" />
              <input id="newDesc" 
                     placeholder="ุจูุงู ุงูุฃุนูุงู *" 
                     style="width:100%;padding:0.5rem;border:2px solid #e1ecf4;border-radius:6px;font-family:'Cairo',sans-serif;font-size:0.85rem" />
              <input id="newPhotos" 
                     type="file" 
                     accept="image/*" 
                     multiple 
                     style="width:100%;padding:0.5rem;border:2px dashed #197c91;border-radius:6px;font-family:'Cairo',sans-serif;background:#fff;cursor:pointer;font-size:0.8rem" />
              <button id="addWorkBtn" 
                      class="btn btn-primary" 
                      style="padding:0.5rem 1rem;font-size:0.85rem;font-weight:700;border-radius:6px;background:linear-gradient(135deg, #197c91 0%, #1565c0 100%);color:#fff;border:none;cursor:pointer;font-family:'Cairo',sans-serif;box-shadow:0 4px 12px rgba(25,124,145,0.3);transition:all 0.3s">
                โ ุฅุถุงูุฉ
              </button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:0.5rem">
        <button id="saveBtn" class="btn btn-primary">ุญูุธ ุงูุชุบููุฑุงุช</button>
      </div>

      <div style="margin-top:2rem;padding-top:1rem;border-top:1px solid #eef5f7;text-align:left">
        <div class="small">ุฅุนุฏุงุฏ: <span id="currentUser">ุฌุงุฑู ุงูุชุญููู...</span></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://taskon-production.up.railway.app';
    const equipmentList = [
      'ุณูุงุฑุฉ','ุณูุงุฑุฉ ูููุน','ุจููููู','ูุฑูู','ููุงุจ','ููุต ุญุฏูุฏ','ุซูุงูุฉ ุญุฏูุฏ','ุตุงุฑูุฎ ุชูุทูุน','ุฑุตุงุตู','ุฌุฑูุฏุฑ','ูุงูุช ููุงู','ุณุทุญุฉ ููุด','ููุชูุฑ ูุฑูุน ุงูููุงู','ูุงูููุฉ ูุญุงู','ูุฒุงุฒ','ุจูุจ ูุงุช','ูููุฏ ููุฑุจุงุก','ุบุทุงุณ','ุฑุงูุนุฉ','ูููุจุฑูุณุฑ ููุงุก','ุดููู','ุจูุฏูุฒุฑ','ุฌู ุณู ุจู'
    ];

    const query = new URLSearchParams(window.location.search);
    const reportId = query.get('id');
    const equipmentTable = document.getElementById('equipmentTable');
    const workItemsTbody = document.querySelector('#workItemsTable tbody');
    const newBuilding = document.getElementById('newBuilding');
    const newDesc = document.getElementById('newDesc');
    const newPhotos = document.getElementById('newPhotos');
    const addWorkBtn = document.getElementById('addWorkBtn');
    const saveBtn = document.getElementById('saveBtn');

    let report = null;

    function renderEquipment(){
      const equipmentData = report?.equipment || {};
      
      // ุนุฑุถ ุงููุนุฏุงุช ูู ุตููู ุนุงุฏูุฉ (ุตููู)
      equipmentTable.querySelector('tbody').innerHTML = equipmentList.map(e => `<tr>
        <td style="padding:0.6rem 0.8rem;text-align:right;font-weight:600">${e}</td>
        <td style="text-align:center;padding:0.4rem">
          <input type="number" 
                 min="0" 
                 value="${equipmentData[e] || ''}" 
                 style="width:80px;text-align:center;border:2px solid #e1ecf4;border-radius:6px;padding:0.4rem;font-family:'Cairo',sans-serif"
                 onchange="updateEquipmentCount('${e}', this.value)"
                 placeholder="0"/>
        </td>
      </tr>`).join('');
    }

    function updateEquipmentCount(equipmentName, count) {
      if (!report.equipment) report.equipment = {};
      report.equipment[equipmentName] = count || '';
    }

    function renderWorkItems(){
      workItemsTbody.innerHTML = (report.workItems||[]).map((it,i)=>`<tr>
        <td style="font-weight:600">${i+1}</td>
        <td style="padding:0.7rem">${it.building||''}</td>
        <td style="text-align:right;padding:0.7rem">${it.desc}</td>
        <td style="padding:0.5rem">${(it.photos||[]).length ? it.photos.map(p=>`<a href="${API_BASE_URL}${p.path}" target="_blank" style="color:#197c91;text-decoration:none;margin:0 3px">๐ท</a>`).join('') : '-'}</td>
        <td style="color:#6c7a80;font-size:0.9rem">${it.addedBy || 'ุบูุฑ ูุญุฏุฏ'}</td>
        <td><button class="icon-btn del-item" data-index="${i}" style="background:#ffe6e6;color:#d32f2f">ุญุฐู</button></td>
      </tr>`).join('');

      document.querySelectorAll('.del-item').forEach(b=>b.addEventListener('click',e=>{
        const idx = +e.currentTarget.dataset.index; report.workItems.splice(idx,1); renderWorkItems();
      }));
    }

    addWorkBtn.addEventListener('click', ()=>{
      const building = newBuilding.value.trim(); 
      const desc = newDesc.value.trim();
      if(!desc){ alert('ุฃุฏุฎู ุงูุจูุงู'); return; }
      
      // Get current user name
      let currentUser = 'ุบูุฑ ูุญุฏุฏ';
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        currentUser = user.username || 'ุบูุฑ ูุญุฏุฏ';
      } catch (e) {}
      
      const files = Array.from(newPhotos.files || []);
      // Temporarily store files in memory for upload on save
      (report.workItems = report.workItems || []).push({ 
        building, 
        desc, 
        photosFiles: files, 
        photos: [],
        addedBy: currentUser,
        addedAt: new Date().toISOString()
      });
      newBuilding.value=''; newDesc.value=''; newPhotos.value=''; 
      renderWorkItems();
    });

    saveBtn.addEventListener('click', async ()=>{
      try{
        // build formData
        const fd = new FormData();
        fd.append('title', report.title || 'ุชูุฑูุฑ');
        fd.append('date', report.date || new Date().toISOString());
        fd.append('reportNumber', report.reportNumber || '');
        fd.append('equipment', JSON.stringify(report.equipment || {}));
        
        // workItems meta and files grouping (include addedBy and addedAt)
        const itemsMeta = (report.workItems||[]).map((it,idx)=>({ 
          building: it.building, 
          desc: it.desc, 
          addedBy: it.addedBy || 'ุบูุฑ ูุญุฏุฏ',
          addedAt: it.addedAt || new Date().toISOString(),
          photoFieldPrefix:`photos_${idx}_` 
        }));
        fd.append('workItems', JSON.stringify(itemsMeta));
        report.workItems.forEach((it,idx)=>{ (it.photosFiles||[]).forEach((f,fi)=> fd.append(`photos_${idx}_`+fi, f)); });

        const res = await fetch(`${API_BASE_URL}/daily-reports/${report._id}`, { method:'PUT', body: fd });
        if(res.ok){ alert('ุชู ุงูุญูุธ'); const updated = await res.json(); report = updated; renderWorkItems(); renderEquipment(); }
        else{ alert('ุฎุทุฃ ูู ุงูุญูุธ'); }
      }catch(e){ console.error(e); alert('ุฎุทุฃ ูู ุงูุงุชุตุงู'); }
    });

    async function load(){
      renderEquipment();
      if(!reportId){ document.getElementById('reportCard').innerHTML = '<div class="empty">ูู ูุชู ุชุญุฏูุฏ ุชูุฑูุฑ</div>'; return; }
      try{
        const res = await fetch(`${API_BASE_URL}/daily-reports/${reportId}`);
        if(!res.ok){ document.getElementById('reportCard').innerHTML = '<div class="empty">ุชุนุฐุฑ ุชุญููู ุงูุชูุฑูุฑ</div>'; return; }
        report = await res.json();
        document.getElementById('reportHeader').innerHTML = `<div><strong>${report.reportNumber || 'ุบูุฑ ูุญุฏุฏ'}</strong> - ${report.title||'ุชูุฑูุฑ ูููู'}</div><div class=\"small\">${new Date(report.date).toLocaleDateString('ar-EG')}</div>`;
        renderWorkItems();
      }catch(e){ console.error(e); document.getElementById('reportCard').innerHTML = '<div class="empty">ุฎุทุฃ ูู ุงูุงุชุตุงู</div>'; }
    }

    load();

    // Display current user
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('currentUser').textContent = user.username || 'ุบูุฑ ูุนุฑู';
    } catch (e) {
      document.getElementById('currentUser').textContent = 'ุบูุฑ ูุนุฑู';
    }
  </script>
</body>
</html>