<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>التقارير - نظام إدارة المشاريع</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }
    
    .header h1 {
      font-size: 2.5rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #7f8c8d;
      font-size: 1.1rem;
    }
    
    /* Report Types Grid */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .report-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }
    
    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }
    
    .report-card .icon {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .report-card h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    
    .report-card p {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    
    /* Filters Section */
    .filters-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: none;
    }
    
    .filters-section.active {
      display: block;
    }
    
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .filter-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Cairo', Arial, sans-serif;
      transition: border-color 0.3s;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Cairo', Arial, sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
    }
    
    /* Results Section */
    .results-section {
      margin-top: 30px;
      display: none;
    }
    
    .results-section.active {
      display: block;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .results-header h2 {
      color: #2c3e50;
      font-size: 1.8rem;
    }
    
    .results-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-box {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 20px;
      border-radius: 10px;
      color: white;
      text-align: center;
    }
    
    .stat-box .label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .stat-box .value {
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    th {
      padding: 15px;
      text-align: right;
      font-weight: 700;
      font-size: 1rem;
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #2c3e50;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    tbody tr:last-child td {
      border-bottom: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar-container"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-chart-bar"></i> نظام التقارير الشامل</h1>
      <p>اختر نوع التقرير المطلوب واستخراج البيانات</p>
    </div>

    <!-- Report Types -->
    <div class="reports-grid">
      <div class="report-card" onclick="selectReport('extracts')">
        <div class="icon"><i class="fas fa-file-invoice"></i></div>
        <h3>تقرير المستخلصات</h3>
        <p>عرض وتحليل جميع المستخلصات حسب الفترة والمقاول</p>
      </div>

      <div class="report-card" onclick="selectReport('workers')">
        <div class="icon"><i class="fas fa-users"></i></div>
        <h3>تقرير العمالة</h3>
        <p>رواتب العمال والحضور والغياب</p>
      </div>

      <div class="report-card" onclick="selectReport('store')">
        <div class="icon"><i class="fas fa-warehouse"></i></div>
        <h3>تقرير المخزن</h3>
        <p>حركة المواد الواردة والصادرة</p>
      </div>

      <div class="report-card" onclick="selectReport('equipment')">
        <div class="icon"><i class="fas fa-tools"></i></div>
        <h3>تقرير المعدات</h3>
        <p>المعدات المؤجرة والتكاليف</p>
      </div>

      <div class="report-card" onclick="selectReport('contractors')">
        <div class="icon"><i class="fas fa-handshake"></i></div>
        <h3>تقرير المقاولين</h3>
        <p>مقارنة أداء المقاولين والمدفوعات</p>
      </div>

      <div class="report-card" onclick="selectReport('financial')">
        <div class="icon"><i class="fas fa-coins"></i></div>
        <h3>التقرير المالي</h3>
        <p>إجمالي المصروفات والإيرادات</p>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filtersSection">
      <h2 style="margin-bottom: 20px; color: #2c3e50;">
        <i class="fas fa-filter"></i> تصفية البيانات
      </h2>
      <div class="filters-grid">
        <div class="filter-group">
          <label>من تاريخ</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="filter-group">
          <label>إلى تاريخ</label>
          <input type="date" id="dateTo">
        </div>
        <div class="filter-group" id="contractorFilter" style="display: none;">
          <label>المقاول</label>
          <select id="contractorSelect">
            <option value="">الكل</option>
          </select>
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateReport()">
          <i class="fas fa-chart-line"></i> إنشاء التقرير
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> تصدير Excel
        </button>
        <button class="btn btn-danger" onclick="exportToPDF()">
          <i class="fas fa-file-pdf"></i> تصدير PDF
        </button>
        <button class="btn btn-warning" onclick="printReport()">
          <i class="fas fa-print"></i> طباعة
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <h2 id="reportTitle">نتائج التقرير</h2>
        <button class="btn btn-danger" onclick="closeReport()">
          <i class="fas fa-times"></i> إغلاق
        </button>
      </div>
      <div class="results-stats" id="reportStats"></div>
      <div id="reportContent"></div>
    </div>
  </div>

  <script>
    // Load Navbar
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('navbar-container').innerHTML = data;
      });

    // Check authentication
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user.username) {
      window.location.href = 'login.html';
    }

    let currentReportType = '';
    let reportData = [];

    // Select Report Type
    function selectReport(type) {
      currentReportType = type;
      document.getElementById('filtersSection').classList.add('active');
      document.getElementById('resultsSection').classList.remove('active');
      
      // Show/hide contractor filter
      if (type === 'extracts' || type === 'contractors') {
        document.getElementById('contractorFilter').style.display = 'block';
        loadContractors();
      } else {
        document.getElementById('contractorFilter').style.display = 'none';
      }
      
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
      document.getElementById('dateFrom').value = firstDay;
      document.getElementById('dateTo').value = today;
    }

    // Load Contractors
    async function loadContractors() {
      try {
        const response = await fetch('/contractors');
        const contractors = await response.json();
        const select = document.getElementById('contractorSelect');
        select.innerHTML = '<option value="">الكل</option>';
        contractors.forEach(c => {
          select.innerHTML += `<option value="${c._id}">${c.name}</option>`;
        });
      } catch (error) {
        console.error('خطأ في تحميل المقاولين:', error);
      }
    }

    // Generate Report
    async function generateReport() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const contractor = document.getElementById('contractorSelect').value;

      if (!dateFrom || !dateTo) {
        alert('يرجى اختيار الفترة الزمنية');
        return;
      }

      document.getElementById('reportContent').innerHTML = '<div class="loading"><div class="spinner"></div><div>جاري إنشاء التقرير...</div></div>';
      document.getElementById('resultsSection').classList.add('active');

      try {
        switch (currentReportType) {
          case 'extracts':
            await generateExtractsReport(dateFrom, dateTo, contractor);
            break;
          case 'workers':
            await generateWorkersReport(dateFrom, dateTo);
            break;
          case 'store':
            await generateStoreReport(dateFrom, dateTo);
            break;
          case 'equipment':
            await generateEquipmentReport(dateFrom, dateTo);
            break;
          case 'contractors':
            await generateContractorsReport(dateFrom, dateTo);
            break;
          case 'financial':
            await generateFinancialReport(dateFrom, dateTo);
            break;
        }
      } catch (error) {
        console.error('خطأ في إنشاء التقرير:', error);
        document.getElementById('reportContent').innerHTML = '<div class="no-data">حدث خطأ في إنشاء التقرير</div>';
      }
    }

    // Generate Extracts Report
    async function generateExtractsReport(dateFrom, dateTo, contractor) {
      const response = await fetch('/extracts');
      let data = await response.json();
      
      // Filter by date
      data = data.filter(e => {
        const date = e.date;
        return date >= dateFrom && date <= dateTo;
      });
      
      // Filter by contractor
      if (contractor) {
        data = data.filter(e => e.contractorId === contractor || e.contractor === contractor);
      }
      
      reportData = data;
      
      // Calculate stats
      const totalCount = data.length;
      const totalAmount = data.reduce((sum, e) => sum + (parseFloat(e.afterDeductions) || 0), 0);
      const avgAmount = totalCount > 0 ? totalAmount / totalCount : 0;
      
      // Display stats
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-file-invoice"></i> تقرير المستخلصات';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">عدد المستخلصات</div>
          <div class="value">${totalCount}</div>
        </div>
        <div class="stat-box">
          <div class="label">إجمالي المبالغ</div>
          <div class="value">${totalAmount.toLocaleString('ar-EG')} جنيه</div>
        </div>
        <div class="stat-box">
          <div class="label">المتوسط</div>
          <div class="value">${avgAmount.toLocaleString('ar-EG', {maximumFractionDigits: 0})} جنيه</div>
        </div>
      `;
      
      // Display table
      if (data.length === 0) {
        document.getElementById('reportContent').innerHTML = '<div class="no-data">لا توجد بيانات لعرضها</div>';
        return;
      }
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>رقم المستخلص</th>
              <th>التاريخ</th>
              <th>المقاول</th>
              <th>الصافي بعد الخصومات</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach((e, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${e.number || '-'}</td>
            <td>${e.date || '-'}</td>
            <td>${e.contractor || '-'}</td>
            <td>${(parseFloat(e.afterDeductions) || 0).toLocaleString('ar-EG')} جنيه</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('reportContent').innerHTML = html;
    }

    // Generate Workers Report
    async function generateWorkersReport(dateFrom, dateTo) {
      const response = await fetch('/workers');
      const data = await response.json();
      
      reportData = data;
      
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-users"></i> تقرير العمالة';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">عدد العمال</div>
          <div class="value">${data.length}</div>
        </div>
        <div class="stat-box">
          <div class="label">إجمالي الرواتب</div>
          <div class="value">${data.reduce((sum, w) => sum + (parseFloat(w.salary) || 0), 0).toLocaleString('ar-EG')} جنيه</div>
        </div>
      `;
      
      if (data.length === 0) {
        document.getElementById('reportContent').innerHTML = '<div class="no-data">لا توجد بيانات لعرضها</div>';
        return;
      }
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>الاسم</th>
              <th>الوظيفة</th>
              <th>الراتب</th>
              <th>رقم الهاتف</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach((w, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${w.name || '-'}</td>
            <td>${w.job || '-'}</td>
            <td>${(parseFloat(w.salary) || 0).toLocaleString('ar-EG')} جنيه</td>
            <td>${w.phone || '-'}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('reportContent').innerHTML = html;
    }

    // Generate Store Report
    async function generateStoreReport(dateFrom, dateTo) {
      const response = await fetch('/store');
      const data = await response.json();
      
      reportData = data;
      
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-warehouse"></i> تقرير المخزن';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">عدد الأصناف</div>
          <div class="value">${data.length}</div>
        </div>
        <div class="stat-box">
          <div class="label">إجمالي الكمية</div>
          <div class="value">${data.reduce((sum, s) => sum + (parseFloat(s.quantity) || 0), 0).toLocaleString('ar-EG')}</div>
        </div>
      `;
      
      if (data.length === 0) {
        document.getElementById('reportContent').innerHTML = '<div class="no-data">لا توجد بيانات لعرضها</div>';
        return;
      }
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>الصنف</th>
              <th>الكمية</th>
              <th>الوحدة</th>
              <th>سعر الوحدة</th>
              <th>الإجمالي</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach((s, idx) => {
        const total = (parseFloat(s.quantity) || 0) * (parseFloat(s.unitPrice) || 0);
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${s.item || '-'}</td>
            <td>${(parseFloat(s.quantity) || 0).toLocaleString('ar-EG')}</td>
            <td>${s.unit || '-'}</td>
            <td>${(parseFloat(s.unitPrice) || 0).toLocaleString('ar-EG')} جنيه</td>
            <td>${total.toLocaleString('ar-EG')} جنيه</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('reportContent').innerHTML = html;
    }

    // Generate Equipment Report
    async function generateEquipmentReport(dateFrom, dateTo) {
      const response = await fetch('/equipments');
      let data = await response.json();
      
      // Filter by date
      data = data.filter(e => {
        const date = e.rentDate;
        return date >= dateFrom && date <= dateTo;
      });
      
      reportData = data;
      
      const totalCost = data.reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
      
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-tools"></i> تقرير المعدات';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">عدد المعدات</div>
          <div class="value">${data.length}</div>
        </div>
        <div class="stat-box">
          <div class="label">إجمالي التكلفة</div>
          <div class="value">${totalCost.toLocaleString('ar-EG')} جنيه</div>
        </div>
      `;
      
      if (data.length === 0) {
        document.getElementById('reportContent').innerHTML = '<div class="no-data">لا توجد بيانات لعرضها</div>';
        return;
      }
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>اسم المعدة</th>
              <th>المالك</th>
              <th>تاريخ التأجير</th>
              <th>عدد الأيام</th>
              <th>قيمة اليوم</th>
              <th>الإجمالي</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach((e, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${e.name || '-'}</td>
            <td>${e.owner || '-'}</td>
            <td>${e.rentDate || '-'}</td>
            <td>${e.days || 0}</td>
            <td>${(parseFloat(e.dayValue) || 0).toLocaleString('ar-EG')} جنيه</td>
            <td>${(parseFloat(e.total) || 0).toLocaleString('ar-EG')} جنيه</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('reportContent').innerHTML = html;
    }

    // Generate Contractors Report
    async function generateContractorsReport(dateFrom, dateTo) {
      const [contractors, extracts] = await Promise.all([
        fetch('/contractors').then(r => r.json()),
        fetch('/extracts').then(r => r.json())
      ]);
      
      // Calculate per contractor
      const contractorStats = contractors.map(c => {
        const cExtracts = extracts.filter(e => 
          (e.contractorId === c._id || e.contractor === c.name) &&
          e.date >= dateFrom && e.date <= dateTo
        );
        const total = cExtracts.reduce((sum, e) => sum + (parseFloat(e.afterDeductions) || 0), 0);
        return {
          name: c.name,
          count: cExtracts.length,
          total: total
        };
      });
      
      reportData = contractorStats;
      
      const totalAmount = contractorStats.reduce((sum, c) => sum + c.total, 0);
      
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-handshake"></i> تقرير المقاولين';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">عدد المقاولين</div>
          <div class="value">${contractors.length}</div>
        </div>
        <div class="stat-box">
          <div class="label">إجمالي المدفوعات</div>
          <div class="value">${totalAmount.toLocaleString('ar-EG')} جنيه</div>
        </div>
      `;
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>اسم المقاول</th>
              <th>عدد المستخلصات</th>
              <th>إجمالي المبلغ</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      contractorStats.forEach((c, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${c.name}</td>
            <td>${c.count}</td>
            <td>${c.total.toLocaleString('ar-EG')} جنيه</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('reportContent').innerHTML = html;
    }

    // Generate Financial Report
    async function generateFinancialReport(dateFrom, dateTo) {
      const [extracts, workers, equipment] = await Promise.all([
        fetch('/extracts').then(r => r.json()),
        fetch('/workers').then(r => r.json()),
        fetch('/equipments').then(r => r.json())
      ]);
      
      const extractsTotal = extracts
        .filter(e => e.date >= dateFrom && e.date <= dateTo)
        .reduce((sum, e) => sum + (parseFloat(e.afterDeductions) || 0), 0);
      
      const workersTotal = workers.reduce((sum, w) => sum + (parseFloat(w.salary) || 0), 0);
      
      const equipmentTotal = equipment
        .filter(e => e.rentDate >= dateFrom && e.rentDate <= dateTo)
        .reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
      
      const grandTotal = extractsTotal + workersTotal + equipmentTotal;
      
      document.getElementById('reportTitle').innerHTML = '<i class="fas fa-coins"></i> التقرير المالي';
      document.getElementById('reportStats').innerHTML = `
        <div class="stat-box">
          <div class="label">مستخلصات</div>
          <div class="value">${extractsTotal.toLocaleString('ar-EG')} جنيه</div>
        </div>
        <div class="stat-box">
          <div class="label">رواتب</div>
          <div class="value">${workersTotal.toLocaleString('ar-EG')} جنيه</div>
        </div>
        <div class="stat-box">
          <div class="label">معدات</div>
          <div class="value">${equipmentTotal.toLocaleString('ar-EG')} جنيه</div>
        </div>
        <div class="stat-box">
          <div class="label">الإجمالي</div>
          <div class="value">${grandTotal.toLocaleString('ar-EG')} جنيه</div>
        </div>
      `;
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>البند</th>
              <th>المبلغ</th>
              <th>النسبة</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>مستخلصات المقاولين</td>
              <td>${extractsTotal.toLocaleString('ar-EG')} جنيه</td>
              <td>${((extractsTotal / grandTotal) * 100).toFixed(1)}%</td>
            </tr>
            <tr>
              <td>رواتب العمالة</td>
              <td>${workersTotal.toLocaleString('ar-EG')} جنيه</td>
              <td>${((workersTotal / grandTotal) * 100).toFixed(1)}%</td>
            </tr>
            <tr>
              <td>المعدات والإيجارات</td>
              <td>${equipmentTotal.toLocaleString('ar-EG')} جنيه</td>
              <td>${((equipmentTotal / grandTotal) * 100).toFixed(1)}%</td>
            </tr>
            <tr style="background: #f8f9fa; font-weight: 700;">
              <td>الإجمالي</td>
              <td>${grandTotal.toLocaleString('ar-EG')} جنيه</td>
              <td>100%</td>
            </tr>
          </tbody>
        </table>
      `;
      
      document.getElementById('reportContent').innerHTML = html;
    }

    // Export to Excel
    function exportToExcel() {
      if (reportData.length === 0) {
        alert('لا توجد بيانات للتصدير');
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'التقرير');
      XLSX.writeFile(wb, `تقرير_${currentReportType}_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add Arabic support (you'll need to add Arabic font)
      doc.text('تقرير ' + currentReportType, 105, 20, { align: 'center' });
      
      const table = document.querySelector('table');
      if (table) {
        doc.autoTable({ html: table });
      }
      
      doc.save(`تقرير_${currentReportType}_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // Print Report
    function printReport() {
      window.print();
    }

    // Close Report
    function closeReport() {
      document.getElementById('resultsSection').classList.remove('active');
      document.getElementById('filtersSection').classList.remove('active');
      currentReportType = '';
    }
  </script>
</body>
</html>
