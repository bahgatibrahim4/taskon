<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠ | ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { direction: rtl; }
    body {
      margin: 0;
      font-family: 'Cairo', Arial, sans-serif;
      background: #c5d6db;
      min-height: 100vh;
      /* direction: rtl; */ /* ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ :root */
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px #1a3b5011, 0 1.5px 8px #c5d6dbcc;
      padding: 32px 18px 24px 18px;
      margin-top: 18px;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-row h1 {
      margin: 0;
      font-size: 2rem;
      color: #1a3b50;
      letter-spacing: 1px;
      text-align: right;
      flex: 1 1 auto;
    }
    .back-btn {
      border: 2px solid #2e8ca3;
      background: #fff;
      color: #1a3b50;
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 1.1rem;
      font-weight: 900;
      padding: 8px 22px;
      border-radius: 0;
      cursor: pointer;
      margin-bottom: 0;
      transition: background 0.15s, color 0.15s, border 0.15s;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #2e8ca311;
      outline: none;
      display: inline-block;
    }
    .back-btn:hover, .back-btn:focus {
      background: #2e8ca3;
      color: #fff;
      border-color: #1a3b50;
    }
    
    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙÙŠØ© */
    #filterBtn:hover {
      background: #28a745 !important;
      color: #fff !important;
    }
    
    #addMonthBtn:hover {
      background: #2e8ca3 !important;
      color: #fff !important;
    }
    
    #clearFilterBtn:hover {
      background: #c82333 !important;
    }
    .footer {
      text-align: center;
      color: #2e8ca3;
      font-size: 1.1rem;
      margin-top: 60px;
      padding-bottom: 18px;
      opacity: 0.8;
      letter-spacing: 1px;
      font-weight: 500;
      text-shadow: 0 1px 8px #2e8ca311;
    }
    @media (max-width: 900px) {
      .container { max-width: 99vw; }
      .header-row h1 { font-size: 1.2rem; }
    }
    @media (max-width: 600px) {
      .container { padding: 10px 2px; }
      .header-row { flex-direction: column-reverse; align-items: stretch; gap: 6px; }
      .header-row h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div class="container">
    <div class="header-row">
      <h1>Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
      <div style="display:flex; gap:6px; align-items:center;">
        <!-- Ø²Ø± Ø§Ù„ØªØµÙÙŠØ© -->
        <button id="filterBtn" type="button" style="border:1.5px solid #28a745; border-radius:0; background:#fff; color:#28a745; font-family:'Cairo',Arial,sans-serif; font-size:0.8rem; font-weight:700; padding:3px 10px; letter-spacing:0.5px; box-shadow:0 1px 4px #28a74533; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">
          ğŸ”
        </button>
        <button class="add-month-btn" id="addMonthBtn" type="button" style="border:1.5px solid #2e8ca3; border-radius:0; background:#fff; color:#1a3b50; font-family:'Cairo',Arial,sans-serif; font-size:0.85rem; font-weight:700; padding:4px 12px; letter-spacing:0.5px; box-shadow:0 1px 4px #2e8ca311; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="back-btn" id="backBtn" style="border:1.5px solid #2e8ca3; background:#fff; color:#1a3b50; font-family:'Cairo',Arial,sans-serif; font-size:0.85rem; font-weight:700; padding:4px 12px; border-radius:0; cursor:pointer; margin-bottom:0; transition:background 0.15s, color 0.15s, border 0.15s; letter-spacing:0.5px; box-shadow:0 1px 4px #2e8ca311; outline:none; display:inline-block;">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØµÙÙŠØ© -->
    <div id="filterBar" style="display:none; background:#f8fafb; border:1px solid #2e8ca3; border-radius:6px; padding:12px 16px; margin-bottom:16px;">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:0.9rem;">Ø§Ù„Ø³Ù†Ø©:</label>
          <select id="yearFilter" style="padding:4px 8px; border:1px solid #c5d6db; border-radius:4px; font-size:0.9rem;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
          </select>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:0.9rem;">Ø§Ù„Ø´Ù‡Ø±:</label>
          <select id="monthFilter" style="padding:4px 8px; border:1px solid #c5d6db; border-radius:4px; font-size:0.9rem;">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
            <option value="01">ÙŠÙ†Ø§ÙŠØ±</option>
            <option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option>
            <option value="03">Ù…Ø§Ø±Ø³</option>
            <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option>
            <option value="05">Ù…Ø§ÙŠÙˆ</option>
            <option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
            <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option>
            <option value="08">Ø£ØºØ³Ø·Ø³</option>
            <option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
            <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
            <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
            <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
          </select>
        </div>
        <button id="clearFilterBtn" style="background:#e74c3c; color:#fff; border:none; border-radius:4px; padding:2px 8px; font-size:0.75rem; cursor:pointer; font-weight:700;">Ù…Ø³Ø­</button>
      </div>
    </div>
    <div id="monthsCards" style="display:flex; flex-wrap:wrap; gap:18px; margin-top:32px;"></div>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… -->
    <div id="totalBar" style="margin-top:20px; padding:8px 14px; background:#1a3b50; border-radius:4px; text-align:center; display:none;">
      <div style="font-size:0.9rem; font-weight:700; color:#fff; margin-bottom:1px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±</div>
      <div id="grandTotal" style="font-size:1.2rem; font-weight:900; color:#28a745;">0</div>
    </div>
  </div>
  <div class="footer">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2025 Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯
  </div>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± -->
  <div id="monthModalOverlay" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:#0006; z-index:2000; align-items:center; justify-content:center;">
    <form id="monthModal" style="background:#fff; border-radius:12px; box-shadow:0 8px 32px #1a3b5044; padding:28px 18px 18px 18px; min-width:320px; max-width:95vw; width:340px; display:flex; flex-direction:column; gap:14px; font-family:'Cairo',Arial,sans-serif;">
      <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±</label>
      <input type="text" id="monthNameInput" required style="padding:6px 10px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; margin-bottom:8px;">
      <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="monthDateInput" required style="padding:6px 10px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; margin-bottom:8px;">
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
        <button type="button" id="cancelMonthModalBtn" style="border:none; background:#c5d6db; color:#1a3b50; font-weight:700; font-size:0.85rem; padding:5px 14px; border-radius:4px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" style="border:none; background:#2e8ca3; color:#fff; font-weight:700; font-size:0.85rem; padding:5px 14px; border-radius:4px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </form>
  </div>
  <script>
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    if (!localStorage.getItem('user')) {
      window.location.href = 'login.html';
    }
    // Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
    document.getElementById('backBtn').onclick = function() {
      window.location.href = 'workers.html';
    };

    // --- Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± ---
    const addMonthBtn = document.getElementById('addMonthBtn');
    const monthModalOverlay = document.getElementById('monthModalOverlay');
    const monthModal = document.getElementById('monthModal');
    const cancelMonthModalBtn = document.getElementById('cancelMonthModalBtn');
    const monthsCards = document.getElementById('monthsCards');
    let monthsList = [];
    let filteredMonthsList = [];

    // --- Ø§Ù„ØªØµÙÙŠØ© ---
    const filterBtn = document.getElementById('filterBtn');
    const filterBar = document.getElementById('filterBar');
    const yearFilter = document.getElementById('yearFilter');
    const monthFilter = document.getElementById('monthFilter');
    const clearFilterBtn = document.getElementById('clearFilterBtn');

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØµÙÙŠØ©
    filterBtn.onclick = function() {
      if (filterBar.style.display === 'none') {
        filterBar.style.display = 'block';
        populateYearFilter();
      } else {
        filterBar.style.display = 'none';
      }
    };

    // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª
    function populateYearFilter() {
      const years = new Set();
      monthsList.forEach(m => {
        if (m.date) {
          const year = m.date.split('-')[0];
          years.add(year);
        }
      });
      
      yearFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>';
      Array.from(years).sort().forEach(year => {
        yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
      });
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
    function applyFilter() {
      const selectedYear = yearFilter.value;
      const selectedMonth = monthFilter.value;

      filteredMonthsList = monthsList.filter(m => {
        if (!m.date) return false;
        
        const dateParts = m.date.split('-');
        const year = dateParts[0];
        const month = dateParts[1];

        let matchYear = true;
        let matchMonth = true;

        if (selectedYear && year !== selectedYear) {
          matchYear = false;
        }

        if (selectedMonth && month !== selectedMonth) {
          matchMonth = false;
        }

        return matchYear && matchMonth;
      });

      renderFilteredMonthsCards();
    }

    // Ù…Ø³Ø­ Ø§Ù„ØªØµÙÙŠØ©
    clearFilterBtn.onclick = function() {
      yearFilter.value = '';
      monthFilter.value = '';
      filteredMonthsList = [...monthsList];
      renderFilteredMonthsCards();
    };

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØµÙÙŠØ©
    yearFilter.onchange = applyFilter;
    monthFilter.onchange = applyFilter;

    if (addMonthBtn) {
      addMonthBtn.onclick = function(e) {
        e.preventDefault();
        console.log('Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡');
        monthModalOverlay.style.display = 'flex';
        if (monthModal) monthModal.reset();
        setTimeout(() => {
          const input = document.getElementById('monthNameInput');
          if (input) input.focus();
        }, 100);
      };
    }

    if (cancelMonthModalBtn) {
      cancelMonthModalBtn.onclick = function() {
        monthModalOverlay.style.display = 'none';
      };
    }
    if (monthModalOverlay) {
      monthModalOverlay.onclick = function(e) {
        if (e.target === this) this.style.display = 'none';
      };
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡ÙˆØ± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function fetchMonths() {
      try {
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        monthsCards.innerHTML = '<div style="text-align:center; font-size:1.1rem; color:#2e8ca3; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª...</div>';
        
        const res = await fetch('/monthly-pays');
        if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡ÙˆØ±');
        const data = await res.json();
        monthsList = data;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        renderMonthsCards();
        
        // Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙƒÙ„ Ø´Ù‡Ø± ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
        for (let i = 0; i < monthsList.length; i++) {
          monthsList[i].total = await getMonthTotal(monthsList[i].date);
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          renderMonthsCards();
        }
        
      } catch (err) {
        monthsList = [];
        renderMonthsCards();
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡ÙˆØ±: ' + err.message);
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ù‡Ø± Ù…Ø¹ÙŠÙ†
    async function getMonthTotal(monthDate) {
      try {
        const res = await fetch(`/pays?month=${encodeURIComponent(monthDate)}`);
        if (!res.ok) return 0;
        const pays = await res.json();
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙÙ‚Ø· Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù„ÙŠØ³ Ø§Ù„ÙÙˆØ§ØµÙ„)
        let total = 0;
        pays.forEach(pay => {
          if (!pay.isSeparator) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
            const extraTotal = Array.isArray(pay.extra) ? pay.extra.reduce((sum, r) => {
              const c = parseFloat(r.count) || 0;
              const v = parseFloat(r.value) || 0;
              return sum + (c * v);
            }, 0) : 0;
            
            total += (Number(pay.value) || 0) + extraTotal;
          }
        });
        
        return total;
      } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±:', err);
        return 0;
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯
    monthModal.onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('monthNameInput').value.trim();
      const date = document.getElementById('monthDateInput').value;
      if (!name || !date) return;
      
      const response = await fetch('/monthly-pays', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, date })
      });
      
      if (response.ok) {
        const result = await response.json();
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        await window.waitForNotificationSystem();
        if (window.sendNotification) {
          await window.sendNotification(
            'month-add',
            `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ù‚Ø¨Ø¶ Ø¬Ø¯ÙŠØ¯: ${name}`,
            'monthly-pay',
            result.monthId || ''
          );
        }
      }
      
      monthModalOverlay.style.display = 'none';
      await fetchMonths();
    };

    // Ø­Ø°Ù Ø´Ù‡Ø±
    async function deleteMonth(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ')) return;
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
      const month = monthsList.find(m => m._id === id);
      const monthName = month ? month.name : 'Ø´Ù‡Ø±';
      
      const response = await fetch('/monthly-pays/' + id, { method: 'DELETE' });
      
      if (response.ok) {
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        await window.waitForNotificationSystem();
        if (window.sendNotification) {
          await window.sendNotification(
            'month-delete',
            `ØªÙ… Ø­Ø°Ù Ø´Ù‡Ø± Ø§Ù„Ù‚Ø¨Ø¶: ${monthName}`,
            'monthly-pay',
            id
          );
        }
      }
      
      await fetchMonths();
    }

    function renderMonthsCards() {
      filteredMonthsList = [...monthsList]; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµÙØ§Ø©
      renderFilteredMonthsCards();
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØµÙØ§Ø©
    function renderFilteredMonthsCards() {
      monthsCards.innerHTML = '';
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØµÙØ§Ø©
      let grandTotal = 0;
      
      filteredMonthsList.forEach(m => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: #f8fafb;
          border: 2px solid #2e8ca3;
          border-radius: 0;
          padding: 12px 16px 10px 16px;
          min-width: 150px;
          min-height: 70px;
          box-shadow: 0 2px 8px #2e8ca311;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          font-family: 'Cairo', Arial, sans-serif;
          margin-bottom: 0;
          cursor: pointer;
          transition: box-shadow 0.15s, border-color 0.15s;
          position: relative;
        `;
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        const totalFormatted = (m.total || 0).toLocaleString();
        grandTotal += (m.total || 0);
        
        card.innerHTML = `
          <div style="font-size:1rem; font-weight:900; color:#1a3b50; margin-bottom:4px;">${m.name}</div>
          <div style="font-size:0.85rem; color:#2e8ca3; margin-bottom:6px;">${m.date}</div>
          <div style="font-size:0.9rem; font-weight:700; color:#28a745; background:#e8f5e8; padding:2px 6px; border-radius:3px; border:1px solid #28a745;">
            ${totalFormatted}
          </div>
          <button style="position:absolute; left:4px; top:4px; background:#e74c3c; color:#fff; border:none; border-radius:2px; padding:1px 4px; font-size:0.7rem; cursor:pointer;" onclick="event.stopPropagation(); deleteMonth('${m._id}')">Ã—</button>
        `;
        card.onclick = function() {
          window.location.href = `month-details.html?name=${encodeURIComponent(m.name)}&date=${encodeURIComponent(m.date)}`;
        };
        card.onmouseover = function() {
          card.style.boxShadow = "0 4px 16px #2e8ca344";
          card.style.borderColor = "#1a3b50";
        };
        card.onmouseout = function() {
          card.style.boxShadow = "0 2px 8px #2e8ca311";
          card.style.borderColor = "#2e8ca3";
        };
        monthsCards.appendChild(card);
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØµÙØ§Ø©
      updateGrandTotal(grandTotal, filteredMonthsList.length);
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…
    function updateGrandTotal(total, filteredCount) {
      const totalBar = document.getElementById('totalBar');
      const grandTotalElement = document.getElementById('grandTotal');
      
      if (monthsList.length > 0) {
        totalBar.style.display = 'block';
        grandTotalElement.textContent = total.toLocaleString();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ù„ÙŠÙˆØ¶Ø­ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØµÙØ§Ø© Ù…Ø¹ Ø§Ù„Ø³Ù†Ø©
        const titleElement = totalBar.querySelector('div:first-child');
        const selectedYear = yearFilter.value;
        const selectedMonth = monthFilter.value;
        
        let titleText = '';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØµÙÙŠØ©
        if (selectedYear || selectedMonth) {
          if (selectedYear && selectedMonth) {
            // ØªØ­Ø¯ÙŠØ¯ Ø³Ù†Ø© ÙˆØ´Ù‡Ø± Ù…Ø­Ø¯Ø¯ÙŠÙ†
            const monthNames = {
              '01': 'ÙŠÙ†Ø§ÙŠØ±', '02': 'ÙØ¨Ø±Ø§ÙŠØ±', '03': 'Ù…Ø§Ø±Ø³', '04': 'Ø£Ø¨Ø±ÙŠÙ„',
              '05': 'Ù…Ø§ÙŠÙˆ', '06': 'ÙŠÙˆÙ†ÙŠÙˆ', '07': 'ÙŠÙˆÙ„ÙŠÙˆ', '08': 'Ø£ØºØ³Ø·Ø³',
              '09': 'Ø³Ø¨ØªÙ…Ø¨Ø±', '10': 'Ø£ÙƒØªÙˆØ¨Ø±', '11': 'Ù†ÙˆÙÙ…Ø¨Ø±', '12': 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            };
            titleText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${monthNames[selectedMonth]} ${selectedYear}`;
          } else if (selectedYear && !selectedMonth) {
            // ØªØ­Ø¯ÙŠØ¯ Ø³Ù†Ø© ÙÙ‚Ø· Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±
            titleText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ù…ÙŠØ¹ Ø´Ù‡ÙˆØ± Ø³Ù†Ø© ${selectedYear} (${filteredCount} Ø´Ù‡Ø±)`;
          } else if (selectedMonth && !selectedYear) {
            // ØªØ­Ø¯ÙŠØ¯ Ø´Ù‡Ø± ÙÙ‚Ø·
            const monthNames = {
              '01': 'ÙŠÙ†Ø§ÙŠØ±', '02': 'ÙØ¨Ø±Ø§ÙŠØ±', '03': 'Ù…Ø§Ø±Ø³', '04': 'Ø£Ø¨Ø±ÙŠÙ„',
              '05': 'Ù…Ø§ÙŠÙˆ', '06': 'ÙŠÙˆÙ†ÙŠÙˆ', '07': 'ÙŠÙˆÙ„ÙŠÙˆ', '08': 'Ø£ØºØ³Ø·Ø³',
              '09': 'Ø³Ø¨ØªÙ…Ø¨Ø±', '10': 'Ø£ÙƒØªÙˆØ¨Ø±', '11': 'Ù†ÙˆÙÙ…Ø¨Ø±', '12': 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            };
            titleText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ù‡Ø± ${monthNames[selectedMonth]} (${filteredCount} Ù…Ù† ${monthsList.length})`;
          }
        } else {
          // Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙÙŠØ©
          titleText = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±';
        }
        
        titleElement.textContent = titleText;
      } else {
        totalBar.style.display = 'none';
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    fetchMonths();
  </script>
  <script>
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ sendNotification
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    // Ø±Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(s => s.parentNode.removeChild(s));
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>
</body>
</html>