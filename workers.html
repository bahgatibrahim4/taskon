<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ø§Ù„ | Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { direction: rtl; }
    body {
      margin: 0;
      font-family: 'Cairo', Arial, sans-serif;
      background: #c5d6db;
      min-height: 100vh;
      /* direction: rtl; */ /* ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ :root */
    }
    .navbar {
      background: #1a3b50;
      color: #fff;
      padding: 14px 0 10px 0;
      text-align: center;
      font-size: 1.6rem;
      font-weight: 900;
      letter-spacing: 2px;
      box-shadow: 0 2px 18px #1a3b5022;
      border-radius: 0 0 24px 24px;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 3px solid #2e8ca3;
    }
    .navbar .user-info {
      position: absolute;
      left: 32px;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      /* background: #2e8ca3; */ /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© */
      padding: 6px 18px;
      border-radius: 18px;
      box-shadow: 0 1px 6px #2e8ca322;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .container {
      max-width: 1200px; /* ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹ */
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px #1a3b5011, 0 1.5px 8px #c5d6dbcc;
      padding: 24px 18px 18px 18px;
      margin-top: 4px; /* Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø£Ø¹Ù„Ù‰ */
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .add-btn, .monthly-btn {
      border: 2px solid #2e8ca3;
      background: #fff;
      color: #1a3b50;
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 0.85rem; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
      padding: 3px 10px;  /* ØªØµØºÙŠØ± Ø§Ù„Ø­Ø´Ùˆ */
      border-radius: 0;
      cursor: pointer;
      margin-bottom: 0;
      transition: background 0.15s, color 0.15s, border 0.15s;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #2e8ca311;
      outline: none;
      display: inline-block;
    }
    .export-btn {
      border: 2px solid #27ae60;
      background: #27ae60;
      color: #fff;
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 0.85rem;
      font-weight: 900;
      padding: 3px 10px;
      border-radius: 0;
      cursor: pointer;
      margin-bottom: 0;
      margin-right: 6px;
      transition: background 0.15s, color 0.15s, border 0.15s;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #27ae6011;
      outline: none;
      display: inline-block;
    }
    .add-btn:hover, .add-btn:focus,
    .monthly-btn:hover, .monthly-btn:focus {
      background: #2e8ca3;
      color: #fff;
      border-color: #1a3b50;
    }
    .export-btn:hover, .export-btn:focus {
      background: #219150;
      color: #fff;
      border-color: #219150;
    }
    h1 {
      color: #1a3b50;
      text-align: center;
      margin-bottom: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
      font-size: 2rem;
      letter-spacing: 1px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
      background: #f8fafb;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 4px 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
      text-align: center;
      border-bottom: 1px solid #c5d6db;
      font-size: 0.95rem; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
    }
    th {
      background: #2e8ca3;
      color: #fff;
      font-weight: bold;
      font-size: 0.95rem;
      padding: 4px 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    }
    tr:last-child td {
      border-bottom: none;
    }
    .footer {
      text-align: center;
      color: #2e8ca3;
      font-size: 1.1rem;
      margin-top: 60px;
      padding-bottom: 18px;
      opacity: 0.8;
      letter-spacing: 1px;
      font-weight: 500;
      text-shadow: 0 1px 8px #2e8ca311;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #0006;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px #1a3b5044;
      padding: 28px 18px 18px 18px;
      min-width: 420px; /* ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹ */
      max-width: 99vw;
      width: 520px;     /* ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹ */
      position: relative;
      font-family: 'Cairo', Arial, sans-serif;
      direction: rtl;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-fields-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .modal-fields-row > div {
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .modal label {
      font-weight: 700;
      color: #1a3b50;
      margin-bottom: 4px;
      font-size: 1rem;
      display: block;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 4px 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
      border: 1.5px solid #c5d6db;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      margin-bottom: 8px;
      outline: none;
      transition: border 0.15s;
      height: 32px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
      box-sizing: border-box;
    }
    .modal input:focus, .modal select:focus {
      border-color: #2e8ca3;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 8px;
    }
    .modal-btn {
      border: none;
      background: #2e8ca3;
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      padding: 7px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .modal-btn.cancel {
      background: #c5d6db;
      color: #1a3b50;
    }
    .modal-btn:hover, .modal-btn:focus {
      background: #1a3b50;
      color: #fff;
    }
    .modal-btn.cancel:hover, .modal-btn.cancel:focus {
      background: #8c969a;
      color: #fff;
    }
    @media (max-width: 900px) {
      .container { max-width: 99vw; }
      .header-row h1 { font-size: 1.2rem; }
    }
    @media (max-width: 600px) {
      .container { padding: 10px 2px; }
      .header-row { flex-direction: column-reverse; align-items: stretch; gap: 6px; }
      .header-row h1 { font-size: 1.1rem; }
      th, td { font-size: 0.95rem; padding: 7px 2px; }
      .modal-fields-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div class="container" style="margin-top:4px;">
    <div class="header-actions" style="margin-bottom:18px; justify-content:space-between; display:flex; gap:10px; align-items:center;">
      <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙˆØ²Ø± ØªØµØ¯ÙŠØ± Excel Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ -->
      <div style="display:flex; gap:6px;">
        <button class="add-btn" id="addWorkerBtn" style="font-size:0.85rem; padding:3px 10px;">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="export-btn" id="exportExcelBtn" style="font-size:0.85rem; padding:3px 10px;">ØªØµØ¯ÙŠØ± Excel</button>
      </div>
      <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ -->
      <input
        type="text"
        id="searchInput"
        placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨"
        style="flex:1 1 320px; max-width:340px; min-width:180px; margin:0 18px; padding:6px 12px; border:1.5px solid #c5d6db; border-radius:8px; font-size:1rem; font-family:'Cairo',Arial,sans-serif;"
      >
      <button class="monthly-btn" id="monthlyPayBtn" style="font-size:0.85rem; padding:3px 10px;">Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
    </div>
    <!-- Ø­Ø°Ù Ø§Ù„Ø¹Ù†ÙˆØ§Ù† h1 Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->
    <table id="workersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø±Ù‚Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
          <th>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
          <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</th>
          <th>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ / Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</th>
          <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="workersTbody">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
      </tbody>
    </table>
  </div>
  <!-- Ù…Ø±Ø¨Ø¹ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ -->
  <div class="modal-overlay" id="modalOverlay">
    <form class="modal" id="workerForm" autocomplete="off">
      <div class="modal-fields-row">
        <div>
          <label for="workerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label>
          <input type="text" id="workerName" required>
        </div>
        <div>
          <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</label>
          <input type="date" id="startDate" required>
        </div>
      </div>
      <div class="modal-fields-row">
        <div>
          <label for="idNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
          <input type="text" id="idNumber" required pattern="\d+">
        </div>
        <div>
          <label for="workPlace">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
          <input type="text" id="workPlace" required>
        </div>
      </div>
      <div class="modal-fields-row">
        <div>
          <label for="supervisor">Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ / Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³</label>
          <input type="text" id="supervisor" required>
        </div>
        <div>
          <label for="workStatus">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„</label>
          <select id="workStatus" required>
            <option value="ÙŠØ¹Ù…Ù„">ÙŠØ¹Ù…Ù„</option>
            <option value="Ø¥Ø¬Ø§Ø²Ø©">Ø¥Ø¬Ø§Ø²Ø©</option>
            <option value="Ù…ÙˆÙ‚ÙˆÙ">Ù…ÙˆÙ‚ÙˆÙ</option>
            <option value="Ù…Ù†ØªÙ‡ÙŠ">Ù…Ù†ØªÙ‡ÙŠ</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn cancel" id="cancelModalBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="modal-btn">Ø­ÙØ¸</button>
      </div>
    </form>
  </div>
  <div class="footer">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2025 Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯
  </div>
  <!-- Ø£Ø¶Ù Ù…ÙƒØªØ¨Ø© SheetJS Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    if (!localStorage.getItem('user')) {
      window.location.href = 'login.html';
    }

    // Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ± Ø¨Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
    const pageUser = localStorage.getItem('user');
    if (pageUser) {
      try {
        const username = JSON.parse(pageUser).username || '';
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†ØµØ± userInfo Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ)
        const userInfoEl = document.getElementById('userInfo');
        if (userInfoEl && userInfoEl.childNodes[0]) {
          userInfoEl.childNodes[0].textContent = 'ğŸ‘¤ ' + username + ' ';
        }
      } catch {}
    }

    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        };
      }
      const addWorkerBtn = document.getElementById('addWorkerBtn');
      if (addWorkerBtn) {
        addWorkerBtn.onclick = function() {
          document.getElementById('modalOverlay').style.display = 'flex';
          document.getElementById('workerForm').reset();
          setTimeout(() => document.getElementById('workerName').focus(), 100);
        };
      }
      const monthlyPayBtn = document.getElementById('monthlyPayBtn');
      if (monthlyPayBtn) {
        monthlyPayBtn.onclick = function() {
          window.location.href = 'monthly-pay.html';
        };
      }
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      if (cancelModalBtn) {
        cancelModalBtn.onclick = function() {
          document.getElementById('modalOverlay').style.display = 'none';
        };
      }
      const modalOverlay = document.getElementById('modalOverlay');
      if (modalOverlay) {
        modalOverlay.onclick = function(e) {
          if (e.target === this) this.style.display = 'none';
        };
      }
      // Ø§Ù„Ø¨Ø­Ø«
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', renderWorkersTable);
      }
    });

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¹Ø±Ø¶Ù‡Ù… (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    let allWorkers = [];
    async function fetchWorkers() {
      try {
        const res = await fetch('/workers');
        if (!res.ok) {
          allWorkers = [];
          alert('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
          renderWorkersTable();
          return;
        }
        // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSON ÙØ¹Ù„Ø§Ù‹
        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          allWorkers = [];
          alert('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³Øª Ø¨ÙŠØ§Ù†Ø§Øª JSON');
          renderWorkersTable();
          return;
        }
        allWorkers = await res.json();
        renderWorkersTable();
      } catch (err) {
        allWorkers = [];
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø§Ù„: ' + err.message);
        renderWorkersTable();
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø«)
    function renderWorkersTable() {
      const tbody = document.getElementById('workersTbody');
      const q = document.getElementById('searchInput').value.trim();
      tbody.innerHTML = '';
      let filtered = allWorkers;
      if (q) {
        filtered = allWorkers.filter(w =>
          (w.name || '').includes(q) ||
          (w.place || '').includes(q) ||
          (w.supervisor || '').includes(q)
        );
      }
      filtered.forEach((w, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td>${w.name || ''}</td>
          <td>${w.date || ''}</td>
          <td>${w.idNum || ''}</td>
          <td>${w.place || ''}</td>
          <td>${w.supervisor || ''}</td>
          <td>${w.status || ''}</td>
          <td style="display:flex; justify-content:center; align-items:center; gap:2px;">
            <button class="edit-btn" data-id="${w._id}" style="background:none; border:none; padding:1px; cursor:pointer;" title="ØªØ¹Ø¯ÙŠÙ„">
              <svg width="16" height="16" viewBox="0 0 24 24" style="vertical-align:middle; fill:#2e8ca3;">
                <path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25zm14.71-10.04a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
              </svg>
            </button>
            <button class="delete-btn" data-id="${w._id}" style="background:none; border:none; padding:1px; cursor:pointer;" title="Ø­Ø°Ù">
              <svg width="16" height="16" viewBox="0 0 24 24" style="vertical-align:middle; fill:#a0522d;">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
      attachDeleteEvents();
      attachEditEvents();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯
    document.getElementById('workerForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('workerName').value.trim();
      const date = document.getElementById('startDate').value;
      const idNum = document.getElementById('idNumber').value.trim();
      const place = document.getElementById('workPlace').value.trim();
      const supervisor = document.getElementById('supervisor').value.trim();
      const status = document.getElementById('workStatus').value;
      const editId = document.getElementById('workerForm').getAttribute('data-edit-id');
      if (editId) {
        // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø§Ù…Ù„
        const res = await fetch('/workers/' + editId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, date, idNum, place, supervisor, status })
        });
        if (res.ok) {
          const result = await res.json();
          
          // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            await window.sendNotification(
              'worker-edit',
              `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„: ${name} - ${place}`,
              'workers',
              editId
            );
          }
          
          document.getElementById('workerForm').removeAttribute('data-edit-id');
          document.getElementById('modalOverlay').style.display = 'none';
          await fetchWorkers();
        } else {
          alert('ØªØ¹Ø°Ø± ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„!');
        }
      } else {
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯
        const res = await fetch('/workers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, date, idNum, place, supervisor, status })
        });
        if (res.ok) {
          const result = await res.json();
          
          // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            await window.sendNotification(
              'worker-add',
              `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯: ${name} - ${place}`,
              'workers',
              result.insertedId || ''
            );
          }
          
          document.getElementById('modalOverlay').style.display = 'none';
          await fetchWorkers();
        } else {
          alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ù„!');
        }
      }
    };

    // Ø­Ø°Ù Ø¹Ø§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    function attachDeleteEvents() {
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async function() {
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ')) {
            const id = btn.getAttribute('data-id');
            const worker = allWorkers.find(w => w._id === id);
            const workerName = worker ? worker.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            const res = await fetch('/workers/' + id, { method: 'DELETE' });
            
            if (res.ok) {
              // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ù„
              await window.waitForNotificationSystem();
              if (window.sendNotification) {
                await window.sendNotification(
                  'worker-delete',
                  `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ù„: ${workerName}`,
                  'workers',
                  id
                );
              }
            }
            
            await fetchWorkers();
          }
        };
      });
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¬Ø¯ÙŠØ¯)
    function attachEditEvents() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-id');
          const worker = allWorkers.find(w => w._id === id);
          if (!worker) return;
          document.getElementById('workerName').value = worker.name || '';
          document.getElementById('startDate').value = worker.date || '';
          document.getElementById('idNumber').value = worker.idNum || '';
          document.getElementById('workPlace').value = worker.place || '';
          document.getElementById('supervisor').value = worker.supervisor || '';
          document.getElementById('workStatus').value = worker.status || '';
          document.getElementById('modalOverlay').style.display = 'flex';
          document.getElementById('workerForm').setAttribute('data-edit-id', id);
          setTimeout(() => document.getElementById('workerName').focus(), 100);
        };
      });
    }

    // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Excel
    document.getElementById('exportExcelBtn').onclick = function() {
      const data = [
        ["Ø§Ù„Ø±Ù‚Ù…", "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„", "ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„", "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„", "Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ / Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³", "Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„"]
      ];
      let filtered = allWorkers;
      const q = document.getElementById('searchInput').value.trim();
      if (q) {
        filtered = allWorkers.filter(w =>
          (w.name || '').includes(q) ||
          (w.place || '').includes(q) ||
          (w.supervisor || '').includes(q)
        );
      }
      filtered.forEach((w, idx) => {
        data.push([
          idx + 1,
          w.name || '',
          w.date || '',
          w.idNum || '',
          w.place || '',
          w.supervisor || '',
          w.status || ''
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¹Ù…Ø§Ù„");
      XLSX.writeFile(wb, "workers.xlsx");
    };

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    fetchWorkers();
  </script>
  <script>
    // Ø±Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ sendNotification
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(s => s.parentNode.removeChild(s));
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      });
  </script>
</body>
</html>