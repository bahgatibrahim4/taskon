<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Cairo', Arial, sans-serif !important;
    }
    body{font-family:'Cairo',sans-serif;background:#f1f6f8;color:#213140;padding:1rem}
    .container{max-width:1100px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    h1{font-size:1.25rem;font-family:'Cairo',sans-serif}
    .btn{padding:0.5rem 0.9rem;border-radius:8px;border:none;cursor:pointer;font-family:'Cairo',sans-serif}
    .btn-primary{background:#197c91;color:#fff}
    .card{background:#fff;padding:1rem;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.06)}
    table{width:100%;border-collapse:collapse;margin-top:1rem;font-family:'Cairo',sans-serif}
    th,td{padding:0.6rem;border-bottom:1px solid #eef5f7;text-align:center;font-family:'Cairo',sans-serif}
    thead th{background:#f8fbfc;font-weight:800;font-family:'Cairo',sans-serif}
    .empty{padding:2rem;text-align:center;color:#6c7a80;font-family:'Cairo',sans-serif}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:9999}
    .modal.show{display:flex}
    .modal-card{width:900px;background:#fff;border-radius:8px;padding:1rem}
    .form-row{display:flex;gap:0.6rem;margin-bottom:0.6rem}
    .form-row input,.form-row textarea{flex:1;padding:0.45rem;border:1px solid #dbe7ea;border-radius:6px;font-family:'Cairo',sans-serif}
    .equipment-table td{text-align:right;font-family:'Cairo',sans-serif}
    .work-items-table th, .work-items-table td{text-align:center;font-family:'Cairo',sans-serif}
    .small{font-size:0.85rem;color:#6c7a80;font-family:'Cairo',sans-serif}
    .link{color:#197c91;text-decoration:none;font-family:'Cairo',sans-serif}
    .actions{display:flex;gap:0.4rem;justify-content:center}
    .icon-btn{padding:0.35rem 0.5rem;border-radius:6px;border:none;background:#f3f8f9;cursor:pointer;font-family:'Cairo',sans-serif}
    h3,h4,h5{font-family:'Cairo',sans-serif}
    input,textarea,button{font-family:'Cairo',sans-serif}
    
    /* Report cards styles */
    .reports-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:1rem}
    .report-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 12px rgba(0,0,0,0.08);border:1px solid #e9f0f2;transition:all 0.2s ease;cursor:pointer}
    .report-card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,0.12);border-color:#197c91}
    .report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.8rem}
    .report-number{font-size:1.1rem;font-weight:bold;color:#197c91}
    .report-date{font-size:0.85rem;color:#6c7a80}
    .report-title{font-size:0.95rem;margin-bottom:0.5rem;color:#213140}
    .report-meta{display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;color:#6c7a80}
    .report-actions{display:flex;gap:0.3rem;margin-top:0.8rem}
    .report-actions .btn{font-size:0.8rem;padding:0.3rem 0.6rem}
    .delete-btn{background:#e74c3c;color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
      <div>
        <button id="newReportBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>

    <div class="card">
      <div id="reportsList">
        <div class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</div>
      </div>
    </div>
  </div>

  <!-- Modal: Create Report -->
  <div id="reportModal" class="modal">
    <div class="modal-card" style="width:450px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid #e9f0f2">
        <h3 style="margin:0;color:#1a3b50">ğŸ“‹ Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <button id="closeModalX" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#6c7a80;padding:0;width:30px;height:30px;border-radius:50%;transition:all 0.2s">Ã—</button>
      </div>
      
      <form id="reportForm">
        <div style="margin-bottom:1.2rem">
          <label style="display:block;margin-bottom:0.5rem;color:#1a3b50;font-weight:600;font-size:0.95rem">Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
          <input id="reportNumber" type="text" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly style="width:100%;padding:0.7rem;border:2px solid #e1ecf4;border-radius:8px;font-family:'Cairo';font-size:0.95rem;background:#f8f9fa;cursor:not-allowed;box-sizing:border-box"/>
        </div>
        
        <div style="margin-bottom:1.5rem">
          <label style="display:block;margin-bottom:0.5rem;color:#1a3b50;font-weight:600;font-size:0.95rem">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="reportDate" type="date" required style="width:100%;padding:0.7rem;border:2px solid #e1ecf4;border-radius:8px;font-family:'Cairo';font-size:0.95rem;transition:border-color 0.2s;box-sizing:border-box"/>
        </div>

        <div style="display:flex;gap:0.8rem;justify-content:flex-end">
          <button type="button" id="cancelReportBtn" class="btn" style="background:#6c7a80;color:#fff;padding:0.6rem 1.2rem">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-primary" style="padding:0.6rem 1.2rem">âœ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://taskon-production.up.railway.app';

    // Fixed equipment list (rows as requested)
    const equipmentList = [
      'Ø³ÙŠØ§Ø±Ø©','Ø³ÙŠØ§Ø±Ø© Ù…ÙˆÙ‚Ø¹','Ø¨ÙˆÙƒÙ„ÙŠÙ†','ÙƒØ±ÙŠÙ†','Ù‚Ù„Ø§Ø¨','Ù…Ù‚Øµ Ø­Ø¯ÙŠØ¯','Ø«Ù†Ø§ÙŠØ© Ø­Ø¯ÙŠØ¯','ØµØ§Ø±ÙˆØ® ØªÙ‚Ø·ÙŠØ¹','Ø±ØµØ§ØµÙ‡','Ø¬Ø±ÙŠØ¯Ø±','ÙˆØ§ÙŠØª Ù…ÙŠØ§Ù‡','Ø³Ø·Ø­Ø© ÙˆÙ†Ø´','Ù…ÙˆØªÙˆØ± Ù„Ø±ÙØ¹ Ø§Ù„Ù…ÙŠØ§Ù‡','Ù…Ø§ÙƒÙŠÙ†Ø© Ù„Ø­Ø§Ù…','Ù‡Ø²Ø§Ø²','Ø¨ÙˆØ¨ ÙƒØ§Øª','Ù…ÙˆÙ„Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡','ØºØ·Ø§Ø³','Ø±Ø§ÙØ¹Ø©','ÙƒÙˆÙ…Ø¨Ø±ÙˆØ³Ø± Ù‡ÙˆØ§Ø¡','Ø´ÙŠÙˆÙ„','Ø¨Ù„Ø¯ÙˆØ²Ø±','Ø¬Ù‰ Ø³Ù‰ Ø¨Ù‰'
    ];

    // State
    let workItems = [];
    let reports = [];

    // Elements
    const reportsList = document.getElementById('reportsList');
    const newReportBtn = document.getElementById('newReportBtn');
    const reportModal = document.getElementById('reportModal');
    const reportNumber = document.getElementById('reportNumber');
    const reportDate = document.getElementById('reportDate');
    const reportForm = document.getElementById('reportForm');
    const cancelReportBtn = document.getElementById('cancelReportBtn');

    function formatDateISO(d){
      const dt = new Date(d);
      return dt.toISOString().split('T')[0];
    }

    function openModal(){
      // Generate next report number
      const nextNumber = (reports.length + 1).toString().padStart(4, '0');
      reportNumber.value = `DR-${nextNumber}`;
      reportDate.value = formatDateISO(new Date());
      reportModal.classList.add('show');
    }
    function closeModal(){ reportModal.classList.remove('show'); }

    newReportBtn.addEventListener('click', openModal);
    cancelReportBtn.addEventListener('click', closeModal);
    closeModalX.addEventListener('click', closeModal);

    // Save report with basic data and redirect to details page
    reportForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      const reportData = {
        reportNumber: reportNumber.value,
        date: reportDate.value,
        title: `ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${reportDate.value}`,
        workItems: [],
        equipment: {}
      };

      try{
        const res = await fetch(`${API_BASE_URL}/daily-reports`, { 
          method:'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        });
        
        if(res.ok){
          const result = await res.json();
          const newId = result.insertedId || result._id;
          closeModal();
          // Redirect to report details page
          window.location.href = `daily-report.html?id=${newId}`;
        } else { 
          const txt = await res.text(); 
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+ (txt||res.status)); 
        }
      }catch(err){ console.error(err); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
    });

    // Load reports list
    async function loadReports(){
      reportsList.innerHTML = '<div class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</div>';
      try{
        const res = await fetch(`${API_BASE_URL}/daily-reports`);
        if(!res.ok){ reportsList.innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø±Ù…Ø²: ${res.status})</div>`; return; }
        reports = await res.json();
        if(!reports.length){ 
          reportsList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†<br><small>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ ØªÙ‚Ø±ÙŠØ±</small></div>'; 
          return; 
        }
        
        // Display reports as cards
        reportsList.innerHTML = `<div class="reports-grid">${reports.map(r=>{
          const reportDate = new Date(r.date).toLocaleDateString('ar-EG');
          const workItemsCount = (r.workItems||[]).length;
          const photosCount = r.photoCount || 0;
          
          return `<div class="report-card" onclick="openReport('${r._id}')">
            <div class="report-header">
              <div class="report-number">${r.reportNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
              <div class="report-date">${reportDate}</div>
            </div>
            <div class="report-title">${r.title || 'ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ'}</div>
            <div class="report-meta">
              <span>ğŸ“‹ ${workItemsCount} Ø¨Ù†Ø¯ Ø¹Ù…Ù„</span>
              <span>ğŸ“· ${photosCount} ØµÙˆØ±Ø©</span>
            </div>
            <div class="report-actions">
              <button class="btn btn-primary" onclick="event.stopPropagation(); openReport('${r._id}')">Ø¹Ø±Ø¶</button>
              <button class="btn delete-btn" onclick="event.stopPropagation(); deleteReport('${r._id}')">Ø­Ø°Ù</button>
            </div>
          </div>`;
        }).join('')}</div>`;

      }catch(err){ 
        console.error(err); 
        reportsList.innerHTML = '<div class="empty">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>'; 
      }
    }

    // Open report in new tab
    function openReport(reportId) {
      window.open(`daily-report.html?id=${reportId}`, '_blank');
    }

    // Delete report function
    async function deleteReport(reportId) {
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ')) return;
      try {
        const res = await fetch(`${API_BASE_URL}/daily-reports/${reportId}`, { method:'DELETE' });
        if(res.ok) {
          loadReports();
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        } else {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
      } catch (err) {
        console.error(err);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    }

    // init
    loadReports();
  </script>
</body>
</html>