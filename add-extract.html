<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ù„Øµ | Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯</title>
  <!-- Ø®Ø· Tajawal Ù…Ù† Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="permissions-check.js"></script>
  <style>
    /* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø®Ø· Cairo Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯ */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
    
    /* ÙØ±Ø¶ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
    #topSaveDraftBtn, 
    button[type="submit"][form="extractForm"],
    button[type="submit"] {
      background: linear-gradient(135deg, #2e7d32, #1b5e20) !important;
      color: #fff !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
    }
    
    :root {
      direction: rtl;
      writing-mode: horizontal-tb;
      /* text-orientation: initial; // optional, add if needed */
    }
    body {
      margin: 0;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
      background: #c5d6db;
      height: 100vh;
      overflow: hidden;
    }
    .navbar {
      background: #1a3b50; /* Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
      color: #fff;
      padding: 10px 0;
      text-align: center;
      font-size: 1.15rem;
      font-weight: bold;
      box-shadow: 0 2px 12px #0001;
      letter-spacing: 1px;
      border-bottom: 3px solid #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
    }
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      background: #f7fafd;
      border-radius: 0;
      box-shadow: none;
      padding: 5px 0 5px 5px; /* Ø¥Ø²Ø§Ù„Ø© padding Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
      border: none;
      position: fixed;
      display: flex;
      gap: 6px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ¬ÙˆØ© */
      height: calc(100vh - 45px);
      overflow: hidden;
      top: 45px;
      left: 0;
      right: 0;
    }
    
    .main-content {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      height: 100%;
      padding-left: 6px; /* ØªÙ‚Ù„ÙŠÙ„ padding */
      order: 1; /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£ÙˆÙ„Ø§Ù‹ */
    }
    
    /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
    .operations-sidebar {
      width: 240px;
      background: #f7fafd;
      border: 2px solid #8c969a;
      border-radius: 8px 0 0 8px; /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„ÙŠØ³Ø±Ù‰ ÙÙ‚Ø· */
      padding: 8px;
      height: 100%;
      overflow-y: auto;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1); /* Ø¸Ù„ Ù…Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± */
      order: 2; /* Ù†Ù‚Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ */
      flex-shrink: 0;
      position: relative;
      margin-right: 0; /* Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    }
    
    .operations-sidebar h3 {
      margin: 0 0 8px 0;
      color: #7a5230;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
      background: #c5d6db;
      padding: 4px;
      border-radius: 6px;
    }
    
    .operation-item {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 0.75rem;
      line-height: 1.3;
      transition: all 0.2s ease;
    }
    
    .operation-item:hover {
      background: #f0f8ff;
      border-color: #22799b;
    }
    
    .operation-time {
      color: #666;
      font-size: 0.75rem;
      margin-bottom: 5px;
    }
    
    .operation-action {
      color: #333;
      font-weight: 500;
    }
    
    .operation-details {
      color: #555;
      font-size: 0.8rem;
      margin-top: 3px;
    }
    
    .operation-user {
      color: #2e7d32;
      font-size: 0.7rem;
      margin-top: 4px;
      font-weight: 500;
      border-top: 1px solid #e0e0e0;
      padding-top: 2px;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .operations-sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    h2 {
      text-align: right;
      margin-bottom: 18px;
      color: #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      font-size: 1.15rem;
      font-weight: bold;
      letter-spacing: 1px;
      margin-top: 0;
      padding-top: 0;
    }
    h3, .section-title {
      color: #7a5230; /* Ø¨Ù†ÙŠ */
      background: #c5d6db; /* ÙØ§ØªØ­ */
      margin: 24px 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: right;
      border-radius: 8px;
      padding: 8px;
    }
    .back {
      color: #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      display: block;
      margin: 0 auto 15px auto;
      text-align: center;
      text-decoration: underline;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
    }
    .row, .row.details-inline, .details-inline {
      background: #8c969a22; /* Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù */
      border-radius: 10px;
      padding: 7px 7px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #22799b;
    }
    .row.details-inline {
      display: flex;
      flex-wrap: nowrap !important;
      gap: 18px;
      margin-bottom: 10px;
      align-items: center;
      background: #e8f5e9;
      border-radius: 10px;
      padding: 5px 10px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #1b5e20;
      overflow-x: auto;
    }
    .row.details-inline .form-group {
      flex: none;
      min-width: 140px;
      margin-bottom: 0;
    }
    .row.details-inline label {
      font-size: 0.88rem;
      margin-bottom: 2px;
    }
    .row.details-inline input,
    .row.details-inline select {
      font-size: 0.88rem;
      padding: 4px 6px;
      min-width: 80px;
      max-width: 160px;
    }
    .form-group {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
    }
    .form-group label {
      color: #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .form-group input, .form-group select {
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1.2px solid #c5d6db;
      outline: none;
      transition: border-color 0.2s;
      background: #fff;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #2e8ca3;
      background: #c5d6db;
    }
    .sort-btns {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }
    .sort-btn {
      background: #fff;
      color: #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      border: 2px solid #2e8ca3;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: bold;
      padding: 3px 8px;
      cursor: pointer;
      box-shadow: 0 2px 10px #0001;
      transition: background 0.2s, color 0.2s, border 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sort-btn.active {
      background: #1a3b50;
      color: #fff;
    }
    .table-section {
      background: #c5d6db;
      border-radius: 10px;
      padding: 14px 8px;
      box-shadow: 0 2px 8px #1b5e2022;
      margin-bottom: 14px;
      border: 1.5px solid #8c969a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #f7fafd;
      margin-bottom: 8px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px #8c969a;
    }
    th, td {
      padding: 6px 2px;
      border-bottom: 1px solid #c5d6db;
      text-align: center;
      vertical-align: middle;
      font-size: 0.93rem;
      background: transparent;
      white-space: nowrap;
      word-break: break-word;
    }
    th {
      background: #2e8ca3 !important; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      color: #fff !important;
      font-weight: bold;
      font-size: 0.85rem; /* ØªÙ… Ø§Ù„ØªØµØºÙŠØ± Ù…Ù† 1rem Ø¥Ù„Ù‰ 0.85rem */
    }
    th.work-item-col, td.work-item-col,
    th.work-desc-col, td.work-desc-col {
      min-width: 55px !important;
      max-width: 110px !important;
      white-space: normal !important;
      word-break: break-word;
      width: auto !important;
      font-size: 0.95rem;
    }
    /* ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
    th[style*="min-width:0px;"], td[style*="min-width:20px;"] {
      min-width: 10px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†ÙŠ */
    }
    th.work-desc-col, td.work-desc-col {
      min-width: 180px !important;
      max-width: 350px !important;
      width: 220px !important;
      white-space: normal !important;
      word-break: break-word;
    }
    th[style*="min-width:12px;"], td[style*="min-width:12px;"] {
      min-width: 12px !important;
      max-width: 40px !important;
    }
    tr.group-row, tr.subgroup-row {
      height: 15px !important;
      min-height: 13px !important;
      font-size: 0.80rem !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      background: #8c969a !important; /* Ø±Ù…Ø§Ø¯ÙŠ */
      color: #fff;
      font-size: 1.08rem;
      font-weight: bold;
      border-bottom: 1.5px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
    }
    tr.subgroup-row {
      height: 16px !important;
      min-height: 14px !important;
      font-size: 0.90rem !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      background: #c5d6db !important; /* ÙØ§ØªØ­ */
      color: #1a3b50;
      font-size: 1.01rem;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
    }
    tr.work-row {
      background: #f7fafd;
      font-size: 0.82rem;
      color: #222;
      transition: box-shadow 0.18s, background 0.18s;
      border-radius: 10px;
      box-shadow: 0 1px 8px #e0e0e0;
    }
    tr.work-row:hover {
      background: #c5d6db;
      box-shadow: 0 2px 16px #b2dfdb;
    }
    tr.work-row td {
      border-bottom: 1px solid #e0e0e0;
      padding: 0 0;
      font-size: 0.75rem;
      height: 32px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
      background: transparent;
      transition: background 0.18s;
      text-align: center !important;
    }
    tr.work-row td:first-child {
      color: #2e8ca3;
      background: #c5d6db;
      border-radius: 10px 0 0 10px;
      box-shadow: 0 1px 4px #c8e6c9;
    }
    tr.work-row td:last-child {
      border-radius: 0 10px 10px 0;
    }
    tr.work-row input {
      width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c8e6c9;
      border-radius: 0px;
      padding: 4px 2px;
      font-size: 0.75rem;
      height: 28px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
      background: #fff;
      transition: border 0.18s, background 0.18s, box-shadow 0.18s;
      box-shadow: 0 1px 6px #e0e0e0;
      text-align: center;
    }
    .hidden-row { display: none; }
    input.total-percent-max {
      background: #7a5230 !important; /* Ø¨Ù†ÙŠ */
      color: #fff !important;
      border: 2px solid #7a5230 !important;
    }
    .add-row-btn {
      background: #2e8ca3;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: bold;
      padding: 2px 8px;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      height: 28px;
    }
    .add-row-btn:hover {
      background: #1a3b50;
    }
    .summary {
      background: #8c969a22;
      border-radius: 10px;
      border: 1.5px solid #8c969a;
      color: #7a5230;
      padding: 12px 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 6px #e0e0e0;
      font-size: 1.05rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
    }
    .summary-row, .highlight {
      background: #7a5230 !important; /* Ø¨Ù†ÙŠ */
      color: #fff !important;
      font-weight: bold;
    }
    .notes {
      border: 1px solid #2e8ca3;
      background: #c5d6db;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #1a3b50;
    }
    .signatures td {
      color: #1a3b50;
      border: none;
      padding: 8px;
      position: relative;
    }
    .signatures td:after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, #2e8ca3, transparent);
      bottom: 0;
      left: 0;
    }
    @media (max-width: 900px) {
      .container { padding: 8px; }
      .row { flex-direction: column; gap: 10px; padding: 10px 4px; }
      table { font-size: .92rem; }
      th, td { padding: 4px; }
      .summary { padding: 10px 6px; }
      .add-row-btn { padding: 6px 10px; font-size: 0.92rem; }
    }
    tr.work-row:nth-child(even) {
      background: #f7fafc !important;
    }
    tr.work-row:nth-child(odd) {
      background: #e8f5e9 !important;
    }
    .details-inline {
      display: flex;
      flex-wrap: nowrap !important;
      gap: 18px;
      margin-bottom: 10px;
      align-items: center;
      background: #e8f5e9;
      border-radius: 10px;
      padding: 5px 10px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #1b5e20;
      overflow-x: auto;
    }
    .details-pair {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 0;
    }
    .details-pair label {
      font-size: 0.85rem;
      color: #2e8ca3; /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      font-weight: 600;
      margin-bottom: 0;
      letter-spacing: 0.5px;
    }
    .details-pair input,
    .details-pair select {
      font-size: 0.85rem;
      padding: 3px 6px;
      min-width: 80px;
      max-width: 160px;
      border-radius: 6px;
      border: 1.2px solid #c5d6db;
      background: #fff;
    }
    /* ØªØµØºÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ù… ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙÙ‚Ø· */
    .details-inline, .details-pair {
      gap: 6px !important;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± - ØªØ£Ø«ÙŠØ±Ø§Øª Hover */
    #topSaveDraftBtn:hover,
    button[type="submit"]:hover, 
    button[type="submit"][form="extractForm"]:hover {
      background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(46,125,50,0.6) !important;
      letter-spacing: 0.8px !important;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
    }
    
    #saveDraftBtn:hover, #topSaveDraftBtn:hover {
      background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(46,125,50,0.6) !important;
      letter-spacing: 0.8px !important;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
    }
    
    button:active {
      transform: translateY(-1px) !important;
    }
    
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© */
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    #draftIndicator {
      background: linear-gradient(135deg, #4caf50, #388e3c) !important;
      box-shadow: 0 2px 8px rgba(76,175,80,0.3) !important;
    }
    
    .details-inline {
      padding: 2px 4px !important;
    }
    .details-pair label {
      font-size: 0.78rem !important;
      margin-bottom: 0 !important;
    }
    .details-pair input,
    .details-pair select {
      font-size: 0.78rem !important;
      padding: 2px 4px !important;
      min-width: 60px !important;
      max-width: 110px !important;
      height: 26px !important;
    }
    .details-pair {
      margin-bottom: 0 !important;
    }
    #extraWorksTable {
      width: 100%;
      border-collapse: collapse;
      background: #f7fafd;
      margin-bottom: 8px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px #8c969a;
    }
    #extraWorksTable th, #extraWorksTable td {
      padding: 6px 2px;
      border-bottom: 1px solid #c5d6db;
      text-align: center;
      vertical-align: middle;
      font-size: 0.93rem;
      background: transparent;
      white-space: nowrap;
      word-break: break-word;
    }
    #extraWorksTable th {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold;
      font-size: 0.85rem;
    }
    #extraWorksTable tr:last-child td {
      border-bottom: none;
    }
    #extraWorksTable tr:hover td {
      background: #c5d6db;
      transition: background 0.18s;
    }
    #extraWorksTable input {
      width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c8e6c9;
      border-radius: 0px;
      padding: 4px 2px;
      font-size: 0.75rem;
      height: 28px;
      background: #fff;
      transition: border 0.18s, background 0.18s, box-shadow 0.18s;
      box-shadow: 0 1px 6px #e0e0e0;
      text-align: center;
    }
    #extraWorksTable td:first-child {
      color: #2e8ca3;
      background: #c5d6db;
      border-radius: 10px 0 0 10px;
      box-shadow: 0 1px 4px #c8e6c9;
    }
    #extraWorksTable td:last-child {
      border-radius: 0 10px 10px 0;
    }
    #deductionsTable {
    width: 100%;
    border-collapse: collapse;
    background: #f7fafd;
    margin-bottom: 8px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px #8c969a;
  }
  #deductionsTable th, #deductionsTable td {
    padding: 6px 2px;
    border-bottom: 1px solid #c5d6db;
    text-align: center;
    vertical-align: middle;
    font-size: 0.93rem;
    background: transparent;
    white-space: nowrap;
    word-break: break-word;
  }
  #deductionsTable th {
    background: #2e8ca3 !important;
    color: #fff !important;
    font-weight: bold;
    font-size: 0.85rem;
  }
  #deductionsTable tr:last-child td {
    border-bottom: none;
  }
  #deductionsTable tr:hover td {
    background: #c5d6db;
    transition: background 0.18s;
  }
  #deductionsTable input {
    width: 100%;
    box-sizing: border-box;
    border: 1.5px solid #c8e6c9;
    border-radius: 0px;
    padding: 4px 2px;
    font-size: 0.75rem;
    height: 28px;
    background: #fff;
    transition: border 0.18s, background 0.18s, box-shadow 0.18s;
    box-shadow: 0 1px 6px #e0e0e0;
    text-align: center;
  }
  #deductionsTable td:first-child {
    color: #2e8ca3;
    background: #c5d6db;
    border-radius: 10px 0 0 10px;
    box-shadow: 0 1px 4px #c8e6c9;
  }
  #deductionsTable td:last-child {
    border-radius: 0 10px 10px 0;
  }
  /* ØªØ®ØµÙŠØµ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ø£Ø¹Ù…Ø§Ù„ Ø£Ø®Ø±Ù‰ */
  #otherWorksTable th.unit-col, #otherWorksTable td.unit-col,
  #otherWorksTable th.category-col, #otherWorksTable td.category-col,
  #otherWorksTable th.quantity-col, #otherWorksTable td.quantity-col {
    min-width: 38px !important;
    max-width: 60px !important;
    width: 50px !important;
  }
  #otherWorksTable th.work-desc-col, #otherWorksTable td.work-desc-col {
    min-width: 180px !important;
    max-width: 350px !important;
    width: 220px !important;
    white-space: normal !important;
    word-break: break-word;
  }
  /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚ÙÙˆÙ„Ø© */
  #otherWorksTable input.readonly-cell {
    background: #e8f5e9 !important;
    color: #7a5230 !important;
    cursor: not-allowed !important;
    font-weight: bold;
    border: 1.5px solid #7a5230 !important;
  }
  #dailyTable {
  border-radius: 12px;
  /* Ø§Ø­Ø°Ù Ø£Ùˆ Ø¹Ø·Ù„ Ø§Ù„Ù€ box-shadow */
  /* box-shadow: 0 2px 12px #8c969a; */
  background: #f7fafd;
  margin-bottom: 8px;
  width: 100%;
  /* Ø§Ø­Ø°Ù Ø£Ùˆ Ø¹Ø·Ù„ Ø§Ù„Ù€ border */
  /* border: 1.5px solid #8c969a; */
}
#dailyTable th, #dailyTable td {
  padding: 6px 2px;
  /* Ø§Ø­Ø°Ù Ø£Ùˆ Ø¹Ø·Ù„ Ø§Ù„Ù€ border-bottom */
  /* border-bottom: 1px solid #c5d6db; */
  text-align: center;
  vertical-align: middle;
  font-size: 0.93rem;
  background: transparent;
  white-space: nowrap;
  word-break: break-word;
}
#dailyTable th {
  background: #2e8ca3 !important;
  color: #fff !important;
  font-weight: bold;
  font-size: 0.85rem;
}
#dailyTable tr:last-child td {
  border-bottom: none;
}
#dailyTable tr:hover td {
  background: #c5d6db;
  transition: background 0.18s;
}
#dailyTable input {
  width: 100%;
  box-sizing: border-box;
  border: 1.5px solid #c8e6c9;
  border-radius: 0px;
  padding: 4px 2px;
  font-size: 0.75rem;
  height: 28px;
  background: #fff;
  transition: border 0.18s, background 0.18s, box-shadow 0.18s;
  box-shadow: 0 1px 6px #e0e0e0;
  text-align: center;
}
#dailyTable td:first-child {
  color: #2e8ca3;
  background: #c5d6db;
  border-radius: 10px 0 0 10px;
  box-shadow: 0 1px 4px #c8e6c9;
}
#dailyTable td:last-child {
  border-radius: 0 10px 10px 0;
}
#dailyTable tr:nth-child(even) {
  background: #f7fafc !important;
}
#dailyTable tr:nth-child(odd) {
  background: #e8f5e9 !important;
}
/* --- Ø§Ø¬Ø¹Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ù†ÙØ³ Ø§Ø³ØªØ§ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ --- */
#lumpSumTable {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px #8c969a;
  background: #f7fafd;
  margin-bottom: 8px;
  width: 100%;
}
#lumpSumTable th, #lumpSumTable td {
  padding: 6px 2px;
  border-bottom: 1px solid #c5d6db;
  text-align: center;
  vertical-align: middle;
  font-size: 0.93rem;
  background: transparent;
  white-space: nowrap;
  word-break: break-word;
}
#lumpSumTable th {
  background: #2e8ca3 !important;
  color: #fff !important;
  font-weight: bold;
  font-size: 0.85rem;
}
#lumpSumTable tr:last-child td {
  border-bottom: none;
}
#lumpSumTable tr:hover td {
  background: #c5d6db;
  transition: background 0.18s;
}
#lumpSumTable input {
  width: 100%;
  box-sizing: border-box;
  border: 1.5px solid #c8e6c9;
  border-radius: 0px;
  padding: 4px 2px;
  font-size: 0.75rem;
  height: 28px;
  background: #fff;
  transition: border 0.18s, background 0.18s, box-shadow 0.18s;
  box-shadow: 0 1px 6px #e0e0e0;
  text-align: center;
}
#lumpSumTable td:first-child {
  color: #2e8ca3;
  background: #c5d6db;
  border-radius: 10px 0 0 10px;
  box-shadow: 0 1px 4px #c8e6c9;
}
#lumpSumTable td:last-child {
  border-radius: 0 10px 10px 0;
}
#lumpSumTable tr:nth-child(even) {
  background: #f7fafc !important;
}
#lumpSumTable tr:nth-child(odd) {
  background: #e8f5e9 !important;
}
#dailyTable th[data-col="prev"],
#dailyTable th[data-col="current"],
#dailyTable th[data-col="total"],
#dailyTable th[data-col="prevAmount"],
#dailyTable th[data-col="currentAmount"],
#dailyTable th[data-col="totalAmount"],
#dailyTable td[data-col="prev"],
#dailyTable td[data-col="current"],
#dailyTable td[data-col="total"],
#dailyTable td[data-col="prevAmount"],
#dailyTable td[data-col="currentAmount"],
#dailyTable td[data-col="totalAmount"] {
  min-width: 70px !important;
  max-width: 100px !important;
  width: 80px !important;
  padding-left: 6px;
  padding-right: 6px;
}
#dailyTable th[data-col="dailyDesc"],
#dailyTable td[data-col="dailyDesc"] {
  min-width: 220px !important;
  max-width: 400px !important;
  width: 260px !important;
  white-space: normal !important;
  word-break: break-word;
}
    .btn-brown {
  background: #7a5230 !important;
  color: #fff !important;
  border: 1.2px solid #7a5230 !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  letter-spacing: 0.2px;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-brown:hover, .btn-brown:focus {
  background: #5d3f22 !important;
  color: #fff !important;
  border-color: #5d3f22 !important;
}
.btn-brown-outline {
  background: #fff !important;
  color: #7a5230 !important;
  border: 1.2px solid #7a5230 !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  letter-spacing: 0.2px;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-brown-outline:hover, .btn-brown-outline:focus {
  background: #7a5230 !important;
  color: #fff !important;
  border-color: #7a5230 !important;
}
/* Ø²Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø¶Ø± Ø¨Ù†ÙØ³ Ø§Ù„ØªØµØºÙŠØ± */
.btn-green {
  background: #388e3c !important;
  color: #fff !important;
  border: 1.2px solid #388e3c !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-green:hover, .btn-green:focus {
  background: #256c27 !important;
  border-color: #256c27 !important;
}
/* ØªØµØºÙŠØ± input Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ */
#maxTotalPercentInput {
  width: 38px !important;
  font-size: 0.82rem !important;
  padding: 2px 2px !important;
  height: 24px !important;
  border-radius: 4px !important;
}
/* ØªØµØºÙŠØ± span % */
#maxTotalPercentInput + span,
[for="maxTotalPercentInput"] {
  font-size: 0.82rem !important;
}
/* ØªØµØºÙŠØ± Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.shrink-btns-bar {
  gap: 4px !important;
}
.drag-handle {
  cursor: grab;
  display: inline-block;
  margin-left: 6px;
  font-size: 1.1em;
  color: #2e8ca3;
  user-select: none;
}
.drag-handle:active {
  cursor: grabbing;
  color: #7a5230;
}
  /* ...existing code... */
  .form-group input, .form-group select,
  .details-pair input, .details-pair select,
  input, select {
    font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
    font-weight: 600;
    letter-spacing: 0.2px;
    color: #111 !important; /* Ø®Ø· Ø£Ø³ÙˆØ¯ Ø³Ø§Ø¯Ø© */
    text-shadow: none !important; /* Ø£Ø²Ù„ Ø§Ù„Ø¸Ù„ */
    vertical-align: middle;
    font-style: normal !important; /* Ø£Ø²Ù„ Ø§Ù„Ù…ÙŠÙ„Ø§Ù† */
  }
  /* Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ readonly Ø£Ø³ÙˆØ¯ ÙˆØºÙŠØ± Ù…Ø§ÙŠÙ„ */
  input:read-only, input[readonly], .details-pair input:read-only, .details-pair input[readonly] {
    background: #e8f5e9 !important;
    color: #111 !important;
    cursor: not-allowed;
    font-style: normal !important;
    border: 1.5px solid #c5d6db;
  }
  
  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(3px);
  }
  
  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(46, 140, 163, 0.3);
    border-top: 4px solid #2e8ca3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  .loading-message {
    color: white;
    font-size: 18px;
    font-weight: bold;
    font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
    text-align: center;
    background: rgba(46, 140, 163, 0.9);
    padding: 15px 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Success Notification */
  .success-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
    text-align: center;
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    z-index: 10000;
    min-width: 300px;
    animation: successPop 0.5s ease-out;
  }
  
  @keyframes successPop {
    0% { 
      opacity: 0; 
      transform: translate(-50%, -50%) scale(0.7); 
    }
    100% { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1); 
    }
  }
  /* ...existing code... */
</style>
</head>
<body>
  <!-- Ø±Ø¨Ø· Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
  <div id="main-navbar"></div>
  <script>
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù…Ù† components/main-navbar.html
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ sendNotification
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-navbar').innerHTML = html;

        // Ù†ÙØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹
        document.querySelectorAll('#main-navbar script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });

        setTimeout(function() {
          if (typeof window.initMainNavbar === 'function') window.initMainNavbar();
          if (typeof window.updateNavbarUserName === 'function') window.updateNavbarUserName();
        }, 100);

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            const usernameInput = document.getElementById('extractUsername');
            if (usernameInput) usernameInput.value = user.username || '';
          } catch {}
        }
      });
  </script>
  <div class="container">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ - Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
    <div class="operations-sidebar">
      <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <div style="background:#e8f5e9; padding:4px; border-radius:4px; margin-bottom:6px; text-align:center; font-size:0.7rem; color:#2e7d32;">
        ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="currentUser">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>
      <div id="operationsContent">
        <div class="operation-item" style="text-align:center; color:#666; font-style:italic;">
          <div class="operation-action">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main-content">
      <!-- Ù„Ø§ÙØªØ© Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
      <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <h3 style="margin:0; color:#495057; font-size:1.0rem;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯</h3>
          <span id="topDraftIndicator" style="display:none; background:linear-gradient(135deg, #ff9800, #f57c00); color:#fff; padding:2px 10px; border-radius:16px; font-size:0.8rem; font-weight:bold; box-shadow:0 2px 6px rgba(255,152,0,0.3); animation:pulse 2s infinite;" title="ÙŠÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„">
            ğŸ“ Ù…Ø³ÙˆØ¯Ø©
          </span>
        </div>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
          <button type="button" id="topSaveDraftBtn" style="background:linear-gradient(135deg, #2e7d32, #1b5e20) !important; color:#fff !important; border:none; border-radius:6px; padding:8px 14px; font-family:'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; box-shadow:0 3px 8px rgba(46,125,50,0.3); transition:all 0.3s ease; min-width:110px; letter-spacing:0.3px; text-shadow:0 1px 2px rgba(0,0,0,0.1);">
            ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
          </button>
          <button type="submit" form="extractForm" style="background:linear-gradient(135deg, #2e7d32, #1b5e20) !important; color:#fff !important; border:none; border-radius:6px; padding:8px 14px; font-family:'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; box-shadow:0 3px 8px rgba(46,125,50,0.3); transition:all 0.3s ease; min-width:110px; letter-spacing:0.3px; text-shadow:0 1px 2px rgba(0,0,0,0.1);"
            data-permission="add-extract-create">
            âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
          </button>
        </div>
      </div>
    
    <h2 style="margin-top:0; padding-top:0; text-align:right; display:none;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="extractForm">
      <div class="details-inline">
        <div class="details-pair">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</label>
          <input name="date" type="date" id="extractDate" required>
        </div>
        <div class="details-pair">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ</label>
          <input name="number" type="number" id="statementNumber" readonly style="background:#e8f5e9;">
        </div>
        <div class="details-pair">
          <label>Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</label>
          <select id="workItemFilterSelect" required>
            <option value="">Ø§Ø®ØªØ± Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</option>
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¯ÙŠÙ†Ø§Ù…ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± -->
          </select>
        </div>
        <div class="details-pair">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</label>
          <div style="display:flex; align-items:center; gap:6px;">
            <select name="contractor" id="contractorSelect" required disabled>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>
            </select>
            <button type="button" id="refreshContractorsBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†" style="background:#fff; border:1px solid #388e3c; border-radius:5px; color:#388e3c; font-weight:bold; cursor:pointer; padding:2px 8px;">
              &#x21bb;
            </button>
          </div>
        </div>
        <div class="details-pair">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input name="username" type="text" id="extractUsername" required readonly>
        </div>
      </div>
      <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 24px; margin-bottom: 8px;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
          Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
          <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© -->
          <button type="button" id="addWorkItemRowBtn" title="Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯"
            style="background: #2e8ca3; color: #fff; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
            data-permission="add-extract-add-workitem">
            <i class="fa fa-plus"></i>
          </button>
        </h3>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button type="button" class="btn-brown" id="addLumpSumBtn" data-permission="add-extract-add-lump">Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©</button>
          <button type="button" class="btn-green" id="addDailyBtn" data-permission="add-extract-add-daily">Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ§Øª</button>
          <button type="button" class="btn-brown" id="addSeparatorBtn" data-permission="add-extract-create">+ Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„</button>
          <!-- Ø²Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø£Ø¹Ù…Ø§Ù„ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± (ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡) -->
          <!-- Ø­Ù‚Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ % Ù„ÙƒÙ„ Ø¨Ù†Ø¯: ØªÙ… Ù†Ù‚Ù„Ù‡ Ù‡Ù†Ø§ -->
          <div style="display:flex; align-items:center; gap:4px; margin-right:8px;">
            <label for="maxTotalPercentInput" style="font-weight:bold; color:#7a5230; font-size:0.82rem;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ % Ù„ÙƒÙ„ Ø¨Ù†Ø¯:</label>
            <input type="number" id="maxTotalPercentInput" value="100" min="1" max="100">
            <span style="color:#7a5230;">%</span>
          </div>
          <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© sort ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
          <div style="position: relative;">
            <button id="sortMenuBtn" type="button" style="background: #fff; border: 1.5px solid #2e8ca3; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <i class="fa fa-sort" style="color:#2e8ca3; font-size: 1.1rem;"></i>
            </button>
            <div id="sortMenu" style="display:none; position: absolute; left: 0; top: 38px; background: #fff; border: 1px solid #2e8ca3; border-radius: 8px; box-shadow: 0 2px 10px #0002; z-index: 10; min-width: 120px; padding: 6px;">
              <button type="button" id="sortByBuilding" class="sort-btn" style="width:100%; margin-bottom:4px;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
              <button type="button" id="sortByWorkItem" class="sort-btn" style="width:100%;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</button>
              <button type="button" id="sortByCurrentPercent" class="sort-btn" style="width:100%; margin-top:4px;">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ %</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Ø®Ø· ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ -->
      <hr style="border:0; border-top:2px solid #8c969a; margin: 0 0 18px 0; width:100%;">
      <div class="table-section">
        <table id="workItemsTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a;">
          <thead>
            <tr style="background: #2e8ca3;">
              <th style="background: #2e8ca3; min-width:32px;">Ù…</th>
              <th style="min-width:12px; max-width:40px;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th class="work-item-col">Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
              <th class="work-desc-col" style="min-width:180px; max-width:350px;">Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
              <th style="min-width:38px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th style="min-width:20px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th style="min-width:38px;">Ø§Ù„ÙØ¦Ø©</th>
              <th style="min-width:38px;">Ø§Ù„Ø³Ø§Ø¨Ù‚ %</th>
              <th style="min-width:38px;">Ø§Ù„Ø­Ø§Ù„ÙŠ %</th>
              <th style="min-width:38px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ %</th>
              <th style="min-width:38px;">Ø§Ù„Ø³Ø§Ø¨Ù‚ $</th>
              <th style="min-width:38px;">Ø§Ù„Ø­Ø§Ù„ÙŠ $</th>
              <th style="min-width:38px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ $</th>
              <th style="min-width:38px;">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="workItemsBody"></tbody>
          <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª -->
          <tfoot>
            <tr id="workItemsTotalRow" style="background:#e8f5e9; font-weight:bold;">
              <td colspan="10" style="text-align:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
              <td id="workItemsPrevAmountTotal" style="background:#c5d6db;">0</td>
              <td id="workItemsCurrentAmountTotal" style="background:#c5d6db;">0</td>
              <td id="workItemsTotalAmountTotal" style="background:#c5d6db;">0</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="14" style="padding:0; border:none;">
                <div style="display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:24px; margin:0; padding:10px 0 0 0;">
                  <div style="background:#ede7f6; border-radius:8px; padding:8px 24px; min-width:220px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 1px 6px #d1c4e9;">
                    <span style="color:#7a5230; font-weight:bold; font-size:1.05em;">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
                    <span id="workItemsGrandTotal" style="color:#2e8ca3; font-weight:bold; font-size:1.12em;"></span>
                  </div>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª -->
        <div id="lumpSumSection" style="display:none; margin-top:0;">
          <h3 class="section-title" style="margin-bottom:10px; margin-top:0; text-align:right; display:flex; align-items:center; gap:8px;">
            Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
            <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© -->
            <button type="button" id="addLumpSumRowBtn" title="Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯"
              style="background: #388e3c; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
              data-permission="add-extract-add-lump">
              <i class="fa fa-plus"></i>
            </button>
          </h3>
          <table id="lumpSumTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd;">
            <thead>
              <tr style="background: #2e8ca3;">
                <th style="background: #2e8ca3; min-width:32px;">Ù…</th>
                <th style="min-width:60px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù†Ù‰</th>
                <th style="min-width:120px;">Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
                <th style="min-width:90px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="min-width:80px;">Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª / Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©</th>
                <th style="min-width:80px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th style="min-width:80px;">Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù…</th>
                <th style="min-width:38px;">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="lumpSumBody"></tbody>
            <tfoot>
              <tr style="background:#e8f5e9; font-weight:bold;">
                <td colspan="5" style="text-align:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td id="lumpSumTotalCell" style="background:#c5d6db;">0</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <!-- Ø£Ø¶Ù Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ù‡Ù†Ø§ -->
        <div class="table-section" id="dailySection" style="display:none; margin-top:0;">
          <h3 id="dailyTitle" style="margin-top:0; margin-bottom:10px; text-align:right; display:flex; align-items:center; gap:8px;">
            ÙŠÙˆÙ…ÙŠØ§Øª
            <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© -->
            <button type="button" id="addDailyRowBtn" title="Ø¥Ø¶Ø§ÙØ© ØµÙ ÙŠÙˆÙ…ÙŠØ©"
              style="background: #388e3c; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
              data-permission="add-extract-add-daily">
              <i class="fa fa-plus"></i>
            </button>
          </h3>
          <div style="overflow-x:auto; max-width:100%;">
            <table id="dailyTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd; min-width:900px;">
              <thead>
                <tr style="background: #2e8ca3;">
                  <th style="background: #2e8ca3; min-width:32px;">Ù…</th>
                  <th data-col="dailyDesc" style="min-width:220px;">Ø¨ÙŠØ§Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª</th>
                  <th data-col="dailyCount" style="min-width:40px;">Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª</th>
                  <th data-col="dailyValue" style="min-width:50px;">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</th>
                  <th style="min-width:60px;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
                  <th data-col="prev" style="min-width:70px;">Ø§Ù„Ø³Ø§Ø¨Ù‚</th>
                  <th data-col="current" style="min-width:70px;">Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                  <th data-col="total" style="min-width:70px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th data-col="prevAmount" style="min-width:70px;">Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº</th>
                  <th data-col="currentAmount" style="min-width:70px;">Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº</th>
                  <th data-col="totalAmount" style="min-width:70px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº</th>
                  <th style="min-width:38px;">Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="dailyBody"></tbody>
              <tfoot>
                <tr style="background:#e8f5e9; font-weight:bold;">
                  <td colspan="8" style="text-align:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                  <td id="dailyPrevAmountTotal" style="background:#c5d6db;">0</td>
                  <td id="dailyCurrentAmountTotal" style="background:#c5d6db;">0</td>
                  <td id="dailyTotalAmountTotal" style="background:#c5d6db;">0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ù†Øª Ù‡Ù†Ø§ØŒ ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ø£Ø¹Ù„Ù‰ -->
        <!--
        <button type="button" class="add-row-btn" id="addLumpSumBtn" style="background:#7a5230;">Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·ÙˆØ¹ÙŠØ© / ÙŠÙˆÙ…ÙŠØ§Øª</button>
        <button type="button" class="add-row-btn" id="addDailyBtn" style="background:#388e3c;">Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ§Øª</button>
        <button type="button" class="add-row-btn" id="addSeparatorBtn" style="background:#7a5230;">+ Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„</button>
        -->
      </div>
      <!-- Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª -->
      <h3 style="display:flex; align-items:center; gap:8px;">
        <span>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª</span>
        <button type="button" id="toggleDeductionsBtn" style="background:#fff; border:1px solid #388e3c; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
          <span id="deductionsArrow" style="font-size:1.2rem; color:#388e3c;">&#x25BC;</span>
        </button>
      </h3>
      <div id="deductionsSection" class="table-section" style="background: #e3f2fd; border: 1px solid #90caf9; display:none;">
        <table id="deductionsTable" style="border-radius: 10px; overflow: hidden;">
          <thead>
            <tr style="background: #90caf9;">
              <th style="background: #42a5f5;">Ø¨ÙŠØ§Ù† Ø§Ù„Ø®ØµÙ…</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="deductionsBody"></tbody>
        </table>
        <button type="button" class="add-row-btn" id="addDeductionRowBtn" style="background: #42a5f5;">+ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <div class="summary" style="display: flex; justify-content: space-between; align-items: center; gap: 18px;">
        <div>
          <span>Ø§Ù„ØµØ§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
          <span id="beforeDeductions">0</span>
        </div>
        <div>
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
          <span id="totalDeductions">0</span>
        </div>
        <div>
          <span>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª:</span>
          <span id="afterDeductions">0</span>
        </div>
      </div>
    </form>
    <div class="table-section" id="lumpSumSection" style="display:none; margin-top:0;">
      <!-- ÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªÙƒØ±Ø§Ø± Ù„Ù„Ù‚Ø³Ù… (Ø§Ø­Ø°Ù Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠ) -->
      <table id="lumpSumTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd;">
        <thead>
          <tr style="background: #2e8ca3;">
            <th style="background: #2e8ca3; min-width:32px;">Ù…</th>
            <th style="min-width:60px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù†Ù‰</th>
            <th style="min-width:120px;">Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</th>
            <th style="min-width:90px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="min-width:80px;">Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª / Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©</th>
            <th style="min-width:80px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th style="min-width:80px;">Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù…</th>
            <th style="min-width:38px;">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="lumpSumBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-message">
      ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹
    </div>
  </div>
  
  <script>
    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    function showSuccessNotification(message) {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      const notification = document.createElement('div');
      notification.className = 'success-notification';
      notification.textContent = message;
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØµÙØ­Ø©
      document.body.appendChild(notification);
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }
    
    // Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø­Ø³Ø¨ Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„)
    async function loadContractors(workItem = null) {
      const select = document.getElementById('contractorSelect');
      const current = select.value;
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>';
      try {
        let url = '/contractors';
        if (workItem) {
          url += '?workItem=' + encodeURIComponent(workItem);
        }
        const res = await fetch(url);
        const contractors = await res.json();
        contractors.forEach(c => {
          const option = document.createElement('option');
          option.value = c._id || c.name;
          option.textContent = c.name;
          select.appendChild(option);
        });
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
        if (current) select.value = current;
      } catch (err) {
        alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±.');
      }
    }

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ØŒ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø§Ù„Ø®Ø§ØµÙŠÙ† Ø¨Ù‡ ÙÙ‚Ø·
    document.getElementById('workItemFilterSelect').addEventListener('change', function() {
      const workItem = this.value;
      const contractorSelect = document.getElementById('contractorSelect');
      if (workItem) {
        contractorSelect.disabled = false;
        loadContractors(workItem);
      } else {
        contractorSelect.disabled = true;
        contractorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>';
      }
      contractorSelect.value = '';
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†ØŒ Ø¬Ù„Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    document.getElementById('refreshContractorsBtn').onclick = function() {
      const workItem = document.getElementById('workItemFilterSelect').value;
      loadContractors(workItem);
    };

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù„Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)
    document.addEventListener('DOMContentLoaded', function() {
      const workItem = document.getElementById('workItemFilterSelect').value;
      const contractorSelect = document.getElementById('contractorSelect');
      if (!workItem) {
        contractorSelect.disabled = true;
        contractorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>';
      } else {
        contractorSelect.disabled = false;
        loadContractors(workItem);
      }
    });

    // Ø¬Ù„Ø¨ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    async function loadWorkItemsOptions() {
      const select = document.getElementById('workItemFilterSelect');
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</option>';
      try {
        const res = await fetch('/contractors');
        const contractors = await res.json();
        // Ø§Ø³ØªØ®Ø±Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© ÙÙ‚Ø·
        const workItemsSet = new Set();
        contractors.forEach(c => {
          if (c.workItem && typeof c.workItem === 'string' && c.workItem.trim()) {
            workItemsSet.add(c.workItem.trim());
          }
        });
        Array.from(workItemsSet).sort().forEach(workItem => {
          const option = document.createElement('option');
          option.value = workItem;
          option.textContent = workItem;
          select.appendChild(option);
        });
      } catch (err) {
        // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¨Ù‚Ù Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙ‚Ø·
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    document.addEventListener('DOMContentLoaded', async function() {
      await loadWorkItemsOptions();
      const workItem = document.getElementById('workItemFilterSelect').value;
      loadContractors(workItem);
    });

    let sortOrder = [];
    let groupsCollapsed = {};
    let workItems = [];
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø±Ù‘ÙØ© ÙÙŠ Ù…ÙˆØ§Ø¶Ø¹Ù‡Ø§ Ø§Ù„ØµØ­ÙŠØ­Ø©:
    // - lumpSumRows Ù…Ø¹Ø±Ù‘Ù ÙÙŠ Ø³Ø·Ø± 2185
    // - dailyRows Ù…Ø¹Ø±Ù‘Ù ÙÙŠ Ø³Ø·Ø± 2312
    // - Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ØªÙØ¬Ù…Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† #deductionsBody

    document.getElementById('sortByBuilding').addEventListener('click', function() {
      toggleSort('buildingNumber');
      renderWorkItems();
    });
    document.getElementById('sortByWorkItem').addEventListener('click', function() {
      toggleSort('workItem');
      renderWorkItems();
    });
    // Ø²Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ %
    document.getElementById('sortByCurrentPercent').addEventListener('click', function() {
      toggleSort('currentPercentFilter');
      renderWorkItems();
    });

    function toggleSort(field) {
      const idx = sortOrder.indexOf(field);
      if (idx === -1) {
        sortOrder.push(field);
        if (field === 'buildingNumber')
          document.getElementById('sortByBuilding').classList.add('active');
        else if (field === 'workItem')
          document.getElementById('sortByWorkItem').classList.add('active');
        else if (field === 'currentPercentFilter')
          document.getElementById('sortByCurrentPercent').classList.add('active');
      } else {
        sortOrder.splice(idx, 1);
        if (field === 'buildingNumber')
          document.getElementById('sortByBuilding').classList.remove('active');
        else if (field === 'workItem')
          document.getElementById('sortByWorkItem').classList.remove('active');
        else if (field === 'currentPercentFilter')
          document.getElementById('sortByCurrentPercent').classList.remove('active');
      }
      groupsCollapsed = {};
    }

    document.getElementById('contractorSelect').addEventListener('change', async function() {
      // ØªØ¬Ø§Ù‡Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©
      if (window.isLoadingDraft) return;
      
      const contractorId = this.value;
      const input = document.getElementById('statementNumber');
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
      if (contractorId) {
        try {
          const contractorRes = await fetch(`/contractors`);
          const contractors = await contractorRes.json();
          const contractor = contractors.find(c => c._id === contractorId);
          // Ø¬Ù„Ø¨ maxTotalPercentPerItem
          window.maxTotalPercentPerItem = contractor?.maxTotalPercentPerItem || {};
          document.getElementById('maxTotalPercentInput').value = contractor.maxTotalPercent || 100;
        } catch {
          window.maxTotalPercentPerItem = {};
          document.getElementById('maxTotalPercentInput').value = 100;
        }
        try {
          const res = await fetch(`/extracts?contractor=${contractorId}`);
          const extracts = await res.json();
          const filteredExtracts = extracts.filter(e => e.contractor == contractorId);
          input.value = filteredExtracts.length + 1;
          let prev = filteredExtracts.length > 0 ? filteredExtracts[filteredExtracts.length - 1] : null;

          // Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„: Ø§Ù„Ø­Ø§Ù„Ù‰ Ø¯Ø§Ø¦Ù…Ø§ ØµÙØ±
          if (prev && prev.workItems && prev.workItems.length > 0) {
            workItems = prev.workItems.map(item => ({
              ...item,
              prevPercent: item.totalPercent || '',
              prevAmount: item.totalAmount || '',
              currentPercent: '0',
              currentAmount: '0',
              totalPercent: item.totalPercent || '',
              totalAmount: item.totalAmount || ''
            }));
          } else {
            // Ù„Ø§ ØªÙ…Ø­Ùˆ workItems Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©
            if (!window.isLoadingDraft) {
              workItems = [];
            }
          }

          if (workItems.length === 0) {
            addWorkItemRow();
          }
          renderWorkItems();

          // Ù†Ø³Ø® Ø§Ù„Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
          lumpSumRows = [];
          if (prev && prev.lumpSumRows && prev.lumpSumRows.length > 0) {
            prev.lumpSumRows.forEach(row => {
              lumpSumRows.push({
                buildingsCount: row.buildingsCount,
                statementDesc: row.statementDesc,
                lumpSum: row.lumpSum,
                date: row.date,
                total: row.total,
                statementNumber: row.statementNumber || prev.number // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
              });
            });
            document.getElementById('lumpSumSection').style.display = '';
            renderLumpSumRows();
          } else {
            document.getElementById('lumpSumSection').style.display = 'none';
            lumpSumRows = [];
            renderLumpSumRows();
          }

          // ====== ØªØ±Ø­ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ======
          dailyRows = [];
          if (prev && Array.isArray(prev.dailyRows) && prev.dailyRows.length > 0) {
            // Ø±Ø­Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø³Ø§Ø¨Ù‚
            prev.dailyRows.forEach(row => {
              dailyRows.push({
                dailyDesc: row.dailyDesc || '',
                dailyCount: row.dailyCount || '',
                dailyValue: row.dailyValue || '',
                building: row.building || '',
                prev: row.total || '', // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚
                current: '',
                total: row.total || '', // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ø§Ù„Ø³Ø§Ø¨Ù‚ + Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø­Ø§Ù„ÙŠ ØµÙØ±)
                prevAmount: row.totalAmount || '', // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø§Ø¨Ù‚
                currentAmount: '',
                totalAmount: row.totalAmount || '' // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº = Ø§Ù„Ø³Ø§Ø¨Ù‚ + Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø­Ø§Ù„ÙŠ ØµÙØ±)
              });
            });
            document.getElementById('dailySection').style.display = '';
            renderDailyRows();
          } else {
            document.getElementById('dailySection').style.display = 'none';
            dailyRows = [];
            renderDailyRows();
          }
          // ====== Ù†Ù‡Ø§ÙŠØ© ØªØ±Ø­ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ======

        } catch {
          if (!window.isLoadingDraft) {
            input.value = '';
            workItems = [];
            addWorkItemRow();
            renderWorkItems();
            lumpSumRows = [];
            document.getElementById('lumpSumSection').style.display = 'none';
            renderLumpSumRows();
            dailyRows = [];
            document.getElementById('dailySection').style.display = 'none';
            renderDailyRows();
          }
        }
      } else {
        if (!window.isLoadingDraft) {
          input.value = '';
          workItems = [];
          addWorkItemRow();
          renderWorkItems();
          lumpSumRows = [];
          document.getElementById('lumpSumSection').style.display = 'none';
          renderLumpSumRows();
          // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ÙØ§Ø±Øº ÙˆÙ…Ø®ÙÙŠ
          dailyRows = [];
          document.getElementById('dailySection').style.display = 'none';
          renderDailyRows();
        }
      }
    });

    function addWorkItemRow() {
      workItems.push({
        buildingNumber: '',
        workItem: '',
        workDescription: '',
        quantity: '',
        unit: '',
        category: '',
        prevPercent: '',
        currentPercent: '',
        totalPercent: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      });
      renderWorkItems();
    }

    // ØªØ¹Ø¯ÙŠÙ„ addWorkItemRow Ù„ÙŠØ¶ÙŠÙ ØµÙ Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ØµÙ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„ÙØ§ØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± ØµÙ ÙØ§ØµÙ„
    function addWorkItemRow(afterIdx = null) {
      const newRow = {
        buildingNumber: '',
        workItem: '',
        workDescription: '',
        quantity: '',
        unit: '',
        category: '',
        prevPercent: '',
        currentPercent: '',
        totalPercent: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      };
      if (afterIdx !== null && afterIdx >= 0 && afterIdx < workItems.length) {
        workItems.splice(afterIdx + 1, 0, newRow);
      } else {
        workItems.push(newRow);
      }
      renderWorkItems();
    }

    // Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„
    document.getElementById('addSeparatorBtn').onclick = function() {
      const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ§ØµÙ„:');
      if (name && name.trim()) {
        workItems.push({ isSeparator: true, separatorName: name.trim() });
        renderWorkItems();
      }
    };

    // ØªØ¹Ø¯ÙŠÙ„ renderWorkItems Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙˆØ§ØµÙ„
    function renderWorkItems() {
      let items = [...workItems];
      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ %
      if (sortOrder.includes('currentPercentFilter')) {
        items = items.filter(item => item.currentPercent && item.currentPercent !== '0');
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø£Ùˆ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ØŒ Ø£Ø®ÙÙ Ø§Ù„ÙÙˆØ§ØµÙ„
      let hideSeparators = false;
      if (
        (sortOrder.length === 1 && (sortOrder[0] === 'buildingNumber' || sortOrder[0] === 'workItem')) ||
        (sortOrder.length === 2 && sortOrder.includes('buildingNumber') && sortOrder.includes('workItem'))
      ) {
        hideSeparators = true;
      }

      if (sortOrder.length > 0) {
        // ØªØ¬Ø§Ù‡Ù„ currentPercentFilter Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ ÙÙ‚Ø· Ù„Ù„ØªØµÙÙŠØ©
        let orderFields = sortOrder.filter(f => f !== 'currentPercentFilter');
        if (orderFields.length > 0) {
          items.sort((a, b) => {
            for (let field of orderFields) {
              if (a[field] < b[field]) return -1;
              if (a[field] > b[field]) return 1;
            }
            return 0;
          });
        }
      }

      let finalHtml = '';
      let rowNum = 1;

      // Ø¯Ø§Ù„Ø© Ù„Ø±Ø³Ù… ØµÙ Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ ÙØ§ØµÙ„
      function renderRowOrSeparator(item, idx, groupKey) {
        if (item.isSeparator) {
          if (hideSeparators) return ''; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨
          let hiddenClass = groupKey && groupsCollapsed[groupKey] ? "hidden-row" : "";
          return `
            <tr class="group-row ${hiddenClass}" style="background:#7a5230 !important; color:#fff; font-weight:bold; height:22px;">
              <td colspan="13" style="text-align:center; padding:2px 0; background:#7a5230 !important;">
                <span style="font-size:0.92rem; vertical-align:middle;">${item.separatorName || item.name || 'ÙØ§ØµÙ„'}</span>
              </td>
              <td style="text-align:center; background:#7a5230 !important; padding:0;">
                <button type="button" class="delete-separator-btn" data-idx="${idx}" title="Ø­Ø°Ù Ø§Ù„ÙØ§ØµÙ„"
                  style="background:none; color:#fff; border:none; border-radius:0; width:auto; height:auto; font-size:1.5rem; cursor:pointer; font-weight:bold; display:inline-block; vertical-align:middle; line-height:1; float:left;">
                  &times;
                </button>
              </td>
            </tr>
          `;
        } else {
          return workItemRowHtml(item, rowNum++, idx, groupKey);
        }
      }

      if (sortOrder.length === 2) {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø«Ù… Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
        let groups = {};
        items.forEach((item, idx) => {
          let building = item.buildingNumber || 'Ø¨Ø¯ÙˆÙ†';
          let workItem = item.workItem || 'Ø¨Ø¯ÙˆÙ†';
          if (!groups[building]) groups[building] = {};
          if (!groups[building][workItem]) groups[building][workItem] = [];
          groups[building][workItem].push({ item, idx });
        });

        for (let building in groups) {
          let groupKey1 = `g1_${building}`;
          let totalInGroup1 = Object.values(groups[building]).reduce((acc, arr) => acc + arr.length, 0);

          // ØµÙ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ/Ø§Ù„ÙØªØ­)
          finalHtml += `
            <tr class="group-row" data-group="${groupKey1}" style="height:20px;">
              <td colspan="13" style="text-align:right; cursor:pointer; background:#8c969a; color:#fff; font-weight:bold; font-size:.7rem; border-radius:10px 10px 0 0;">
                Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰: ${building} (${totalInGroup1})
                <span id="icon_${groupKey1}">${groupsCollapsed[groupKey1] ? "&#x25BC;" : "&#x25B2;"}</span>
              </td>
            </tr>
          `;

          for (let workItem in groups[building]) {
            let groupKey2 = `g2_${building}_${workItem}`;
            let subgroupHidden = groupsCollapsed[groupKey1] ? "hidden-row" : "";
            finalHtml += `
              <tr class="subgroup-row ${subgroupHidden}" data-group="${groupKey2}" data-parent="${groupKey1}" style="height:20px;">
                <td colspan="13" style="text-align:right; cursor:pointer; background:#c5d6db; color:#1a3b50; font-weight:bold; font-size:.7rem; border-radius:0 0 10px 10px;">
                  Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„: ${workItem} (${groups[building][workItem].length})
                  <span id="icon_${groupKey2}">${groupsCollapsed[groupKey2] ? "&#x25BC;" : "&#x25B2;"}</span>
                </td>
              </tr>
            `;
            // ØµÙÙˆÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ØªØ­Øª Ø§Ù„Ø¨Ù†Ø¯
            if (!groupsCollapsed[groupKey2] && !groupsCollapsed[groupKey1]) {
              groups[building][workItem].forEach(({ item, idx }) => {
                finalHtml += renderRowOrSeparator(item, idx, groupKey2);
              });
            }
          }
        }
      } else if (sortOrder.length === 1) {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø£Ùˆ Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙÙ‚Ø·
        let field = sortOrder[0];
        let groups = {};
        items.forEach((item, idx) => {
          let key = item[field] || 'Ø¨Ø¯ÙˆÙ†';
          if (!groups[key]) groups[key] = [];
          groups[key].push({ item, idx });
        });
        for (let g in groups) {
          let groupKey = `g_${g}`;
          finalHtml += `
            <tr class="group-row" data-group="${groupKey}">
              <td colspan="13" style="text-align:right; cursor:pointer;">
                <span style="font-weight:bold;">
                  ${field === 'buildingNumber' ? 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰: ' : 'Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„: '}${g} (${groups[g].length})
                  <span id="icon_${groupKey}">${groupsCollapsed[groupKey] ? "&#x25BC;" : "&#x25B2;"}</span>
                </span>
              </td>
            </tr>
          `;
          if (!groupsCollapsed[groupKey]) {
            groups[g].forEach(({ item, idx }) => {
              finalHtml += renderRowOrSeparator(item, idx, groupKey);
            });
          }
        }
      } else {
        // Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨
        items.forEach((item, idx) => {
          finalHtml += renderRowOrSeparator(item, idx, null);
        });
      }

      document.getElementById('workItemsBody').innerHTML = finalHtml;

      // Ù‚ÙÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
      let user = {};
      try { user = JSON.parse(localStorage.getItem('user')) || {}; } catch {}
      const perms = user.permissions || [];
      const canEditAll = perms.includes('add-extract-edit-all');
      const canEditCurrent = perms.includes('add-extract-edit-current');
      
      // Ù„Ø§ Ù†Ù‚ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ù†Ø§ - permissions-check.js ÙŠØªÙˆÙ„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø·ÙŠ/Ø§Ù„ÙØªØ­ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
      document.querySelectorAll('.group-row').forEach(el => {
        let groupKey = el.dataset.group;
        el.onclick = function() {
          groupsCollapsed[groupKey] = !groupsCollapsed[groupKey];
          renderWorkItems();
        }
      });
      document.querySelectorAll('.subgroup-row').forEach(el => {
        let groupKey = el.dataset.group;
        el.onclick = function(e) {
          e.stopPropagation();
          groupsCollapsed[groupKey] = !groupsCollapsed[groupKey];
          renderWorkItems();
        }
      });
      document.querySelectorAll('.work-item-input').forEach(input => {
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø­Ù‚Ù„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
          if (!window._lastWorkItemField) window._lastWorkItemField = {};
          window._lastWorkItemField[idx] = field;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
          workItems[idx][field] = e.target.value;
          
          // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
          updateTotalsRow(idx);
        };
      });
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø­Ø°Ù Ø§Ù„ÙØ§ØµÙ„
      document.querySelectorAll('.delete-separator-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          if (!isNaN(idx)) {
            workItems.splice(idx, 1);
            renderWorkItems();
          }
        };
      });
      updateTotalRowInTable();
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø±ÙŠÙƒ ØµÙ Ù„Ù„Ø£Ø¹Ù„Ù‰ (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙÙˆÙ‚ Ø§Ù„ÙØ§ØµÙ„)
    function moveRowUp(idx) {
      if (idx > 0) {
        [workItems[idx - 1], workItems[idx]] = [workItems[idx], workItems[idx - 1]];
        renderWorkItems();
        calculateSummary();
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø±ÙŠÙƒ ØµÙ Ù„Ù„Ø£Ø³ÙÙ„ (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ­Ø±ÙŠÙƒ ØªØ­Øª Ø§Ù„ÙØ§ØµÙ„)
    function moveRowDown(idx) {
      if (idx < workItems.length - 1) {
        [workItems[idx], workItems[idx + 1]] = [workItems[idx + 1], workItems[idx]];
        renderWorkItems();
        calculateSummary();
      }
    }

    // Ø¹Ø¯Ù„ Ø¯Ø§Ù„Ø© workItemRowHtml Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù…Ù‚Ø¨Ø¶ ÙˆÙ„ÙŠØ³ Ø§Ù„ØµÙ ÙƒÙ„Ù‡
    function workItemRowHtml(item, rowNum, idx, groupKey) {
      let hiddenClass = groupKey && groupsCollapsed[groupKey] ? "hidden-row" : "";

      // ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userStr = localStorage.getItem('user');
      const user = userStr ? JSON.parse(userStr) : {};
      const canEditAll = user.permissions && user.permissions.includes('add-extract-edit-all');
      const canEditWorkitem = user.permissions && user.permissions.includes('add-extract-edit-workitem');
      const canEditCurrent = user.permissions && user.permissions.includes('add-extract-create');
      const canMove = user.permissions && user.permissions.includes('add-extract-create');
      const canDelete = user.permissions && user.permissions.includes('add-extract-delete-workitem');
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ø¨Ù†Ø¯ (Ø¥Ù…Ø§ Ù…Ù‚ÙÙˆÙ„ Ø£Ùˆ Ù…Ø³Ø­ÙˆØ¨)
      const isLocked = item.locked || item.isPulled;
      const isPulledWork = item.isPulledWork; // Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±
      
      // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙÙ„ ÙˆÙ„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©
      let readonlyAttr = '';
      let readonlyAttrForPercentCurrent = '';
      let readonlyAttrForAmountCurrent = '';
      let lockMsg = '';
      let bgColor = '';
      
      if (item.isPulled) {
        // Ø¹Ù…Ù„ ØªÙ… Ø³Ø­Ø¨Ù‡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù‚ÙÙˆÙ„
        readonlyAttr = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        lockMsg = `title="ØªÙ… Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ø¥Ù„Ù‰ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡"`;
        bgColor = 'style="background:#ffe0e0;"';
      } else if (isPulledWork) {
        // Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù‚ÙÙˆÙ„Ø© Ù„ÙƒÙ† Ø§Ù„Ù†Ø³Ø¨Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…ØªØ§Ø­ÙŠÙ†
        readonlyAttr = 'readonly style="background:#e8f5e9;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = ''; // Ø®Ø§Ù†Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…ØªØ§Ø­Ø©
        readonlyAttrForAmountCurrent = ''; // Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…ØªØ§Ø­Ø©
        lockMsg = `title="Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† ${item.pulledFromContractorName || 'Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø±'} - ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·"`;
        bgColor = 'style="background:#e8f5e9;"';
      } else if (isLocked) {
        // Ù…Ù‚ÙÙˆÙ„ Ù„Ø³Ø¨Ø¨ Ø¢Ø®Ø±
        readonlyAttr = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        lockMsg = 'title="ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡"';
        bgColor = 'style="background:#ffe0e0;"';
      } else if (canEditAll || canEditWorkitem) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ - ÙƒÙ„ Ø´ÙŠØ¡ Ù…ØªØ§Ø­
        readonlyAttr = '';
        readonlyAttrForPercentCurrent = '';
        readonlyAttrForAmountCurrent = '';
        lockMsg = '';
        bgColor = '';
      } else if (canEditCurrent) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ ÙÙ‚Ø· - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù‚ÙÙˆÙ„ Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ
        readonlyAttr = 'readonly style="background:#fff3e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = ''; // Ø®Ø§Ù†Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…ØªØ§Ø­Ø©
        readonlyAttrForAmountCurrent = 'readonly style="background:#fff3e0;cursor:not-allowed;"'; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù‚ÙÙˆÙ„
        lockMsg = `title="ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·"`;
        bgColor = 'style="background:#fffef0;"';
      } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª - ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù‚ÙÙˆÙ„
        readonlyAttr = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        lockMsg = 'title="Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„"';
        bgColor = 'style="background:#fafafa;"';
      }

      return `
        <tr class="work-row ${hiddenClass}" ${groupKey ? `data-childof="${groupKey}"` : ""} data-idx="${idx}" ${bgColor}>
          <td title="Ø§Ø³Ø­Ø¨ Ù„ØªØºÙŠÙŠØ± ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙ" ${lockMsg}>
            <span class="drag-handle" draggable="true" data-idx="${idx}">&#9776;</span>
            ${rowNum}${isLocked ? ' ğŸ”’' : ''}${isPulledWork ? ' â¬…ï¸' : ''}${item.isPulled ? ' â¡ï¸' : ''}
          </td>
          <td><input name="buildingNumber" class="work-item-input" data-idx="${idx}" data-field="buildingNumber" value="${item.buildingNumber || ''}" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†ÙŠ" ${readonlyAttr}></td>
          <td><input name="workItem" class="work-item-input" data-idx="${idx}" data-field="workItem" value="${item.workItem || ''}" required placeholder="Ù…Ø«Ù„: 1Ø£ØŒ 1Ø¨ØŒ 2Ø£ØŒ 2Ø¨" ${readonlyAttr}></td>
          <td><input name="workDescription" class="work-item-input" data-idx="${idx}" data-field="workDescription" value="${item.workDescription || ''}" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„" ${readonlyAttr}></td>
          <td><input name="quantity" class="work-item-input" data-idx="${idx}" data-field="quantity" value="${item.quantity || ''}" type="number" step="any" required placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" ${readonlyAttr}></td>
          <td><input name="unit" class="work-item-input" data-idx="${idx}" data-field="unit" value="${item.unit || ''}" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø©" ${readonlyAttr}></td>
          <td><input name="category" class="work-item-input" data-idx="${idx}" data-field="category" value="${item.category || ''}" type="number" step="any" placeholder="Ø§Ù„ÙØ¦Ø©" ${readonlyAttr}></td>
          <td><input name="prevPercent" class="work-item-input" data-idx="${idx}" data-field="prevPercent" value="${item.prevPercent || ''}" type="number" step="any" placeholder="Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù†Ø³Ø¨Ø©" readonly style="background:#e5f8e5;"></td>
          <td><input name="currentPercent" class="work-item-input" data-idx="${idx}" data-field="currentPercent" value="${item.currentPercent || ''}" type="number" step="any" placeholder="Ø§Ù„Ø­Ø§Ù„ÙŠ Ù†Ø³Ø¨Ø©" ${readonlyAttrForPercentCurrent}></td>
          <td><input name="totalPercent" class="work-item-input" data-idx="${idx}" data-field="totalPercent" value="${item.totalPercent || ''}" type="number" step="any" readonly placeholder="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ø³Ø¨Ø©" style="background:#e5f8e5;"></td>
          <td><input name="prevAmount" class="work-item-input" data-idx="${idx}" data-field="prevAmount" value="${item.prevAmount || ''}" type="number" step="any" placeholder="Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº" readonly style="background:#e5f8e5;"></td>
          <td><input name="currentAmount" class="work-item-input" data-idx="${idx}" data-field="currentAmount" value="${item.currentAmount || ''}" type="number" step="any" placeholder="Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº" ${readonlyAttrForAmountCurrent}></td>
          <td><input name="totalAmount" class="work-item-input" data-idx="${idx}" data-field="totalAmount" value="${item.totalAmount || ''}" type="number" step="any" readonly placeholder="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº" style="background:#e5f8e5;"></td>
          <td>
            ${canDelete && !(isLocked && !isPulledWork) ? `
              <button type="button" class="delete-work-row" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button>
            ` : ''}
            ${canMove && !(isLocked && !isPulledWork) ? `
              <button type="button" class="move-up-row" data-idx="${idx}" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰" style="background:#fff; color:#388e3c; border:1px solid #388e3c; border-radius:5px; padding:2px 6px; margin-right:2px; cursor:pointer;">&#8593;</button>
              <button type="button" class="move-down-row" data-idx="${idx}" title="ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„" style="background:#fff; color:#388e3c; border:1px solid #388e3c; border-radius:5px; padding:2px 6px; margin-right:2px; cursor:pointer;">&#8595;</button>
            ` : ''}
          </td>
        </tr>
      `;
    }

    // ğŸ¯ Ø§Ù„Ø­Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹ Hybrid: Ø­Ø³Ø§Ø¨ Ø°ÙƒÙŠ Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº)
    function updateTotalsRow(idx) {
      let item = workItems[idx];
      let quantity = parseFloat(item.quantity) || 0;
      let category = parseFloat(item.category) || 0;
      const totalItemValue = quantity * category; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ù†Ø¯

      // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ %
      let maxTotalPercent = parseFloat(document.getElementById('maxTotalPercentInput')?.value) || 100;

      // Ù…Ø¹Ø±ÙØ© Ø¢Ø®Ø± Ø­Ù‚Ù„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡
      if (!window._lastWorkItemField) window._lastWorkItemField = {};
      let lastField = window._lastWorkItemField[idx];
      
      // ğŸ†• ØªØªØ¨Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ… Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      if (!window._autoCalculatedFields) window._autoCalculatedFields = {};
      if (!window._autoCalculatedFields[idx]) window._autoCalculatedFields[idx] = {};

      // ğŸ”§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„ÙØ¦Ø©: Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚% Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº Ø§Ù„Ø«Ø§Ø¨Øª
      if (lastField === 'quantity' || lastField === 'category') {
        const prevAmount = parseFloat(item.prevAmount) || 0;
        if (totalItemValue > 0 && prevAmount > 0) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚% = (Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº / Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) Ã— 100
          item.prevPercent = ((prevAmount / totalItemValue) * 100).toFixed(2);
          window._autoCalculatedFields[idx].prevPercent = true;
        }
        
        // ğŸ”§ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ% ÙˆØ§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø«Ø§Ø¨Øª
        const currentAmount = parseFloat(item.currentAmount) || 0;
        if (totalItemValue > 0 && currentAmount > 0) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ% = (Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº / Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) Ã— 100
          item.currentPercent = ((currentAmount / totalItemValue) * 100).toFixed(2);
          window._autoCalculatedFields[idx].currentPercent = true;
        }
      }

      if (lastField === 'currentAmount') {
        let currentAmount = parseFloat(item.currentAmount) || 0;
        let percent = 0;
        if (totalItemValue !== 0) {
          percent = (currentAmount / totalItemValue) * 100;
        }
        item.currentPercent = +percent.toFixed(2);
        item.currentAmount = currentAmount.toFixed(2);
        window._autoCalculatedFields[idx].currentPercent = true;
      } else if (lastField === 'currentPercent') {
        // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ% Ù…Ø¨Ø§Ø´Ø±Ø©
        let current = parseFloat(item.currentPercent) || 0;
        item.currentAmount = ((totalItemValue * current) / 100).toFixed(2);
        window._autoCalculatedFields[idx].currentAmount = true;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
      const prevPercent = parseFloat(item.prevPercent) || 0;
      const currentPercent = parseFloat(item.currentPercent) || 0;
      item.totalPercent = +(prevPercent + currentPercent).toFixed(2);
      
      if (item.totalPercent > maxTotalPercent && maxTotalPercent > 0) {
        item.totalPercent = maxTotalPercent;
        // Ø¹Ø¯Ù„ currentPercent Ø¨Ø­ÙŠØ« Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
        item.currentPercent = Math.max(0, (maxTotalPercent - prevPercent)).toFixed(2);
        item.currentAmount = ((totalItemValue * (item.currentPercent || 0)) / 100).toFixed(2);
        window._autoCalculatedFields[idx].currentPercent = true;
        window._autoCalculatedFields[idx].currentAmount = true;
      }
      
      item.totalAmount =
        ((parseFloat(item.prevAmount) || 0) +
        (parseFloat(item.currentAmount) || 0)).toFixed(2);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
      let rowInputs = document.querySelectorAll('.work-item-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        let field = input.dataset.field;
        if (field === 'prevPercent') {
          input.value = item.prevPercent || '';
          // ğŸ¨ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (window._autoCalculatedFields[idx]?.prevPercent) {
            input.style.background = '#e3f2fd';
            input.title = 'âœ¨ Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº Ø§Ù„Ø«Ø§Ø¨Øª';
          }
        }
        if (field === 'currentPercent') {
          input.value = item.currentPercent || '';
          // ğŸ¨ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ† - Ø®Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù†Ø³Ø¨Ø© Ø¨Ù„ÙˆÙ† Ø«Ø§Ø¨Øª
          // if (window._autoCalculatedFields[idx]?.currentPercent) {
          //   input.style.background = '#e3f2fd';
          //   input.title = 'âœ¨ Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
          // }
        }
        if (field === 'totalPercent') {
          input.value = item.totalPercent || '';
        }
        if (field === 'currentAmount') {
          input.value = item.currentAmount || '';
          // ğŸ¨ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (window._autoCalculatedFields[idx]?.currentAmount) {
            input.style.background = '#e3f2fd';
            input.title = 'âœ¨ Ù…Ø­Ø³ÙˆØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
          }
        }
        if (field === 'totalAmount') input.value = item.totalAmount || '';
      });

      updateTotalRowInTable();
      calculateSummary();
    }

    document.getElementById('addWorkItemRowBtn').addEventListener('click', addWorkItemRow);

    function addDeductionRow() {
      const tbody = document.getElementById('deductionsBody');
      const userStr = localStorage.getItem('user');
      let username = '';
      if (userStr) {
        try {
          username = JSON.parse(userStr).username || '';
        } catch {}
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="position:relative; overflow:visible;">
          <button type="button" class="show-materials-btn" title="Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø§Ø¯Ø©" style="background:none; border:none; cursor:pointer; font-size:1.2em; color:#2e8ca3; margin-left:2px;">&#x25BC;</button>
          <input name="deductionStatement" style="width:70%;" autocomplete="off">
          <div class="materials-dropdown" style="display:none; position:fixed; left:0; top:0; z-index:99999; background:#fff; border:1px solid #2e8ca3; border-radius:7px; min-width:180px; max-width:350px; box-shadow:0 2px 12px #0002; max-height:320px; overflow:auto;"></div>
        </td>
        <td><input name="deductionDate" type="date"></td>
        <td><input name="deductionQuantity" type="number" step="any"></td>
        <td><input name="deductionCategory" type="number" step="any"></td>
        <td><input name="deductionTotal" type="number" step="any" readonly></td>
        <td><input name="deductionUser" value="${username}" readonly style="background:#e8f5e9;"></td>
        <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø¬Ù…Ø§Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„ÙØ¦Ø©
      const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
      const catInput = tr.querySelector('input[name="deductionCategory"]');
      const totalInput = tr.querySelector('input[name="deductionTotal"]');
      const dateInput = tr.querySelector('input[name="deductionDate"]');
      
      function updateDeductionTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const cat = parseFloat(catInput.value) || 0;
        totalInput.value = (qty * cat).toFixed(2);
        calculateSummary();
      }
      qtyInput.addEventListener('input', updateDeductionTotal);
      catInput.addEventListener('input', updateDeductionTotal);
      
      // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø§Ø¯Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
      dateInput.addEventListener('change', function() {
        if (tr.dataset.materialName) {
          tr.dataset.materialDate = this.value;
        }
      });

      // Ø²Ø± Ø§Ù„Ø³Ù‡Ù… Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯
      const showBtn = tr.querySelector('.show-materials-btn');
      const dropdown = tr.querySelector('.materials-dropdown');
      const statementInput = tr.querySelector('input[name="deductionStatement"]');
      showBtn.onclick = async function(e) {
        e.stopPropagation();
        dropdown.innerHTML = '<div style="padding:8px; color:#888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        dropdown.style.display = 'block';

        // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù† ÙˆÙ„ÙŠØ³ Ø§Ù„Ø²Ø±
        const rect = statementInput.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 2) + 'px';
        dropdown.style.width = rect.width + 'px';

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
        const contractorId = document.getElementById('contractorSelect')?.value;
        if (!contractorId) {
          dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>';
          return;
        }
        try {
          const res = await fetch(`/contractors/${contractorId}`);
          const contractor = await res.json();
          // ÙÙ‚Ø· Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ Ù„Ù… ØªØ®ØµÙ… Ø¨Ø¹Ø¯ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡Ø§ deductedInExtractNumber)
          const availableMaterials = (contractor.materials || []).filter(mat => !mat.deductedInExtractNumber);
          if (!availableMaterials.length) {
            dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø®ØµÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>';
            return;
          }
          dropdown.innerHTML = availableMaterials.map((mat, i) => `
            <div class="material-option" data-name="${mat.name}" data-qty="${mat.quantity}" data-category="${mat.unitPrice || mat.category || ''}" style="padding:7px 12px; cursor:pointer; border-bottom:1px solid #eee;">
              <b>${mat.name}</b> <span style="color:#7a5230;">(${mat.quantity} ${mat.unit || ''})</span>
            </div>
          `).join('');
          dropdown.querySelectorAll('.material-option').forEach(opt => {
            opt.onclick = async function() {
              statementInput.value = opt.dataset.name;
              qtyInput.value = opt.dataset.qty;
              catInput.value = opt.dataset.category || '';
              dropdown.style.display = 'none';
              updateDeductionTotal();
              
              // Ù„Ø§ ØªØ®ØµÙ… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¢Ù†ØŒ ÙÙ‚Ø· Ø§Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
              tr.dataset.materialName = opt.dataset.name;
              tr.dataset.materialDate = tr.querySelector('input[name="deductionDate"]')?.value || '';
            };
          });
        } catch {
          dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯</div>';
        }
      };

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
      document.addEventListener('click', function(e) {
        if (dropdown && dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== showBtn) {
          dropdown.style.display = 'none';
        }
      });
    }
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø«
    const addDeductionRowBtn = document.getElementById('addDeductionRowBtn');
    if (addDeductionRowBtn) {
      addDeductionRowBtn.addEventListener('click', addDeductionRow);
    }

    addWorkItemRow();
    addDeductionRow();

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    document.getElementById('deductionsSection').style.display = 'none';
    document.getElementById('deductionsArrow').textContent = 'â–¼';

    document.getElementById('toggleDeductionsBtn').onclick = function() {
      const section = document.getElementById('deductionsSection');
      const arrow = document.getElementById('deductionsArrow');
      if (section.style.display === 'none') {
        section.style.display = '';
        arrow.textContent = 'â–²';
      } else {
        section.style.display = 'none';
        arrow.textContent = 'â–¼';
      }
    };

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    document.addEventListener('DOMContentLoaded', function() {
      const sortMenuBtn = document.getElementById('sortMenuBtn');
      const sortMenu = document.getElementById('sortMenu');
      sortMenuBtn.onclick = function(e) {
        e.stopPropagation();
        sortMenu.style.display = sortMenu.style.display === 'block' ? 'none' : 'block';
      };
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
      document.addEventListener('click', function(e) {
        if (sortMenu.style.display === 'block') sortMenu.style.display = 'none';
      });
      // Ù…Ù†Ø¹ ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¯Ø§Ø®Ù„Ù‡Ø§
      sortMenu.onclick = function(e) { e.stopPropagation(); };
      
      // ğŸ¯ Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø­Ù‚ÙˆÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
      setupSmartCalculationSystem();
    });
    
    // ğŸ¯ Ø§Ù„Ø­Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹ Hybrid: Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function setupSmartCalculationSystem() {
      document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('work-item-input')) return;
        
        const field = e.target.dataset.field;
        const idx = parseInt(e.target.dataset.idx);
        
        if (!workItems[idx] || workItems[idx].isSeparator) return;
        
        // ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ø­Ù‚Ù„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡
        if (!window._lastWorkItemField) window._lastWorkItemField = {};
        window._lastWorkItemField[idx] = field;
        
        // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        workItems[idx][field] = e.target.value;
        
        // ğŸ”” Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø°ÙŠØ± ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ
        if (field === 'quantity' || field === 'category') {
          const currentPercent = parseFloat(workItems[idx].currentPercent) || 0;
          const prevPercent = parseFloat(workItems[idx].prevPercent) || 0;
          
          // âœ… Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ø®Ù„ "Ø§Ù„Ø­Ø§Ù„ÙŠ%" â†’ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
          if (currentPercent > 0) {
            updateTotalsRow(idx);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 60px;
              left: 50%;
              transform: translateX(-50%);
              background: #4caf50;
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              z-index: 10000;
              font-size: 0.9rem;
              animation: slideDown 0.3s ease;
            `;
            notification.textContent = `âœ¨ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ${field === 'quantity' ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Ø§Ù„ÙØ¦Ø©'} Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.style.animation = 'slideUp 0.3s ease';
              setTimeout(() => notification.remove(), 300);
            }, 2000);
          }
          // âš ï¸ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ¯Ø®Ù„ "Ø§Ù„Ø­Ø§Ù„ÙŠ%" Ø¨Ø¹Ø¯ â†’ ØªÙ†Ø¨ÙŠÙ‡
          else {
            // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø·ÙŠÙ
            const warning = document.createElement('div');
            warning.style.cssText = `
              position: fixed;
              top: 60px;
              left: 50%;
              transform: translateX(-50%);
              background: #ff9800;
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              z-index: 10000;
              font-size: 0.9rem;
              animation: slideDown 0.3s ease;
            `;
            warning.innerHTML = `âš ï¸ ÙŠÙÙØ¶Ù„ Ø¥Ø¯Ø®Ø§Ù„ <b>Ø§Ù„Ø­Ø§Ù„ÙŠ %</b> Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØºÙŠÙŠØ± ${field === 'quantity' ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Ø§Ù„ÙØ¦Ø©'}`;
            document.body.appendChild(warning);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ù…Ù† Ø­Ù‚Ù„ "Ø§Ù„Ø­Ø§Ù„ÙŠ%" - Ø®Ù„ÙŠÙ†Ø§Ù‡ Ø¨Ù„ÙˆÙ† Ø«Ø§Ø¨Øª
            // const currentPercentInput = document.querySelector(`.work-item-input[data-idx="${idx}"][data-field="currentPercent"]`);
            // if (currentPercentInput) {
            //   currentPercentInput.style.background = '#fff3cd';
            //   currentPercentInput.style.border = '2px solid #ff9800';
            //   
            //   setTimeout(() => {
            //     currentPercentInput.style.background = '';
            //     currentPercentInput.style.border = '';
            //   }, 3000);
            // }
            
            setTimeout(() => {
              warning.style.animation = 'slideUp 0.3s ease';
              setTimeout(() => warning.remove(), 300);
            }, 3000);
          }
        }
        // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ% Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ
        else if (field === 'currentPercent' || field === 'currentAmount') {
          updateTotalsRow(idx);
        }
      });
      
      // Ø¥Ø¶Ø§ÙØ© CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { top: -50px; opacity: 0; }
          to { top: 60px; opacity: 1; }
        }
        @keyframes slideUp {
          from { top: 60px; opacity: 1; }
          to { top: -50px; opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙÙˆÙ
    document.addEventListener('click', function(e) {
     
      if (e.target.classList.contains('move-up-row')) {
        const idx = parseInt(e.target.dataset.idx);
        moveRowUp(idx);
      }
      if (e.target.classList.contains('move-down-row')) {
        const idx = parseInt(e.target.dataset.idx);
        moveRowDown(idx);
      }
    });

    // Ø­Ø°Ù ØµÙ Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-deduction-row')) {
        const tr = e.target.closest('tr');
        if (tr) tr.remove();
        calculateSummary();
      }
    });

    // Ø­Ø°Ù ØµÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-work-row')) {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        const userStr = localStorage.getItem('user');
        const user = userStr ? JSON.parse(userStr) : {};
        const canDelete = user.permissions && user.permissions.includes('add-extract-delete-workitem');
        
        if (!canDelete) {
          alert('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„');
          return;
        }
        
        const idx = parseInt(e.target.dataset.idx);
        if (!isNaN(idx) && idx >= 0 && idx < workItems.length) {
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) {
            workItems.splice(idx, 1);
            renderWorkItems();
            updateTotalRowInTable();
            calculateSummary();
          }
        }
      }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    let lumpSumRows = [];

    // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    document.getElementById('addLumpSumBtn').onclick = function() {
     
     
      document.getElementById('lumpSumSection').style.display = '';
      if (lumpSumRows.length === 0) addLumpSumRow();
      renderLumpSumRows();
    };

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function addLumpSumRow() {
      // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
      let statementNumber = document.getElementById('statementNumber')?.value || '';
      lumpSumRows.push({
        buildingsCount: '',
        statementDesc: '',
        lumpSum: '',
        date: '',
        total: '',
        statementNumber: statementNumber
      });
      renderLumpSumRows();
    }

    // Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function renderLumpSumRows() {
      let html = '';
      // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
      let currentStatementNumber = parseInt(document.getElementById('statementNumber')?.value || '0');
      lumpSumRows.forEach((row, idx) => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ© Ù…Ù† Ù…Ø³ØªØ®Ù„Øµ Ø³Ø§Ø¨Ù‚ (statementNumber Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ)
        let isPrev = parseInt(row.statementNumber) < currentStatementNumber;
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="buildingsCount" value="${row.buildingsCount || ''}" style="width:60px" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="text" class="lump-input" data-idx="${idx}" data-field="statementDesc" value="${row.statementDesc || ''}" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="date" class="lump-input" data-idx="${idx}" data-field="date" value="${row.date || ''}" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="lumpSum" value="${row.lumpSum || ''}" placeholder="Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª / Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="total" value="${row.total || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="text" class="lump-input" data-idx="${idx}" data-field="statementNumber" value="${row.statementNumber || ''}" readonly style="background:#f5f5f5;"></td>
            <td>
              ${isPrev ? '' : `<button type="button" class="delete-lump-row-btn" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button>`}
            </td>
          </tr>
        `;
      });
      document.getElementById('lumpSumBody').innerHTML = html;

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø­Ø°Ù
      document.querySelectorAll('.lump-input').forEach(input => {
        // Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ readonly
        if (input.hasAttribute('readonly')) return;
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨
          lumpSumRows[idx][field] = e.target.value;
          
          if (field === 'buildingsCount' || field === 'lumpSum') updateLumpSumRow(idx);
          updateLumpSumTotalRow();
        };
      });
      document.querySelectorAll('.delete-lump-row-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          lumpSumRows.splice(idx, 1);
          if (lumpSumRows.length === 0) {
            // Ø£Ø®ÙÙ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚ ØµÙÙˆÙ
            document.getElementById('lumpSumSection').style.display = 'none';
          }
          renderLumpSumRows();
          updateLumpSumTotalRow(); // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        };

      });
    }

    // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function updateLumpSumRow(idx) {
      const row = lumpSumRows[idx];
      row.total = ((parseFloat(row.lumpSum) || 0) * (parseFloat(row.buildingsCount) || 0)).toFixed(2);
      let rowInputs = document.querySelectorAll('.lump-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        if (input.dataset.field === 'total') input.value = row.total || '';
      });
    }

    // Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©/Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    document.getElementById('addLumpSumRowBtn').onclick = addLumpSumRow;

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯, ØªØ±Ø­Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
    document.getElementById('contractorSelect').addEventListener('change', function() {
      // ØªØ¬Ø§Ù‡Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©
      if (window.isLoadingDraft) return;
      
      const contractorId = this.value;
      if (contractorId) {
        fetch(`/extracts?contractor=${contractorId}`)
          .then(res => res.json())
          .then(extracts => {
            const filteredExtracts = extracts.filter(e => e.contractor == contractorId);
            if (filteredExtracts.length > 0) {
              // Ø®Ø° Ø¢Ø®Ø± Ù…Ø³ØªØ®Ù„Øµ ÙˆØ£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
              const lastExtract = filteredExtracts[filteredExtracts.length - 1];
              if (lastExtract.lumpSumRows && lastExtract.lumpSumRows.length > 0) {
                lastExtract.lumpSumRows.forEach(row => {
                  lumpSumRows.push({
                    buildingsCount: row.buildingsCount,
                    statementDesc: row.statementDesc,
                    lumpSum: row.lumpSum,
                    date: row.date,
                    total: row.total,
                    statementNumber: row.statementNumber || prev.number // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
                  });
                });
                renderLumpSumRows();
              }
            }
          });
      }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    let dailyRows = [];

    // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    document.getElementById('addDailyBtn').onclick = function() {
      document.getElementById('dailySection').style.display = '';
      if (dailyRows.length === 0) addDailyRow();
      renderDailyRows();
    };

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function addDailyRow() {
      dailyRows.push({
        dailyDesc: '',
        dailyCount: '',
        dailyValue: '',
        building: '',
        prev: '',
        current: '',
        total: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      });
      renderDailyRows();
    }

    // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ ÙŠÙˆÙ…ÙŠØ©
    document.getElementById('addDailyRowBtn').onclick = addDailyRow;

    // Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function renderDailyRows() {
      let html = '';
      dailyRows.forEach((row, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td><input type="text" class="daily-input" data-idx="${idx}" data-field="dailyDesc" value="${row.dailyDesc || ''}" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="dailyCount" value="${row.dailyCount || ''}" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="dailyValue" value="${row.dailyValue || ''}" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©"></td>
            <td><input type="text" class="daily-input" data-idx="${idx}" data-field="building" value="${row.building || ''}" placeholder="Ø§Ù„Ù…Ø¨Ù†Ù‰"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="prev" value="${row.prev || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="current" value="${row.current || ''}" placeholder="Ø§Ù„Ø­Ø§Ù„ÙŠ"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="total" value="${row.total || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="prevAmount" value="${row.prevAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="currentAmount" value="${row.currentAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="totalAmount" value="${row.totalAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td>
              <button type="button" class="delete-daily-row-btn" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });
      document.getElementById('dailyBody').innerHTML = html;

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø­Ø°Ù
      document.querySelectorAll('.daily-input').forEach(input => {
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
          dailyRows[idx][field] = e.target.value;
          
          // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£Ù‰ Ø­Ù‚Ù„ Ù…Ø¤Ø«Ø± (Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø£Ùˆ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ) Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù„Øº
          if (['dailyCount', 'dailyValue', 'current'].includes(field)) {
            updateDailyRow(idx);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨
            let row = dailyRows[idx];
            let rowInputs = document.querySelectorAll('.daily-input[data-idx="' + idx + '"]');
            rowInputs.forEach(input2 => {
              let f = input2.dataset.field;
              if (f === 'total') input2.value = row.total || '';
              if (f === 'prevAmount') input2.value = row.prevAmount || '';
              if (f === 'currentAmount') input2.value = row.currentAmount || '';
              if (f === 'totalAmount') input2.value = row.totalAmount || '';
            });
            updateDailyTotalRow();
          }
        };
      });
      document.querySelectorAll('.delete-daily-row-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          dailyRows.splice(idx, 1);
          if (dailyRows.length === 0) {
            // Ø£Ø®ÙÙ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚ ØµÙÙˆÙ
            document.getElementById('dailySection').style.display = 'none';
          }
          renderDailyRows();
        };
      });
    }

    // Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
    function updateDailyRow(idx) {
      const row = dailyRows[idx];
      // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ø§Ù„Ø³Ø§Ø¨Ù‚ + Ø§Ù„Ø­Ø§Ù„ÙŠ
      row.total = (parseFloat(row.prev) || 0) + (parseFloat(row.current) || 0);
      // Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº = Ø§Ù„Ø³Ø§Ø¨Ù‚ * Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
      row.prevAmount = ((parseFloat(row.prev) || 0) * (parseFloat(row.dailyValue) || 0)).toFixed(2);
      // Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº = Ø§Ù„Ø­Ø§Ù„ÙŠ * Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
      row.currentAmount = ((parseFloat(row.current) || 0) * (parseFloat(row.dailyValue) || 0)).toFixed(2);
      // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº = Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ù„Øº + Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº
      row.totalAmount = (parseFloat(row.prevAmount) + parseFloat(row.currentAmount)).toFixed(2);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
      let rowInputs = document.querySelectorAll('.daily-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        let field = input.dataset.field;
        if (field === 'total') input.value = row.total || '';
        if (field === 'prevAmount') input.value = row.prevAmount || '';
        if (field === 'currentAmount') input.value = row.currentAmount || '';
        if (field === 'totalAmount') input.value = row.totalAmount || '';
      });

      calculateSummary(); // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨ÙÙˆØ§ØµÙ„ (Ù…Ù‚Ø±Ø¨Ø© Ù„Ø±Ù‚Ù…ÙŠÙ† Ø¹Ø´Ø±ÙŠÙŠÙ†)
function formatNumberWithCommas(num) {
  num = Number(num) || 0;
  return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === Ø£Ø¶Ù Ù‡Ù†Ø§ ===
function calculateSummary() {
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„)
  let workCurrent = 0;
  if (Array.isArray(workItems)) {
    workItems.forEach(item => {
      if (!item.isSeparator) workCurrent += parseFloat(item.currentAmount) || 0;
    });
  }
  
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
  let lumpSumTotal = 0;
  if (Array.isArray(lumpSumRows)) {
    lumpSumRows.forEach(row => {
      lumpSumTotal += parseFloat(row.total) || 0;
    });
  }
  
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª (Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·)
  let dailyCurrentTotal = 0;
  if (Array.isArray(dailyRows)) {
    dailyRows.forEach(row => {
      dailyCurrentTotal += parseFloat(row.currentAmount) || 0;
    });
  }

  // Ø§Ù„ØµØ§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª = Ù…Ø¬Ù…ÙˆØ¹ (Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ + Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª + Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  let beforeDeductions = workCurrent + lumpSumTotal + dailyCurrentTotal;

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
  let totalDeductions = 0;
  document.querySelectorAll('#deductionsBody tr').forEach(tr => {
    const totalInput = tr.querySelector('input[name="deductionTotal"]');
    if (totalInput) totalDeductions += parseFloat(totalInput.value) || 0;
  });

  // Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª = Ø§Ù„ØµØ§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª - Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
  let afterDeductions = beforeDeductions - totalDeductions;

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  document.getElementById('beforeDeductions').textContent = formatNumberWithCommas(beforeDeductions);
  document.getElementById('totalDeductions').textContent = formatNumberWithCommas(totalDeductions);
  document.getElementById('afterDeductions').textContent = formatNumberWithCommas(afterDeductions);
}

    // ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© updateTotalRowInTable ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
    function updateTotalRowInTable() {
      let totalQuantity = 0, totalCategory = 0, totalPrevPercent = 0, totalCurrentPercent = 0, totalTotalPercent = 0;
      let totalPrevAmount = 0, totalCurrentAmount = 0, totalTotalAmount = 0;
      let grandTotal = 0;
      if (typeof workItems !== 'undefined' && Array.isArray(workItems)) {
        workItems.forEach(item => {
          if (!item.isSeparator) {
            totalQuantity += parseFloat(item.quantity) || 0;
            totalCategory += parseFloat(item.category) || 0;
            totalPrevPercent += parseFloat(item.prevPercent) || 0;
            totalCurrentPercent += parseFloat(item.currentPercent) || 0;
            totalTotalPercent += parseFloat(item.totalPercent) || 0;
            totalPrevAmount += parseFloat(item.prevAmount) || 0;
            totalCurrentAmount += parseFloat(item.currentAmount) || 0;
            totalTotalAmount += parseFloat(item.totalAmount) || 0;
            grandTotal += (parseFloat(item.quantity) || 0) * (parseFloat(item.category) || 0);
          }
        });
      }
      // ØªØ­Ø¯ÙŠØ« ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø·
      const totalRow = document.getElementById('workItemsTotalRow');
      if (totalRow) {
        totalRow.innerHTML = `
          <td colspan="4" style="font-weight:bold;text-align:center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
          <td>${formatNumberWithCommas(totalQuantity)}</td>
          <td></td>
          <td>${formatNumberWithCommas(totalCategory)}</td>
          <td>${formatNumberWithCommas(totalPrevPercent)}</td>
          <td>${formatNumberWithCommas(totalCurrentPercent)}</td>
          <td>${formatNumberWithCommas(totalTotalPercent)}</td>
          <td id="workItemsPrevAmountTotal">${formatNumberWithCommas(totalPrevAmount)}</td>
          <td id="workItemsCurrentAmountTotal">${formatNumberWithCommas(totalCurrentAmount)}</td>
          <td id="workItemsTotalAmountTotal">${formatNumberWithCommas(totalTotalAmount)}</td>
          <td></td>
        `;
      }
      // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
      const grandTotalSpan = document.getElementById('workItemsGrandTotal');
      if (grandTotalSpan) {
        grandTotalSpan.textContent = formatNumberWithCommas(grandTotal);
      }
    }    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª (Ø¬Ù…Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
    function updateLumpSumTotalRow() {
      let total = 0;
      // Ø§Ø¬Ù…Ø¹ ÙÙ‚Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙØ¹Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (tbody)
      document.querySelectorAll('#lumpSumBody tr').forEach(tr => {
        const totalInput = tr.querySelector('input[data-field="total"]');
        if (totalInput && !totalInput.disabled && totalInput.offsetParent !== null) {
          total += parseFloat(totalInput.value) || 0;
        }
      });
      const cell = document.getElementById('lumpSumTotalCell');
      if (cell) cell.textContent = formatNumberWithCommas(total);
    }

    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª (Ø¬Ù…Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
    function updateDailyTotalRow() {
      let prevAmount = 0, currentAmount = 0, totalAmount = 0;
      // Ø§Ø¬Ù…Ø¹ ÙÙ‚Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙØ¹Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (tbody)
      document.querySelectorAll('#dailyBody tr').forEach(tr => {
        const prevAmountInput = tr.querySelector('input[data-field="prevAmount"]');
        const currentAmountInput = tr.querySelector('input[data-field="currentAmount"]');
        const totalAmountInput = tr.querySelector('input[data-field="totalAmount"]');
        if (prevAmountInput && prevAmountInput.offsetParent !== null)
          prevAmount += parseFloat(prevAmountInput.value) || 0;
        if (currentAmountInput && currentAmountInput.offsetParent !== null)
          currentAmount += parseFloat(currentAmountInput.value) || 0;
        if (totalAmountInput && totalAmountInput.offsetParent !== null)
          totalAmount += parseFloat(totalAmountInput.value) || 0;
      });
      document.getElementById('dailyPrevAmountTotal').textContent = formatNumberWithCommas(prevAmount);
      document.getElementById('dailyCurrentAmountTotal').textContent = formatNumberWithCommas(currentAmount);
      document.getElementById('dailyTotalAmountTotal').textContent = formatNumberWithCommas(totalAmount);
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    const oldRenderLumpSumRows = renderLumpSumRows;
    renderLumpSumRows = function() {
      oldRenderLumpSumRows.apply(this, arguments);
      updateLumpSumTotalRow();
    };

    const oldRenderDailyRows = renderDailyRows;
    renderDailyRows = function() {
      oldRenderDailyRows.apply(this, arguments);
      updateDailyTotalRow();
    };

    document.addEventListener('DOMContentLoaded', function() {
      updateLumpSumTotalRow();
      updateDailyTotalRow();
    });

    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§
    const extractDate = document.getElementById('extractDate');
    if (extractDate && !extractDate.value) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      extractDate.value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
  // Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  let user = {};
  try {
    user = JSON.parse(localStorage.getItem('user')) || {};
  } catch {}
  const perms = user.permissions || [];

  // Ø§Ø¬Ø¹Ù„ Ø®Ø§Ù†Ø© Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…
  document.getElementById('workItemFilterSelect').disabled = false;
  document.getElementById('contractorSelect').disabled = false;

  // ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³ÙˆØ¯Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM ÙƒØ§Ù…Ù„Ø§Ù‹)
  setTimeout(() => {
    const contractorSelect = document.getElementById('contractorSelect');
    const currentContractor = contractorSelect?.value;
    
    if (currentContractor) {
      console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù‚Ø§ÙˆÙ„ Ù…Ø®ØªØ§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:', currentContractor);
      
      // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
      const savedDraft = localStorage.getItem('extractDraft');
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          if (draftData.contractorId === currentContractor) {
            console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ÙˆØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
            loadDraftSilently();
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
              showDraftIndicator();
              // ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
              const extractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
              addOperation('ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©', `ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber}`);
            }, 800);
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
        }
      } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø©ØŒ Ø£Ø¸Ù‡Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© (Ø³ÙŠÙƒÙˆÙ† Ù…Ø®ÙÙŠ)
        showDraftIndicator();
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
      restoreOperationsForContractor(currentContractor);
    } else {
      // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ Ù…Ø®ØªØ§Ø±
      showDraftIndicator();
      initializeOperationsLog();
    }
  }, 300);

  // Ø§Ø¬Ø¹Ù„ Ø®Ø§Ù†Ø© Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…
  document.getElementById('workItemFilterSelect').disabled = false;
  document.getElementById('contractorSelect').disabled = false;

  // ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„ - ÙŠÙØªØ­ ÙƒÙ„ Ø´ÙŠØ¡
  if (perms.includes('add-extract-edit-all')) {
    document.querySelectorAll('input, select, button').forEach(el => {
      el.disabled = false;
      el.readOnly = false;
      el.style.opacity = "1";
      el.style.cursor = "";
      el.style.display = "";
    });
    const extractUsername = document.getElementById('extractUsername');
    if (extractUsername) extractUsername.readOnly = true;
    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„');
    return;
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ù‰ ÙÙ‚Ø·: ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù‚ÙÙˆÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ø§Ø¹Ø¯Ø§ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ù‰ Ù†Ø³Ø¨Ø©
  if (perms.includes('add-extract-edit-current')) {
    // Ù‚ÙÙ„ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ø§Ø¹Ø¯Ø§ currentPercent
    document.querySelectorAll('#workItemsTable input').forEach(inp => {
      if (inp.dataset.field !== "currentPercent") {
        inp.readOnly = true;
        inp.disabled = true;
        inp.style.background = "#eee";
        inp.style.cursor = "not-allowed";
      } else {
        inp.readOnly = false;
        inp.disabled = false;
        inp.style.background = "";
        inp.style.cursor = "";
      }
    });
    // Ø¹Ø·Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ
    document.querySelectorAll('.delete-work-row, .move-up-row, .move-down-row').forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";
    });
    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·');
    return;
  }

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡Ø§ Ù…Ù† permissions-check.js
  console.log('âœ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© ØªÙØ¯Ø§Ø± Ù…Ù† permissions-check.js');
});
  </script>
  <!-- Ø£Ø¶Ù Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ -->
  <script>
// ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ù…Ù†Ø·Ù‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø¹Ù…Ø§Ù„ Ù…Ù‚Ø§ÙˆÙ„ Ø¢Ø®Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  </script>
  <script>
    // Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('extractForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨Ù†Ø¯ Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ù„ÙŠØ³ ÙØ§ØµÙ„ ÙˆÙ…Ø¹Ø¨Ø£)
      const hasRealWorkItem = Array.isArray(workItems) &&
    workItems.some(item =>
      !item.isSeparator &&
      String(item.buildingNumber).trim() !== "" &&
      String(item.workItem).trim() !== ""
    );
      if (!hasRealWorkItem) {
        alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (ØºÙŠØ± Ø§Ù„ÙÙˆØ§ØµÙ„) Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ.');
        return;
      }

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      const submitBtn = document.querySelector('button[type="submit"][form="extractForm"]');
      const saveDraftBtn = document.getElementById('topSaveDraftBtn');
      
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
      }
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      }
      if (saveDraftBtn) {
        saveDraftBtn.disabled = true;
      }

      // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      const form = event.target;
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      let userId = '';
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        userId = user._id || user.id || '';
      } catch (e) {
        console.warn('Error parsing user data:', e);
      }
      
      const data = {
        date: form.date.value,
        number: form.number.value,
        contractor: form.contractor.value,
        username: form.username.value,
        userId: userId,
        workItems: workItems || [],
        lumpSumRows: lumpSumRows || [],
        dailyRows: dailyRows || [],
        deductions: Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
          statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
          date: tr.querySelector('input[name="deductionDate"]')?.value || '',
          quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
          category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
          total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
          user: tr.querySelector('input[name="deductionUser"]')?.value || ''
        }))
      };

      try {
        const res = await fetch('/extracts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          const result = await res.json();
          
          // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            const contractorSelect = form.contractor;
            let contractorName = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù‚Ø§ÙˆÙ„ Ù…Ø­Ø¯Ø¯
            if (contractorSelect.selectedIndex > 0 && contractorSelect.options[contractorSelect.selectedIndex]) {
              contractorName = contractorSelect.options[contractorSelect.selectedIndex].text;
            }
            
            await window.sendNotification(
              'extract-add',
              `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${form.number.value} Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„: ${contractorName}`,
              'extracts',
              result._id || ''
            );
          }
          
          // Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
          const extractNumber = form.number.value;
          const contractorId = form.contractor.value;
          
          // Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
          const materialsToDeduct = [];
          document.querySelectorAll('#deductionsBody tr').forEach(tr => {
            const materialName = tr.dataset.materialName;
            const materialDate = tr.querySelector('input[name="deductionDate"]')?.value || '';
            const statementText = tr.querySelector('input[name="deductionStatement"]')?.value || '';
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø£Ø®ÙˆØ°Ø© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù„Ù‡Ø§ dataset.materialName)
            if (materialName && statementText.includes(materialName)) {
              materialsToDeduct.push({
                name: materialName,
                date: materialDate
              });
            }
          });
          
          // Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          for (const material of materialsToDeduct) {
            try {
              await fetch(`/contractors/${contractorId}/materials/deduct`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: material.name,
                  deductedInExtractNumber: extractNumber,
                  deductedDate: material.date
                })
              });
            } catch (err) {
              console.error('ØªØ¹Ø°Ø± Ø®ØµÙ… Ø§Ù„Ù…Ø§Ø¯Ø©:', material.name, err);
            }
          }
          
          // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ loading spinner Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø¥Ø¶Ø§ÙÙŠØªÙŠÙ†
          setTimeout(() => {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ loading overlay Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ';
            }
            if (saveDraftBtn) {
              saveDraftBtn.disabled = false;
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø®ØµØµØ©
            setTimeout(() => {
              showSuccessNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©');
              
              // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª
              setTimeout(() => {
                window.location.href = 'list-extracts.html';
              }, 2000);
            }, 100);
          }, 2000); // ØªØ£Ø®ÙŠØ± Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ†
          
        } else {
          // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ loading overlay ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ';
          }
          if (saveDraftBtn) {
            saveDraftBtn.disabled = false;
          }
          
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
        }
      } catch (err) {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ loading overlay ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ';
        }
        if (saveDraftBtn) {
          saveDraftBtn.disabled = false;
        }
        
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
      }
    });
  </script>
  <script>
// Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡
document.addEventListener('DOMContentLoaded', function() {
  const maxTotalPercentInput = document.getElementById('maxTotalPercentInput');
  const contractorSelect = document.getElementById('contractorSelect');

  // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ØŒ Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø³ÙŠØ±ÙØ±
  maxTotalPercentInput.addEventListener('change', async function() {
    const contractorId = contractorSelect.value;
    const value = parseFloat(this.value) || 100;
    if (!contractorId) return;
    try {
      await fetch(`/contractors/${contractorId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ maxTotalPercent: value })
      });
    } catch (err) {
      alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    }
  });

  // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§ÙˆÙ„ØŒ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  contractorSelect.addEventListener('change', async function() {
    // ØªØ¬Ø§Ù‡Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©
    if (window.isLoadingDraft) return;
    
    const contractorId = this.value;
    if (!contractorId) return;
    try {
      const res = await fetch(`/contractors/${contractorId}`);
      if (!res.ok) return;
      const contractor = await res.json();
      document.getElementById('maxTotalPercentInput').value = contractor.maxTotalPercent || 100;
    } catch {
      document.getElementById('maxTotalPercentInput').value = 100;
    }
  });

  // === Ù†Ø¸Ø§Ù… Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª ===
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  const saveDraftBtn = document.getElementById('saveDraftBtn') || document.getElementById('topSaveDraftBtn');
  
  if (!saveDraftBtn) {
    console.error('Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  } else {
    console.log('Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…ÙˆØ¬ÙˆØ¯');
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ÙƒÙ…Ø³ÙˆØ¯Ø© - Ø±Ø¨Ø· ÙƒÙ„Ø§ Ø§Ù„Ø²Ø±ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¢Ù…Ù†Ø©
  if (document.getElementById('saveDraftBtn')) {
    document.getElementById('saveDraftBtn').addEventListener('click', function() {
      console.log('ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
      safeSaveDraft(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
    });
  }
  
  if (document.getElementById('topSaveDraftBtn')) {
    document.getElementById('topSaveDraftBtn').addEventListener('click', function() {
      console.log('ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ');
      safeSaveDraft(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
    });
  }

  // Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª Ù„Ù†Ø·Ø§Ù‚ Ø¹Ø§Ù„Ù…ÙŠ Ø£Ø³ÙÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù

  function loadDraftSilently() {
    try {
      console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
      // ØªÙØ¹ÙŠÙ„ flag Ù„Ù…Ù†Ø¹ event listeners Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ù† Ø§Ù„ØªØ¯Ø§Ø®Ù„
      window.isLoadingDraft = true;
      console.log('ØªÙ… ØªÙØ¹ÙŠÙ„ flag Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„');
      
      const savedDraft = localStorage.getItem('extractDraft');
      if (!savedDraft) {
        window.isLoadingDraft = false;
        return;
      }

      const draftData = JSON.parse(savedDraft);
      console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', draftData);
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ø£Ù†Ù‡ Ù…Ø®ØªØ§Ø± Ø¨Ø§Ù„ÙØ¹Ù„)
      document.getElementById('workItemFilterSelect').value = draftData.workItemFilterSelect || '';
      document.getElementById('statementNumber').value = draftData.extractNumber || '';
      document.getElementById('extractDate').value = draftData.extractDate || '';
      document.getElementById('maxTotalPercentInput').value = draftData.maxTotalPercent || '100';
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
      console.log('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„...');
      workItems.length = 0;
      workItems.push(...(draftData.workItems || []));
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
      lumpSumRows.length = 0;
      lumpSumRows.push(...(draftData.lumpSumRows || []));
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.lumpSumRows && Array.isArray(draftData.lumpSumRows)) {
        draftData.lumpSumRows.forEach(row => {
          const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
          if (row.statementDesc && row.statementDesc.trim() !== '') {
            loggedLumpSumRows.add(rowKey);
          }
        });
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
      dailyRows.length = 0;
      dailyRows.push(...(draftData.dailyRows || []));
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.dailyRows && Array.isArray(draftData.dailyRows)) {
        draftData.dailyRows.forEach(row => {
          const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
          if (row.dailyDesc && row.dailyDesc.trim() !== '' && row.current && parseFloat(row.current) > 0) {
            loggedDailyRows.add(rowKey);
          }
        });
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª - Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const deductionsBody = document.getElementById('deductionsBody');
      if (deductionsBody) {
        deductionsBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        
        if (draftData.deductions && Array.isArray(draftData.deductions)) {
          draftData.deductions.forEach(deduction => {
            if (deduction.statement || deduction.quantity || deduction.total) {
              // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px;"><input type="text" name="deductionStatement" value="${deduction.statement || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø®ØµÙ…"></td>
                <td style="padding:4px;"><input type="date" name="deductionDate" value="${deduction.date || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;"></td>
                <td style="padding:4px;"><input type="number" name="deductionQuantity" value="${deduction.quantity || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"></td>
                <td style="padding:4px;"><input type="number" name="deductionCategory" value="${deduction.category || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="ÙØ¦Ø© Ø§Ù„Ø³Ø¹Ø±"></td>
                <td style="padding:4px;"><input type="number" name="deductionTotal" value="${deduction.total || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" readonly></td>
                <td style="padding:4px;"><input type="text" name="deductionUser" value="${deduction.user || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" readonly></td>
                <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button></td>
              `;
              deductionsBody.appendChild(tr);
              
              // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
              const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
              const catInput = tr.querySelector('input[name="deductionCategory"]');
              const totalInput = tr.querySelector('input[name="deductionTotal"]');
              
              function updateDeductionTotal() {
                const qty = parseFloat(qtyInput.value) || 0;
                const cat = parseFloat(catInput.value) || 0;
                totalInput.value = (qty * cat).toFixed(2);
                calculateSummary();
              }
              
              qtyInput.addEventListener('input', updateDeductionTotal);
              catInput.addEventListener('input', updateDeductionTotal);
            }
          });
        }
      }
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.deductions && Array.isArray(draftData.deductions)) {
        draftData.deductions.forEach(deduction => {
          if (deduction.statement || deduction.quantity || deduction.total) {
            const rowKey = `${deduction.statement || ''}_${deduction.quantity || ''}_${deduction.total || ''}`;
            loggedDeductionRows.add(rowKey);
          }
        });
      }
      
      console.log('workItems Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', workItems);
      console.log('lumpSumRows Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', lumpSumRows);
      console.log('dailyRows Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', dailyRows);
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      console.log('Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
      renderWorkItems();
      renderLumpSumRows();
      renderDailyRows();
      updateTotalRowInTable();
      updateLumpSumTotalRow();
      updateDailyTotalRow();
      calculateSummary();
      
      showDraftIndicator();
      console.log('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      
      // Ø¥Ù„ØºØ§Ø¡ flag Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      setTimeout(() => {
        console.log('Ø¥Ù„ØºØ§Ø¡ flag Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„');
        window.isLoadingDraft = false;
      }, 1000);
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', error);
      window.isLoadingDraft = false;
    }
  }

  function loadDraft() {
    try {
      const savedDraft = localStorage.getItem('extractDraft');
      if (!savedDraft) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©.');
        return;
      }

      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        return;
      }

      const draftData = JSON.parse(savedDraft);
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      document.getElementById('workItemFilterSelect').value = draftData.workItemFilterSelect || '';
      document.getElementById('contractorSelect').value = draftData.contractorId || '';
      document.getElementById('statementNumber').value = draftData.extractNumber || '';
      document.getElementById('extractDate').value = draftData.extractDate || '';
      document.getElementById('maxTotalPercentInput').value = draftData.maxTotalPercent || '100';
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
      workItems.length = 0;
      workItems.push(...(draftData.workItems || []));
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
      lumpSumRows.length = 0;
      lumpSumRows.push(...(draftData.lumpSumRows || []));
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.lumpSumRows && Array.isArray(draftData.lumpSumRows)) {
        draftData.lumpSumRows.forEach(row => {
          const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
          if (row.statementDesc && row.statementDesc.trim() !== '') {
            loggedLumpSumRows.add(rowKey);
          }
        });
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª
      dailyRows.length = 0;
      dailyRows.push(...(draftData.dailyRows || []));
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.dailyRows && Array.isArray(draftData.dailyRows)) {
        draftData.dailyRows.forEach(row => {
          const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
          if (row.dailyDesc && row.dailyDesc.trim() !== '' && row.current && parseFloat(row.current) > 0) {
            loggedDailyRows.add(rowKey);
          }
        });
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª - Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const deductionsBody = document.getElementById('deductionsBody');
      if (deductionsBody) {
        deductionsBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        
        if (draftData.deductions && Array.isArray(draftData.deductions)) {
          draftData.deductions.forEach(deduction => {
            if (deduction.statement || deduction.quantity || deduction.total) {
              // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px;"><input type="text" name="deductionStatement" value="${deduction.statement || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø®ØµÙ…"></td>
                <td style="padding:4px;"><input type="date" name="deductionDate" value="${deduction.date || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;"></td>
                <td style="padding:4px;"><input type="number" name="deductionQuantity" value="${deduction.quantity || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"></td>
                <td style="padding:4px;"><input type="number" name="deductionCategory" value="${deduction.category || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="ÙØ¦Ø© Ø§Ù„Ø³Ø¹Ø±"></td>
                <td style="padding:4px;"><input type="number" name="deductionTotal" value="${deduction.total || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" readonly></td>
                <td style="padding:4px;"><input type="text" name="deductionUser" value="${deduction.user || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" readonly></td>
                <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">Ø­Ø°Ù</button></td>
              `;
              deductionsBody.appendChild(tr);
              
              // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
              const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
              const catInput = tr.querySelector('input[name="deductionCategory"]');
              const totalInput = tr.querySelector('input[name="deductionTotal"]');
              
              function updateDeductionTotal() {
                const qty = parseFloat(qtyInput.value) || 0;
                const cat = parseFloat(catInput.value) || 0;
                totalInput.value = (qty * cat).toFixed(2);
                calculateSummary();
              }
              
              qtyInput.addEventListener('input', updateDeductionTotal);
              catInput.addEventListener('input', updateDeductionTotal);
            }
          });
        }
      }
      
      // ØªØ­Ø¯ÙŠØ« ØªØªØ¨Ø¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (draftData.deductions && Array.isArray(draftData.deductions)) {
        draftData.deductions.forEach(deduction => {
          if (deduction.statement || deduction.quantity || deduction.total) {
            const rowKey = `${deduction.statement || ''}_${deduction.quantity || ''}_${deduction.total || ''}`;
            loggedDeductionRows.add(rowKey);
          }
        });
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      renderWorkItems();
      renderLumpSumRows();
      renderDailyRows();
      updateTotalRowInTable();
      updateLumpSumTotalRow();
      updateDailyTotalRow();
      calculateSummary();
      
      alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
      showDraftIndicator();
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©.');
    }
  }

  function showDraftIndicator() {
    const savedDraft = localStorage.getItem('extractDraft');
    const currentContractor = document.getElementById('contractorSelect').value;
    const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    
    if (savedDraft && currentContractor) {
      try {
        const draftData = JSON.parse(savedDraft);
        if (draftData.contractorId === currentContractor) {
          if (draftIndicator) draftIndicator.style.display = 'inline-block';
          if (topDraftIndicator) topDraftIndicator.style.display = 'inline-block';
        } else {
          if (draftIndicator) draftIndicator.style.display = 'none';
          if (topDraftIndicator) topDraftIndicator.style.display = 'none';
        }
      } catch (error) {
        if (draftIndicator) draftIndicator.style.display = 'none';
        if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      }
    } else {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    }
  }
  
  // Ø¥Ø¶Ø§ÙØ© event listener Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
  document.getElementById('contractorSelect').addEventListener('change', function() {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø©ØŒ ØªØ¬Ø§Ù‡Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    if (window.isLoadingDraft) return;
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    if (draftIndicator) draftIndicator.style.display = 'none';
    if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    
    // Ø«Ù… ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    showDraftIndicator();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯
    const savedDraft = localStorage.getItem('extractDraft');
    if (savedDraft && this.value) {
      try {
        const draftData = JSON.parse(savedDraft);
        if (draftData.contractorId === this.value) {
          setTimeout(() => {
            loadDraftSilently();
          }, 300);
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
      }
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ setTimeout Ø£Ø¹Ù„Ø§Ù‡)
  updateCurrentUser();

});

// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
let loggedDailyRows = new Set();
let loggedLumpSumRows = new Set();
let loggedDeductionRows = new Set(); // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
let modifiedWorkItems = new Set(); // Ù„ØªØªØ¨Ø¹ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
let modifiedWorkItemsDetails = new Map(); // Ù„Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
function logNewWorkItems() {
  if (Array.isArray(workItems) && workItems.length > 0) {
    let newItemsCount = 0;
    
    workItems.forEach((item, index) => {
      // ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø· Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙŠ Ù„ÙŠØ³Øª ÙÙˆØ§ØµÙ„ ÙˆÙ„Ù‡Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ù… ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹
      if (!item.isSeparator && item.buildingNumber && item.buildingNumber.trim() !== '' && 
          item.workItem && item.workItem.trim() !== '' && !modifiedWorkItems.has(index.toString())) {
        
        const rowNumber = index + 1;
        const buildingNumber = item.buildingNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const workItemNumber = item.workItem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const currentPercent = item.currentPercent || '0';
        const currentAmount = item.currentAmount || '0';
        
        addOperation('Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¯ Ø¹Ù…Ù„', `Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… ${rowNumber} - Ù…Ø¨Ù†Ù‰: ${buildingNumber} - Ø¨Ù†Ø¯: ${workItemNumber} - Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentPercent}% - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentAmount} Ø¬Ù†ÙŠÙ‡`);
        newItemsCount++;
      }
    });
    
    if (newItemsCount > 0) {
      console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${newItemsCount} Ø¨Ù†Ø¯ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…Ø¹Ø¯Ù„)`);
    }
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
function logModifiedWorkItems() {
  if (modifiedWorkItemsDetails.size > 0) {
    modifiedWorkItemsDetails.forEach((details, idx) => {
      if (details.modifications.length > 0) {
        const modificationsText = details.modifications.map(mod => 
          `${mod.field}: ${mod.newValue}`
        ).join(', ');
        
        addOperation('ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¯ Ø¹Ù…Ù„', `ØªØ¹Ø¯ÙŠÙ„ ØµÙ Ø±Ù‚Ù… ${details.rowNumber} - Ù…Ø¨Ù†Ù‰: ${details.buildingNumber} - Ø¨Ù†Ø¯: ${details.workItemNumber} - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ${modificationsText}`);
      }
    });
    
    console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ${modifiedWorkItemsDetails.size} ØµÙ Ù…Ù† Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„`);
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
function logNewDeductions() {
  const deductionRows = document.querySelectorAll('#deductionsBody tr');
  
  if (deductionRows.length > 0) {
    let newDeductionsCount = 0;
    
    deductionRows.forEach((row, index) => {
      const statement = row.querySelector('input[name="deductionStatement"]')?.value || '';
      const quantity = row.querySelector('input[name="deductionQuantity"]')?.value || '';
      const total = row.querySelector('input[name="deductionTotal"]')?.value || '';
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ø®ØµÙ…
      const rowKey = `${statement}_${quantity}_${total}`;
      
      if ((statement.trim() !== '' || quantity.trim() !== '' || total.trim() !== '') && !loggedDeductionRows.has(rowKey)) {
        const rowNumber = index + 1;
        addOperation('Ø¥Ù†Ø´Ø§Ø¡ Ø®ØµÙ…', `Ø¥Ù†Ø´Ø§Ø¡ Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… ${rowNumber} - Ø§Ù„Ù…Ø§Ø¯Ø©: ${statement} - Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity} - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡`);
        newDeductionsCount++;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµÙ… Ù„Ù„Ù…ÙØ³Ø¬Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        loggedDeductionRows.add(rowKey);
      }
    });
    
    if (newDeductionsCount > 0) {
      console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${newDeductionsCount} Ø®ØµÙ… Ø¬Ø¯ÙŠØ¯`);
    }
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
function logDailyAndLumpOperations() {
  const currentStatementNumber = parseInt(document.getElementById('statementNumber')?.value || '0');
  
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· (Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø­Ø§Ù„ÙŠ" ÙˆÙ„Ù… ØªÙØ³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„)
  if (Array.isArray(dailyRows) && dailyRows.length > 0) {
    dailyRows.forEach((row, index) => {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„ØµÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆØ§Ù‡
      const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
      
      // ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø­Ø§Ù„ÙŠ" ÙˆÙ„Ù… ØªÙØ³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„
      if (row.dailyDesc && row.dailyDesc.trim() !== '' && 
          row.current && parseFloat(row.current) > 0 &&
          !loggedDailyRows.has(rowKey)) {
        
        const dailyDesc = row.dailyDesc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const building = row.building || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const dailyValue = row.dailyValue || '0';
        const currentQuantity = row.current || '0';
        const currentAmount = row.currentAmount || '0';
        
        addOperation('ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©', `ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©: ${dailyDesc} - Ø§Ù„Ù…Ø¨Ù†Ù‰: ${building} - Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentQuantity} - Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ${dailyValue} - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentAmount} Ø¬Ù†ÙŠÙ‡`);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ù„Ù„Ù…ÙØ³Ø¬Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        loggedDailyRows.add(rowKey);
      }
    });
  }
  
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· (Ø§Ù„ØªÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ„Ù… ØªÙØ³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„)
  if (Array.isArray(lumpSumRows) && lumpSumRows.length > 0) {
    lumpSumRows.forEach((row, index) => {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„ØµÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆØ§Ù‡
      const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
      
      // ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø· Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ„Ù… ØªÙØ³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„
      const rowStatementNumber = parseInt(row.statementNumber || '0');
      const isCurrentStatement = rowStatementNumber === 0 || rowStatementNumber >= currentStatementNumber;
      
      if (row.statementDesc && row.statementDesc.trim() !== '' && 
          isCurrentStatement && !loggedLumpSumRows.has(rowKey)) {
        
        const statementDesc = row.statementDesc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const buildingsCount = row.buildingsCount || '0';
        const lumpSum = row.lumpSum || '0';
        const total = row.total || '0';
        
        addOperation('ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·ÙˆØ¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©', `ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·ÙˆØ¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©: ${statementDesc} - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: ${buildingsCount} - Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©: ${lumpSum} - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡`);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ù„Ù„Ù…ÙØ³Ø¬Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        loggedLumpSumRows.add(rowKey);
      }
    });
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯)
function resetLoggedRowsTracking() {
  loggedDailyRows.clear();
  loggedLumpSumRows.clear();
  loggedDeductionRows.clear(); // Ù…Ø³Ø­ ØªØªØ¨Ø¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
  modifiedWorkItems.clear(); // Ù…Ø³Ø­ ØªØªØ¨Ø¹ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
  modifiedWorkItemsDetails.clear(); // Ù…Ø³Ø­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  console.log('ØªÙ… Ù…Ø³Ø­ ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯');
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯
function restoreOperationsForContractor(contractorId) {
  try {
    const operationsKey = `currentExtractOperations_${contractorId}`;
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    const operationsContent = document.getElementById('operationsContent');
    
    if (!operationsContent) return;
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
    operationsContent.innerHTML = '';
    
    if (operations.length === 0) {
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§ØªØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ÙˆØ¯Ø©
      const savedDraft = localStorage.getItem('extractDraft');
      let isDraftExisting = false;
      
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          if (draftData.contractorId === contractorId && 
              (draftData.workItems?.length > 0 || draftData.lumpSumRows?.length > 0 || 
               draftData.dailyRows?.length > 0 || draftData.deductions?.length > 0)) {
            isDraftExisting = true;
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
        }
      }
      
      const currentUser = document.getElementById('currentUser')?.textContent || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
      const extractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const actionText = isDraftExisting ? 'Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯';
      const detailsText = isDraftExisting ? 
        `ØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© - Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber}` : 
        `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber}`;
      
      // Ø§Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      operationsContent.innerHTML = `
        <div class="operation-item">
          <div class="operation-time">${new Date().toLocaleTimeString('ar-EG')}</div>
          <div class="operation-action">${actionText}</div>
          <div class="operation-details">${detailsText}</div>
          <div class="operation-user">ğŸ‘¤ ${currentUser}</div>
        </div>
      `;
      console.log(`ğŸ“ ${actionText} Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorId}`);
    } else {
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      operations.reverse().forEach(op => {
        const operationItem = document.createElement('div');
        operationItem.className = 'operation-item';
        operationItem.innerHTML = `
          <div class="operation-time">${op.time}</div>
          <div class="operation-action">${op.action}</div>
          <div class="operation-details">${op.details}</div>
          <div class="operation-user">ğŸ‘¤ ${op.user}</div>
        `;
        operationsContent.appendChild(operationItem);
      });
      console.log(`ğŸ”„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${operations.length} Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorId}`);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', error);
  }
}

// ÙˆØ¸ÙŠÙØ© Ù„ÙØ±Ø¶ Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
function forceDraftIndicatorHide() {
  const draftIndicator = document.getElementById('draftIndicator');
  const topDraftIndicator = document.getElementById('topDraftIndicator');
  
  if (draftIndicator) {
    draftIndicator.style.display = 'none !important';
    draftIndicator.style.visibility = 'hidden';
  }
  if (topDraftIndicator) {
    topDraftIndicator.style.display = 'none !important';
    topDraftIndicator.style.visibility = 'hidden';
  }
  
  console.log('ğŸ”´ ØªÙ… ÙØ±Ø¶ Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
}

// ÙˆØ¸Ø§Ø¦Ù Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
function updateCurrentUser() {
  try {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const userName = user.name || user.username || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±Ù';
    const userElement = document.getElementById('currentUser');
    if (userElement) {
      userElement.textContent = userName;
    }
    return userName;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    const userElement = document.getElementById('currentUser');
    if (userElement) {
      userElement.textContent = 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±Ù';
    }
    return 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±Ù';
  }
}

function initializeOperationsLog() {
  const operationsContent = document.getElementById('operationsContent');
  if (!operationsContent) return;
  
  // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
  operationsContent.innerHTML = `
    <div class="operation-item" style="text-align:center; color:#666; font-style:italic;">
      <div class="operation-action">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    </div>
  `;
}

function updateCurrentTime() {
  const now = new Date();
  const timeStr = now.toLocaleString('ar-EG', {
    timeZone: 'Africa/Cairo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  const timeElement = document.getElementById('currentTime');
  if (timeElement) {
    timeElement.textContent = timeStr;
  }
}

function addOperation(action, details) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù‚Ø§ÙˆÙ„ Ù…Ø­Ø¯Ø¯
  const contractorSelect = document.getElementById('contractorSelect');
  if (!contractorSelect || !contractorSelect.value) {
    console.log('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ØŒ Ù„Ù† ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
    return;
  }

  const operationsContent = document.getElementById('operationsContent');
  if (!operationsContent) return;
  
  const now = new Date();
  const timeStr = now.toLocaleString('ar-EG', {
    timeZone: 'Africa/Cairo',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  const currentUser = document.getElementById('currentUser')?.textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  
  const operationItem = document.createElement('div');
  operationItem.className = 'operation-item';
  operationItem.innerHTML = `
    <div class="operation-time">${timeStr}</div>
    <div class="operation-action">${action}</div>
    <div class="operation-details">${details}</div>
    <div class="operation-user">ğŸ‘¤ ${currentUser}</div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
  if (operationsContent.children.length > 0 && operationsContent.children[0].textContent.includes('Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„Ø§Ù‹')) {
    operationsContent.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  }
  
  operationsContent.insertBefore(operationItem, operationsContent.firstChild);
  
  // Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± 50 Ø¹Ù…Ù„ÙŠØ© (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯)
  while (operationsContent.children.length > 50) {
    operationsContent.removeChild(operationsContent.lastChild);
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ localStorage (Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø­ØªÙ‰ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
  saveOperationToStorage(action, details, timeStr, currentUser);
  
  // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  operationsContent.scrollTop = 0;
  
  console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${action} - ${details}`);
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ localStorage ÙˆØ§Ù„Ø³ÙŠØ±ÙØ± (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø­ØªÙ‰ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
function saveOperationToStorage(action, details, time, user) {
  try {
    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const contractorSelect = document.getElementById('contractorSelect');
    const contractorId = contractorSelect ? contractorSelect.value : 'unknown';
    const operationsKey = `currentExtractOperations_${contractorId}`;
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    
    const operation = {
      action,
      details,
      time,
      user,
      contractorId,
      timestamp: new Date().toISOString()
    };
    
    operations.push(operation);
    
    // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹ Ù…ÙØªØ§Ø­ Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
    localStorage.setItem(operationsKey, JSON.stringify(operations));
    
    // Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
    localStorage.setItem('currentContractorOperations', operationsKey);
    
    console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorId}: ${action}`);
    
    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
    if (contractorId && contractorId !== 'unknown') {
      fetch('/extract-operations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          extractId: 'temp', // Ù…Ø¤Ù‚Øª Ø­ØªÙ‰ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
          contractorId: contractorId,
          action,
          details,
          user,
          timestamp: operation.timestamp
        })
      }).catch(error => {
        console.log('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±:', error);
      });
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', error);
  }
}

// Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ø­ÙÙˆØ¸ (ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
function transferOperationsToExtract() {
  try {
    const contractorSelect = document.getElementById('contractorSelect');
    const contractorId = contractorSelect ? contractorSelect.value : null;
    
    if (!contractorId) {
      console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ Ù…Ø­Ø¯Ø¯ Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
      return;
    }
    
    const operationsKey = `currentExtractOperations_${contractorId}`;
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    
    if (operations.length > 0) {
      // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø¢Ø®Ø± Ù…Ø³ØªØ®Ù„Øµ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
      const extractOperationsKey = `extractOperations_${Date.now()}`;
      localStorage.setItem(extractOperationsKey, JSON.stringify(operations));
      localStorage.setItem('lastExtractOperations', extractOperationsKey);
      
      // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
      localStorage.removeItem(operationsKey);
      localStorage.removeItem('currentContractorOperations');
      
      addOperation('Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 'ØªÙ… Ù†Ù‚Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ø­ÙÙˆØ¸');
      
      console.log(`âœ… ØªÙ… Ù†Ù‚Ù„ ${operations.length} Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ø­ÙÙˆØ¸`);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', error);
  }
}

// Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)
function clearDraftAfterSave() {
  try {
    const contractorSelect = document.getElementById('contractorSelect');
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ (Ù„ÙƒÙ† Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)
    localStorage.removeItem('extractDraft');
    console.log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ù† localStorage (Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    resetLoggedRowsTracking();
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
    const draftIndicator = document.getElementById('draftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    
    if (draftIndicator) {
      draftIndicator.style.display = 'none';
      console.log('ØªÙ… Ø¥Ø®ÙØ§Ø¡ draftIndicator');
    }
    if (topDraftIndicator) {
      topDraftIndicator.style.display = 'none';
      console.log('ØªÙ… Ø¥Ø®ÙØ§Ø¡ topDraftIndicator');
    }
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
    setTimeout(() => {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      forceDraftIndicatorHide(); // ÙØ±Ø¶ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
    }, 100);
    
    // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
    setTimeout(() => {
      forceDraftIndicatorHide();
    }, 2000);
    
    // Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙˆØ±Ø§Ù‹ - Ù†ØªØ±ÙƒÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // setTimeout(() => {
    //   resetFormAfterSave();
    // }, 1500);
    
    console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§
function validateAndLogDataState(action) {
  console.log(`=== ${action} ===`);
  console.log('Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:');
  console.log('- workItems:', Array.isArray(workItems) ? workItems.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù', workItems);
  console.log('- lumpSumRows:', Array.isArray(lumpSumRows) ? lumpSumRows.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù', lumpSumRows);
  console.log('- dailyRows:', Array.isArray(dailyRows) ? dailyRows.length : 'ØºÙŠØ± Ù…Ø¹Ø±Ù', dailyRows);
  
  const deductionsCount = document.querySelectorAll('#deductionsBody tr').length;
  console.log('- deductionsRows:', deductionsCount);
  
  console.log('- contractorSelect:', document.getElementById('contractorSelect')?.value || 'ÙØ§Ø±Øº');
  console.log('- statementNumber:', document.getElementById('statementNumber')?.value || 'ÙØ§Ø±Øº');
  console.log('- extractDate:', document.getElementById('extractDate')?.value || 'ÙØ§Ø±Øº');
  console.log('========================');
  
  return {
    workItemsCount: Array.isArray(workItems) ? workItems.length : 0,
    lumpSumCount: Array.isArray(lumpSumRows) ? lumpSumRows.length : 0,
    dailyCount: Array.isArray(dailyRows) ? dailyRows.length : 0,
    deductionsCount: deductionsCount,
    hasContractor: !!document.getElementById('contractorSelect')?.value,
    hasStatementNumber: !!document.getElementById('statementNumber')?.value
  };
}

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function safeSaveDraft() {
  console.log('ğŸ”’ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø¢Ù…Ù†Ø© Ù„Ù„Ù…Ø³ÙˆØ¯Ø©...');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ loading
  const contractorSelect = document.getElementById('contractorSelect');
  if (!contractorSelect || !contractorSelect.value) {
    alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
    return false;
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ loading overlay Ù„Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingMessage = loadingOverlay?.querySelector('.loading-message');
  const submitBtn = document.querySelector('button[type="submit"][form="extractForm"]');
  const saveDraftBtn = document.getElementById('topSaveDraftBtn');
  
  if (loadingOverlay) {
    loadingOverlay.style.display = 'flex';
  }
  
  // ØªØºÙŠÙŠØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù…Ø³ÙˆØ¯Ø©
  if (loadingMessage) {
    loadingMessage.textContent = 'ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹';
  }
  
  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
  if (submitBtn) {
    submitBtn.disabled = true;
  }
  if (saveDraftBtn) {
    saveDraftBtn.disabled = true;
    saveDraftBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  }
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ loading Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª
  setTimeout(() => {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ (Ø¯Ø§Ø®Ù„ try-catch)
      const beforeState = validateAndLogDataState('Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
      // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠØ© (localStorage) - Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯
      saveDraftSilently();
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©)
      logModifiedWorkItems();
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      logNewDeductions();
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
      logDailyAndLumpOperations();
      
      // Ù…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
      modifiedWorkItemsDetails.clear();
      
      // Ø­ÙØ¸ Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø­Ù…Ø§ÙŠØ© Ù…Ø¶Ø§Ø¹ÙØ©)
      const contractorId = document.getElementById('contractorSelect').value;
      if (contractorId) {
        const draftData = {
          contractorId: contractorId,
          workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
          extractNumber: document.getElementById('statementNumber').value,
          extractDate: document.getElementById('extractDate').value,
          workItems: Array.isArray(workItems) ? [...workItems] : [],
          lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
          dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
          deductions: Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
            statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
            date: tr.querySelector('input[name="deductionDate"]')?.value || '',
            quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
            category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
            total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
            user: tr.querySelector('input[name="deductionUser"]')?.value || ''
          })),
          maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
          timestamp: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¹Ø¯Ù… ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
        fetch('/drafts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(draftData)
        }).then(response => {
          if (response.ok) {
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙŠØ¶Ø§Ù‹');
          } else {
            console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù„ÙƒÙ† localStorage Ù†Ø¬Ø­');
          }
        }).catch(error => {
          console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
        });
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      setTimeout(() => {
        const afterState = validateAndLogDataState('Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ØªØ®ØªÙÙŠ
        if (afterState.workItemsCount !== beforeState.workItemsCount) {
          console.warn('âš ï¸ ØªØºÙŠØ±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!');
        }
        if (afterState.lumpSumCount !== beforeState.lumpSumCount) {
          console.warn('âš ï¸ ØªØºÙŠØ±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!');
        }
        if (afterState.dailyCount !== beforeState.dailyCount) {
          console.warn('âš ï¸ ØªØºÙŠØ±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸!');
        }
        
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø£Ù…Ø§Ù†');
        
        // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ loading spinner Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setTimeout(() => {
          // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ loading overlay Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          if (submitBtn) {
            submitBtn.disabled = false;
          }
          if (saveDraftBtn) {
            saveDraftBtn.disabled = false;
            saveDraftBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©';
          }
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø®ØµØµØ©
          setTimeout(() => {
            showSuccessNotification('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
            
            // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          }, 100);
        }, 2000); // ØªØ£Ø®ÙŠØ± Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ†
        
      }, 100);
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ø¢Ù…Ù†:', error);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ loading ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      if (submitBtn) {
        submitBtn.disabled = false;
      }
      if (saveDraftBtn) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©';
      }
      
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©: ' + error.message);
      return false;
    }
  }, 100); // ØªØ£Ø®ÙŠØ± 100ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ loading Ø£ÙˆÙ„Ø§Ù‹
  
  return true;
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
function resetFormAfterSave() {
  try {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù„Ø­Ø§Ù„Ø© "Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„"
    const contractorSelect = document.getElementById('contractorSelect');
    if (contractorSelect) {
      contractorSelect.value = '';
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    initializeOperationsLog();
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const extractDate = document.getElementById('extractDate');
    if (extractDate) extractDate.value = '';
    
    const statementNumber = document.getElementById('statementNumber');
    if (statementNumber) statementNumber.value = '';
    
    const workItemSelect = document.getElementById('workItemFilterSelect');
    if (workItemSelect) workItemSelect.value = '';
    
    console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸');
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
  }
}

// Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
document.addEventListener('DOMContentLoaded', function() {
  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ - ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ
  const contractorSelect = document.getElementById('contractorSelect');
  if (contractorSelect) {
    contractorSelect.addEventListener('change', function() {
      if (this.value) {
        const option = this.options[this.selectedIndex];
        const contractorName = option.text || 'Ù…Ù‚Ø§ÙˆÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const extractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const currentUser = document.getElementById('currentUser')?.textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        resetLoggedRowsTracking();
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
        restoreOperationsForContractor(this.value);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø³ÙˆØ¯Ø©
        setTimeout(() => {
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const updatedExtractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          
          // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ø³ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„
          const savedDraft = localStorage.getItem('extractDraft');
          let isDraftExisting = false;
          
          if (savedDraft) {
            try {
              const draftData = JSON.parse(savedDraft);
              if (draftData.contractorId === this.value && 
                  (draftData.workItems?.length > 0 || draftData.lumpSumRows?.length > 0 || 
                   draftData.dailyRows?.length > 0 || draftData.deductions?.length > 0)) {
                isDraftExisting = true;
              }
            } catch (error) {
              console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
            }
          }
          
          // âŒ ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ "Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ" Ù‡Ù†Ø§
          // âœ… Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ù„Øµ
          
          // if (isDraftExisting) {
          //   addOperation('Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª', `Ø§Ø³ØªÙƒÙ…Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${updatedExtractNumber} Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorName}`);
          // } else {
          //   addOperation('Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ', `Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${updatedExtractNumber} Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorName}`);
          // }
        }, 500);
        
      } else {
        // Ø¥Ø°Ø§ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ØŒ Ø£Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¬Ù„
        initializeOperationsLog();
        resetLoggedRowsTracking();
        resetSessionChanges();
      }
    });
  }
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø¨Ù†Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
  const workItemSelect = document.getElementById('workItemFilterSelect');
  if (workItemSelect) {
    workItemSelect.addEventListener('change', function() {
      if (this.value) {
        const option = this.options[this.selectedIndex];
        addOperation('Ø§Ø®ØªÙŠØ§Ø± Ø¨Ù†Ø¯ Ø£Ø¹Ù…Ø§Ù„', `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${option.text}`);
      }
    });
  }
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© - Ù†Ø¸Ø§Ù… Ù…Ø¨Ø³Ø·
  const saveDraftBtn = document.getElementById('topSaveDraftBtn');
  if (saveDraftBtn) {
    saveDraftBtn.addEventListener('click', function() {
      const currentUser = document.getElementById('currentUser')?.textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const extractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
      const success = safeSaveDraft();
      
      if (success) {
        addOperation('Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©', `Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber} ÙƒÙ…Ø³ÙˆØ¯Ø©`);
      }
    });
  }
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ - Ù†Ø¸Ø§Ù… Ù…Ø¨Ø³Ø·
  const extractForm = document.getElementById('extractForm');
  if (extractForm) {
    extractForm.addEventListener('submit', function(e) {
      const extractNumber = document.getElementById('statementNumber')?.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const contractorSelect = document.getElementById('contractorSelect');
      const contractorName = contractorSelect?.options[contractorSelect.selectedIndex]?.text || 'Ù…Ù‚Ø§ÙˆÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      // âœ… ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      addOperation('Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ', `Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber} Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ ${contractorName}`);
      
      addOperation('Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ', `Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø±Ù‚Ù… ${extractNumber} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`);
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙØ³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„)
      if (modifiedWorkItemsDetails.size > 0) {
        logModifiedWorkItems();
        modifiedWorkItemsDetails.clear(); // Ù…Ø³Ø­ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      }
      
      // ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      logNewWorkItems();
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      logNewDeductions();
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚Ø·ÙˆØ¹ÙŠØ§Øª
      logDailyAndLumpOperations();
      
      // Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      setTimeout(() => {
        clearDraftAfterSave();
        transferOperationsToExtract();
      }, 1500);
    });
  }
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø· - Ù†Ø¸Ø§Ù… Ù…Ø¨Ø³Ø·
  document.addEventListener('click', function(e) {
    const contractorSelect = document.getElementById('contractorSelect');
    if (!contractorSelect || !contractorSelect.value) return; // Ù„Ø§ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ù‚Ø§ÙˆÙ„
    
    const currentUser = document.getElementById('currentUser')?.textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    
    // Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¹Ù…Ù„
    if (e.target && e.target.id === 'addWorkItemRowBtn') {
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      return;
    }
    
    // Ø­Ø°Ù Ø¨Ù†Ø¯ Ø¹Ù…Ù„
    if (e.target && e.target.classList.contains('delete-work-row')) {
      const row = e.target.closest('tr');
      if (row) {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ØµÙ Ù…Ù† data-idx
        const rowIndex = parseInt(row.dataset.idx);
        const rowNumber = rowIndex + 1;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…Ù† input ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙ
        const buildingInput = row.querySelector('input[data-field="buildingNumber"]');
        const buildingNumber = buildingInput ? buildingInput.value.trim() : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø¯ Ù…Ù† input ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙ
        const workItemInput = row.querySelector('input[data-field="workItem"]');
        const workItemNumber = workItemInput ? workItemInput.value.trim() : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        addOperation('Ø­Ø°Ù Ø¨Ù†Ø¯ Ø¹Ù…Ù„', `${currentUser} Ù‚Ø§Ù… Ø¨Ø­Ø°Ù ØµÙ ${rowNumber} - Ù…Ø¨Ù†Ù‰ ${buildingNumber} - Ø¨Ù†Ø¯ ${workItemNumber}`);
      }
      return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ØµÙ…
    if (e.target && e.target.id === 'addDeductionRowBtn') {
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©
    if (e.target && e.target.id === 'addDailyRowBtn') {
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©
    if (e.target && e.target.id === 'addLumpSumRowBtn') {
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
      return;
    }
    
    // Ø­Ø°Ù ÙŠÙˆÙ…ÙŠØ© Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    if (e.target && e.target.classList.contains('delete-daily-row-btn')) {
      const idx = parseInt(e.target.dataset.idx);
      const row = dailyRows[idx];
      if (row) {
        const dailyDesc = row.dailyDesc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const building = row.building || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const dailyValue = row.dailyValue || '0';
        addOperation('Ø­Ø°Ù ÙŠÙˆÙ…ÙŠØ©', `${currentUser} Ù‚Ø§Ù… Ø¨Ø­Ø°Ù ÙŠÙˆÙ…ÙŠØ©: ${dailyDesc} - Ø§Ù„Ù…Ø¨Ù†Ù‰: ${building} - Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ${dailyValue}`);
      }
      return;
    }
    
    // Ø­Ø°Ù Ù…Ù‚Ø·ÙˆØ¹ÙŠØ© Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    if (e.target && e.target.classList.contains('delete-lump-row-btn')) {
      const idx = parseInt(e.target.dataset.idx);
      const row = lumpSumRows[idx];
      if (row) {
        const statementDesc = row.statementDesc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const buildingsCount = row.buildingsCount || '0';
        const lumpSum = row.lumpSum || '0';
        addOperation('Ø­Ø°Ù Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©', `${currentUser} Ù‚Ø§Ù… Ø¨Ø­Ø°Ù Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©: ${statementDesc} - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: ${buildingsCount} - Ø§Ù„Ù‚ÙŠÙ…Ø©: ${lumpSum}`);
      }
      return;
    }
  });
  
  // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© input Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØ±Ø· - Ø§Ø³ØªØ®Ø¯Ø§Ù… change ÙÙ‚Ø· Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ù‡Ù…Ø©
  // Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆÙ„ÙŠØ³ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  document.addEventListener('change', function(e) {
    const contractorSelect = document.getElementById('contractorSelect');
    if (!contractorSelect || !contractorSelect.value) return; // Ù„Ø§ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ù‚Ø§ÙˆÙ„
    
    const currentUser = document.getElementById('currentUser')?.textContent || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    
    // ØªØ³Ø¬ÙŠÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ - Ø¬Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ
    if (e.target && e.target.classList.contains('work-item-input')) {
      const field = e.target.dataset.field;
      const idx = e.target.dataset.idx;
      const newValue = e.target.value;
      
      // ØªØ¬Ù…ÙŠØ¹ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„ÙØ¦Ø© ÙˆØ§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ
      if (field === 'quantity' || field === 'category' || field === 'currentPercent') {
        const workItem = workItems[idx];
        if (workItem && !workItem.isSeparator) {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
          modifiedWorkItems.add(idx);
          
          // Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          if (!modifiedWorkItemsDetails.has(idx)) {
            modifiedWorkItemsDetails.set(idx, {
              rowNumber: parseInt(idx) + 1,
              buildingNumber: workItem.buildingNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              workItemNumber: workItem.workItem || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
              modifications: []
            });
          }
          
          const details = modifiedWorkItemsDetails.get(idx);
          let fieldName = '';
          if (field === 'quantity') fieldName = 'Ø§Ù„ÙƒÙ…ÙŠØ©';
          else if (field === 'category') fieldName = 'Ø§Ù„ÙØ¦Ø©';
          else if (field === 'currentPercent') fieldName = 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
          
          // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          const existingMod = details.modifications.find(m => m.field === fieldName);
          if (existingMod) {
            existingMod.newValue = newValue + (field === 'currentPercent' ? '%' : '');
          } else {
            details.modifications.push({
              field: fieldName,
              newValue: newValue + (field === 'currentPercent' ? '%' : '')
            });
          }
        }
      }
    }
    
    // ØªØ³Ø¬ÙŠÙ„ ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
    if (e.target && e.target.id === 'statementNumber' && e.target.value) {
      addOperation('ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ', `ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ø¥Ù„Ù‰ ${e.target.value}`);
    }
  });
});

  </script>

  <script>
// === Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ===

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ ØµØ§Ù…ØªØ© Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ safeSaveDraft)
function saveDraftSilently() {
  console.log('Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„ØµØ§Ù…ØªØ©...');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  const requiredElements = [
    'contractorSelect', 'workItemFilterSelect', 'statementNumber',
    'extractDate', 'maxTotalPercentInput'
  ];
  
  for (const elementId of requiredElements) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error(`Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${elementId}`);
      return false;
    }
  }
  
  try {
    console.log('Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ÙˆØ¯Ø©...');
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
    const deductionsData = Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
      statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
      date: tr.querySelector('input[name="deductionDate"]')?.value || '',
      quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
      category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
      total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
      user: tr.querySelector('input[name="deductionUser"]')?.value || ''
    }));
    
    const draftData = {
      contractorId: document.getElementById('contractorSelect').value,
      workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
      extractNumber: document.getElementById('statementNumber').value,
      extractDate: document.getElementById('extractDate').value,
      workItems: Array.isArray(workItems) ? [...workItems] : [],
      lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
      dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
      deductions: deductionsData,
      maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
      timestamp: new Date().toISOString()
    };
    
    console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', draftData);
    localStorage.setItem('extractDraft', JSON.stringify(draftData));
    console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ localStorage (ØµØ§Ù…Øª)');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    showDraftIndicator();
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„ØµØ§Ù…ØªØ©:', error);
    return false;
  }
}

function saveDraft() {
  console.log('Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©');
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  const requiredElements = [
    'contractorSelect', 'workItemFilterSelect', 'statementNumber',
    'extractDate', 'maxTotalPercentInput'
  ];
  
  for (const elementId of requiredElements) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error(`Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${elementId}`);
      alert(`Ø®Ø·Ø£: Ø§Ù„Ø¹Ù†ØµØ± ${elementId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
      return;
    }
  }
  
  try {
    console.log('Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ÙˆØ¯Ø©...');
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
    const deductionsData = Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
      statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
      date: tr.querySelector('input[name="deductionDate"]')?.value || '',
      quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
      category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
      total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
      user: tr.querySelector('input[name="deductionUser"]')?.value || ''
    }));
    
    const draftData = {
      contractorId: document.getElementById('contractorSelect').value,
      workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
      extractNumber: document.getElementById('statementNumber').value,
      extractDate: document.getElementById('extractDate').value,
      workItems: Array.isArray(workItems) ? [...workItems] : [],
      lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
      dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
      deductions: deductionsData,
      maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
      timestamp: new Date().toISOString()
    };
    
    console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', draftData);
    localStorage.setItem('extractDraft', JSON.stringify(draftData));
    console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ localStorage');
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ ÙƒÙ…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
    showDraftIndicator();
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©.');
  }
}

function showDraftIndicator() {
  const savedDraft = localStorage.getItem('extractDraft');
  const currentContractor = document.getElementById('contractorSelect').value;
  const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
  const topDraftIndicator = document.getElementById('topDraftIndicator');
  
  if (savedDraft && currentContractor) {
    try {
      const draftData = JSON.parse(savedDraft);
      if (draftData.contractorId === currentContractor) {
        if (draftIndicator) draftIndicator.style.display = 'inline-block';
        if (topDraftIndicator) topDraftIndicator.style.display = 'inline-block';
      } else {
        if (draftIndicator) draftIndicator.style.display = 'none';
        if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      }
    } catch (error) {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    }
  } else {
    if (draftIndicator) draftIndicator.style.display = 'none';
    if (topDraftIndicator) topDraftIndicator.style.display = 'none';
  }
}

  </script>
  
  <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->
  <script>
  window.addEventListener('load', function() {
    setTimeout(function() {
      console.log('ğŸ”§ ÙØ­Øµ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø±...');
      
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const perms = user.permissions || [];
      
      console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.username);
      console.log('ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', perms.length);
      console.log('ğŸ”‘ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', perms);
      
      // ÙØ­Øµ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‡Ù…Ø©
      const buttonsToCheck = [
        { id: 'addWorkItemRowBtn', perm: 'add-extract-add-workitem', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø£Ø¹Ù…Ø§Ù„' },
        { selector: 'button[type="submit"][form="extractForm"]', perm: 'add-extract-create', name: 'Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ' },
        { id: 'addLumpSumBtn', perm: 'add-extract-add-lump', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©' },
        { id: 'addDailyBtn', perm: 'add-extract-add-daily', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ©' },
        { id: 'addSeparatorBtn', perm: 'add-extract-create', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„' },
        { id: 'addLumpSumRowBtn', perm: 'add-extract-add-lump', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ù‚Ø·ÙˆØ¹ÙŠØ©' },
        { id: 'addDailyRowBtn', perm: 'add-extract-add-daily', name: 'Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ ÙŠÙˆÙ…ÙŠØ©' }
      ];
      
      buttonsToCheck.forEach(function(btn) {
        const element = btn.id ? document.getElementById(btn.id) : document.querySelector(btn.selector);
        if (element) {
          const hasPerm = perms.includes(btn.perm);
          console.log(`ğŸ” ${btn.name}:`);
          console.log(`   - Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯: Ù†Ø¹Ù…`);
          console.log(`   - Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${btn.perm}`);
          console.log(`   - Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…ØªÙˆÙØ±Ø©: ${hasPerm ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}`);
          console.log(`   - display: ${element.style.display}`);
          console.log(`   - disabled: ${element.disabled}`);
          console.log(`   - visibility: ${window.getComputedStyle(element).visibility}`);
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ù‚ÙˆØ© ÙˆØ£Ø²Ù„ Ø£ÙŠ Ø¥Ø®ÙØ§Ø¡
          if (hasPerm) {
            element.style.removeProperty('display');
            element.style.display = 'inline-block';
            element.style.visibility = 'visible';
            element.disabled = false;
            element.style.opacity = '1';
            element.style.cursor = 'pointer';
            element.removeAttribute('hidden');
            console.log(`   âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ${btn.name}`);
            console.log(`   - display Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${element.style.display}`);
          } else {
            console.log(`   âŒ ${btn.name} Ù…Ø®ÙÙŠ Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©`);
          }
        } else {
          console.log(`âŒ ${btn.name} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©!`);
        }
      });
      
      // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ø®Ø§Øµ Ø¨Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ
      console.log('\nğŸ¯ ÙØ­Øµ Ø®Ø§Øµ Ù„Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ:');
      const allSubmitButtons = document.querySelectorAll('button[type="submit"]');
      console.log(`   - Ø¹Ø¯Ø¯ Ø£Ø²Ø±Ø§Ø± submit Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${allSubmitButtons.length}`);
      allSubmitButtons.forEach((btn, index) => {
        console.log(`   - Ø²Ø± ${index + 1}:`, btn.textContent.trim(), 'form=', btn.getAttribute('form'), 'display=', btn.style.display);
      });
    }, 500);
  });
  </script>
    </div> <!-- Ø¥ØºÙ„Ø§Ù‚ main-content -->
  </div> <!-- Ø¥ØºÙ„Ø§Ù‚ container -->
</body>
</html>
 