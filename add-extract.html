<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>إضافة مستخلص | سعيد أحمد بالبيد</title>
  <!-- خط Tajawal من Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="permissions-check.js"></script>
  <style>
    /* استيراد خط Cairo إضافي للتأكد */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
    
    /* فرض الخلفية الخضراء للأزرار دائماً */
    #topSaveDraftBtn, 
    button[type="submit"][form="extractForm"],
    button[type="submit"] {
      background: linear-gradient(135deg, #2e7d32, #1b5e20) !important;
      color: #fff !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
    }
    
    :root {
      direction: rtl;
      writing-mode: horizontal-tb;
      /* text-orientation: initial; // optional, add if needed */
    }
    body {
      margin: 0;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
      background: #c5d6db;
      height: 100vh;
      overflow: hidden;
    }
    .navbar {
      background: #1a3b50; /* أزرق غامق */
      color: #fff;
      padding: 10px 0;
      text-align: center;
      font-size: 1.15rem;
      font-weight: bold;
      box-shadow: 0 2px 12px #0001;
      letter-spacing: 1px;
      border-bottom: 3px solid #2e8ca3; /* أزرق فاتح */
    }
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      background: #f7fafd;
      border-radius: 0;
      box-shadow: none;
      padding: 5px 0 5px 5px; /* إزالة padding من اليمين */
      border: none;
      position: fixed;
      display: flex;
      gap: 6px; /* تقليل الفجوة */
      height: calc(100vh - 45px);
      overflow: hidden;
      top: 45px;
      left: 0;
      right: 0;
    }
    
    .main-content {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      height: 100%;
      padding-left: 6px; /* تقليل padding */
      order: 1; /* المحتوى الرئيسي أولاً */
    }
    
    /* سجل العمليات */
    .operations-sidebar {
      width: 240px;
      background: #f7fafd;
      border: 2px solid #8c969a;
      border-radius: 8px 0 0 8px; /* تدوير الزوايا اليسرى فقط */
      padding: 8px;
      height: 100%;
      overflow-y: auto;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1); /* ظل من الجانب الأيسر */
      order: 2; /* نقل السجل للجهة اليمنى */
      flex-shrink: 0;
      position: relative;
      margin-right: 0; /* إلغاء أي مسافة من اليمين */
    }
    
    .operations-sidebar h3 {
      margin: 0 0 8px 0;
      color: #7a5230;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
      background: #c5d6db;
      padding: 4px;
      border-radius: 6px;
    }
    
    .operation-item {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 0.75rem;
      line-height: 1.3;
      transition: all 0.2s ease;
    }
    
    .operation-item:hover {
      background: #f0f8ff;
      border-color: #22799b;
    }
    
    .operation-time {
      color: #666;
      font-size: 0.75rem;
      margin-bottom: 5px;
    }
    
    .operation-action {
      color: #333;
      font-weight: 500;
    }
    
    .operation-details {
      color: #555;
      font-size: 0.8rem;
      margin-top: 3px;
    }
    
    .operation-user {
      color: #2e7d32;
      font-size: 0.7rem;
      margin-top: 4px;
      font-weight: 500;
      border-top: 1px solid #e0e0e0;
      padding-top: 2px;
    }
    
    /* تحسين التمرير */
    .operations-sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 6px;
    }
    
    .operations-sidebar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    h2 {
      text-align: right;
      margin-bottom: 18px;
      color: #2e8ca3; /* أزرق فاتح */
      font-size: 1.15rem;
      font-weight: bold;
      letter-spacing: 1px;
      margin-top: 0;
      padding-top: 0;
    }
    h3, .section-title {
      color: #7a5230; /* بني */
      background: #c5d6db; /* فاتح */
      margin: 24px 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: right;
      border-radius: 8px;
      padding: 8px;
    }
    .back {
      color: #2e8ca3; /* أزرق فاتح */
      display: block;
      margin: 0 auto 15px auto;
      text-align: center;
      text-decoration: underline;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
    }
    .row, .row.details-inline, .details-inline {
      background: #8c969a22; /* رمادي شفاف */
      border-radius: 10px;
      padding: 7px 7px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #22799b;
    }
    .row.details-inline {
      display: flex;
      flex-wrap: nowrap !important;
      gap: 18px;
      margin-bottom: 10px;
      align-items: center;
      background: #e8f5e9;
      border-radius: 10px;
      padding: 5px 10px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #1b5e20;
      overflow-x: auto;
    }
    .row.details-inline .form-group {
      flex: none;
      min-width: 140px;
      margin-bottom: 0;
    }
    .row.details-inline label {
      font-size: 0.88rem;
      margin-bottom: 2px;
    }
    .row.details-inline input,
    .row.details-inline select {
      font-size: 0.88rem;
      padding: 4px 6px;
      min-width: 80px;
      max-width: 160px;
    }
    .form-group {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
    }
    .form-group label {
      color: #2e8ca3; /* أزرق فاتح */
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .form-group input, .form-group select {
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1.2px solid #c5d6db;
      outline: none;
      transition: border-color 0.2s;
      background: #fff;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #2e8ca3;
      background: #c5d6db;
    }
    .sort-btns {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }
    .sort-btn {
      background: #fff;
      color: #2e8ca3; /* أزرق فاتح */
      border: 2px solid #2e8ca3;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: bold;
      padding: 3px 8px;
      cursor: pointer;
      box-shadow: 0 2px 10px #0001;
      transition: background 0.2s, color 0.2s, border 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sort-btn.active {
      background: #1a3b50;
      color: #fff;
    }
    .table-section {
      background: #c5d6db;
      border-radius: 10px;
      padding: 14px 8px;
      box-shadow: 0 2px 8px #1b5e2022;
      margin-bottom: 14px;
      border: 1.5px solid #8c969a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #f7fafd;
      margin-bottom: 8px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px #8c969a;
    }
    th, td {
      padding: 6px 2px;
      border-bottom: 1px solid #c5d6db;
      text-align: center;
      vertical-align: middle;
      font-size: 0.93rem;
      background: transparent;
      white-space: nowrap;
      word-break: break-word;
    }
    th {
      background: #2e8ca3 !important; /* أزرق فاتح */
      color: #fff !important;
      font-weight: bold;
      font-size: 0.85rem; /* تم التصغير من 1rem إلى 0.85rem */
    }
    th.work-item-col, td.work-item-col,
    th.work-desc-col, td.work-desc-col {
      min-width: 55px !important;
      max-width: 110px !important;
      white-space: normal !important;
      word-break: break-word;
      width: auto !important;
      font-size: 0.95rem;
    }
    /* تعديل عرض الأعمدة المطلوبة */
    th[style*="min-width:0px;"], td[style*="min-width:20px;"] {
      min-width: 10px !important; /* تقليل عرض رقم المبني */
    }
    th.work-desc-col, td.work-desc-col {
      min-width: 180px !important;
      max-width: 350px !important;
      width: 220px !important;
      white-space: normal !important;
      word-break: break-word;
    }
    th[style*="min-width:12px;"], td[style*="min-width:12px;"] {
      min-width: 12px !important;
      max-width: 40px !important;
    }
    tr.group-row, tr.subgroup-row {
      height: 15px !important;
      min-height: 13px !important;
      font-size: 0.80rem !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      background: #8c969a !important; /* رمادي */
      color: #fff;
      font-size: 1.08rem;
      font-weight: bold;
      border-bottom: 1.5px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
    }
    tr.subgroup-row {
      height: 16px !important;
      min-height: 14px !important;
      font-size: 0.90rem !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      background: #c5d6db !important; /* فاتح */
      color: #1a3b50;
      font-size: 1.01rem;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
    }
    tr.work-row {
      background: #f7fafd;
      font-size: 0.82rem;
      color: #222;
      transition: box-shadow 0.18s, background 0.18s;
      border-radius: 10px;
      box-shadow: 0 1px 8px #e0e0e0;
    }
    tr.work-row:hover {
      background: #c5d6db;
      box-shadow: 0 2px 16px #b2dfdb;
    }
    tr.work-row td {
      border-bottom: 1px solid #e0e0e0;
      padding: 0 0;
      font-size: 0.75rem;
      height: 32px; /* زيادة الارتفاع */
      background: transparent;
      transition: background 0.18s;
      text-align: center !important;
    }
    tr.work-row td:first-child {
      color: #2e8ca3;
      background: #c5d6db;
      border-radius: 10px 0 0 10px;
      box-shadow: 0 1px 4px #c8e6c9;
    }
    tr.work-row td:last-child {
      border-radius: 0 10px 10px 0;
    }
    tr.work-row input {
      width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c8e6c9;
      border-radius: 0px;
      padding: 4px 2px;
      font-size: 0.75rem;
      height: 28px; /* زيادة ارتفاع المربع */
      background: #fff;
      transition: border 0.18s, background 0.18s, box-shadow 0.18s;
      box-shadow: 0 1px 6px #e0e0e0;
      text-align: center;
    }
    .hidden-row { display: none; }
    input.total-percent-max {
      background: #7a5230 !important; /* بني */
      color: #fff !important;
      border: 2px solid #7a5230 !important;
    }
    .add-row-btn {
      background: #2e8ca3;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: bold;
      padding: 2px 8px;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      height: 28px;
    }
    .add-row-btn:hover {
      background: #1a3b50;
    }
    .summary {
      background: #8c969a22;
      border-radius: 10px;
      border: 1.5px solid #8c969a;
      color: #7a5230;
      padding: 12px 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 6px #e0e0e0;
      font-size: 1.05rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
    }
    .summary-row, .highlight {
      background: #7a5230 !important; /* بني */
      color: #fff !important;
      font-weight: bold;
    }
    .notes {
      border: 1px solid #2e8ca3;
      background: #c5d6db;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #1a3b50;
    }
    .signatures td {
      color: #1a3b50;
      border: none;
      padding: 8px;
      position: relative;
    }
    .signatures td:after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, #2e8ca3, transparent);
      bottom: 0;
      left: 0;
    }
    @media (max-width: 900px) {
      .container { padding: 8px; }
      .row { flex-direction: column; gap: 10px; padding: 10px 4px; }
      table { font-size: .92rem; }
      th, td { padding: 4px; }
      .summary { padding: 10px 6px; }
      .add-row-btn { padding: 6px 10px; font-size: 0.92rem; }
    }
    tr.work-row:nth-child(even) {
      background: #f7fafc !important;
    }
    tr.work-row:nth-child(odd) {
      background: #e8f5e9 !important;
    }
    .details-inline {
      display: flex;
      flex-wrap: nowrap !important;
      gap: 18px;
      margin-bottom: 10px;
      align-items: center;
      background: #e8f5e9;
      border-radius: 10px;
      padding: 5px 10px;
      box-shadow: 0 2px 8px #1b5e2022;
      border: 1.5px solid #1b5e20;
      overflow-x: auto;
    }
    .details-pair {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 0;
    }
    .details-pair label {
      font-size: 0.85rem;
      color: #2e8ca3; /* أزرق فاتح */
      font-weight: 600;
      margin-bottom: 0;
      letter-spacing: 0.5px;
    }
    .details-pair input,
    .details-pair select {
      font-size: 0.85rem;
      padding: 3px 6px;
      min-width: 80px;
      max-width: 160px;
      border-radius: 6px;
      border: 1.2px solid #c5d6db;
      background: #fff;
    }
    /* تصغير الكلام في مربع التفاصيل العلوي فقط */
    .details-inline, .details-pair {
      gap: 6px !important;
    }
    
    /* تحسينات الأزرار - تأثيرات Hover */
    #topSaveDraftBtn:hover,
    button[type="submit"]:hover, 
    button[type="submit"][form="extractForm"]:hover {
      background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(46,125,50,0.6) !important;
      letter-spacing: 0.8px !important;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
    }
    
    #saveDraftBtn:hover, #topSaveDraftBtn:hover {
      background: linear-gradient(135deg, #388e3c, #2e7d32) !important;
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(46,125,50,0.6) !important;
      letter-spacing: 0.8px !important;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      font-family: 'Cairo', 'Tajawal', Arial, sans-serif !important;
    }
    
    button:active {
      transform: translateY(-1px) !important;
    }
    
    /* تأثير النبض لمؤشر المسودة */
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    #draftIndicator {
      background: linear-gradient(135deg, #4caf50, #388e3c) !important;
      box-shadow: 0 2px 8px rgba(76,175,80,0.3) !important;
    }
    
    .details-inline {
      padding: 2px 4px !important;
    }
    .details-pair label {
      font-size: 0.78rem !important;
      margin-bottom: 0 !important;
    }
    .details-pair input,
    .details-pair select {
      font-size: 0.78rem !important;
      padding: 2px 4px !important;
      min-width: 60px !important;
      max-width: 110px !important;
      height: 26px !important;
    }
    .details-pair {
      margin-bottom: 0 !important;
    }
    #extraWorksTable {
      width: 100%;
      border-collapse: collapse;
      background: #f7fafd;
      margin-bottom: 8px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px #8c969a;
    }
    #extraWorksTable th, #extraWorksTable td {
      padding: 6px 2px;
      border-bottom: 1px solid #c5d6db;
      text-align: center;
      vertical-align: middle;
      font-size: 0.93rem;
      background: transparent;
      white-space: nowrap;
      word-break: break-word;
    }
    #extraWorksTable th {
      background: #2e8ca3 !important;
      color: #fff !important;
      font-weight: bold;
      font-size: 0.85rem;
    }
    #extraWorksTable tr:last-child td {
      border-bottom: none;
    }
    #extraWorksTable tr:hover td {
      background: #c5d6db;
      transition: background 0.18s;
    }
    #extraWorksTable input {
      width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c8e6c9;
      border-radius: 0px;
      padding: 4px 2px;
      font-size: 0.75rem;
      height: 28px;
      background: #fff;
      transition: border 0.18s, background 0.18s, box-shadow 0.18s;
      box-shadow: 0 1px 6px #e0e0e0;
      text-align: center;
    }
    #extraWorksTable td:first-child {
      color: #2e8ca3;
      background: #c5d6db;
      border-radius: 10px 0 0 10px;
      box-shadow: 0 1px 4px #c8e6c9;
    }
    #extraWorksTable td:last-child {
      border-radius: 0 10px 10px 0;
    }
    #deductionsTable {
    width: 100%;
    border-collapse: collapse;
    background: #f7fafd;
    margin-bottom: 8px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px #8c969a;
  }
  #deductionsTable th, #deductionsTable td {
    padding: 6px 2px;
    border-bottom: 1px solid #c5d6db;
    text-align: center;
    vertical-align: middle;
    font-size: 0.93rem;
    background: transparent;
    white-space: nowrap;
    word-break: break-word;
  }
  #deductionsTable th {
    background: #2e8ca3 !important;
    color: #fff !important;
    font-weight: bold;
    font-size: 0.85rem;
  }
  #deductionsTable tr:last-child td {
    border-bottom: none;
  }
  #deductionsTable tr:hover td {
    background: #c5d6db;
    transition: background 0.18s;
  }
  #deductionsTable input {
    width: 100%;
    box-sizing: border-box;
    border: 1.5px solid #c8e6c9;
    border-radius: 0px;
    padding: 4px 2px;
    font-size: 0.75rem;
    height: 28px;
    background: #fff;
    transition: border 0.18s, background 0.18s, box-shadow 0.18s;
    box-shadow: 0 1px 6px #e0e0e0;
    text-align: center;
  }
  #deductionsTable td:first-child {
    color: #2e8ca3;
    background: #c5d6db;
    border-radius: 10px 0 0 10px;
    box-shadow: 0 1px 4px #c8e6c9;
  }
  #deductionsTable td:last-child {
    border-radius: 0 10px 10px 0;
  }
  /* تخصيص عرض الأعمدة لأعمال أخرى */
  #otherWorksTable th.unit-col, #otherWorksTable td.unit-col,
  #otherWorksTable th.category-col, #otherWorksTable td.category-col,
  #otherWorksTable th.quantity-col, #otherWorksTable td.quantity-col {
    min-width: 38px !important;
    max-width: 60px !important;
    width: 50px !important;
  }
  #otherWorksTable th.work-desc-col, #otherWorksTable td.work-desc-col {
    min-width: 180px !important;
    max-width: 350px !important;
    width: 220px !important;
    white-space: normal !important;
    word-break: break-word;
  }
  /* تلوين الأعمدة المقفولة */
  #otherWorksTable input.readonly-cell {
    background: #e8f5e9 !important;
    color: #7a5230 !important;
    cursor: not-allowed !important;
    font-weight: bold;
    border: 1.5px solid #7a5230 !important;
  }
  #dailyTable {
  border-radius: 12px;
  /* احذف أو عطل الـ box-shadow */
  /* box-shadow: 0 2px 12px #8c969a; */
  background: #f7fafd;
  margin-bottom: 8px;
  width: 100%;
  /* احذف أو عطل الـ border */
  /* border: 1.5px solid #8c969a; */
}
#dailyTable th, #dailyTable td {
  padding: 6px 2px;
  /* احذف أو عطل الـ border-bottom */
  /* border-bottom: 1px solid #c5d6db; */
  text-align: center;
  vertical-align: middle;
  font-size: 0.93rem;
  background: transparent;
  white-space: nowrap;
  word-break: break-word;
}
#dailyTable th {
  background: #2e8ca3 !important;
  color: #fff !important;
  font-weight: bold;
  font-size: 0.85rem;
}
#dailyTable tr:last-child td {
  border-bottom: none;
}
#dailyTable tr:hover td {
  background: #c5d6db;
  transition: background 0.18s;
}
#dailyTable input {
  width: 100%;
  box-sizing: border-box;
  border: 1.5px solid #c8e6c9;
  border-radius: 0px;
  padding: 4px 2px;
  font-size: 0.75rem;
  height: 28px;
  background: #fff;
  transition: border 0.18s, background 0.18s, box-shadow 0.18s;
  box-shadow: 0 1px 6px #e0e0e0;
  text-align: center;
}
#dailyTable td:first-child {
  color: #2e8ca3;
  background: #c5d6db;
  border-radius: 10px 0 0 10px;
  box-shadow: 0 1px 4px #c8e6c9;
}
#dailyTable td:last-child {
  border-radius: 0 10px 10px 0;
}
#dailyTable tr:nth-child(even) {
  background: #f7fafc !important;
}
#dailyTable tr:nth-child(odd) {
  background: #e8f5e9 !important;
}
/* --- اجعل جدول المقطوعية/اليوميات نفس استايل جدول الأعمال --- */
#lumpSumTable {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px #8c969a;
  background: #f7fafd;
  margin-bottom: 8px;
  width: 100%;
}
#lumpSumTable th, #lumpSumTable td {
  padding: 6px 2px;
  border-bottom: 1px solid #c5d6db;
  text-align: center;
  vertical-align: middle;
  font-size: 0.93rem;
  background: transparent;
  white-space: nowrap;
  word-break: break-word;
}
#lumpSumTable th {
  background: #2e8ca3 !important;
  color: #fff !important;
  font-weight: bold;
  font-size: 0.85rem;
}
#lumpSumTable tr:last-child td {
  border-bottom: none;
}
#lumpSumTable tr:hover td {
  background: #c5d6db;
  transition: background 0.18s;
}
#lumpSumTable input {
  width: 100%;
  box-sizing: border-box;
  border: 1.5px solid #c8e6c9;
  border-radius: 0px;
  padding: 4px 2px;
  font-size: 0.75rem;
  height: 28px;
  background: #fff;
  transition: border 0.18s, background 0.18s, box-shadow 0.18s;
  box-shadow: 0 1px 6px #e0e0e0;
  text-align: center;
}
#lumpSumTable td:first-child {
  color: #2e8ca3;
  background: #c5d6db;
  border-radius: 10px 0 0 10px;
  box-shadow: 0 1px 4px #c8e6c9;
}
#lumpSumTable td:last-child {
  border-radius: 0 10px 10px 0;
}
#lumpSumTable tr:nth-child(even) {
  background: #f7fafc !important;
}
#lumpSumTable tr:nth-child(odd) {
  background: #e8f5e9 !important;
}
#dailyTable th[data-col="prev"],
#dailyTable th[data-col="current"],
#dailyTable th[data-col="total"],
#dailyTable th[data-col="prevAmount"],
#dailyTable th[data-col="currentAmount"],
#dailyTable th[data-col="totalAmount"],
#dailyTable td[data-col="prev"],
#dailyTable td[data-col="current"],
#dailyTable td[data-col="total"],
#dailyTable td[data-col="prevAmount"],
#dailyTable td[data-col="currentAmount"],
#dailyTable td[data-col="totalAmount"] {
  min-width: 70px !important;
  max-width: 100px !important;
  width: 80px !important;
  padding-left: 6px;
  padding-right: 6px;
}
#dailyTable th[data-col="dailyDesc"],
#dailyTable td[data-col="dailyDesc"] {
  min-width: 220px !important;
  max-width: 400px !important;
  width: 260px !important;
  white-space: normal !important;
  word-break: break-word;
}
    .btn-brown {
  background: #7a5230 !important;
  color: #fff !important;
  border: 1.2px solid #7a5230 !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  letter-spacing: 0.2px;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-brown:hover, .btn-brown:focus {
  background: #5d3f22 !important;
  color: #fff !important;
  border-color: #5d3f22 !important;
}
.btn-brown-outline {
  background: #fff !important;
  color: #7a5230 !important;
  border: 1.2px solid #7a5230 !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  letter-spacing: 0.2px;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-brown-outline:hover, .btn-brown-outline:focus {
  background: #7a5230 !important;
  color: #fff !important;
  border-color: #7a5230 !important;
}
/* زر اليوميات الأخضر بنفس التصغير */
.btn-green {
  background: #388e3c !important;
  color: #fff !important;
  border: 1.2px solid #388e3c !important;
  border-radius: 0 !important;
  font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  padding: 2px 8px !important;
  min-width: 0 !important;
  min-height: 0 !important;
  height: 26px !important;
  line-height: 1.1 !important;
  box-shadow: none !important;
}
.btn-green:hover, .btn-green:focus {
  background: #256c27 !important;
  border-color: #256c27 !important;
}
/* تصغير input الحد الأقصى */
#maxTotalPercentInput {
  width: 38px !important;
  font-size: 0.82rem !important;
  padding: 2px 2px !important;
  height: 24px !important;
  border-radius: 4px !important;
}
/* تصغير span % */
#maxTotalPercentInput + span,
[for="maxTotalPercentInput"] {
  font-size: 0.82rem !important;
}
/* تصغير المسافة بين الأزرار */
.shrink-btns-bar {
  gap: 4px !important;
}
.drag-handle {
  cursor: grab;
  display: inline-block;
  margin-left: 6px;
  font-size: 1.1em;
  color: #2e8ca3;
  user-select: none;
}
.drag-handle:active {
  cursor: grabbing;
  color: #7a5230;
}
  /* ...existing code... */
  .form-group input, .form-group select,
  .details-pair input, .details-pair select,
  input, select {
    font-family: 'Tajawal', 'Cairo', Arial, sans-serif !important;
    font-weight: 600;
    letter-spacing: 0.2px;
    color: #111 !important; /* خط أسود سادة */
    text-shadow: none !important; /* أزل الظل */
    vertical-align: middle;
    font-style: normal !important; /* أزل الميلان */
  }
  /* اجعل النص داخل الحقول readonly أسود وغير مايل */
  input:read-only, input[readonly], .details-pair input:read-only, .details-pair input[readonly] {
    background: #e8f5e9 !important;
    color: #111 !important;
    cursor: not-allowed;
    font-style: normal !important;
    border: 1.5px solid #c5d6db;
  }
  
  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(3px);
  }
  
  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(46, 140, 163, 0.3);
    border-top: 4px solid #2e8ca3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  .loading-message {
    color: white;
    font-size: 18px;
    font-weight: bold;
    font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
    text-align: center;
    background: rgba(46, 140, 163, 0.9);
    padding: 15px 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Success Notification */
  .success-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    font-family: 'Cairo', 'Tajawal', Arial, sans-serif;
    text-align: center;
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    z-index: 10000;
    min-width: 300px;
    animation: successPop 0.5s ease-out;
  }
  
  @keyframes successPop {
    0% { 
      opacity: 0; 
      transform: translate(-50%, -50%) scale(0.7); 
    }
    100% { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1); 
    }
  }
  /* ...existing code... */
</style>
</head>
<body>
  <!-- ربط الشريط العلوي الموحد -->
  <div id="main-navbar"></div>
  <script>
    // تحميل الشريط العلوي الموحد من components/main-navbar.html
    // دالة مساعدة للانتظار حتى يتم تحميل sendNotification
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-navbar').innerHTML = html;

        // نفذ جميع السكريبتات الموجودة في الشريط العلوي يدوياً
        document.querySelectorAll('#main-navbar script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });

        setTimeout(function() {
          if (typeof window.initMainNavbar === 'function') window.initMainNavbar();
          if (typeof window.updateNavbarUserName === 'function') window.updateNavbarUserName();
        }, 100);

        // تعبئة اسم المستخدم في تفاصيل المستخلص
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            const usernameInput = document.getElementById('extractUsername');
            if (usernameInput) usernameInput.value = user.username || '';
          } catch {}
        }
      });
  </script>
  <div class="container">
    <!-- الشريط الجانبي - سجل العمليات -->
    <div class="operations-sidebar">
      <h3>سجل العمليات</h3>
      <div style="background:#e8f5e9; padding:4px; border-radius:4px; margin-bottom:6px; text-align:center; font-size:0.7rem; color:#2e7d32;">
        👤 المستخدم: <span id="currentUser">جاري التحميل...</span>
      </div>
      <div id="operationsContent">
        <div class="operation-item" style="text-align:center; color:#666; font-style:italic;">
          <div class="operation-action">اختر مقاولاً لبدء تسجيل العمليات</div>
        </div>
      </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="main-content">
      <!-- لافتة المسودة والأزرار في أعلى الصفحة -->
      <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <h3 style="margin:0; color:#495057; font-size:1.0rem;">إضافة مستخلص جديد</h3>
          <span id="topDraftIndicator" style="display:none; background:linear-gradient(135deg, #ff9800, #f57c00); color:#fff; padding:2px 10px; border-radius:16px; font-size:0.8rem; font-weight:bold; box-shadow:0 2px 6px rgba(255,152,0,0.3); animation:pulse 2s infinite;" title="يوجد مسودة محفوظة لهذا المقاول">
            📝 مسودة
          </span>
        </div>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
          <button type="button" id="topSaveDraftBtn" style="background:linear-gradient(135deg, #2e7d32, #1b5e20) !important; color:#fff !important; border:none; border-radius:6px; padding:8px 14px; font-family:'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; box-shadow:0 3px 8px rgba(46,125,50,0.3); transition:all 0.3s ease; min-width:110px; letter-spacing:0.3px; text-shadow:0 1px 2px rgba(0,0,0,0.1);">
            💾 حفظ كمسودة
          </button>
          <button type="submit" form="extractForm" style="background:linear-gradient(135deg, #2e7d32, #1b5e20) !important; color:#fff !important; border:none; border-radius:6px; padding:8px 14px; font-family:'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; box-shadow:0 3px 8px rgba(46,125,50,0.3); transition:all 0.3s ease; min-width:110px; letter-spacing:0.3px; text-shadow:0 1px 2px rgba(0,0,0,0.1);"
            data-permission="add-extract-create">
            ✅ حفظ المستخلص
          </button>
        </div>
      </div>
    
    <h2 style="margin-top:0; padding-top:0; text-align:right; display:none;">إضافة مستخلص جديد</h2>
    <form id="extractForm">
      <div class="details-inline">
        <div class="details-pair">
          <label>تاريخ المستخلص</label>
          <input name="date" type="date" id="extractDate" required>
        </div>
        <div class="details-pair">
          <label>رقم المستخلص</label>
          <input name="number" type="number" id="statementNumber" readonly style="background:#e8f5e9;">
        </div>
        <div class="details-pair">
          <label>بند الأعمال</label>
          <select id="workItemFilterSelect" required>
            <option value="">اختر بند الأعمال</option>
            <!-- سيتم تعبئة البنود دينامياً من السيرفر -->
          </select>
        </div>
        <div class="details-pair">
          <label>اسم المقاول</label>
          <div style="display:flex; align-items:center; gap:6px;">
            <select name="contractor" id="contractorSelect" required disabled>
              <option value="">اختر المقاول</option>
            </select>
            <button type="button" id="refreshContractorsBtn" title="تحديث المقاولين" style="background:#fff; border:1px solid #388e3c; border-radius:5px; color:#388e3c; font-weight:bold; cursor:pointer; padding:2px 8px;">
              &#x21bb;
            </button>
          </div>
        </div>
        <div class="details-pair">
          <label>اسم المستخدم</label>
          <input name="username" type="text" id="extractUsername" required readonly>
        </div>
      </div>
      <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 24px; margin-bottom: 8px;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
          بنود الأعمال
          <!-- زر إضافة صف جديد كأيقونة -->
          <button type="button" id="addWorkItemRowBtn" title="إضافة صف جديد"
            style="background: #2e8ca3; color: #fff; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
            data-permission="add-extract-add-workitem">
            <i class="fa fa-plus"></i>
          </button>
        </h3>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button type="button" class="btn-brown" id="addLumpSumBtn" data-permission="add-extract-add-lump">إضافة مقطوعية</button>
          <button type="button" class="btn-green" id="addDailyBtn" data-permission="add-extract-add-daily">إضافة يوميات</button>
          <button type="button" class="btn-brown" id="addSeparatorBtn" data-permission="add-extract-create">+ إضافة فاصل</button>
          <!-- زر إدراج أعمال مقاول آخر (تمت إزالته) -->
          <!-- حقل الحد الأقصى للإجمالي % لكل بند: تم نقله هنا -->
          <div style="display:flex; align-items:center; gap:4px; margin-right:8px;">
            <label for="maxTotalPercentInput" style="font-weight:bold; color:#7a5230; font-size:0.82rem;">الحد الأقصى للإجمالي % لكل بند:</label>
            <input type="number" id="maxTotalPercentInput" value="100" min="1" max="100">
            <span style="color:#7a5230;">%</span>
          </div>
          <!-- أيقونة sort في النهاية -->
          <div style="position: relative;">
            <button id="sortMenuBtn" type="button" style="background: #fff; border: 1.5px solid #2e8ca3; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <i class="fa fa-sort" style="color:#2e8ca3; font-size: 1.1rem;"></i>
            </button>
            <div id="sortMenu" style="display:none; position: absolute; left: 0; top: 38px; background: #fff; border: 1px solid #2e8ca3; border-radius: 8px; box-shadow: 0 2px 10px #0002; z-index: 10; min-width: 120px; padding: 6px;">
              <button type="button" id="sortByBuilding" class="sort-btn" style="width:100%; margin-bottom:4px;">ترتيب حسب المبنى</button>
              <button type="button" id="sortByWorkItem" class="sort-btn" style="width:100%;">ترتيب حسب بند الأعمال</button>
              <button type="button" id="sortByCurrentPercent" class="sort-btn" style="width:100%; margin-top:4px;">ترتيب حسب الحالي %</button>
            </div>
          </div>
        </div>
      </div>
      <!-- خط فاصل بين الأزرار وجدول الأعمال -->
      <hr style="border:0; border-top:2px solid #8c969a; margin: 0 0 18px 0; width:100%;">
      <div class="table-section">
        <table id="workItemsTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a;">
          <thead>
            <tr style="background: #2e8ca3;">
              <th style="background: #2e8ca3; min-width:32px;">م</th>
              <th style="min-width:12px; max-width:40px;">المبنى</th>
              <th class="work-item-col">بند الأعمال</th>
              <th class="work-desc-col" style="min-width:180px; max-width:350px;">بيان الأعمال</th>
              <th style="min-width:38px;">الكمية</th>
              <th style="min-width:20px;">الوحدة</th>
              <th style="min-width:38px;">الفئة</th>
              <th style="min-width:38px;">السابق %</th>
              <th style="min-width:38px;">الحالي %</th>
              <th style="min-width:38px;">الإجمالي %</th>
              <th style="min-width:38px;">السابق $</th>
              <th style="min-width:38px;">الحالي $</th>
              <th style="min-width:38px;">الإجمالي $</th>
              <th style="min-width:38px;">حذف</th>
            </tr>
          </thead>
          <tbody id="workItemsBody"></tbody>
          <!-- شريط الإجمالي الثابت -->
          <tfoot>
            <tr id="workItemsTotalRow" style="background:#e8f5e9; font-weight:bold;">
              <td colspan="10" style="text-align:center;">الإجمالي</td>
              <td id="workItemsPrevAmountTotal" style="background:#c5d6db;">0</td>
              <td id="workItemsCurrentAmountTotal" style="background:#c5d6db;">0</td>
              <td id="workItemsTotalAmountTotal" style="background:#c5d6db;">0</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="14" style="padding:0; border:none;">
                <div style="display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:24px; margin:0; padding:10px 0 0 0;">
                  <div style="background:#ede7f6; border-radius:8px; padding:8px 24px; min-width:220px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 1px 6px #d1c4e9;">
                    <span style="color:#7a5230; font-weight:bold; font-size:1.05em;">قيمة الأعمال الإجمالية:</span>
                    <span id="workItemsGrandTotal" style="color:#2e8ca3; font-weight:bold; font-size:1.12em;"></span>
                  </div>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
        <!-- جدول المقطوعيات -->
        <div id="lumpSumSection" style="display:none; margin-top:0;">
          <h3 class="section-title" style="margin-bottom:10px; margin-top:0; text-align:right; display:flex; align-items:center; gap:8px;">
            المقطوعيات
            <!-- زر إضافة صف جديد كأيقونة -->
            <button type="button" id="addLumpSumRowBtn" title="إضافة صف جديد"
              style="background: #388e3c; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
              data-permission="add-extract-add-lump">
              <i class="fa fa-plus"></i>
            </button>
          </h3>
          <table id="lumpSumTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd;">
            <thead>
              <tr style="background: #2e8ca3;">
                <th style="background: #2e8ca3; min-width:32px;">م</th>
                <th style="min-width:60px;">عدد المبانى</th>
                <th style="min-width:120px;">بيان الأعمال</th>
                <th style="min-width:90px;">التاريخ</th>
                <th style="min-width:80px;">اليوميات / المقطوعية</th>
                <th style="min-width:80px;">الإجمالي</th>
                <th style="min-width:80px;">مستخلص رقم</th>
                <th style="min-width:38px;">حذف</th>
              </tr>
            </thead>
            <tbody id="lumpSumBody"></tbody>
            <tfoot>
              <tr style="background:#e8f5e9; font-weight:bold;">
                <td colspan="5" style="text-align:center;">الإجمالي</td>
                <td id="lumpSumTotalCell" style="background:#c5d6db;">0</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <!-- أضف جدول اليوميات هنا -->
        <div class="table-section" id="dailySection" style="display:none; margin-top:0;">
          <h3 id="dailyTitle" style="margin-top:0; margin-bottom:10px; text-align:right; display:flex; align-items:center; gap:8px;">
            يوميات
            <!-- زر إضافة صف جديد كأيقونة -->
            <button type="button" id="addDailyRowBtn" title="إضافة صف يومية"
              style="background: #388e3c; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 4px; cursor: pointer; box-shadow: 0 2px 8px #0001;"
              data-permission="add-extract-add-daily">
              <i class="fa fa-plus"></i>
            </button>
          </h3>
          <div style="overflow-x:auto; max-width:100%;">
            <table id="dailyTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd; min-width:900px;">
              <thead>
                <tr style="background: #2e8ca3;">
                  <th style="background: #2e8ca3; min-width:32px;">م</th>
                  <th data-col="dailyDesc" style="min-width:220px;">بيان اليوميات</th>
                  <th data-col="dailyCount" style="min-width:40px;">عدد اليوميات</th>
                  <th data-col="dailyValue" style="min-width:50px;">قيمة اليومية</th>
                  <th style="min-width:60px;">المبنى</th>
                  <th data-col="prev" style="min-width:70px;">السابق</th>
                  <th data-col="current" style="min-width:70px;">الحالي</th>
                  <th data-col="total" style="min-width:70px;">الإجمالي</th>
                  <th data-col="prevAmount" style="min-width:70px;">السابق مبلغ</th>
                  <th data-col="currentAmount" style="min-width:70px;">الحالي مبلغ</th>
                  <th data-col="totalAmount" style="min-width:70px;">الإجمالي مبلغ</th>
                  <th style="min-width:38px;">حذف</th>
                </tr>
              </thead>
              <tbody id="dailyBody"></tbody>
              <tfoot>
                <tr style="background:#e8f5e9; font-weight:bold;">
                  <td colspan="8" style="text-align:center;">الإجمالي</td>
                  <td id="dailyPrevAmountTotal" style="background:#c5d6db;">0</td>
                  <td id="dailyCurrentAmountTotal" style="background:#c5d6db;">0</td>
                  <td id="dailyTotalAmountTotal" style="background:#c5d6db;">0</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <!-- أزرار الإضافة كانت هنا، تم نقلها للأعلى -->
        <!--
        <button type="button" class="add-row-btn" id="addLumpSumBtn" style="background:#7a5230;">إضافة مقطوعية / يوميات</button>
        <button type="button" class="add-row-btn" id="addDailyBtn" style="background:#388e3c;">إضافة يوميات</button>
        <button type="button" class="add-row-btn" id="addSeparatorBtn" style="background:#7a5230;">+ إضافة فاصل</button>
        -->
      </div>
      <!-- الخصومات والاستحقاقات -->
      <h3 style="display:flex; align-items:center; gap:8px;">
        <span>الخصومات والاستحقاقات</span>
        <button type="button" id="toggleDeductionsBtn" style="background:#fff; border:1px solid #388e3c; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
          <span id="deductionsArrow" style="font-size:1.2rem; color:#388e3c;">&#x25BC;</span>
        </button>
      </h3>
      <div id="deductionsSection" class="table-section" style="background: #e3f2fd; border: 1px solid #90caf9; display:none;">
        <table id="deductionsTable" style="border-radius: 10px; overflow: hidden;">
          <thead>
            <tr style="background: #90caf9;">
              <th style="background: #42a5f5;">بيان الخصم</th>
              <th>التاريخ</th>
              <th>الكمية</th>
              <th>الفئة</th>
              <th>الإجمالي</th>
              <th>اسم المستخدم</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="deductionsBody"></tbody>
        </table>
        <button type="button" class="add-row-btn" id="addDeductionRowBtn" style="background: #42a5f5;">+ إضافة صف جديد</button>
      </div>
      <div class="summary" style="display: flex; justify-content: space-between; align-items: center; gap: 18px;">
        <div>
          <span>الصافي قبل الخصومات:</span>
          <span id="beforeDeductions">0</span>
        </div>
        <div>
          <span>إجمالي الخصومات:</span>
          <span id="totalDeductions">0</span>
        </div>
        <div>
          <span>الصافي بعد الخصومات:</span>
          <span id="afterDeductions">0</span>
        </div>
      </div>
    </form>
    <div class="table-section" id="lumpSumSection" style="display:none; margin-top:0;">
      <!-- كرر نفس التعديل أعلاه إذا كان هناك تكرار للقسم (احذف زر الإضافة السفلي) -->
      <table id="lumpSumTable" style="border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #8c969a; width:100%; background:#f7fafd;">
        <thead>
          <tr style="background: #2e8ca3;">
            <th style="background: #2e8ca3; min-width:32px;">م</th>
            <th style="min-width:60px;">عدد المبانى</th>
            <th style="min-width:120px;">بيان الأعمال</th>
            <th style="min-width:90px;">التاريخ</th>
            <th style="min-width:80px;">اليوميات / المقطوعية</th>
            <th style="min-width:80px;">الإجمالي</th>
            <th style="min-width:80px;">مستخلص رقم</th>
            <th style="min-width:38px;">حذف</th>
          </tr>
        </thead>
        <tbody id="lumpSumBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-message">
      🔄 جاري حفظ المستخلص... يرجى الانتظار قليلاً
    </div>
  </div>
  
  <script>
    // دالة إظهار رسالة النجاح
    function showSuccessNotification(message) {
      // إنشاء عنصر الرسالة
      const notification = document.createElement('div');
      notification.className = 'success-notification';
      notification.textContent = message;
      
      // إضافة الرسالة للصفحة
      document.body.appendChild(notification);
      
      // إزالة الرسالة بعد 3 ثواني
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }
    
    // المقاولين من السيرفر (تعديل: جلب حسب بند الأعمال)
    async function loadContractors(workItem = null) {
      const select = document.getElementById('contractorSelect');
      const current = select.value;
      select.innerHTML = '<option value="">اختر المقاول</option>';
      try {
        let url = '/contractors';
        if (workItem) {
          url += '?workItem=' + encodeURIComponent(workItem);
        }
        const res = await fetch(url);
        const contractors = await res.json();
        contractors.forEach(c => {
          const option = document.createElement('option');
          option.value = c._id || c.name;
          option.textContent = c.name;
          select.appendChild(option);
        });
        // إعادة اختيار المقاول الحالي إذا كان موجود
        if (current) select.value = current;
      } catch (err) {
        alert('تعذر تحميل قائمة المقاولين. تأكد من تشغيل السيرفر.');
      }
    }

    // عند تغيير بند الأعمال، جلب المقاولين الخاصين به فقط
    document.getElementById('workItemFilterSelect').addEventListener('change', function() {
      const workItem = this.value;
      const contractorSelect = document.getElementById('contractorSelect');
      if (workItem) {
        contractorSelect.disabled = false;
        loadContractors(workItem);
      } else {
        contractorSelect.disabled = true;
        contractorSelect.innerHTML = '<option value="">اختر المقاول</option>';
      }
      contractorSelect.value = '';
    });

    // عند الضغط على زر تحديث المقاولين، جلب حسب البند الحالي
    document.getElementById('refreshContractorsBtn').onclick = function() {
      const workItem = document.getElementById('workItemFilterSelect').value;
      loadContractors(workItem);
    };

    // عند تحميل الصفحة، جلب المقاولين للبند الحالي (إن وجد)
    document.addEventListener('DOMContentLoaded', function() {
      const workItem = document.getElementById('workItemFilterSelect').value;
      const contractorSelect = document.getElementById('contractorSelect');
      if (!workItem) {
        contractorSelect.disabled = true;
        contractorSelect.innerHTML = '<option value="">اختر المقاول</option>';
      } else {
        contractorSelect.disabled = false;
        loadContractors(workItem);
      }
    });

    // جلب بنود الأعمال الفعلية من السيرفر وتعبئة القائمة
    async function loadWorkItemsOptions() {
      const select = document.getElementById('workItemFilterSelect');
      select.innerHTML = '<option value="">اختر بند الأعمال</option>';
      try {
        const res = await fetch('/contractors');
        const contractors = await res.json();
        // استخرج جميع البنود الفريدة فقط
        const workItemsSet = new Set();
        contractors.forEach(c => {
          if (c.workItem && typeof c.workItem === 'string' && c.workItem.trim()) {
            workItemsSet.add(c.workItem.trim());
          }
        });
        Array.from(workItemsSet).sort().forEach(workItem => {
          const option = document.createElement('option');
          option.value = workItem;
          option.textContent = workItem;
          select.appendChild(option);
        });
      } catch (err) {
        // في حال الخطأ، أبقِ الخيار الافتراضي فقط
      }
    }

    // عند تحميل الصفحة، جلب جميع البنود الفريدة من السيرفر
    document.addEventListener('DOMContentLoaded', async function() {
      await loadWorkItemsOptions();
      const workItem = document.getElementById('workItemFilterSelect').value;
      loadContractors(workItem);
    });

    let sortOrder = [];
    let groupsCollapsed = {};
    let workItems = [];
    // المتغيرات الفعلية للبيانات معرّفة في مواضعها الصحيحة:
    // - lumpSumRows معرّف في سطر 2185
    // - dailyRows معرّف في سطر 2312
    // - الخصومات تُجمع مباشرة من #deductionsBody

    document.getElementById('sortByBuilding').addEventListener('click', function() {
      toggleSort('buildingNumber');
      renderWorkItems();
    });
    document.getElementById('sortByWorkItem').addEventListener('click', function() {
      toggleSort('workItem');
      renderWorkItems();
    });
    // زر الترتيب حسب الحالي %
    document.getElementById('sortByCurrentPercent').addEventListener('click', function() {
      toggleSort('currentPercentFilter');
      renderWorkItems();
    });

    function toggleSort(field) {
      const idx = sortOrder.indexOf(field);
      if (idx === -1) {
        sortOrder.push(field);
        if (field === 'buildingNumber')
          document.getElementById('sortByBuilding').classList.add('active');
        else if (field === 'workItem')
          document.getElementById('sortByWorkItem').classList.add('active');
        else if (field === 'currentPercentFilter')
          document.getElementById('sortByCurrentPercent').classList.add('active');
      } else {
        sortOrder.splice(idx, 1);
        if (field === 'buildingNumber')
          document.getElementById('sortByBuilding').classList.remove('active');
        else if (field === 'workItem')
          document.getElementById('sortByWorkItem').classList.remove('active');
        else if (field === 'currentPercentFilter')
          document.getElementById('sortByCurrentPercent').classList.remove('active');
      }
      groupsCollapsed = {};
    }

    document.getElementById('contractorSelect').addEventListener('change', async function() {
      // تجاهل إذا كان يتم تحميل مسودة
      if (window.isLoadingDraft) return;
      
      const contractorId = this.value;
      const input = document.getElementById('statementNumber');
      // جلب بيانات المقاول
      if (contractorId) {
        try {
          const contractorRes = await fetch(`/contractors`);
          const contractors = await contractorRes.json();
          const contractor = contractors.find(c => c._id === contractorId);
          // جلب maxTotalPercentPerItem
          window.maxTotalPercentPerItem = contractor?.maxTotalPercentPerItem || {};
          document.getElementById('maxTotalPercentInput').value = contractor.maxTotalPercent || 100;
        } catch {
          window.maxTotalPercentPerItem = {};
          document.getElementById('maxTotalPercentInput').value = 100;
        }
        try {
          const res = await fetch(`/extracts?contractor=${contractorId}`);
          const extracts = await res.json();
          const filteredExtracts = extracts.filter(e => e.contractor == contractorId);
          input.value = filteredExtracts.length + 1;
          let prev = filteredExtracts.length > 0 ? filteredExtracts[filteredExtracts.length - 1] : null;

          // نسخ بنود الأعمال: الحالى دائما صفر
          if (prev && prev.workItems && prev.workItems.length > 0) {
            workItems = prev.workItems.map(item => ({
              ...item,
              prevPercent: item.totalPercent || '',
              prevAmount: item.totalAmount || '',
              currentPercent: '0',
              currentAmount: '0',
              totalPercent: item.totalPercent || '',
              totalAmount: item.totalAmount || ''
            }));
          } else {
            // لا تمحو workItems إذا كان يتم تحميل مسودة
            if (!window.isLoadingDraft) {
              workItems = [];
            }
          }

          if (workItems.length === 0) {
            addWorkItemRow();
          }
          renderWorkItems();

          // نسخ القطوعيات من المستخلص السابق بدون تكرار
          lumpSumRows = [];
          if (prev && prev.lumpSumRows && prev.lumpSumRows.length > 0) {
            prev.lumpSumRows.forEach(row => {
              lumpSumRows.push({
                buildingsCount: row.buildingsCount,
                statementDesc: row.statementDesc,
                lumpSum: row.lumpSum,
                date: row.date,
                total: row.total,
                statementNumber: row.statementNumber || prev.number // رقم المستخلص الأصلي
              });
            });
            document.getElementById('lumpSumSection').style.display = '';
            renderLumpSumRows();
          } else {
            document.getElementById('lumpSumSection').style.display = 'none';
            lumpSumRows = [];
            renderLumpSumRows();
          }

          // ====== ترحيل جدول اليوميات ======
          dailyRows = [];
          if (prev && Array.isArray(prev.dailyRows) && prev.dailyRows.length > 0) {
            // رحّل القيم من المستخلص السابق
            prev.dailyRows.forEach(row => {
              dailyRows.push({
                dailyDesc: row.dailyDesc || '',
                dailyCount: row.dailyCount || '',
                dailyValue: row.dailyValue || '',
                building: row.building || '',
                prev: row.total || '', // ترحيل الإجمالي السابق
                current: '',
                total: row.total || '', // الإجمالي = السابق + الحالي (الحالي صفر)
                prevAmount: row.totalAmount || '', // ترحيل الإجمالي مبلغ السابق
                currentAmount: '',
                totalAmount: row.totalAmount || '' // الإجمالي مبلغ = السابق + الحالي (الحالي صفر)
              });
            });
            document.getElementById('dailySection').style.display = '';
            renderDailyRows();
          } else {
            document.getElementById('dailySection').style.display = 'none';
            dailyRows = [];
            renderDailyRows();
          }
          // ====== نهاية ترحيل جدول اليوميات ======

        } catch {
          if (!window.isLoadingDraft) {
            input.value = '';
            workItems = [];
            addWorkItemRow();
            renderWorkItems();
            lumpSumRows = [];
            document.getElementById('lumpSumSection').style.display = 'none';
            renderLumpSumRows();
            dailyRows = [];
            document.getElementById('dailySection').style.display = 'none';
            renderDailyRows();
          }
        }
      } else {
        if (!window.isLoadingDraft) {
          input.value = '';
          workItems = [];
          addWorkItemRow();
          renderWorkItems();
          lumpSumRows = [];
          document.getElementById('lumpSumSection').style.display = 'none';
          renderLumpSumRows();
          // جدول اليوميات فارغ ومخفي
          dailyRows = [];
          document.getElementById('dailySection').style.display = 'none';
          renderDailyRows();
        }
      }
    });

    function addWorkItemRow() {
      workItems.push({
        buildingNumber: '',
        workItem: '',
        workDescription: '',
        quantity: '',
        unit: '',
        category: '',
        prevPercent: '',
        currentPercent: '',
        totalPercent: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      });
      renderWorkItems();
    }

    // تعديل addWorkItemRow ليضيف صف بعد آخر صف أو بعد الفاصل إذا كان آخر صف فاصل
    function addWorkItemRow(afterIdx = null) {
      const newRow = {
        buildingNumber: '',
        workItem: '',
        workDescription: '',
        quantity: '',
        unit: '',
        category: '',
        prevPercent: '',
        currentPercent: '',
        totalPercent: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      };
      if (afterIdx !== null && afterIdx >= 0 && afterIdx < workItems.length) {
        workItems.splice(afterIdx + 1, 0, newRow);
      } else {
        workItems.push(newRow);
      }
      renderWorkItems();
    }

    // زر إضافة فاصل
    document.getElementById('addSeparatorBtn').onclick = function() {
      const name = prompt('اكتب اسم الفاصل:');
      if (name && name.trim()) {
        workItems.push({ isSeparator: true, separatorName: name.trim() });
        renderWorkItems();
      }
    };

    // تعديل renderWorkItems لدعم الفواصل
    function renderWorkItems() {
      let items = [...workItems];
      // تصفية حسب الحالي %
      if (sortOrder.includes('currentPercentFilter')) {
        items = items.filter(item => item.currentPercent && item.currentPercent !== '0');
      }

      // إذا كان هناك ترتيب حسب المبنى أو البند الأعمال، أخفِ الفواصل
      let hideSeparators = false;
      if (
        (sortOrder.length === 1 && (sortOrder[0] === 'buildingNumber' || sortOrder[0] === 'workItem')) ||
        (sortOrder.length === 2 && sortOrder.includes('buildingNumber') && sortOrder.includes('workItem'))
      ) {
        hideSeparators = true;
      }

      if (sortOrder.length > 0) {
        // تجاهل currentPercentFilter من الترتيب، فقط للتصفية
        let orderFields = sortOrder.filter(f => f !== 'currentPercentFilter');
        if (orderFields.length > 0) {
          items.sort((a, b) => {
            for (let field of orderFields) {
              if (a[field] < b[field]) return -1;
              if (a[field] > b[field]) return 1;
            }
            return 0;
          });
        }
      }

      let finalHtml = '';
      let rowNum = 1;

      // دالة لرسم صف عادي أو فاصل
      function renderRowOrSeparator(item, idx, groupKey) {
        if (item.isSeparator) {
          if (hideSeparators) return ''; // إخفاء الفواصل عند الترتيب
          let hiddenClass = groupKey && groupsCollapsed[groupKey] ? "hidden-row" : "";
          return `
            <tr class="group-row ${hiddenClass}" style="background:#7a5230 !important; color:#fff; font-weight:bold; height:22px;">
              <td colspan="13" style="text-align:center; padding:2px 0; background:#7a5230 !important;">
                <span style="font-size:0.92rem; vertical-align:middle;">${item.separatorName || item.name || 'فاصل'}</span>
              </td>
              <td style="text-align:center; background:#7a5230 !important; padding:0;">
                <button type="button" class="delete-separator-btn" data-idx="${idx}" title="حذف الفاصل"
                  style="background:none; color:#fff; border:none; border-radius:0; width:auto; height:auto; font-size:1.5rem; cursor:pointer; font-weight:bold; display:inline-block; vertical-align:middle; line-height:1; float:left;">
                  &times;
                </button>
              </td>
            </tr>
          `;
        } else {
          return workItemRowHtml(item, rowNum++, idx, groupKey);
        }
      }

      if (sortOrder.length === 2) {
        // ترتيب حسب المبنى ثم بند الأعمال
        let groups = {};
        items.forEach((item, idx) => {
          let building = item.buildingNumber || 'بدون';
          let workItem = item.workItem || 'بدون';
          if (!groups[building]) groups[building] = {};
          if (!groups[building][workItem]) groups[building][workItem] = [];
          groups[building][workItem].push({ item, idx });
        });

        for (let building in groups) {
          let groupKey1 = `g1_${building}`;
          let totalInGroup1 = Object.values(groups[building]).reduce((acc, arr) => acc + arr.length, 0);

          // صف رقم المبنى (قابل للطي/الفتح)
          finalHtml += `
            <tr class="group-row" data-group="${groupKey1}" style="height:20px;">
              <td colspan="13" style="text-align:right; cursor:pointer; background:#8c969a; color:#fff; font-weight:bold; font-size:.7rem; border-radius:10px 10px 0 0;">
                رقم المبنى: ${building} (${totalInGroup1})
                <span id="icon_${groupKey1}">${groupsCollapsed[groupKey1] ? "&#x25BC;" : "&#x25B2;"}</span>
              </td>
            </tr>
          `;

          for (let workItem in groups[building]) {
            let groupKey2 = `g2_${building}_${workItem}`;
            let subgroupHidden = groupsCollapsed[groupKey1] ? "hidden-row" : "";
            finalHtml += `
              <tr class="subgroup-row ${subgroupHidden}" data-group="${groupKey2}" data-parent="${groupKey1}" style="height:20px;">
                <td colspan="13" style="text-align:right; cursor:pointer; background:#c5d6db; color:#1a3b50; font-weight:bold; font-size:.7rem; border-radius:0 0 10px 10px;">
                  بند الأعمال: ${workItem} (${groups[building][workItem].length})
                  <span id="icon_${groupKey2}">${groupsCollapsed[groupKey2] ? "&#x25BC;" : "&#x25B2;"}</span>
                </td>
              </tr>
            `;
            // صفوف الأعمال تحت البند
            if (!groupsCollapsed[groupKey2] && !groupsCollapsed[groupKey1]) {
              groups[building][workItem].forEach(({ item, idx }) => {
                finalHtml += renderRowOrSeparator(item, idx, groupKey2);
              });
            }
          }
        }
      } else if (sortOrder.length === 1) {
        // ترتيب حسب المبنى أو بند الأعمال فقط
        let field = sortOrder[0];
        let groups = {};
        items.forEach((item, idx) => {
          let key = item[field] || 'بدون';
          if (!groups[key]) groups[key] = [];
          groups[key].push({ item, idx });
        });
        for (let g in groups) {
          let groupKey = `g_${g}`;
          finalHtml += `
            <tr class="group-row" data-group="${groupKey}">
              <td colspan="13" style="text-align:right; cursor:pointer;">
                <span style="font-weight:bold;">
                  ${field === 'buildingNumber' ? 'رقم المبنى: ' : 'بند الأعمال: '}${g} (${groups[g].length})
                  <span id="icon_${groupKey}">${groupsCollapsed[groupKey] ? "&#x25BC;" : "&#x25B2;"}</span>
                </span>
              </td>
            </tr>
          `;
          if (!groupsCollapsed[groupKey]) {
            groups[g].forEach(({ item, idx }) => {
              finalHtml += renderRowOrSeparator(item, idx, groupKey);
            });
          }
        }
      } else {
        // بدون ترتيب
        items.forEach((item, idx) => {
          finalHtml += renderRowOrSeparator(item, idx, null);
        });
      }

      document.getElementById('workItemsBody').innerHTML = finalHtml;

      // قفل جميع الحقول إذا لم توجد صلاحيات أو لا توجد صلاحية تعديل الأعمال
      let user = {};
      try { user = JSON.parse(localStorage.getItem('user')) || {}; } catch {}
      const perms = user.permissions || [];
      const canEditAll = perms.includes('add-extract-edit-all');
      const canEditCurrent = perms.includes('add-extract-edit-current');
      
      // لا نقفل الجدول هنا - permissions-check.js يتولى إدارة الصلاحيات
      // السماح بالتفاعل مع الجدول بناءً على الصلاحيات الفردية

      // تفعيل الطي/الفتح للمجموعات والمجموعات الفرعية
      document.querySelectorAll('.group-row').forEach(el => {
        let groupKey = el.dataset.group;
        el.onclick = function() {
          groupsCollapsed[groupKey] = !groupsCollapsed[groupKey];
          renderWorkItems();
        }
      });
      document.querySelectorAll('.subgroup-row').forEach(el => {
        let groupKey = el.dataset.group;
        el.onclick = function(e) {
          e.stopPropagation();
          groupsCollapsed[groupKey] = !groupsCollapsed[groupKey];
          renderWorkItems();
        }
      });
      document.querySelectorAll('.work-item-input').forEach(input => {
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // سجل آخر حقل تم تعديله قبل التحديث
          if (!window._lastWorkItemField) window._lastWorkItemField = {};
          window._lastWorkItemField[idx] = field;
          
          // تحديث القيمة في المصفوفة
          workItems[idx][field] = e.target.value;
          
          // تنفيذ الحسابات والتحديثات
          updateTotalsRow(idx);
        };
      });
      // إضافة أحداث حذف الفاصل
      document.querySelectorAll('.delete-separator-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          if (!isNaN(idx)) {
            workItems.splice(idx, 1);
            renderWorkItems();
          }
        };
      });
      updateTotalRowInTable();
    }

    // دالة لتحريك صف للأعلى (يسمح بالتحريك فوق الفاصل)
    function moveRowUp(idx) {
      if (idx > 0) {
        [workItems[idx - 1], workItems[idx]] = [workItems[idx], workItems[idx - 1]];
        renderWorkItems();
        calculateSummary();
      }
    }

    // دالة لتحريك صف للأسفل (يسمح بالتحريك تحت الفاصل)
    function moveRowDown(idx) {
      if (idx < workItems.length - 1) {
        [workItems[idx], workItems[idx + 1]] = [workItems[idx + 1], workItems[idx]];
        renderWorkItems();
        calculateSummary();
      }
    }

    // عدل دالة workItemRowHtml ليكون السحب فقط من المقبض وليس الصف كله
    function workItemRowHtml(item, rowNum, idx, groupKey) {
      let hiddenClass = groupKey && groupsCollapsed[groupKey] ? "hidden-row" : "";

      // تحقق من صلاحية المستخدم
      const userStr = localStorage.getItem('user');
      const user = userStr ? JSON.parse(userStr) : {};
      const canEditAll = user.permissions && user.permissions.includes('add-extract-edit-all');
      const canEditWorkitem = user.permissions && user.permissions.includes('add-extract-edit-workitem');
      const canEditCurrent = user.permissions && user.permissions.includes('add-extract-create');
      const canMove = user.permissions && user.permissions.includes('add-extract-create');
      const canDelete = user.permissions && user.permissions.includes('add-extract-delete-workitem');
      
      // تحقق من قفل البند (إما مقفول أو مسحوب)
      const isLocked = item.locked || item.isPulled;
      const isPulledWork = item.isPulledWork; // عمل مسحوب من مقاول آخر
      
      // تحديد نوع القفل ولون الخلفية
      let readonlyAttr = '';
      let readonlyAttrForPercentCurrent = '';
      let readonlyAttrForAmountCurrent = '';
      let lockMsg = '';
      let bgColor = '';
      
      if (item.isPulled) {
        // عمل تم سحبه من هذا المقاول - كل شيء مقفول
        readonlyAttr = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        lockMsg = `title="تم سحب هذا العمل إلى مقاول آخر ولا يمكن تعديله"`;
        bgColor = 'style="background:#ffe0e0;"';
      } else if (isPulledWork) {
        // عمل مسحوب من مقاول آخر - البيانات الأساسية مقفولة لكن النسبة والمبلغ الحالي متاحين
        readonlyAttr = 'readonly style="background:#e8f5e9;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = ''; // خانة النسبة الحالية متاحة
        readonlyAttrForAmountCurrent = ''; // خانة المبلغ الحالي متاحة
        lockMsg = `title="هذا العمل مسحوب من ${item.pulledFromContractorName || 'مقاول آخر'} - يمكن تعديل النسبة والمبلغ الحالي فقط"`;
        bgColor = 'style="background:#e8f5e9;"';
      } else if (isLocked) {
        // مقفول لسبب آخر
        readonlyAttr = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#ffe0e0;cursor:not-allowed;"';
        lockMsg = 'title="تم احتساب هذا البند لمقاول آخر ولا يمكن تعديله"';
        bgColor = 'style="background:#ffe0e0;"';
      } else if (canEditAll || canEditWorkitem) {
        // المستخدم لديه صلاحية تعديل كامل أو تعديل بنود الأعمال - كل شيء متاح
        readonlyAttr = '';
        readonlyAttrForPercentCurrent = '';
        readonlyAttrForAmountCurrent = '';
        lockMsg = '';
        bgColor = '';
      } else if (canEditCurrent) {
        // المستخدم لديه صلاحية إنشاء مستخلص فقط - كل شيء مقفول ماعدا الحالي
        readonlyAttr = 'readonly style="background:#fff3e0;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = ''; // خانة النسبة الحالية متاحة
        readonlyAttrForAmountCurrent = 'readonly style="background:#fff3e0;cursor:not-allowed;"'; // المبلغ الحالي مقفول
        lockMsg = `title="يمكنك تعديل النسبة الحالية فقط"`;
        bgColor = 'style="background:#fffef0;"';
      } else {
        // لا توجد صلاحيات - كل شيء مقفول
        readonlyAttr = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        readonlyAttrForPercentCurrent = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        readonlyAttrForAmountCurrent = 'readonly style="background:#f5f5f5;cursor:not-allowed;"';
        lockMsg = 'title="ليس لديك صلاحية للتعديل"';
        bgColor = 'style="background:#fafafa;"';
      }

      return `
        <tr class="work-row ${hiddenClass}" ${groupKey ? `data-childof="${groupKey}"` : ""} data-idx="${idx}" ${bgColor}>
          <td title="اسحب لتغيير ترتيب الصف" ${lockMsg}>
            <span class="drag-handle" draggable="true" data-idx="${idx}">&#9776;</span>
            ${rowNum}${isLocked ? ' 🔒' : ''}${isPulledWork ? ' ⬅️' : ''}${item.isPulled ? ' ➡️' : ''}
          </td>
          <td><input name="buildingNumber" class="work-item-input" data-idx="${idx}" data-field="buildingNumber" value="${item.buildingNumber || ''}" required placeholder="رقم المبني" ${readonlyAttr}></td>
          <td><input name="workItem" class="work-item-input" data-idx="${idx}" data-field="workItem" value="${item.workItem || ''}" required placeholder="مثل: 1أ، 1ب، 2أ، 2ب" ${readonlyAttr}></td>
          <td><input name="workDescription" class="work-item-input" data-idx="${idx}" data-field="workDescription" value="${item.workDescription || ''}" placeholder="بيان الأعمال" ${readonlyAttr}></td>
          <td><input name="quantity" class="work-item-input" data-idx="${idx}" data-field="quantity" value="${item.quantity || ''}" type="number" step="any" required placeholder="الكمية" ${readonlyAttr}></td>
          <td><input name="unit" class="work-item-input" data-idx="${idx}" data-field="unit" value="${item.unit || ''}" placeholder="الوحدة" ${readonlyAttr}></td>
          <td><input name="category" class="work-item-input" data-idx="${idx}" data-field="category" value="${item.category || ''}" type="number" step="any" placeholder="الفئة" ${readonlyAttr}></td>
          <td><input name="prevPercent" class="work-item-input" data-idx="${idx}" data-field="prevPercent" value="${item.prevPercent || ''}" type="number" step="any" placeholder="السابق نسبة" readonly style="background:#e5f8e5;"></td>
          <td><input name="currentPercent" class="work-item-input" data-idx="${idx}" data-field="currentPercent" value="${item.currentPercent || ''}" type="number" step="any" placeholder="الحالي نسبة" ${readonlyAttrForPercentCurrent}></td>
          <td><input name="totalPercent" class="work-item-input" data-idx="${idx}" data-field="totalPercent" value="${item.totalPercent || ''}" type="number" step="any" readonly placeholder="الإجمالي نسبة" style="background:#e5f8e5;"></td>
          <td><input name="prevAmount" class="work-item-input" data-idx="${idx}" data-field="prevAmount" value="${item.prevAmount || ''}" type="number" step="any" placeholder="السابق مبلغ" readonly style="background:#e5f8e5;"></td>
          <td><input name="currentAmount" class="work-item-input" data-idx="${idx}" data-field="currentAmount" value="${item.currentAmount || ''}" type="number" step="any" placeholder="الحالي مبلغ" ${readonlyAttrForAmountCurrent}></td>
          <td><input name="totalAmount" class="work-item-input" data-idx="${idx}" data-field="totalAmount" value="${item.totalAmount || ''}" type="number" step="any" readonly placeholder="الإجمالي مبلغ" style="background:#e5f8e5;"></td>
          <td>
            ${canDelete && !(isLocked && !isPulledWork) ? `
              <button type="button" class="delete-work-row" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button>
            ` : ''}
            ${canMove && !(isLocked && !isPulledWork) ? `
              <button type="button" class="move-up-row" data-idx="${idx}" title="تحريك لأعلى" style="background:#fff; color:#388e3c; border:1px solid #388e3c; border-radius:5px; padding:2px 6px; margin-right:2px; cursor:pointer;">&#8593;</button>
              <button type="button" class="move-down-row" data-idx="${idx}" title="تحريك لأسفل" style="background:#fff; color:#388e3c; border:1px solid #388e3c; border-radius:5px; padding:2px 6px; margin-right:2px; cursor:pointer;">&#8595;</button>
            ` : ''}
          </td>
        </tr>
      `;
    }

    // 🎯 الحل الرابع Hybrid: حساب ذكي مع تنبيهات (مع الحفاظ على السابق مبلغ)
    function updateTotalsRow(idx) {
      let item = workItems[idx];
      let quantity = parseFloat(item.quantity) || 0;
      let category = parseFloat(item.category) || 0;
      const totalItemValue = quantity * category; // القيمة الجديدة للبند

      // الحد الأقصى للإجمالي %
      let maxTotalPercent = parseFloat(document.getElementById('maxTotalPercentInput')?.value) || 100;

      // معرفة آخر حقل تم تعديله
      if (!window._lastWorkItemField) window._lastWorkItemField = {};
      let lastField = window._lastWorkItemField[idx];
      
      // 🆕 تتبع إذا كانت القيم محسوبة تلقائياً
      if (!window._autoCalculatedFields) window._autoCalculatedFields = {};
      if (!window._autoCalculatedFields[idx]) window._autoCalculatedFields[idx] = {};

      // 🔧 عند تغيير الكمية أو الفئة: إعادة حساب السابق% بناءً على السابق مبلغ الثابت
      if (lastField === 'quantity' || lastField === 'category') {
        const prevAmount = parseFloat(item.prevAmount) || 0;
        if (totalItemValue > 0 && prevAmount > 0) {
          // إعادة حساب السابق% = (السابق مبلغ / القيمة الجديدة) × 100
          item.prevPercent = ((prevAmount / totalItemValue) * 100).toFixed(2);
          window._autoCalculatedFields[idx].prevPercent = true;
        }
        
        // 🔧 إعادة حساب الحالي% والحالي مبلغ بناءً على الحالي مبلغ الثابت
        const currentAmount = parseFloat(item.currentAmount) || 0;
        if (totalItemValue > 0 && currentAmount > 0) {
          // إعادة حساب الحالي% = (الحالي مبلغ / القيمة الجديدة) × 100
          item.currentPercent = ((currentAmount / totalItemValue) * 100).toFixed(2);
          window._autoCalculatedFields[idx].currentPercent = true;
        }
      }

      if (lastField === 'currentAmount') {
        let currentAmount = parseFloat(item.currentAmount) || 0;
        let percent = 0;
        if (totalItemValue !== 0) {
          percent = (currentAmount / totalItemValue) * 100;
        }
        item.currentPercent = +percent.toFixed(2);
        item.currentAmount = currentAmount.toFixed(2);
        window._autoCalculatedFields[idx].currentPercent = true;
      } else if (lastField === 'currentPercent') {
        // عند تعديل الحالي% مباشرة
        let current = parseFloat(item.currentPercent) || 0;
        item.currentAmount = ((totalItemValue * current) / 100).toFixed(2);
        window._autoCalculatedFields[idx].currentAmount = true;
      }

      // حساب الإجمالي مع مراعاة الحد الأقصى
      const prevPercent = parseFloat(item.prevPercent) || 0;
      const currentPercent = parseFloat(item.currentPercent) || 0;
      item.totalPercent = +(prevPercent + currentPercent).toFixed(2);
      
      if (item.totalPercent > maxTotalPercent && maxTotalPercent > 0) {
        item.totalPercent = maxTotalPercent;
        // عدل currentPercent بحيث لا يتجاوز الحد الأقصى
        item.currentPercent = Math.max(0, (maxTotalPercent - prevPercent)).toFixed(2);
        item.currentAmount = ((totalItemValue * (item.currentPercent || 0)) / 100).toFixed(2);
        window._autoCalculatedFields[idx].currentPercent = true;
        window._autoCalculatedFields[idx].currentAmount = true;
      }
      
      item.totalAmount =
        ((parseFloat(item.prevAmount) || 0) +
        (parseFloat(item.currentAmount) || 0)).toFixed(2);

      // تحديث القيم في الجدول مباشرة
      let rowInputs = document.querySelectorAll('.work-item-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        let field = input.dataset.field;
        if (field === 'prevPercent') {
          input.value = item.prevPercent || '';
          // 🎨 تلوين الحقل المحسوب تلقائياً
          if (window._autoCalculatedFields[idx]?.prevPercent) {
            input.style.background = '#e3f2fd';
            input.title = '✨ محسوب تلقائياً بناءً على السابق مبلغ الثابت';
          }
        }
        if (field === 'currentPercent') {
          input.value = item.currentPercent || '';
          // 🎨 إزالة التلوين - خلي الحالي نسبة بلون ثابت
          // if (window._autoCalculatedFields[idx]?.currentPercent) {
          //   input.style.background = '#e3f2fd';
          //   input.title = '✨ محسوب تلقائياً';
          // }
        }
        if (field === 'totalPercent') {
          input.value = item.totalPercent || '';
        }
        if (field === 'currentAmount') {
          input.value = item.currentAmount || '';
          // 🎨 تلوين الحقل المحسوب تلقائياً
          if (window._autoCalculatedFields[idx]?.currentAmount) {
            input.style.background = '#e3f2fd';
            input.title = '✨ محسوب تلقائياً';
          }
        }
        if (field === 'totalAmount') input.value = item.totalAmount || '';
      });

      updateTotalRowInTable();
      calculateSummary();
    }

    document.getElementById('addWorkItemRowBtn').addEventListener('click', addWorkItemRow);

    function addDeductionRow() {
      const tbody = document.getElementById('deductionsBody');
      const userStr = localStorage.getItem('user');
      let username = '';
      if (userStr) {
        try {
          username = JSON.parse(userStr).username || '';
        } catch {}
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="position:relative; overflow:visible;">
          <button type="button" class="show-materials-btn" title="إدراج مادة" style="background:none; border:none; cursor:pointer; font-size:1.2em; color:#2e8ca3; margin-left:2px;">&#x25BC;</button>
          <input name="deductionStatement" style="width:70%;" autocomplete="off">
          <div class="materials-dropdown" style="display:none; position:fixed; left:0; top:0; z-index:99999; background:#fff; border:1px solid #2e8ca3; border-radius:7px; min-width:180px; max-width:350px; box-shadow:0 2px 12px #0002; max-height:320px; overflow:auto;"></div>
        </td>
        <td><input name="deductionDate" type="date"></td>
        <td><input name="deductionQuantity" type="number" step="any"></td>
        <td><input name="deductionCategory" type="number" step="any"></td>
        <td><input name="deductionTotal" type="number" step="any" readonly></td>
        <td><input name="deductionUser" value="${username}" readonly style="background:#e8f5e9;"></td>
        <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button></td>
      `;
      tbody.appendChild(tr);

      // حساب الاجمالى تلقائياً عند تغيير الكمية أو الفئة
      const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
      const catInput = tr.querySelector('input[name="deductionCategory"]');
      const totalInput = tr.querySelector('input[name="deductionTotal"]');
      const dateInput = tr.querySelector('input[name="deductionDate"]');
      
      function updateDeductionTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const cat = parseFloat(catInput.value) || 0;
        totalInput.value = (qty * cat).toFixed(2);
        calculateSummary();
      }
      qtyInput.addEventListener('input', updateDeductionTotal);
      catInput.addEventListener('input', updateDeductionTotal);
      
      // تحديث تاريخ المادة عند تغيير التاريخ
      dateInput.addEventListener('change', function() {
        if (tr.dataset.materialName) {
          tr.dataset.materialDate = this.value;
        }
      });

      // زر السهم لإظهار المواد
      const showBtn = tr.querySelector('.show-materials-btn');
      const dropdown = tr.querySelector('.materials-dropdown');
      const statementInput = tr.querySelector('input[name="deductionStatement"]');
      showBtn.onclick = async function(e) {
        e.stopPropagation();
        dropdown.innerHTML = '<div style="padding:8px; color:#888;">جاري التحميل...</div>';
        dropdown.style.display = 'block';

        // اجعل القائمة بمحاذاة مربع البيان وليس الزر
        const rect = statementInput.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 2) + 'px';
        dropdown.style.width = rect.width + 'px';

        // جلب المواد من المقاول المختار
        const contractorId = document.getElementById('contractorSelect')?.value;
        if (!contractorId) {
          dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">اختر المقاول أولاً</div>';
          return;
        }
        try {
          const res = await fetch(`/contractors/${contractorId}`);
          const contractor = await res.json();
          // فقط المواد التي لم تخصم بعد (لا يوجد لها deductedInExtractNumber)
          const availableMaterials = (contractor.materials || []).filter(mat => !mat.deductedInExtractNumber);
          if (!availableMaterials.length) {
            dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">لا توجد مواد متاحة للخصم لهذا المقاول</div>';
            return;
          }
          dropdown.innerHTML = availableMaterials.map((mat, i) => `
            <div class="material-option" data-name="${mat.name}" data-qty="${mat.quantity}" data-category="${mat.unitPrice || mat.category || ''}" style="padding:7px 12px; cursor:pointer; border-bottom:1px solid #eee;">
              <b>${mat.name}</b> <span style="color:#7a5230;">(${mat.quantity} ${mat.unit || ''})</span>
            </div>
          `).join('');
          dropdown.querySelectorAll('.material-option').forEach(opt => {
            opt.onclick = async function() {
              statementInput.value = opt.dataset.name;
              qtyInput.value = opt.dataset.qty;
              catInput.value = opt.dataset.category || '';
              dropdown.style.display = 'none';
              updateDeductionTotal();
              
              // لا تخصم المادة الآن، فقط احفظ معلومات المادة في الصف للاستخدام لاحقاً
              tr.dataset.materialName = opt.dataset.name;
              tr.dataset.materialDate = tr.querySelector('input[name="deductionDate"]')?.value || '';
            };
          });
        } catch {
          dropdown.innerHTML = '<div style="padding:8px; color:#e53935;">خطأ في جلب المواد</div>';
        }
      };

      // إغلاق القائمة عند الضغط خارجها
      document.addEventListener('click', function(e) {
        if (dropdown && dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== showBtn) {
          dropdown.style.display = 'none';
        }
      });
    }
    // تأكد من وجود العنصر قبل إضافة الحدث
    const addDeductionRowBtn = document.getElementById('addDeductionRowBtn');
    if (addDeductionRowBtn) {
      addDeductionRowBtn.addEventListener('click', addDeductionRow);
    }

    addWorkItemRow();
    addDeductionRow();

    // إغلاق الخصومات افتراضياً
    document.getElementById('deductionsSection').style.display = 'none';
    document.getElementById('deductionsArrow').textContent = '▼';

    document.getElementById('toggleDeductionsBtn').onclick = function() {
      const section = document.getElementById('deductionsSection');
      const arrow = document.getElementById('deductionsArrow');
      if (section.style.display === 'none') {
        section.style.display = '';
        arrow.textContent = '▲';
      } else {
        section.style.display = 'none';
        arrow.textContent = '▼';
      }
    };

    // إظهار/إخفاء قائمة الترتيب عند الضغط على الأيقونة
    document.addEventListener('DOMContentLoaded', function() {
      const sortMenuBtn = document.getElementById('sortMenuBtn');
      const sortMenu = document.getElementById('sortMenu');
      sortMenuBtn.onclick = function(e) {
        e.stopPropagation();
        sortMenu.style.display = sortMenu.style.display === 'block' ? 'none' : 'block';
      };
      // إغلاق القائمة عند الضغط خارجها
      document.addEventListener('click', function(e) {
        if (sortMenu.style.display === 'block') sortMenu.style.display = 'none';
      });
      // منع غلق القائمة عند الضغط داخلها
      sortMenu.onclick = function(e) { e.stopPropagation(); };
      
      // 🎯 نظام ذكي لمراقبة تغييرات حقول بنود الأعمال
      setupSmartCalculationSystem();
    });
    
    // 🎯 الحل الرابع Hybrid: نظام ذكي للحساب مع تنبيهات
    function setupSmartCalculationSystem() {
      document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('work-item-input')) return;
        
        const field = e.target.dataset.field;
        const idx = parseInt(e.target.dataset.idx);
        
        if (!workItems[idx] || workItems[idx].isSeparator) return;
        
        // تتبع آخر حقل تم تعديله
        if (!window._lastWorkItemField) window._lastWorkItemField = {};
        window._lastWorkItemField[idx] = field;
        
        // حفظ القيمة الجديدة
        workItems[idx][field] = e.target.value;
        
        // 🔔 منطق التحذير والحساب الذكي
        if (field === 'quantity' || field === 'category') {
          const currentPercent = parseFloat(workItems[idx].currentPercent) || 0;
          const prevPercent = parseFloat(workItems[idx].prevPercent) || 0;
          
          // ✅ السيناريو 1: المستخدم أدخل "الحالي%" → حساب تلقائي
          if (currentPercent > 0) {
            updateTotalsRow(idx);
            
            // إظهار رسالة توضيحية
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 60px;
              left: 50%;
              transform: translateX(-50%);
              background: #4caf50;
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              z-index: 10000;
              font-size: 0.9rem;
              animation: slideDown 0.3s ease;
            `;
            notification.textContent = `✨ تم إعادة الحساب تلقائياً بناءً على ${field === 'quantity' ? 'الكمية' : 'الفئة'} الجديدة`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.style.animation = 'slideUp 0.3s ease';
              setTimeout(() => notification.remove(), 300);
            }, 2000);
          }
          // ⚠️ السيناريو 2: المستخدم لم يدخل "الحالي%" بعد → تنبيه
          else {
            // عرض تنبيه لطيف
            const warning = document.createElement('div');
            warning.style.cssText = `
              position: fixed;
              top: 60px;
              left: 50%;
              transform: translateX(-50%);
              background: #ff9800;
              color: white;
              padding: 12px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              z-index: 10000;
              font-size: 0.9rem;
              animation: slideDown 0.3s ease;
            `;
            warning.innerHTML = `⚠️ يُفضل إدخال <b>الحالي %</b> أولاً قبل تغيير ${field === 'quantity' ? 'الكمية' : 'الفئة'}`;
            document.body.appendChild(warning);
            
            // إزالة التظليل من حقل "الحالي%" - خليناه بلون ثابت
            // const currentPercentInput = document.querySelector(`.work-item-input[data-idx="${idx}"][data-field="currentPercent"]`);
            // if (currentPercentInput) {
            //   currentPercentInput.style.background = '#fff3cd';
            //   currentPercentInput.style.border = '2px solid #ff9800';
            //   
            //   setTimeout(() => {
            //     currentPercentInput.style.background = '';
            //     currentPercentInput.style.border = '';
            //   }, 3000);
            // }
            
            setTimeout(() => {
              warning.style.animation = 'slideUp 0.3s ease';
              setTimeout(() => warning.remove(), 300);
            }, 3000);
          }
        }
        // عند تعديل الحالي% أو المبلغ الحالي
        else if (field === 'currentPercent' || field === 'currentAmount') {
          updateTotalsRow(idx);
        }
      });
      
      // إضافة CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { top: -50px; opacity: 0; }
          to { top: 60px; opacity: 1; }
        }
        @keyframes slideUp {
          from { top: 60px; opacity: 1; }
          to { top: -50px; opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }

    // إضافة دعم الأسهم لتحريك الصفوف
    document.addEventListener('click', function(e) {
     
      if (e.target.classList.contains('move-up-row')) {
        const idx = parseInt(e.target.dataset.idx);
        moveRowUp(idx);
      }
      if (e.target.classList.contains('move-down-row')) {
        const idx = parseInt(e.target.dataset.idx);
        moveRowDown(idx);
      }
    });

    // حذف صف الخصم عند الضغط على زر الحذف
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-deduction-row')) {
        const tr = e.target.closest('tr');
        if (tr) tr.remove();
        calculateSummary();
      }
    });

    // حذف صف الأعمال عند الضغط على زر الحذف
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-work-row')) {
        // تحقق من الصلاحية
        const userStr = localStorage.getItem('user');
        const user = userStr ? JSON.parse(userStr) : {};
        const canDelete = user.permissions && user.permissions.includes('add-extract-delete-workitem');
        
        if (!canDelete) {
          alert('⚠️ ليس لديك صلاحية حذف بنود الأعمال');
          return;
        }
        
        const idx = parseInt(e.target.dataset.idx);
        if (!isNaN(idx) && idx >= 0 && idx < workItems.length) {
          if (confirm('هل أنت متأكد من حذف هذا البند؟')) {
            workItems.splice(idx, 1);
            renderWorkItems();
            updateTotalRowInTable();
            calculateSummary();
          }
        }
      }
    });

    // بيانات جدول المقطوعية/اليوميات
    let lumpSumRows = [];

    // زر إظهار جدول المقطوعية/اليوميات
    document.getElementById('addLumpSumBtn').onclick = function() {
     
     
      document.getElementById('lumpSumSection').style.display = '';
      if (lumpSumRows.length === 0) addLumpSumRow();
      renderLumpSumRows();
    };

    // إضافة صف جديد في جدول المقطوعية/اليوميات
    function addLumpSumRow() {
      // رقم المستخلص الحالي
      let statementNumber = document.getElementById('statementNumber')?.value || '';
      lumpSumRows.push({
        buildingsCount: '',
        statementDesc: '',
        lumpSum: '',
        date: '',
        total: '',
        statementNumber: statementNumber
      });
      renderLumpSumRows();
    }

    // رسم جدول المقطوعية/اليوميات
    function renderLumpSumRows() {
      let html = '';
      // رقم المستخلص الحالي
      let currentStatementNumber = parseInt(document.getElementById('statementNumber')?.value || '0');
      lumpSumRows.forEach((row, idx) => {
        // إذا كانت المقطوعية من مستخلص سابق (statementNumber أقل من الحالي)
        let isPrev = parseInt(row.statementNumber) < currentStatementNumber;
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="buildingsCount" value="${row.buildingsCount || ''}" style="width:60px" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="text" class="lump-input" data-idx="${idx}" data-field="statementDesc" value="${row.statementDesc || ''}" placeholder="بيان الأعمال" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="date" class="lump-input" data-idx="${idx}" data-field="date" value="${row.date || ''}" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="lumpSum" value="${row.lumpSum || ''}" placeholder="اليوميات / المقطوعية" ${isPrev ? 'readonly style="background:#e0e0e0;cursor:not-allowed;"' : ''}></td>
            <td><input type="number" class="lump-input" data-idx="${idx}" data-field="total" value="${row.total || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="text" class="lump-input" data-idx="${idx}" data-field="statementNumber" value="${row.statementNumber || ''}" readonly style="background:#f5f5f5;"></td>
            <td>
              ${isPrev ? '' : `<button type="button" class="delete-lump-row-btn" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button>`}
            </td>
          </tr>
        `;
      });
      document.getElementById('lumpSumBody').innerHTML = html;

      // أحداث الحساب والحذف
      document.querySelectorAll('.lump-input').forEach(input => {
        // لا تسمح بالتعديل إذا readonly
        if (input.hasAttribute('readonly')) return;
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // تحديث القيمة في المصفوفة دون تقريب
          lumpSumRows[idx][field] = e.target.value;
          
          if (field === 'buildingsCount' || field === 'lumpSum') updateLumpSumRow(idx);
          updateLumpSumTotalRow();
        };
      });
      document.querySelectorAll('.delete-lump-row-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          lumpSumRows.splice(idx, 1);
          if (lumpSumRows.length === 0) {
            // أخفِ القسم بالكامل إذا لم يتبق صفوف
            document.getElementById('lumpSumSection').style.display = 'none';
          }
          renderLumpSumRows();
          updateLumpSumTotalRow(); // أضف هذا السطر
        };

      });
    }

    // معادلة الإجمالي للمقطوعية/اليوميات
    function updateLumpSumRow(idx) {
      const row = lumpSumRows[idx];
      row.total = ((parseFloat(row.lumpSum) || 0) * (parseFloat(row.buildingsCount) || 0)).toFixed(2);
      let rowInputs = document.querySelectorAll('.lump-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        if (input.dataset.field === 'total') input.value = row.total || '';
      });
    }

    // زر إضافة صف جديد في جدول المقطوعية/اليوميات
    document.getElementById('addLumpSumRowBtn').onclick = addLumpSumRow;

    // عند تحميل مستخلص جديد, ترحل أرقام المستخلصات السابقة في المقطوعيات
    document.getElementById('contractorSelect').addEventListener('change', function() {
      // تجاهل إذا كان يتم تحميل مسودة
      if (window.isLoadingDraft) return;
      
      const contractorId = this.value;
      if (contractorId) {
        fetch(`/extracts?contractor=${contractorId}`)
          .then(res => res.json())
          .then(extracts => {
            const filteredExtracts = extracts.filter(e => e.contractor == contractorId);
            if (filteredExtracts.length > 0) {
              // خذ آخر مستخلص وأرقام المقطوعيات المرتبطة به
              const lastExtract = filteredExtracts[filteredExtracts.length - 1];
              if (lastExtract.lumpSumRows && lastExtract.lumpSumRows.length > 0) {
                lastExtract.lumpSumRows.forEach(row => {
                  lumpSumRows.push({
                    buildingsCount: row.buildingsCount,
                    statementDesc: row.statementDesc,
                    lumpSum: row.lumpSum,
                    date: row.date,
                    total: row.total,
                    statementNumber: row.statementNumber || prev.number // رقم المستخلص الأصلي
                  });
                });
                renderLumpSumRows();
              }
            }
          });
      }
    });

    // بيانات جدول اليوميات
    let dailyRows = [];

    // زر إظهار جدول اليوميات
    document.getElementById('addDailyBtn').onclick = function() {
      document.getElementById('dailySection').style.display = '';
      if (dailyRows.length === 0) addDailyRow();
      renderDailyRows();
    };

    // إضافة صف جديد في جدول اليوميات
    function addDailyRow() {
      dailyRows.push({
        dailyDesc: '',
        dailyCount: '',
        dailyValue: '',
        building: '',
        prev: '',
        current: '',
        total: '',
        prevAmount: '',
        currentAmount: '',
        totalAmount: ''
      });
      renderDailyRows();
    }

    // أضف هذا السطر لتفعيل زر إضافة صف يومية
    document.getElementById('addDailyRowBtn').onclick = addDailyRow;

    // رسم جدول اليوميات
    function renderDailyRows() {
      let html = '';
      dailyRows.forEach((row, idx) => {
        html += `
          <tr>
            <td>${idx + 1}</td>
            <td><input type="text" class="daily-input" data-idx="${idx}" data-field="dailyDesc" value="${row.dailyDesc || ''}" placeholder="بيان اليوميات"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="dailyCount" value="${row.dailyCount || ''}" placeholder="عدد اليوميات"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="dailyValue" value="${row.dailyValue || ''}" placeholder="قيمة اليومية"></td>
            <td><input type="text" class="daily-input" data-idx="${idx}" data-field="building" value="${row.building || ''}" placeholder="المبنى"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="prev" value="${row.prev || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="current" value="${row.current || ''}" placeholder="الحالي"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="total" value="${row.total || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="prevAmount" value="${row.prevAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="currentAmount" value="${row.currentAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td><input type="number" class="daily-input" data-idx="${idx}" data-field="totalAmount" value="${row.totalAmount || ''}" readonly style="background:#f5f5f5;"></td>
            <td>
              <button type="button" class="delete-daily-row-btn" data-idx="${idx}" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button>
            </td>
          </tr>
        `;
      });
      document.getElementById('dailyBody').innerHTML = html;

      // أحداث الحساب والحذف
      document.querySelectorAll('.daily-input').forEach(input => {
        input.oninput = function(e) {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          
          // تحديث القيمة في المصفوفة دون تقريب أثناء الكتابة
          dailyRows[idx][field] = e.target.value;
          
          // عند تغيير أى حقل مؤثر (عدد اليوميات أو قيمة اليومية أو الحالي) احسب المبالغ
          if (['dailyCount', 'dailyValue', 'current'].includes(field)) {
            updateDailyRow(idx);
            // تحديث القيم في الجدول مباشرة بعد الحساب
            let row = dailyRows[idx];
            let rowInputs = document.querySelectorAll('.daily-input[data-idx="' + idx + '"]');
            rowInputs.forEach(input2 => {
              let f = input2.dataset.field;
              if (f === 'total') input2.value = row.total || '';
              if (f === 'prevAmount') input2.value = row.prevAmount || '';
              if (f === 'currentAmount') input2.value = row.currentAmount || '';
              if (f === 'totalAmount') input2.value = row.totalAmount || '';
            });
            updateDailyTotalRow();
          }
        };
      });
      document.querySelectorAll('.delete-daily-row-btn').forEach(btn => {
        btn.onclick = function() {
          const idx = parseInt(btn.dataset.idx);
          dailyRows.splice(idx, 1);
          if (dailyRows.length === 0) {
            // أخفِ القسم بالكامل إذا لم يتبق صفوف
            document.getElementById('dailySection').style.display = 'none';
          }
          renderDailyRows();
        };
      });
    }

    // معادلات اليوميات
    function updateDailyRow(idx) {
      const row = dailyRows[idx];
      // الإجمالي = السابق + الحالي
      row.total = (parseFloat(row.prev) || 0) + (parseFloat(row.current) || 0);
      // السابق مبلغ = السابق * قيمة اليومية
      row.prevAmount = ((parseFloat(row.prev) || 0) * (parseFloat(row.dailyValue) || 0)).toFixed(2);
      // الحالي مبلغ = الحالي * قيمة اليومية
      row.currentAmount = ((parseFloat(row.current) || 0) * (parseFloat(row.dailyValue) || 0)).toFixed(2);
      // الإجمالي مبلغ = السابق مبلغ + الحالي مبلغ
      row.totalAmount = (parseFloat(row.prevAmount) + parseFloat(row.currentAmount)).toFixed(2);

      // تحديث القيم في الجدول مباشرة
      let rowInputs = document.querySelectorAll('.daily-input[data-idx="' + idx + '"]');
      rowInputs.forEach(input => {
        let field = input.dataset.field;
        if (field === 'total') input.value = row.total || '';
        if (field === 'prevAmount') input.value = row.prevAmount || '';
        if (field === 'currentAmount') input.value = row.currentAmount || '';
        if (field === 'totalAmount') input.value = row.totalAmount || '';
      });

      calculateSummary(); // أضف هذا السطر
    }

    // دالة لتنسيق الأرقام بفواصل (مقربة لرقمين عشريين)
function formatNumberWithCommas(num) {
  num = Number(num) || 0;
  return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// === أضف هنا ===
function calculateSummary() {
  // إجمالي الأعمال (الحالي في بنود الأعمال)
  let workCurrent = 0;
  if (Array.isArray(workItems)) {
    workItems.forEach(item => {
      if (!item.isSeparator) workCurrent += parseFloat(item.currentAmount) || 0;
    });
  }
  
  // إجمالي المقطوعيات (جميع المقطوعيات المعروضة في الجدول)
  let lumpSumTotal = 0;
  if (Array.isArray(lumpSumRows)) {
    lumpSumRows.forEach(row => {
      lumpSumTotal += parseFloat(row.total) || 0;
    });
  }
  
  // إجمالي اليوميات (الحالية فقط)
  let dailyCurrentTotal = 0;
  if (Array.isArray(dailyRows)) {
    dailyRows.forEach(row => {
      dailyCurrentTotal += parseFloat(row.currentAmount) || 0;
    });
  }

  // الصافي قبل الخصومات = مجموع (الحالي في بنود الأعمال + جميع المقطوعيات + اليوميات الحالية)
  let beforeDeductions = workCurrent + lumpSumTotal + dailyCurrentTotal;

  // إجمالي الخصومات
  let totalDeductions = 0;
  document.querySelectorAll('#deductionsBody tr').forEach(tr => {
    const totalInput = tr.querySelector('input[name="deductionTotal"]');
    if (totalInput) totalDeductions += parseFloat(totalInput.value) || 0;
  });

  // الصافي بعد الخصومات = الصافي قبل الخصومات - الخصومات
  let afterDeductions = beforeDeductions - totalDeductions;

  // تحديث القيم في الصفحة
  document.getElementById('beforeDeductions').textContent = formatNumberWithCommas(beforeDeductions);
  document.getElementById('totalDeductions').textContent = formatNumberWithCommas(totalDeductions);
  document.getElementById('afterDeductions').textContent = formatNumberWithCommas(afterDeductions);
}

    // تعريف دالة updateTotalRowInTable في الأعلى لتكون متاحة للجميع
    function updateTotalRowInTable() {
      let totalQuantity = 0, totalCategory = 0, totalPrevPercent = 0, totalCurrentPercent = 0, totalTotalPercent = 0;
      let totalPrevAmount = 0, totalCurrentAmount = 0, totalTotalAmount = 0;
      let grandTotal = 0;
      if (typeof workItems !== 'undefined' && Array.isArray(workItems)) {
        workItems.forEach(item => {
          if (!item.isSeparator) {
            totalQuantity += parseFloat(item.quantity) || 0;
            totalCategory += parseFloat(item.category) || 0;
            totalPrevPercent += parseFloat(item.prevPercent) || 0;
            totalCurrentPercent += parseFloat(item.currentPercent) || 0;
            totalTotalPercent += parseFloat(item.totalPercent) || 0;
            totalPrevAmount += parseFloat(item.prevAmount) || 0;
            totalCurrentAmount += parseFloat(item.currentAmount) || 0;
            totalTotalAmount += parseFloat(item.totalAmount) || 0;
            grandTotal += (parseFloat(item.quantity) || 0) * (parseFloat(item.category) || 0);
          }
        });
      }
      // تحديث صف الإجمالي فقط
      const totalRow = document.getElementById('workItemsTotalRow');
      if (totalRow) {
        totalRow.innerHTML = `
          <td colspan="4" style="font-weight:bold;text-align:center;">الإجمالي</td>
          <td>${formatNumberWithCommas(totalQuantity)}</td>
          <td></td>
          <td>${formatNumberWithCommas(totalCategory)}</td>
          <td>${formatNumberWithCommas(totalPrevPercent)}</td>
          <td>${formatNumberWithCommas(totalCurrentPercent)}</td>
          <td>${formatNumberWithCommas(totalTotalPercent)}</td>
          <td id="workItemsPrevAmountTotal">${formatNumberWithCommas(totalPrevAmount)}</td>
          <td id="workItemsCurrentAmountTotal">${formatNumberWithCommas(totalCurrentAmount)}</td>
          <td id="workItemsTotalAmountTotal">${formatNumberWithCommas(totalTotalAmount)}</td>
          <td></td>
        `;
      }
      // تحديث قيمة الأعمال الإجمالية
      const grandTotalSpan = document.getElementById('workItemsGrandTotal');
      if (grandTotalSpan) {
        grandTotalSpan.textContent = formatNumberWithCommas(grandTotal);
      }
    }    // تحديث شريط الإجمالي في جدول المقطوعيات (جمع تلقائي للبيانات المعروضة في الجدول)
    function updateLumpSumTotalRow() {
      let total = 0;
      // اجمع فقط القيم المعروضة فعلياً في الجدول (tbody)
      document.querySelectorAll('#lumpSumBody tr').forEach(tr => {
        const totalInput = tr.querySelector('input[data-field="total"]');
        if (totalInput && !totalInput.disabled && totalInput.offsetParent !== null) {
          total += parseFloat(totalInput.value) || 0;
        }
      });
      const cell = document.getElementById('lumpSumTotalCell');
      if (cell) cell.textContent = formatNumberWithCommas(total);
    }

    // تحديث شريط الإجمالي في جدول اليوميات (جمع تلقائي للبيانات المعروضة في الجدول)
    function updateDailyTotalRow() {
      let prevAmount = 0, currentAmount = 0, totalAmount = 0;
      // اجمع فقط القيم المعروضة فعلياً في الجدول (tbody)
      document.querySelectorAll('#dailyBody tr').forEach(tr => {
        const prevAmountInput = tr.querySelector('input[data-field="prevAmount"]');
        const currentAmountInput = tr.querySelector('input[data-field="currentAmount"]');
        const totalAmountInput = tr.querySelector('input[data-field="totalAmount"]');
        if (prevAmountInput && prevAmountInput.offsetParent !== null)
          prevAmount += parseFloat(prevAmountInput.value) || 0;
        if (currentAmountInput && currentAmountInput.offsetParent !== null)
          currentAmount += parseFloat(currentAmountInput.value) || 0;
        if (totalAmountInput && totalAmountInput.offsetParent !== null)
          totalAmount += parseFloat(totalAmountInput.value) || 0;
      });
      document.getElementById('dailyPrevAmountTotal').textContent = formatNumberWithCommas(prevAmount);
      document.getElementById('dailyCurrentAmountTotal').textContent = formatNumberWithCommas(currentAmount);
      document.getElementById('dailyTotalAmountTotal').textContent = formatNumberWithCommas(totalAmount);
    }

    // استدعاء التحديثات التلقائية بعد رسم الجداول
    const oldRenderLumpSumRows = renderLumpSumRows;
    renderLumpSumRows = function() {
      oldRenderLumpSumRows.apply(this, arguments);
      updateLumpSumTotalRow();
    };

    const oldRenderDailyRows = renderDailyRows;
    renderDailyRows = function() {
      oldRenderDailyRows.apply(this, arguments);
      updateDailyTotalRow();
    };

    document.addEventListener('DOMContentLoaded', function() {
      updateLumpSumTotalRow();
      updateDailyTotalRow();
    });

    // تعيين تاريخ المستخلص إلى اليوم تلقائيًا إذا كان فارغًا
    const extractDate = document.getElementById('extractDate');
    if (extractDate && !extractDate.value) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      extractDate.value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
  // جلب صلاحيات المستخدم
  let user = {};
  try {
    user = JSON.parse(localStorage.getItem('user')) || {};
  } catch {}
  const perms = user.permissions || [];

  // اجعل خانة بند الأعمال واسم المقاول متاحة دائماً لأي مستخدم
  document.getElementById('workItemFilterSelect').disabled = false;
  document.getElementById('contractorSelect').disabled = false;

  // فحص تلقائي للمسودة عند تحميل الصفحة (بعد تحميل DOM كاملاً)
  setTimeout(() => {
    const contractorSelect = document.getElementById('contractorSelect');
    const currentContractor = contractorSelect?.value;
    
    if (currentContractor) {
      console.log('تم العثور على مقاول مختار عند تحميل الصفحة:', currentContractor);
      
      // فحص وجود مسودة للمقاول
      const savedDraft = localStorage.getItem('extractDraft');
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          if (draftData.contractorId === currentContractor) {
            console.log('تم العثور على مسودة، جاري التحميل...');
            loadDraftSilently();
            // إظهار مؤشر المسودة بعد التحميل
            setTimeout(() => {
              showDraftIndicator();
              // تسجيل استكمال التعديلات للمسودة المحملة
              const extractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
              addOperation('تحميل مسودة', `تحميل المسودة المحفوظة للمستخلص رقم ${extractNumber}`);
            }, 800);
          }
        } catch (error) {
          console.error('خطأ في فحص المسودة:', error);
        }
      } else {
        // لا توجد مسودة، أظهر مؤشر المسودة (سيكون مخفي)
        showDraftIndicator();
      }
      
      // استعادة العمليات
      restoreOperationsForContractor(currentContractor);
    } else {
      // لا يوجد مقاول مختار
      showDraftIndicator();
      initializeOperationsLog();
    }
  }, 300);

  // اجعل خانة بند الأعمال واسم المقاول متاحة دائماً لأي مستخدم
  document.getElementById('workItemFilterSelect').disabled = false;
  document.getElementById('contractorSelect').disabled = false;

  // تعديل كامل - يفتح كل شيء
  if (perms.includes('add-extract-edit-all')) {
    document.querySelectorAll('input, select, button').forEach(el => {
      el.disabled = false;
      el.readOnly = false;
      el.style.opacity = "1";
      el.style.cursor = "";
      el.style.display = "";
    });
    const extractUsername = document.getElementById('extractUsername');
    if (extractUsername) extractUsername.readOnly = true;
    console.log('✅ تم تفعيل صلاحية التعديل الكامل');
    return;
  }

  // تعديل الحالى فقط: كل شيء مقفول في جدول بنود الأعمال ماعدا عمود الحالى نسبة
  if (perms.includes('add-extract-edit-current')) {
    // قفل كل الأعمدة في جدول بنود الأعمال ماعدا currentPercent
    document.querySelectorAll('#workItemsTable input').forEach(inp => {
      if (inp.dataset.field !== "currentPercent") {
        inp.readOnly = true;
        inp.disabled = true;
        inp.style.background = "#eee";
        inp.style.cursor = "not-allowed";
      } else {
        inp.readOnly = false;
        inp.disabled = false;
        inp.style.background = "";
        inp.style.cursor = "";
      }
    });
    // عطل أزرار الحذف والتحريك
    document.querySelectorAll('.delete-work-row, .move-up-row, .move-down-row').forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";
    });
    console.log('✅ تم تفعيل صلاحية تعديل الحالي فقط');
    return;
  }

  // باقي الصلاحيات يتم التحكم بها من permissions-check.js
  console.log('✅ الصلاحيات الفردية تُدار من permissions-check.js');
});
  </script>
  <!-- أضف نافذة اختيار المقاول لاستيراد الأعمال -->
  <script>
// تمت إزالة منطق استيراد أعمال مقاول آخر بالكامل
  </script>
  <script>
    // منطق حفظ المستخلص عند إرسال النموذج
    document.getElementById('extractForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      // تحقق من وجود بند أعمال واحد على الأقل (ليس فاصل ومعبأ)
      const hasRealWorkItem = Array.isArray(workItems) &&
    workItems.some(item =>
      !item.isSeparator &&
      String(item.buildingNumber).trim() !== "" &&
      String(item.workItem).trim() !== ""
    );
      if (!hasRealWorkItem) {
        alert('يجب إضافة بند أعمال واحد على الأقل (غير الفواصل) قبل حفظ المستخلص.');
        return;
      }

      // إظهار الـ loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      const submitBtn = document.querySelector('button[type="submit"][form="extractForm"]');
      const saveDraftBtn = document.getElementById('topSaveDraftBtn');
      
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
      }
      
      // تعطيل الأزرار لمنع الضغط المتكرر
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ جاري الحفظ...';
      }
      if (saveDraftBtn) {
        saveDraftBtn.disabled = true;
      }

      // جمع بيانات النموذج
      const form = event.target;
      
      // الحصول على معرف المستخدم
      let userId = '';
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        userId = user._id || user.id || '';
      } catch (e) {
        console.warn('Error parsing user data:', e);
      }
      
      const data = {
        date: form.date.value,
        number: form.number.value,
        contractor: form.contractor.value,
        username: form.username.value,
        userId: userId,
        workItems: workItems || [],
        lumpSumRows: lumpSumRows || [],
        dailyRows: dailyRows || [],
        deductions: Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
          statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
          date: tr.querySelector('input[name="deductionDate"]')?.value || '',
          quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
          category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
          total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
          user: tr.querySelector('input[name="deductionUser"]')?.value || ''
        }))
      };

      try {
        const res = await fetch('/extracts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          const result = await res.json();
          
          // إرسال إشعار بإضافة مستخلص جديد
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            const contractorSelect = form.contractor;
            let contractorName = 'غير محدد';
            
            // التأكد من وجود مقاول محدد
            if (contractorSelect.selectedIndex > 0 && contractorSelect.options[contractorSelect.selectedIndex]) {
              contractorName = contractorSelect.options[contractorSelect.selectedIndex].text;
            }
            
            await window.sendNotification(
              'extract-add',
              `تم إضافة مستخلص رقم ${form.number.value} للمقاول: ${contractorName}`,
              'extracts',
              result._id || ''
            );
          }
          
          // خصم المواد فقط بعد نجاح حفظ المستخلص
          const extractNumber = form.number.value;
          const contractorId = form.contractor.value;
          
          // جمع المواد المستخدمة في الخصومات
          const materialsToDeduct = [];
          document.querySelectorAll('#deductionsBody tr').forEach(tr => {
            const materialName = tr.dataset.materialName;
            const materialDate = tr.querySelector('input[name="deductionDate"]')?.value || '';
            const statementText = tr.querySelector('input[name="deductionStatement"]')?.value || '';
            
            // إذا كانت المادة مأخوذة من قائمة المواد (لها dataset.materialName)
            if (materialName && statementText.includes(materialName)) {
              materialsToDeduct.push({
                name: materialName,
                date: materialDate
              });
            }
          });
          
          // خصم المواد من السيرفر
          for (const material of materialsToDeduct) {
            try {
              await fetch(`/contractors/${contractorId}/materials/deduct`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: material.name,
                  deductedInExtractNumber: extractNumber,
                  deductedDate: material.date
                })
              });
            } catch (err) {
              console.error('تعذر خصم المادة:', material.name, err);
            }
          }
          
          // إبقاء الـ loading spinner لمدة ثانيتين إضافيتين
          setTimeout(() => {
            // إخفاء الـ loading overlay بعد التأخير
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
            
            // إعادة تفعيل الأزرار
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = '✅ حفظ المستخلص';
            }
            if (saveDraftBtn) {
              saveDraftBtn.disabled = false;
            }
            
            // إظهار رسالة النجاح مخصصة
            setTimeout(() => {
              showSuccessNotification('✅ تم حفظ المستخلص بنجاح وخصم المواد المستخدمة');
              
              // التحويل إلى صفحة قائمة المستخلصات
              setTimeout(() => {
                window.location.href = 'list-extracts.html';
              }, 2000);
            }, 100);
          }, 2000); // تأخير لمدة ثانيتين
          
        } else {
          // إخفاء الـ loading overlay في حالة الخطأ
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
          
          // إعادة تفعيل الأزرار
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '✅ حفظ المستخلص';
          }
          if (saveDraftBtn) {
            saveDraftBtn.disabled = false;
          }
          
          alert('حدث خطأ أثناء الحفظ');
        }
      } catch (err) {
        // إخفاء الـ loading overlay في حالة الخطأ
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
        
        // إعادة تفعيل الأزرار
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = '✅ حفظ المستخلص';
        }
        if (saveDraftBtn) {
          saveDraftBtn.disabled = false;
        }
        
        alert('تعذر الاتصال بالسيرفر');
      }
    });
  </script>
  <script>
// حفظ الحد الأقصى في السيرفر عند تغييره
document.addEventListener('DOMContentLoaded', function() {
  const maxTotalPercentInput = document.getElementById('maxTotalPercentInput');
  const contractorSelect = document.getElementById('contractorSelect');

  // عند تغيير الحد الأقصى، أرسله للسيرفر
  maxTotalPercentInput.addEventListener('change', async function() {
    const contractorId = contractorSelect.value;
    const value = parseFloat(this.value) || 100;
    if (!contractorId) return;
    try {
      await fetch(`/contractors/${contractorId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ maxTotalPercent: value })
      });
    } catch (err) {
      alert('تعذر حفظ الحد الأقصى في السيرفر');
    }
  });

  // عند اختيار مقاول، جلب الحد الأقصى من السيرفر
  contractorSelect.addEventListener('change', async function() {
    // تجاهل إذا كان يتم تحميل مسودة
    if (window.isLoadingDraft) return;
    
    const contractorId = this.value;
    if (!contractorId) return;
    try {
      const res = await fetch(`/contractors/${contractorId}`);
      if (!res.ok) return;
      const contractor = await res.json();
      document.getElementById('maxTotalPercentInput').value = contractor.maxTotalPercent || 100;
    } catch {
      document.getElementById('maxTotalPercentInput').value = 100;
    }
  });

  // === نظام حفظ وتحميل المسودات ===
  
  // التحقق من وجود الأزرار
  const saveDraftBtn = document.getElementById('saveDraftBtn') || document.getElementById('topSaveDraftBtn');
  
  if (!saveDraftBtn) {
    console.error('زر حفظ المسودة غير موجود');
  } else {
    console.log('زر حفظ المسودة موجود');
  }
  
  // حفظ المستخلص كمسودة - ربط كلا الزرين مع الحماية الآمنة
  if (document.getElementById('saveDraftBtn')) {
    document.getElementById('saveDraftBtn').addEventListener('click', function() {
      console.log('تم الضغط على زر حفظ المسودة');
      safeSaveDraft(); // استخدام الدالة الآمنة
    });
  }
  
  if (document.getElementById('topSaveDraftBtn')) {
    document.getElementById('topSaveDraftBtn').addEventListener('click', function() {
      console.log('تم الضغط على زر حفظ المسودة العلوي');
      safeSaveDraft(); // استخدام الدالة الآمنة
    });
  }

  // سيتم نقل دوال المسودات لنطاق عالمي أسفل هذا الملف

  function loadDraftSilently() {
    try {
      console.log('بدء تحميل المسودة تلقائياً...');
      // تفعيل flag لمنع event listeners الأخرى من التداخل
      window.isLoadingDraft = true;
      console.log('تم تفعيل flag منع التداخل');
      
      const savedDraft = localStorage.getItem('extractDraft');
      if (!savedDraft) {
        window.isLoadingDraft = false;
        return;
      }

      const draftData = JSON.parse(savedDraft);
      console.log('بيانات المسودة المحملة:', draftData);
      
      // استعادة البيانات الأساسية (بدون تغيير المقاول لأنه مختار بالفعل)
      document.getElementById('workItemFilterSelect').value = draftData.workItemFilterSelect || '';
      document.getElementById('statementNumber').value = draftData.extractNumber || '';
      document.getElementById('extractDate').value = draftData.extractDate || '';
      document.getElementById('maxTotalPercentInput').value = draftData.maxTotalPercent || '100';
      
      // استعادة بنود الأعمال بالمتغيرات الصحيحة
      console.log('استعادة بنود الأعمال...');
      workItems.length = 0;
      workItems.push(...(draftData.workItems || []));
      
      // استعادة المقطوعيات
      lumpSumRows.length = 0;
      lumpSumRows.push(...(draftData.lumpSumRows || []));
      
      // تحديث تتبع المقطوعيات المسجلة لتجنب إعادة التسجيل
      if (draftData.lumpSumRows && Array.isArray(draftData.lumpSumRows)) {
        draftData.lumpSumRows.forEach(row => {
          const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
          if (row.statementDesc && row.statementDesc.trim() !== '') {
            loggedLumpSumRows.add(rowKey);
          }
        });
      }
      
      // استعادة اليوميات
      dailyRows.length = 0;
      dailyRows.push(...(draftData.dailyRows || []));
      
      // تحديث تتبع اليوميات المسجلة لتجنب إعادة التسجيل
      if (draftData.dailyRows && Array.isArray(draftData.dailyRows)) {
        draftData.dailyRows.forEach(row => {
          const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
          if (row.dailyDesc && row.dailyDesc.trim() !== '' && row.current && parseFloat(row.current) > 0) {
            loggedDailyRows.add(rowKey);
          }
        });
      }
      
      // استعادة الخصومات - إعادة إنشاء الصفوف في الجدول
      const deductionsBody = document.getElementById('deductionsBody');
      if (deductionsBody) {
        deductionsBody.innerHTML = ''; // مسح الخصومات الحالية
        
        if (draftData.deductions && Array.isArray(draftData.deductions)) {
          draftData.deductions.forEach(deduction => {
            if (deduction.statement || deduction.quantity || deduction.total) {
              // إنشاء صف خصم جديد
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px;"><input type="text" name="deductionStatement" value="${deduction.statement || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="بيان الخصم"></td>
                <td style="padding:4px;"><input type="date" name="deductionDate" value="${deduction.date || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;"></td>
                <td style="padding:4px;"><input type="number" name="deductionQuantity" value="${deduction.quantity || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="الكمية"></td>
                <td style="padding:4px;"><input type="number" name="deductionCategory" value="${deduction.category || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="فئة السعر"></td>
                <td style="padding:4px;"><input type="number" name="deductionTotal" value="${deduction.total || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="المجموع" readonly></td>
                <td style="padding:4px;"><input type="text" name="deductionUser" value="${deduction.user || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="المستخدم" readonly></td>
                <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button></td>
              `;
              deductionsBody.appendChild(tr);
              
              // إضافة event listeners للحساب التلقائي
              const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
              const catInput = tr.querySelector('input[name="deductionCategory"]');
              const totalInput = tr.querySelector('input[name="deductionTotal"]');
              
              function updateDeductionTotal() {
                const qty = parseFloat(qtyInput.value) || 0;
                const cat = parseFloat(catInput.value) || 0;
                totalInput.value = (qty * cat).toFixed(2);
                calculateSummary();
              }
              
              qtyInput.addEventListener('input', updateDeductionTotal);
              catInput.addEventListener('input', updateDeductionTotal);
            }
          });
        }
      }
      
      // تحديث تتبع الخصومات المسجلة لتجنب إعادة التسجيل
      if (draftData.deductions && Array.isArray(draftData.deductions)) {
        draftData.deductions.forEach(deduction => {
          if (deduction.statement || deduction.quantity || deduction.total) {
            const rowKey = `${deduction.statement || ''}_${deduction.quantity || ''}_${deduction.total || ''}`;
            loggedDeductionRows.add(rowKey);
          }
        });
      }
      
      console.log('workItems بعد الاستعادة:', workItems);
      console.log('lumpSumRows بعد الاستعادة:', lumpSumRows);
      console.log('dailyRows بعد الاستعادة:', dailyRows);
      
      // إعادة عرض البيانات
      console.log('إعادة عرض البيانات...');
      renderWorkItems();
      renderLumpSumRows();
      renderDailyRows();
      updateTotalRowInTable();
      updateLumpSumTotalRow();
      updateDailyTotalRow();
      calculateSummary();
      
      showDraftIndicator();
      console.log('تم الانتهاء من عرض البيانات');
      
      // إلغاء flag بعد انتهاء العملية
      setTimeout(() => {
        console.log('إلغاء flag منع التداخل');
        window.isLoadingDraft = false;
      }, 1000);
      
    } catch (error) {
      console.error('خطأ في تحميل المسودة تلقائياً:', error);
      window.isLoadingDraft = false;
    }
  }

  function loadDraft() {
    try {
      const savedDraft = localStorage.getItem('extractDraft');
      if (!savedDraft) {
        alert('لا توجد مسودة محفوظة.');
        return;
      }

      if (!confirm('هل تريد تحميل المسودة المحفوظة؟ سيتم استبدال البيانات الحالية.')) {
        return;
      }

      const draftData = JSON.parse(savedDraft);
      
      // استعادة البيانات الأساسية
      document.getElementById('workItemFilterSelect').value = draftData.workItemFilterSelect || '';
      document.getElementById('contractorSelect').value = draftData.contractorId || '';
      document.getElementById('statementNumber').value = draftData.extractNumber || '';
      document.getElementById('extractDate').value = draftData.extractDate || '';
      document.getElementById('maxTotalPercentInput').value = draftData.maxTotalPercent || '100';
      
      // استعادة بنود الأعمال بالمتغيرات الصحيحة
      workItems.length = 0;
      workItems.push(...(draftData.workItems || []));
      
      // استعادة المقطوعيات
      lumpSumRows.length = 0;
      lumpSumRows.push(...(draftData.lumpSumRows || []));
      
      // تحديث تتبع المقطوعيات المسجلة لتجنب إعادة التسجيل
      if (draftData.lumpSumRows && Array.isArray(draftData.lumpSumRows)) {
        draftData.lumpSumRows.forEach(row => {
          const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
          if (row.statementDesc && row.statementDesc.trim() !== '') {
            loggedLumpSumRows.add(rowKey);
          }
        });
      }
      
      // استعادة اليوميات
      dailyRows.length = 0;
      dailyRows.push(...(draftData.dailyRows || []));
      
      // تحديث تتبع اليوميات المسجلة لتجنب إعادة التسجيل
      if (draftData.dailyRows && Array.isArray(draftData.dailyRows)) {
        draftData.dailyRows.forEach(row => {
          const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
          if (row.dailyDesc && row.dailyDesc.trim() !== '' && row.current && parseFloat(row.current) > 0) {
            loggedDailyRows.add(rowKey);
          }
        });
      }
      
      // استعادة الخصومات - إعادة إنشاء الصفوف في الجدول
      const deductionsBody = document.getElementById('deductionsBody');
      if (deductionsBody) {
        deductionsBody.innerHTML = ''; // مسح الخصومات الحالية
        
        if (draftData.deductions && Array.isArray(draftData.deductions)) {
          draftData.deductions.forEach(deduction => {
            if (deduction.statement || deduction.quantity || deduction.total) {
              // إنشاء صف خصم جديد
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding:4px;"><input type="text" name="deductionStatement" value="${deduction.statement || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="بيان الخصم"></td>
                <td style="padding:4px;"><input type="date" name="deductionDate" value="${deduction.date || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;"></td>
                <td style="padding:4px;"><input type="number" name="deductionQuantity" value="${deduction.quantity || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="الكمية"></td>
                <td style="padding:4px;"><input type="number" name="deductionCategory" value="${deduction.category || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="فئة السعر"></td>
                <td style="padding:4px;"><input type="number" name="deductionTotal" value="${deduction.total || ''}" step="0.01" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="المجموع" readonly></td>
                <td style="padding:4px;"><input type="text" name="deductionUser" value="${deduction.user || ''}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;" placeholder="المستخدم" readonly></td>
                <td><button type="button" class="delete-deduction-row" style="background:#e53935; color:#fff; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">حذف</button></td>
              `;
              deductionsBody.appendChild(tr);
              
              // إضافة event listeners للحساب التلقائي
              const qtyInput = tr.querySelector('input[name="deductionQuantity"]');
              const catInput = tr.querySelector('input[name="deductionCategory"]');
              const totalInput = tr.querySelector('input[name="deductionTotal"]');
              
              function updateDeductionTotal() {
                const qty = parseFloat(qtyInput.value) || 0;
                const cat = parseFloat(catInput.value) || 0;
                totalInput.value = (qty * cat).toFixed(2);
                calculateSummary();
              }
              
              qtyInput.addEventListener('input', updateDeductionTotal);
              catInput.addEventListener('input', updateDeductionTotal);
            }
          });
        }
      }
      
      // تحديث تتبع الخصومات المسجلة لتجنب إعادة التسجيل
      if (draftData.deductions && Array.isArray(draftData.deductions)) {
        draftData.deductions.forEach(deduction => {
          if (deduction.statement || deduction.quantity || deduction.total) {
            const rowKey = `${deduction.statement || ''}_${deduction.quantity || ''}_${deduction.total || ''}`;
            loggedDeductionRows.add(rowKey);
          }
        });
      }
      
      // إعادة عرض البيانات
      renderWorkItems();
      renderLumpSumRows();
      renderDailyRows();
      updateTotalRowInTable();
      updateLumpSumTotalRow();
      updateDailyTotalRow();
      calculateSummary();
      
      alert('تم تحميل المسودة بنجاح!');
      showDraftIndicator();
    } catch (error) {
      console.error('خطأ في تحميل المسودة:', error);
      alert('حدث خطأ أثناء تحميل المسودة.');
    }
  }

  function showDraftIndicator() {
    const savedDraft = localStorage.getItem('extractDraft');
    const currentContractor = document.getElementById('contractorSelect').value;
    const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    
    if (savedDraft && currentContractor) {
      try {
        const draftData = JSON.parse(savedDraft);
        if (draftData.contractorId === currentContractor) {
          if (draftIndicator) draftIndicator.style.display = 'inline-block';
          if (topDraftIndicator) topDraftIndicator.style.display = 'inline-block';
        } else {
          if (draftIndicator) draftIndicator.style.display = 'none';
          if (topDraftIndicator) topDraftIndicator.style.display = 'none';
        }
      } catch (error) {
        if (draftIndicator) draftIndicator.style.display = 'none';
        if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      }
    } else {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    }
  }
  
  // إضافة event listener لتغيير المقاول
  document.getElementById('contractorSelect').addEventListener('change', function() {
    // إذا كان يتم تحميل مسودة، تجاهل باقي العمليات
    if (window.isLoadingDraft) return;
    
    // إخفاء مؤشر المسودة أولاً عند تغيير المقاول
    const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    if (draftIndicator) draftIndicator.style.display = 'none';
    if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    
    // ثم فحص وجود مسودة للمقاول الجديد
    showDraftIndicator();
    
    // تحميل المسودة تلقائياً إذا وُجدت للمقاول المحدد
    const savedDraft = localStorage.getItem('extractDraft');
    if (savedDraft && this.value) {
      try {
        const draftData = JSON.parse(savedDraft);
        if (draftData.contractorId === this.value) {
          setTimeout(() => {
            loadDraftSilently();
          }, 300);
        }
      } catch (error) {
        console.error('خطأ في فحص المسودة:', error);
      }
    }
  });
  
  // تحديث اسم المستخدم (سيتم التحقق من المسودة في setTimeout أعلاه)
  updateCurrentUser();

});

// متغيرات لتتبع الصفوف المسجلة لتجنب التكرار
let loggedDailyRows = new Set();
let loggedLumpSumRows = new Set();
let loggedDeductionRows = new Set(); // لتتبع الخصومات المسجلة
let modifiedWorkItems = new Set(); // لتتبع بنود الأعمال المعدلة
let modifiedWorkItemsDetails = new Map(); // لحفظ تفاصيل التعديلات

// دالة لتسجيل بنود الأعمال الجديدة عند الحفظ
function logNewWorkItems() {
  if (Array.isArray(workItems) && workItems.length > 0) {
    let newItemsCount = 0;
    
    workItems.forEach((item, index) => {
      // تسجيل فقط البنود التي ليست فواصل ولها بيانات ولم يتم تعديلها مسبقاً
      if (!item.isSeparator && item.buildingNumber && item.buildingNumber.trim() !== '' && 
          item.workItem && item.workItem.trim() !== '' && !modifiedWorkItems.has(index.toString())) {
        
        const rowNumber = index + 1;
        const buildingNumber = item.buildingNumber || 'غير محدد';
        const workItemNumber = item.workItem || 'غير محدد';
        const currentPercent = item.currentPercent || '0';
        const currentAmount = item.currentAmount || '0';
        
        addOperation('إنشاء بند عمل', `إنشاء صف جديد رقم ${rowNumber} - مبنى: ${buildingNumber} - بند: ${workItemNumber} - النسبة الحالية: ${currentPercent}% - المبلغ الحالي: ${currentAmount} جنيه`);
        newItemsCount++;
      }
    });
    
    if (newItemsCount > 0) {
      console.log(`تم تسجيل ${newItemsCount} بند عمل جديد (غير معدل)`);
    }
  }
}

// دالة لتسجيل التعديلات المجمعة للصفوف المعدلة
function logModifiedWorkItems() {
  if (modifiedWorkItemsDetails.size > 0) {
    modifiedWorkItemsDetails.forEach((details, idx) => {
      if (details.modifications.length > 0) {
        const modificationsText = details.modifications.map(mod => 
          `${mod.field}: ${mod.newValue}`
        ).join(', ');
        
        addOperation('تحديث بند عمل', `تعديل صف رقم ${details.rowNumber} - مبنى: ${details.buildingNumber} - بند: ${details.workItemNumber} - التعديلات: ${modificationsText}`);
      }
    });
    
    console.log(`تم تسجيل تعديلات ${modifiedWorkItemsDetails.size} صف من بنود الأعمال`);
  }
}

// دالة لتسجيل الخصومات الجديدة عند الحفظ
function logNewDeductions() {
  const deductionRows = document.querySelectorAll('#deductionsBody tr');
  
  if (deductionRows.length > 0) {
    let newDeductionsCount = 0;
    
    deductionRows.forEach((row, index) => {
      const statement = row.querySelector('input[name="deductionStatement"]')?.value || '';
      const quantity = row.querySelector('input[name="deductionQuantity"]')?.value || '';
      const total = row.querySelector('input[name="deductionTotal"]')?.value || '';
      
      // إنشاء مفتاح فريد للخصم
      const rowKey = `${statement}_${quantity}_${total}`;
      
      if ((statement.trim() !== '' || quantity.trim() !== '' || total.trim() !== '') && !loggedDeductionRows.has(rowKey)) {
        const rowNumber = index + 1;
        addOperation('إنشاء خصم', `إنشاء خصم جديد رقم ${rowNumber} - المادة: ${statement} - الكمية: ${quantity} - الإجمالي: ${total} جنيه`);
        newDeductionsCount++;
        
        // إضافة الخصم للمُسجل لتجنب التكرار
        loggedDeductionRows.add(rowKey);
      }
    });
    
    if (newDeductionsCount > 0) {
      console.log(`تم تسجيل ${newDeductionsCount} خصم جديد`);
    }
  }
}

// دالة لتسجيل اليوميات والمقطوعيات الجديدة فقط عند الحفظ (بدون تكرار)
function logDailyAndLumpOperations() {
  const currentStatementNumber = parseInt(document.getElementById('statementNumber')?.value || '0');
  
  // تسجيل اليوميات الجديدة فقط (التي لها قيم في العمود "الحالي" ولم تُسجل من قبل)
  if (Array.isArray(dailyRows) && dailyRows.length > 0) {
    dailyRows.forEach((row, index) => {
      // إنشاء مفتاح فريد للصف بناءً على محتواه
      const rowKey = `${row.dailyDesc}_${row.building}_${row.dailyValue}_${row.current}`;
      
      // تسجيل فقط اليوميات التي لها قيم في العمود "الحالي" ولم تُسجل من قبل
      if (row.dailyDesc && row.dailyDesc.trim() !== '' && 
          row.current && parseFloat(row.current) > 0 &&
          !loggedDailyRows.has(rowKey)) {
        
        const dailyDesc = row.dailyDesc || 'غير محدد';
        const building = row.building || 'غير محدد';
        const dailyValue = row.dailyValue || '0';
        const currentQuantity = row.current || '0';
        const currentAmount = row.currentAmount || '0';
        
        addOperation('تسجيل يومية جديدة', `تسجيل يومية جديدة: ${dailyDesc} - المبنى: ${building} - الكمية الحالية: ${currentQuantity} - قيمة اليومية: ${dailyValue} - المبلغ الحالي: ${currentAmount} جنيه`);
        
        // إضافة الصف للمُسجل لتجنب التكرار
        loggedDailyRows.add(rowKey);
      }
    });
  }
  
  // تسجيل المقطوعيات الجديدة فقط (التي تنتمي للمستخلص الحالي ولم تُسجل من قبل)
  if (Array.isArray(lumpSumRows) && lumpSumRows.length > 0) {
    lumpSumRows.forEach((row, index) => {
      // إنشاء مفتاح فريد للصف بناءً على محتواه
      const rowKey = `${row.statementDesc}_${row.buildingsCount}_${row.lumpSum}_${row.statementNumber}`;
      
      // تسجيل فقط المقطوعيات التي تنتمي للمستخلص الحالي ولم تُسجل من قبل
      const rowStatementNumber = parseInt(row.statementNumber || '0');
      const isCurrentStatement = rowStatementNumber === 0 || rowStatementNumber >= currentStatementNumber;
      
      if (row.statementDesc && row.statementDesc.trim() !== '' && 
          isCurrentStatement && !loggedLumpSumRows.has(rowKey)) {
        
        const statementDesc = row.statementDesc || 'غير محدد';
        const buildingsCount = row.buildingsCount || '0';
        const lumpSum = row.lumpSum || '0';
        const total = row.total || '0';
        
        addOperation('تسجيل مقطوعية جديدة', `تسجيل مقطوعية جديدة: ${statementDesc} - عدد المباني: ${buildingsCount} - قيمة المقطوعية: ${lumpSum} - الإجمالي: ${total} جنيه`);
        
        // إضافة الصف للمُسجل لتجنب التكرار
        loggedLumpSumRows.add(rowKey);
      }
    });
  }
}

// دالة لإعادة تعيين تتبع الصفوف المسجلة (عند بدء مستخلص جديد)
function resetLoggedRowsTracking() {
  loggedDailyRows.clear();
  loggedLumpSumRows.clear();
  loggedDeductionRows.clear(); // مسح تتبع الخصومات المسجلة
  modifiedWorkItems.clear(); // مسح تتبع بنود الأعمال المعدلة
  modifiedWorkItemsDetails.clear(); // مسح تفاصيل التعديلات
  console.log('تم مسح تتبع الصفوف المسجلة لبدء مستخلص جديد');
}

// استعادة العمليات للمقاول المحدد
function restoreOperationsForContractor(contractorId) {
  try {
    const operationsKey = `currentExtractOperations_${contractorId}`;
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    const operationsContent = document.getElementById('operationsContent');
    
    if (!operationsContent) return;
    
    // مسح المحتوى الحالي
    operationsContent.innerHTML = '';
    
    if (operations.length === 0) {
      // إذا لم توجد عمليات، تحقق من وجود مسودة
      const savedDraft = localStorage.getItem('extractDraft');
      let isDraftExisting = false;
      
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          if (draftData.contractorId === contractorId && 
              (draftData.workItems?.length > 0 || draftData.lumpSumRows?.length > 0 || 
               draftData.dailyRows?.length > 0 || draftData.deductions?.length > 0)) {
            isDraftExisting = true;
          }
        } catch (error) {
          console.error('خطأ في فحص المسودة:', error);
        }
      }
      
      const currentUser = document.getElementById('currentUser')?.textContent || 'المستخدم';
      const extractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
      const actionText = isDraftExisting ? 'استكمال التعديلات' : 'بدء إنشاء مستخلص جديد';
      const detailsText = isDraftExisting ? 
        `تم استكمال تعديل المسودة المحفوظة - مستخلص رقم ${extractNumber}` : 
        `تم اختيار المقاول وبدء التسجيل - مستخلص رقم ${extractNumber}`;
      
      // اعرض رسالة البداية
      operationsContent.innerHTML = `
        <div class="operation-item">
          <div class="operation-time">${new Date().toLocaleTimeString('ar-EG')}</div>
          <div class="operation-action">${actionText}</div>
          <div class="operation-details">${detailsText}</div>
          <div class="operation-user">👤 ${currentUser}</div>
        </div>
      `;
      console.log(`📝 ${actionText} للمقاول ${contractorId}`);
    } else {
      // استعادة العمليات المحفوظة
      operations.reverse().forEach(op => {
        const operationItem = document.createElement('div');
        operationItem.className = 'operation-item';
        operationItem.innerHTML = `
          <div class="operation-time">${op.time}</div>
          <div class="operation-action">${op.action}</div>
          <div class="operation-details">${op.details}</div>
          <div class="operation-user">👤 ${op.user}</div>
        `;
        operationsContent.appendChild(operationItem);
      });
      console.log(`🔄 تم استعادة ${operations.length} عملية للمقاول ${contractorId}`);
    }
  } catch (error) {
    console.error('خطأ في استعادة العمليات:', error);
  }
}

// وظيفة لفرض إخفاء مؤشر المسودة
function forceDraftIndicatorHide() {
  const draftIndicator = document.getElementById('draftIndicator');
  const topDraftIndicator = document.getElementById('topDraftIndicator');
  
  if (draftIndicator) {
    draftIndicator.style.display = 'none !important';
    draftIndicator.style.visibility = 'hidden';
  }
  if (topDraftIndicator) {
    topDraftIndicator.style.display = 'none !important';
    topDraftIndicator.style.visibility = 'hidden';
  }
  
  console.log('🔴 تم فرض إخفاء مؤشر المسودة');
}

// وظائف سجل العمليات
function updateCurrentUser() {
  try {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const userName = user.name || user.username || 'مستخدم غير معرف';
    const userElement = document.getElementById('currentUser');
    if (userElement) {
      userElement.textContent = userName;
    }
    return userName;
  } catch (error) {
    console.error('خطأ في جلب بيانات المستخدم:', error);
    const userElement = document.getElementById('currentUser');
    if (userElement) {
      userElement.textContent = 'مستخدم غير معرف';
    }
    return 'مستخدم غير معرف';
  }
}

function initializeOperationsLog() {
  const operationsContent = document.getElementById('operationsContent');
  if (!operationsContent) return;
  
  // مسح المحتوى السابق
  operationsContent.innerHTML = `
    <div class="operation-item" style="text-align:center; color:#666; font-style:italic;">
      <div class="operation-action">اختر مقاولاً لبدء تسجيل العمليات</div>
    </div>
  `;
}

function updateCurrentTime() {
  const now = new Date();
  const timeStr = now.toLocaleString('ar-EG', {
    timeZone: 'Africa/Cairo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  const timeElement = document.getElementById('currentTime');
  if (timeElement) {
    timeElement.textContent = timeStr;
  }
}

function addOperation(action, details) {
  // التحقق من وجود مقاول محدد
  const contractorSelect = document.getElementById('contractorSelect');
  if (!contractorSelect || !contractorSelect.value) {
    console.log('لم يتم اختيار مقاول بعد، لن يتم تسجيل العملية');
    return;
  }

  const operationsContent = document.getElementById('operationsContent');
  if (!operationsContent) return;
  
  const now = new Date();
  const timeStr = now.toLocaleString('ar-EG', {
    timeZone: 'Africa/Cairo',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  const currentUser = document.getElementById('currentUser')?.textContent || 'غير محدد';
  
  const operationItem = document.createElement('div');
  operationItem.className = 'operation-item';
  operationItem.innerHTML = `
    <div class="operation-time">${timeStr}</div>
    <div class="operation-action">${action}</div>
    <div class="operation-details">${details}</div>
    <div class="operation-user">👤 ${currentUser}</div>
  `;
  
  // إضافة العملية في الأعلى (بعد الرسالة الافتراضية)
  if (operationsContent.children.length > 0 && operationsContent.children[0].textContent.includes('اختر مقاولاً')) {
    operationsContent.innerHTML = ''; // مسح الرسالة الافتراضية
  }
  
  operationsContent.insertBefore(operationItem, operationsContent.firstChild);
  
  // إبقاء آخر 50 عملية (زيادة الحد)
  while (operationsContent.children.length > 50) {
    operationsContent.removeChild(operationsContent.lastChild);
  }
  
  // حفظ العمليات في localStorage (دائماً بدون مسح حتى الحفظ النهائي)
  saveOperationToStorage(action, details, timeStr, currentUser);
  
  // تمرير للأعلى لرؤية العملية الجديدة
  operationsContent.scrollTop = 0;
  
  console.log(`✅ تم تسجيل العملية: ${action} - ${details}`);
}

// حفظ العمليات في localStorage والسيرفر (بدون مسح حتى الحفظ النهائي)
function saveOperationToStorage(action, details, time, user) {
  try {
    // تحديد مفتاح فريد للمقاول الحالي
    const contractorSelect = document.getElementById('contractorSelect');
    const contractorId = contractorSelect ? contractorSelect.value : 'unknown';
    const operationsKey = `currentExtractOperations_${contractorId}`;
    
    // جلب العمليات الحالية للمقاول
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    
    const operation = {
      action,
      details,
      time,
      user,
      contractorId,
      timestamp: new Date().toISOString()
    };
    
    operations.push(operation);
    
    // حفظ العمليات مع مفتاح خاص بالمقاول
    localStorage.setItem(operationsKey, JSON.stringify(operations));
    
    // حفظ مفتاح المقاول الحالي للمرجعية
    localStorage.setItem('currentContractorOperations', operationsKey);
    
    console.log(`💾 تم حفظ العملية للمقاول ${contractorId}: ${action}`);
    
    // حفظ في السيرفر (اختياري للمستقبل)
    if (contractorId && contractorId !== 'unknown') {
      fetch('/extract-operations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          extractId: 'temp', // مؤقت حتى يتم إنشاء المستخلص
          contractorId: contractorId,
          action,
          details,
          user,
          timestamp: operation.timestamp
        })
      }).catch(error => {
        console.log('تم الحفظ محلياً، خطأ في الإرسال للسيرفر:', error);
      });
    }
  } catch (error) {
    console.error('خطأ في حفظ العملية:', error);
  }
}

// نقل العمليات لصفحة المستخلص المحفوظ (فقط عند الحفظ النهائي)
function transferOperationsToExtract() {
  try {
    const contractorSelect = document.getElementById('contractorSelect');
    const contractorId = contractorSelect ? contractorSelect.value : null;
    
    if (!contractorId) {
      console.log('لا يوجد مقاول محدد لنقل العمليات');
      return;
    }
    
    const operationsKey = `currentExtractOperations_${contractorId}`;
    const operations = JSON.parse(localStorage.getItem(operationsKey) || '[]');
    
    if (operations.length > 0) {
      // حفظ العمليات لآخر مستخلص تم إنشاؤه
      const extractOperationsKey = `extractOperations_${Date.now()}`;
      localStorage.setItem(extractOperationsKey, JSON.stringify(operations));
      localStorage.setItem('lastExtractOperations', extractOperationsKey);
      
      // مسح العمليات للمقاول فقط بعد النقل الناجح
      localStorage.removeItem(operationsKey);
      localStorage.removeItem('currentContractorOperations');
      
      addOperation('نقل العمليات', 'تم نقل سجل العمليات لصفحة المستخلص المحفوظ');
      
      console.log(`✅ تم نقل ${operations.length} عملية للمستخلص المحفوظ`);
    }
  } catch (error) {
    console.error('خطأ في نقل العمليات:', error);
  }
}

// مسح المسودة بعد الحفظ النهائي (بدون مسح العمليات)
function clearDraftAfterSave() {
  try {
    const contractorSelect = document.getElementById('contractorSelect');
    
    // مسح المسودة بغض النظر عن المقاول (لكن الاحتفاظ بالعمليات)
    localStorage.removeItem('extractDraft');
    console.log('تم مسح المسودة من localStorage (مع الاحتفاظ بالعمليات)');
    
    // إعادة تعيين تتبع الصفوف المسجلة بعد الحفظ النهائي
    resetLoggedRowsTracking();
    
    // إخفاء مؤشر المسودة فوراً من جميع الأماكن
    const draftIndicator = document.getElementById('draftIndicator');
    const topDraftIndicator = document.getElementById('topDraftIndicator');
    
    if (draftIndicator) {
      draftIndicator.style.display = 'none';
      console.log('تم إخفاء draftIndicator');
    }
    if (topDraftIndicator) {
      topDraftIndicator.style.display = 'none';
      console.log('تم إخفاء topDraftIndicator');
    }
    
    // التأكد من إخفاء المؤشر نهائياً
    setTimeout(() => {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      forceDraftIndicatorHide(); // فرض الإخفاء
    }, 100);
    
    // فحص إضافي بعد ثانيتين
    setTimeout(() => {
      forceDraftIndicatorHide();
    }, 2000);
    
    // لا نعيد تعيين النموذج فوراً - نتركه للمستخدم
    // setTimeout(() => {
    //   resetFormAfterSave();
    // }, 1500);
    
    console.log('✅ تم مسح المسودة مع الاحتفاظ بالعمليات');
  } catch (error) {
    console.error('❌ خطأ في مسح المسودة:', error);
  }
}

// دالة للتحقق من صحة البيانات ومنع فقدانها
function validateAndLogDataState(action) {
  console.log(`=== ${action} ===`);
  console.log('حالة البيانات الحالية:');
  console.log('- workItems:', Array.isArray(workItems) ? workItems.length : 'غير معرف', workItems);
  console.log('- lumpSumRows:', Array.isArray(lumpSumRows) ? lumpSumRows.length : 'غير معرف', lumpSumRows);
  console.log('- dailyRows:', Array.isArray(dailyRows) ? dailyRows.length : 'غير معرف', dailyRows);
  
  const deductionsCount = document.querySelectorAll('#deductionsBody tr').length;
  console.log('- deductionsRows:', deductionsCount);
  
  console.log('- contractorSelect:', document.getElementById('contractorSelect')?.value || 'فارغ');
  console.log('- statementNumber:', document.getElementById('statementNumber')?.value || 'فارغ');
  console.log('- extractDate:', document.getElementById('extractDate')?.value || 'فارغ');
  console.log('========================');
  
  return {
    workItemsCount: Array.isArray(workItems) ? workItems.length : 0,
    lumpSumCount: Array.isArray(lumpSumRows) ? lumpSumRows.length : 0,
    dailyCount: Array.isArray(dailyRows) ? dailyRows.length : 0,
    deductionsCount: deductionsCount,
    hasContractor: !!document.getElementById('contractorSelect')?.value,
    hasStatementNumber: !!document.getElementById('statementNumber')?.value
  };
}

// دالة محسّنة لحفظ المسودة مع حماية البيانات
function safeSaveDraft() {
  console.log('🔒 بدء عملية حفظ آمنة للمسودة...');
  
  // التحقق السريع من البيانات قبل إظهار الـ loading
  const contractorSelect = document.getElementById('contractorSelect');
  if (!contractorSelect || !contractorSelect.value) {
    alert('يجب اختيار مقاول أولاً قبل حفظ المسودة');
    return false;
  }
  
  // إظهار الـ loading overlay للمسودة بعد التأكد من البيانات
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingMessage = loadingOverlay?.querySelector('.loading-message');
  const submitBtn = document.querySelector('button[type="submit"][form="extractForm"]');
  const saveDraftBtn = document.getElementById('topSaveDraftBtn');
  
  if (loadingOverlay) {
    loadingOverlay.style.display = 'flex';
  }
  
  // تغيير رسالة التحميل للمسودة
  if (loadingMessage) {
    loadingMessage.textContent = '💾 جاري حفظ المسودة... يرجى الانتظار قليلاً';
  }
  
  // تعطيل الأزرار لمنع الضغط المتكرر
  if (submitBtn) {
    submitBtn.disabled = true;
  }
  if (saveDraftBtn) {
    saveDraftBtn.disabled = true;
    saveDraftBtn.textContent = '⏳ جاري الحفظ...';
  }
  
  // استخدام setTimeout للتأكد من ظهور الـ loading أولاً قبل تنفيذ أي عمليات
  setTimeout(() => {
    try {
      // التحقق من البيانات قبل الحفظ (داخل try-catch)
      const beforeState = validateAndLogDataState('قبل حفظ المسودة');
      // استدعاء دالة الحفظ الأصلية (localStorage) - بدون رسائل تأكيد
      saveDraftSilently();
      
      // تسجيل التعديلات المجمعة للصفوف المعدلة (فقط عند حفظ المسودة)
      logModifiedWorkItems();
      
      // تسجيل الخصومات الجديدة
      logNewDeductions();
      
      // تسجيل اليوميات والمقطوعيات
      logDailyAndLumpOperations();
      
      // مسح التعديلات المجمعة بعد التسجيل لمنع التكرار
      modifiedWorkItemsDetails.clear();
      
      // حفظ إضافي في السيرفر (حماية مضاعفة)
      const contractorId = document.getElementById('contractorSelect').value;
      if (contractorId) {
        const draftData = {
          contractorId: contractorId,
          workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
          extractNumber: document.getElementById('statementNumber').value,
          extractDate: document.getElementById('extractDate').value,
          workItems: Array.isArray(workItems) ? [...workItems] : [],
          lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
          dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
          deductions: Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
            statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
            date: tr.querySelector('input[name="deductionDate"]')?.value || '',
            quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
            category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
            total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
            user: tr.querySelector('input[name="deductionUser"]')?.value || ''
          })),
          maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
          timestamp: new Date().toISOString()
        };
        
        // حفظ في السيرفر (بدون انتظار لعدم تعليق الواجهة)
        fetch('/drafts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(draftData)
        }).then(response => {
          if (response.ok) {
            console.log('✅ تم حفظ المسودة في السيرفر أيضاً');
          } else {
            console.warn('⚠️ فشل حفظ المسودة في السيرفر، لكن localStorage نجح');
          }
        }).catch(error => {
          console.warn('⚠️ خطأ في حفظ المسودة في السيرفر:', error);
        });
      }
      
      // التحقق من البيانات بعد الحفظ
      setTimeout(() => {
        const afterState = validateAndLogDataState('بعد حفظ المسودة');
        
        // التأكد من أن البيانات لم تختفي
        if (afterState.workItemsCount !== beforeState.workItemsCount) {
          console.warn('⚠️ تغيرت بيانات بنود الأعمال بعد الحفظ!');
        }
        if (afterState.lumpSumCount !== beforeState.lumpSumCount) {
          console.warn('⚠️ تغيرت بيانات المقطوعيات بعد الحفظ!');
        }
        if (afterState.dailyCount !== beforeState.dailyCount) {
          console.warn('⚠️ تغيرت بيانات اليوميات بعد الحفظ!');
        }
        
        console.log('✅ تم حفظ المسودة بأمان');
        
        // إبقاء الـ loading spinner لمدة ثانيتين
        setTimeout(() => {
          // إخفاء الـ loading overlay بعد التأخير
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
          
          // إعادة تفعيل الأزرار
          if (submitBtn) {
            submitBtn.disabled = false;
          }
          if (saveDraftBtn) {
            saveDraftBtn.disabled = false;
            saveDraftBtn.textContent = '💾 حفظ كمسودة';
          }
          
          // إظهار رسالة النجاح مخصصة
          setTimeout(() => {
            showSuccessNotification('💾 تم حفظ المسودة بنجاح');
            
            // التحويل إلى الصفحة الرئيسية
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          }, 100);
        }, 2000); // تأخير لمدة ثانيتين
        
      }, 100);
      
    } catch (error) {
      console.error('❌ خطأ في حفظ المسودة الآمن:', error);
      
      // إخفاء الـ loading في حالة الخطأ
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      
      // إعادة تفعيل الأزرار
      if (submitBtn) {
        submitBtn.disabled = false;
      }
      if (saveDraftBtn) {
        saveDraftBtn.disabled = false;
        saveDraftBtn.textContent = '💾 حفظ كمسودة';
      }
      
      alert('حدث خطأ أثناء حفظ المسودة: ' + error.message);
      return false;
    }
  }, 100); // تأخير 100ms للتأكد من ظهور الـ loading أولاً
  
  return true;
}

// إعادة تعيين النموذج بعد الحفظ
function resetFormAfterSave() {
  try {
    // إعادة تعيين قائمة المقاولين لحالة "اختر المقاول"
    const contractorSelect = document.getElementById('contractorSelect');
    if (contractorSelect) {
      contractorSelect.value = '';
    }
    
    // إعادة تهيئة سجل العمليات
    initializeOperationsLog();
    
    // مسح الحقول الرئيسية
    const extractDate = document.getElementById('extractDate');
    if (extractDate) extractDate.value = '';
    
    const statementNumber = document.getElementById('statementNumber');
    if (statementNumber) statementNumber.value = '';
    
    const workItemSelect = document.getElementById('workItemFilterSelect');
    if (workItemSelect) workItemSelect.value = '';
    
    console.log('تم إعادة تعيين النموذج بعد الحفظ');
  } catch (error) {
    console.error('خطأ في إعادة تعيين النموذج:', error);
  }
}

// إضافة event listeners للعمليات المختلفة
document.addEventListener('DOMContentLoaded', function() {
  // مراقبة تغيير المقاول - تسجيل بداية إنشاء مستخلص
  const contractorSelect = document.getElementById('contractorSelect');
  if (contractorSelect) {
    contractorSelect.addEventListener('change', function() {
      if (this.value) {
        const option = this.options[this.selectedIndex];
        const contractorName = option.text || 'مقاول غير محدد';
        const extractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
        const currentUser = document.getElementById('currentUser')?.textContent || 'غير محدد';
        
        // إعادة تعيين تتبع الصفوف المسجلة للمقاول الجديد
        resetLoggedRowsTracking();
        
        // استعادة العمليات المحفوظة للمقاول
        restoreOperationsForContractor(this.value);
        
        // تسجيل بداية إنشاء مستخلص جديد أو استكمال مسودة
        setTimeout(() => {
          // الحصول على رقم المستخلص المحدث بعد تحميل البيانات
          const updatedExtractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
          
          // فحص وجود مسودة للمقاول
          const savedDraft = localStorage.getItem('extractDraft');
          let isDraftExisting = false;
          
          if (savedDraft) {
            try {
              const draftData = JSON.parse(savedDraft);
              if (draftData.contractorId === this.value && 
                  (draftData.workItems?.length > 0 || draftData.lumpSumRows?.length > 0 || 
                   draftData.dailyRows?.length > 0 || draftData.deductions?.length > 0)) {
                isDraftExisting = true;
              }
            } catch (error) {
              console.error('خطأ في فحص المسودة:', error);
            }
          }
          
          // ❌ تم إزالة تسجيل "بداية إنشاء مستخلص" هنا
          // ✅ سيتم التسجيل فقط عند الحفظ النهائي للمستخلص
          
          // if (isDraftExisting) {
          //   addOperation('استكمال التعديلات', `استكمال تعديل المستخلص رقم ${updatedExtractNumber} للمقاول ${contractorName}`);
          // } else {
          //   addOperation('بداية إنشاء مستخلص', `إنشاء مستخلص رقم ${updatedExtractNumber} للمقاول ${contractorName}`);
          // }
        }, 500);
        
      } else {
        // إذا تم إلغاء اختيار المقاول، أعد تهيئة السجل
        initializeOperationsLog();
        resetLoggedRowsTracking();
        resetSessionChanges();
      }
    });
  }
  
  // مراقبة تغيير بند الأعمال
  const workItemSelect = document.getElementById('workItemFilterSelect');
  if (workItemSelect) {
    workItemSelect.addEventListener('change', function() {
      if (this.value) {
        const option = this.options[this.selectedIndex];
        addOperation('اختيار بند أعمال', `تم اختيار: ${option.text}`);
      }
    });
  }
  
  // مراقبة حفظ المسودة - نظام مبسط
  const saveDraftBtn = document.getElementById('topSaveDraftBtn');
  if (saveDraftBtn) {
    saveDraftBtn.addEventListener('click', function() {
      const currentUser = document.getElementById('currentUser')?.textContent || 'غير محدد';
      const extractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
      
      // استخدام الدالة الآمنة لحفظ المسودة
      const success = safeSaveDraft();
      
      if (success) {
        addOperation('حفظ مسودة', `حفظ المستخلص رقم ${extractNumber} كمسودة`);
      }
    });
  }
  
  // مراقبة حفظ المستخلص النهائي - نظام مبسط
  const extractForm = document.getElementById('extractForm');
  if (extractForm) {
    extractForm.addEventListener('submit', function(e) {
      const extractNumber = document.getElementById('statementNumber')?.value || 'غير محدد';
      const contractorSelect = document.getElementById('contractorSelect');
      const contractorName = contractorSelect?.options[contractorSelect.selectedIndex]?.text || 'مقاول غير محدد';
      
      // ✅ تسجيل بداية إنشاء المستخلص مرة واحدة عند الحفظ
      addOperation('بداية إنشاء مستخلص', `إنشاء مستخلص رقم ${extractNumber} للمقاول ${contractorName}`);
      
      addOperation('حفظ نهائي', `حفظ المستخلص رقم ${extractNumber} نهائياً`);
      
      // تسجيل التعديلات المجمعة للصفوف المعدلة (فقط إذا لم تُسجل من قبل)
      if (modifiedWorkItemsDetails.size > 0) {
        logModifiedWorkItems();
        modifiedWorkItemsDetails.clear(); // مسح بعد التسجيل
      }
      
      // تسجيل بنود الأعمال الجديدة
      logNewWorkItems();
      
      // تسجيل الخصومات الجديدة
      logNewDeductions();
      
      // تسجيل اليوميات والمقطوعيات
      logDailyAndLumpOperations();
      
      // مسح المسودة بعد الحفظ النهائي
      setTimeout(() => {
        clearDraftAfterSave();
        transferOperationsToExtract();
      }, 1500);
    });
  }
  
  // مراقبة الأزرار المهمة فقط - نظام مبسط
  document.addEventListener('click', function(e) {
    const contractorSelect = document.getElementById('contractorSelect');
    if (!contractorSelect || !contractorSelect.value) return; // لا تسجيل بدون مقاول
    
    const currentUser = document.getElementById('currentUser')?.textContent || 'غير محدد';
    
    // إضافة بند عمل
    if (e.target && e.target.id === 'addWorkItemRowBtn') {
      // تم إزالة التسجيل الفوري - سيتم التسجيل عند الحفظ
      return;
    }
    
    // حذف بند عمل
    if (e.target && e.target.classList.contains('delete-work-row')) {
      const row = e.target.closest('tr');
      if (row) {
        // الحصول على رقم الصف من data-idx
        const rowIndex = parseInt(row.dataset.idx);
        const rowNumber = rowIndex + 1;
        
        // الحصول على رقم المبنى من input في نفس الصف
        const buildingInput = row.querySelector('input[data-field="buildingNumber"]');
        const buildingNumber = buildingInput ? buildingInput.value.trim() : 'غير محدد';
        
        // الحصول على رقم البند من input في نفس الصف
        const workItemInput = row.querySelector('input[data-field="workItem"]');
        const workItemNumber = workItemInput ? workItemInput.value.trim() : 'غير محدد';
        
        addOperation('حذف بند عمل', `${currentUser} قام بحذف صف ${rowNumber} - مبنى ${buildingNumber} - بند ${workItemNumber}`);
      }
      return;
    }
    
    // إضافة خصم
    if (e.target && e.target.id === 'addDeductionRowBtn') {
      // تم إزالة التسجيل الفوري - سيتم التسجيل عند الحفظ
      return;
    }
    
    // إضافة يومية
    if (e.target && e.target.id === 'addDailyRowBtn') {
      // تم إزالة التسجيل الفوري - سيتم التسجيل عند الحفظ
      return;
    }
    
    // إضافة مقطوعية
    if (e.target && e.target.id === 'addLumpSumRowBtn') {
      // تم إزالة التسجيل الفوري - سيتم التسجيل عند الحفظ
      return;
    }
    
    // حذف يومية مع التفاصيل
    if (e.target && e.target.classList.contains('delete-daily-row-btn')) {
      const idx = parseInt(e.target.dataset.idx);
      const row = dailyRows[idx];
      if (row) {
        const dailyDesc = row.dailyDesc || 'غير محدد';
        const building = row.building || 'غير محدد';
        const dailyValue = row.dailyValue || '0';
        addOperation('حذف يومية', `${currentUser} قام بحذف يومية: ${dailyDesc} - المبنى: ${building} - قيمة اليومية: ${dailyValue}`);
      }
      return;
    }
    
    // حذف مقطوعية مع التفاصيل
    if (e.target && e.target.classList.contains('delete-lump-row-btn')) {
      const idx = parseInt(e.target.dataset.idx);
      const row = lumpSumRows[idx];
      if (row) {
        const statementDesc = row.statementDesc || 'غير محدد';
        const buildingsCount = row.buildingsCount || '0';
        const lumpSum = row.lumpSum || '0';
        addOperation('حذف مقطوعية', `${currentUser} قام بحذف مقطوعية: ${statementDesc} - عدد المباني: ${buildingsCount} - القيمة: ${lumpSum}`);
      }
      return;
    }
  });
  
  // تم إلغاء مراقبة input لتقليل التسجيل المفرط - استخدام change فقط للأحداث المهمة
  // سيتم تسجيل العمليات فقط عند الانتهاء من التعديل وليس أثناء الكتابة
  
  // مراقبة محدودة للتغييرات المهمة فقط عند الانتهاء من التعديل
  document.addEventListener('change', function(e) {
    const contractorSelect = document.getElementById('contractorSelect');
    if (!contractorSelect || !contractorSelect.value) return; // لا تسجيل بدون مقاول
    
    const currentUser = document.getElementById('currentUser')?.textContent || 'غير محدد';
    
    // تسجيل تعديل بنود الأعمال - جمع التعديلات بدون تسجيل فوري
    if (e.target && e.target.classList.contains('work-item-input')) {
      const field = e.target.dataset.field;
      const idx = e.target.dataset.idx;
      const newValue = e.target.value;
      
      // تجميع تغييرات الكمية والفئة والنسبة الحالية بدون تسجيل فوري
      if (field === 'quantity' || field === 'category' || field === 'currentPercent') {
        const workItem = workItems[idx];
        if (workItem && !workItem.isSeparator) {
          // إضافة البند للقائمة المعدلة
          modifiedWorkItems.add(idx);
          
          // حفظ تفاصيل التعديل
          if (!modifiedWorkItemsDetails.has(idx)) {
            modifiedWorkItemsDetails.set(idx, {
              rowNumber: parseInt(idx) + 1,
              buildingNumber: workItem.buildingNumber || 'غير محدد',
              workItemNumber: workItem.workItem || 'غير محدد',
              modifications: []
            });
          }
          
          const details = modifiedWorkItemsDetails.get(idx);
          let fieldName = '';
          if (field === 'quantity') fieldName = 'الكمية';
          else if (field === 'category') fieldName = 'الفئة';
          else if (field === 'currentPercent') fieldName = 'النسبة الحالية';
          
          // تحديث أو إضافة التعديل
          const existingMod = details.modifications.find(m => m.field === fieldName);
          if (existingMod) {
            existingMod.newValue = newValue + (field === 'currentPercent' ? '%' : '');
          } else {
            details.modifications.push({
              field: fieldName,
              newValue: newValue + (field === 'currentPercent' ? '%' : '')
            });
          }
        }
      }
    }
    
    // تسجيل تغيير رقم المستخلص
    if (e.target && e.target.id === 'statementNumber' && e.target.value) {
      addOperation('تحديث رقم المستخلص', `تغيير رقم المستخلص إلى ${e.target.value}`);
    }
  });
});

  </script>

  <script>
// === دوال حفظ المسودات في النطاق العالمي ===

// دالة حفظ صامتة بدون رسائل تأكيد (للاستخدام مع safeSaveDraft)
function saveDraftSilently() {
  console.log('بدء دالة حفظ المسودة الصامتة...');
  
  // التحقق من وجود العناصر المطلوبة
  const requiredElements = [
    'contractorSelect', 'workItemFilterSelect', 'statementNumber',
    'extractDate', 'maxTotalPercentInput'
  ];
  
  for (const elementId of requiredElements) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error(`العنصر غير موجود: ${elementId}`);
      return false;
    }
  }
  
  try {
    console.log('جمع البيانات للمسودة...');
    
    // جمع بيانات الخصومات من الجدول مباشرة
    const deductionsData = Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
      statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
      date: tr.querySelector('input[name="deductionDate"]')?.value || '',
      quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
      category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
      total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
      user: tr.querySelector('input[name="deductionUser"]')?.value || ''
    }));
    
    const draftData = {
      contractorId: document.getElementById('contractorSelect').value,
      workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
      extractNumber: document.getElementById('statementNumber').value,
      extractDate: document.getElementById('extractDate').value,
      workItems: Array.isArray(workItems) ? [...workItems] : [],
      lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
      dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
      deductions: deductionsData,
      maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
      timestamp: new Date().toISOString()
    };
    
    console.log('بيانات المسودة:', draftData);
    localStorage.setItem('extractDraft', JSON.stringify(draftData));
    console.log('تم حفظ المسودة في localStorage (صامت)');
    
    // إظهار علامة المسودة بدون رسالة تأكيد
    showDraftIndicator();
    return true;
  } catch (error) {
    console.error('خطأ في حفظ المسودة الصامتة:', error);
    return false;
  }
}

function saveDraft() {
  console.log('بدء دالة حفظ المسودة');
  
  // التحقق من وجود العناصر المطلوبة
  const requiredElements = [
    'contractorSelect', 'workItemFilterSelect', 'statementNumber',
    'extractDate', 'maxTotalPercentInput'
  ];
  
  for (const elementId of requiredElements) {
    const element = document.getElementById(elementId);
    if (!element) {
      console.error(`العنصر غير موجود: ${elementId}`);
      alert(`خطأ: العنصر ${elementId} غير موجود`);
      return;
    }
  }
  
  try {
    console.log('جمع البيانات للمسودة...');
    
    // جمع بيانات الخصومات من الجدول مباشرة
    const deductionsData = Array.from(document.querySelectorAll('#deductionsBody tr')).map(tr => ({
      statement: tr.querySelector('input[name="deductionStatement"]')?.value || '',
      date: tr.querySelector('input[name="deductionDate"]')?.value || '',
      quantity: tr.querySelector('input[name="deductionQuantity"]')?.value || '',
      category: tr.querySelector('input[name="deductionCategory"]')?.value || '',
      total: tr.querySelector('input[name="deductionTotal"]')?.value || '',
      user: tr.querySelector('input[name="deductionUser"]')?.value || ''
    }));
    
    const draftData = {
      contractorId: document.getElementById('contractorSelect').value,
      workItemFilterSelect: document.getElementById('workItemFilterSelect').value,
      extractNumber: document.getElementById('statementNumber').value,
      extractDate: document.getElementById('extractDate').value,
      workItems: Array.isArray(workItems) ? [...workItems] : [],
      lumpSumRows: Array.isArray(lumpSumRows) ? [...lumpSumRows] : [],
      dailyRows: Array.isArray(dailyRows) ? [...dailyRows] : [],
      deductions: deductionsData,
      maxTotalPercent: document.getElementById('maxTotalPercentInput').value,
      timestamp: new Date().toISOString()
    };
    
    console.log('بيانات المسودة:', draftData);
    localStorage.setItem('extractDraft', JSON.stringify(draftData));
    console.log('تم حفظ المسودة في localStorage');
    alert('تم حفظ المستخلص كمسودة بنجاح!');
    
    // إظهار علامة المسودة
    showDraftIndicator();
  } catch (error) {
    console.error('خطأ في حفظ المسودة:', error);
    alert('حدث خطأ أثناء حفظ المسودة.');
  }
}

function showDraftIndicator() {
  const savedDraft = localStorage.getItem('extractDraft');
  const currentContractor = document.getElementById('contractorSelect').value;
  const draftIndicator = document.getElementById('draftIndicator') || document.getElementById('topDraftIndicator');
  const topDraftIndicator = document.getElementById('topDraftIndicator');
  
  if (savedDraft && currentContractor) {
    try {
      const draftData = JSON.parse(savedDraft);
      if (draftData.contractorId === currentContractor) {
        if (draftIndicator) draftIndicator.style.display = 'inline-block';
        if (topDraftIndicator) topDraftIndicator.style.display = 'inline-block';
      } else {
        if (draftIndicator) draftIndicator.style.display = 'none';
        if (topDraftIndicator) topDraftIndicator.style.display = 'none';
      }
    } catch (error) {
      if (draftIndicator) draftIndicator.style.display = 'none';
      if (topDraftIndicator) topDraftIndicator.style.display = 'none';
    }
  } else {
    if (draftIndicator) draftIndicator.style.display = 'none';
    if (topDraftIndicator) topDraftIndicator.style.display = 'none';
  }
}

  </script>
  
  <!-- سكريبت لإظهار الأزرار بعد تحميل الصفحة بالكامل -->
  <script>
  window.addEventListener('load', function() {
    setTimeout(function() {
      console.log('🔧 فحص نهائي للأزرار...');
      
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const perms = user.permissions || [];
      
      console.log('👤 المستخدم:', user.username);
      console.log('📋 عدد الصلاحيات:', perms.length);
      console.log('🔑 الصلاحيات:', perms);
      
      // فحص وإظهار الأزرار المهمة
      const buttonsToCheck = [
        { id: 'addWorkItemRowBtn', perm: 'add-extract-add-workitem', name: 'زر إضافة بند أعمال' },
        { selector: 'button[type="submit"][form="extractForm"]', perm: 'add-extract-create', name: 'زر حفظ المستخلص' },
        { id: 'addLumpSumBtn', perm: 'add-extract-add-lump', name: 'زر إضافة مقطوعية' },
        { id: 'addDailyBtn', perm: 'add-extract-add-daily', name: 'زر إضافة يومية' },
        { id: 'addSeparatorBtn', perm: 'add-extract-create', name: 'زر إضافة فاصل' },
        { id: 'addLumpSumRowBtn', perm: 'add-extract-add-lump', name: 'زر إضافة صف مقطوعية' },
        { id: 'addDailyRowBtn', perm: 'add-extract-add-daily', name: 'زر إضافة صف يومية' }
      ];
      
      buttonsToCheck.forEach(function(btn) {
        const element = btn.id ? document.getElementById(btn.id) : document.querySelector(btn.selector);
        if (element) {
          const hasPerm = perms.includes(btn.perm);
          console.log(`🔍 ${btn.name}:`);
          console.log(`   - العنصر موجود: نعم`);
          console.log(`   - الصلاحية المطلوبة: ${btn.perm}`);
          console.log(`   - الصلاحية متوفرة: ${hasPerm ? '✅ نعم' : '❌ لا'}`);
          console.log(`   - display: ${element.style.display}`);
          console.log(`   - disabled: ${element.disabled}`);
          console.log(`   - visibility: ${window.getComputedStyle(element).visibility}`);
          
          // إذا كانت الصلاحية موجودة، أظهر الزر بالقوة وأزل أي إخفاء
          if (hasPerm) {
            element.style.removeProperty('display');
            element.style.display = 'inline-block';
            element.style.visibility = 'visible';
            element.disabled = false;
            element.style.opacity = '1';
            element.style.cursor = 'pointer';
            element.removeAttribute('hidden');
            console.log(`   ✅ تم تفعيل ${btn.name}`);
            console.log(`   - display بعد التعديل: ${element.style.display}`);
          } else {
            console.log(`   ❌ ${btn.name} مخفي لعدم وجود الصلاحية`);
          }
        } else {
          console.log(`❌ ${btn.name} غير موجود في الصفحة!`);
        }
      });
      
      // فحص إضافي خاص بزر حفظ المستخلص
      console.log('\n🎯 فحص خاص لزر حفظ المستخلص:');
      const allSubmitButtons = document.querySelectorAll('button[type="submit"]');
      console.log(`   - عدد أزرار submit الموجودة: ${allSubmitButtons.length}`);
      allSubmitButtons.forEach((btn, index) => {
        console.log(`   - زر ${index + 1}:`, btn.textContent.trim(), 'form=', btn.getAttribute('form'), 'display=', btn.style.display);
      });
    }, 500);
  });
  </script>
    </div> <!-- إغلاق main-content -->
  </div> <!-- إغلاق container -->
</body>
</html>
 