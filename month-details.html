<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root { direction: rtl; }
    body {
      margin: 0;
      font-family: 'Cairo', Arial, sans-serif;
      background: #c5d6db;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px #1a3b5011, 0 1.5px 8px #c5d6dbcc;
      padding: 32px 24px 24px 24px;
      margin-top: 32px;
      text-align: center;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    .month-title {
      font-size: 1.15rem;
      color: #1a3b50;
      font-weight: 900;
      margin-bottom: 0;
      letter-spacing: 1px;
      text-align: center;
    }
    .month-date {
      font-size: 1.1rem;
      color: #2e8ca3;
      margin-bottom: 0;
      font-weight: 700;
      text-align: left;
    }
    .back-btn {
      border: 2px solid #2e8ca3;
      background: #fff;
      color: #1a3b50;
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      padding: 6px 16px;
      border-radius: 0;
      cursor: pointer;
      margin-bottom: 0;
      transition: background 0.15s, color 0.15s, border 0.15s;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #2e8ca311;
      outline: none;
      display: inline-block;
    }
    .back-btn:hover, .back-btn:focus {
      background: #2e8ca3;
      color: #fff;
      border-color: #1a3b50;
    }
    .footer {
      text-align: center;
      color: #2e8ca3;
      font-size: 1.1rem;
      margin-top: 60px;
      padding-bottom: 18px;
      opacity: 0.8;
      letter-spacing: 1px;
      font-weight: 500;
      text-shadow: 0 1px 8px #2e8ca311;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0 18px 0;
      background: #f8fafb;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px #2e8ca311;
    }
    th, td {
      padding: 8px 6px;
      text-align: center;
      font-size: 0.9rem;
      color: #333;
      border-bottom: 1px solid #ddd;
      min-width: 150px;
      vertical-align: middle;
      line-height: 1.2;
    }
    th {
      background: #2e8ca3;
      color: #fff;
      font-weight: bold;
      font-size: 1.05rem;
    }
    /* Ø¹ÙˆØ§Ù…ÙŠØ¯ Ø®Ø§ØµØ© Ø¨Ø£Ø­Ø¬Ø§Ù… Ù…Ø®ØªÙ„ÙØ© */
    th:nth-child(1), td:nth-child(1) { min-width: 80px; } /* Ø±Ù‚Ù… */
    th:nth-child(2), td:nth-child(2) { min-width: 200px; } /* Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ */
    th:nth-child(3), td:nth-child(3) { min-width: 180px; } /* Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ */
    th:nth-child(4), td:nth-child(4) { min-width: 150px; } /* ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø¨Ø¶ */
    th:nth-child(5), td:nth-child(5) { min-width: 150px; } /* Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¨Ø¶ */
    th:nth-child(6), td:nth-child(6) { min-width: 200px; } /* Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ */
    th:nth-child(7), td:nth-child(7) { min-width: 150px; } /* Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
    th:nth-child(8), td:nth-child(8) { min-width: 100px; } /* Ø­Ø°Ù */
    tr:hover {
      background: #f1f1f1;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª */
    tr[draggable="true"] {
      cursor: move;
      transition: all 0.2s ease;
    }
    
    tr.dragging {
      opacity: 0.5;
      background: #e3f2fd !important;
      transform: scale(1.02);
    }
    
    tr.drag-over {
      border-top: 3px solid #2e8ca3 !important;
      background: #f0f8ff !important;
    }
    
    .drag-handle {
      cursor: grab;
      color: #2e8ca3;
      font-size: 1.2rem;
      padding: 0 5px;
      display: inline-block;
      user-select: none;
      transition: color 0.2s ease;
    }
    
    .drag-handle:hover {
      color: #1a6b7e;
      transform: scale(1.1);
    }
    
    .drag-handle:active {
      cursor: grabbing;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ØµÙÙˆÙ */
    tr {
      transition: background-color 0.2s ease;
    }
    
    tr:hover .drag-handle {
      color: #1a6b7e;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„ÙÙˆØ§ØµÙ„ */
    tr[data-separator="true"] {
      border: 2px solid #7a5230;
    }
    
    tr[data-separator="true"] .drag-handle {
      color: #fff !important;
    }
    
    tr[data-separator="true"]:hover .drag-handle {
      color: #f0f0f0 !important;
      transform: scale(1.1);
    }
    button.delete-btn {
      color: #fff;
      background: #e74c3c;
      border: none;
      border-radius: 4px;
      padding: 3px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    /* ØªØ£Ø«ÙŠØ±Ø§Øª hover Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
    #addPayBtn:hover {
      background: #2e8ca3 !important;
      color: #fff !important;
    }
    
    #addSeparatorBtn:hover {
      background: #7a5230 !important;
      color: #fff !important;
    }
    
    #exportExcelBtn:hover {
      background: #1e7e34 !important;
      border-color: #155724 !important;
    }
    
    button.delete-btn:hover {
      background: #c82333 !important;
    }
  </style>
</head>
<body>
  <div id="main-navbar"></div>
  <script>
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù…Ù† components/main-navbar.html
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ sendNotification
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-navbar').innerHTML = html;
        document.querySelectorAll('#main-navbar script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
        setTimeout(function() {
          if (typeof window.initMainNavbar === 'function') window.initMainNavbar();
          if (typeof window.updateNavbarUserName === 'function') window.updateNavbarUserName();
        }, 100);
      });
  </script>
  <div class="container">
    <div class="header-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø© -->
        <div id="draftIndicator" style="display:none; background:#ffc107; color:#1a3b50; padding:5px 12px; border-radius:4px; font-weight:700; font-size:0.85rem; box-shadow:0 2px 8px #ffc10733;">
          ğŸ“ Ù…Ø³ÙˆØ¯Ø©
        </div>
        
        <button id="editModeBtn" type="button" style="display:none; border:2px solid #ff8c00; border-radius:0; background:#ff8c00; color:#fff; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #ff8c0033; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">
          âœï¸ ØªØ¹Ø¯ÙŠÙ„
        </button>
        <button id="saveModeBtn" type="button" style="border:2px solid #28a745; border-radius:0; background:#28a745; color:#fff; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #28a74533; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">
          ğŸ’¾ Ø­ÙØ¸
        </button>
        <button id="saveDraftBtn" type="button" style="border:2px solid #ffc107; border-radius:0; background:#ffc107; color:#1a3b50; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #ffc10733; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">
          ğŸ“ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
        </button>
        <button id="addPayBtn" type="button" style="border:2px solid #2e8ca3; border-radius:0; background:#fff; color:#1a3b50; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #2e8ca311; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">Ø¥Ø¶Ø§ÙØ©</button>
        <button id="addSeparatorBtn" type="button" style="border:2px solid #7a5230; border-radius:0; background:#fff; color:#7a5230; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #7a523033; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">+ ÙØ§ØµÙ„</button>
      </div>
      <!-- Ø²Ø± ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel -->
      <button id="exportExcelBtn" type="button" style="border:2px solid #28a745; border-radius:0; background:#28a745; color:#fff; font-family:'Cairo',Arial,sans-serif; font-size:0.9rem; font-weight:700; padding:5px 16px; letter-spacing:1px; box-shadow:0 2px 8px #28a74533; outline:none; cursor:pointer; transition:background 0.15s, color 0.15s, border 0.15s;">ØªØµØ¯ÙŠØ± Excel</button>
      <div class="month-title" id="monthName" style="margin-bottom:0; flex:1; text-align:center;"></div>
      <div class="month-date" id="monthDate" style="margin-bottom:0; min-width:120px; text-align:left; font-size:1.1rem;"></div>
    </div>
    <table id="payTable">
      <thead>
        <tr>
          <th>Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
          <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</th> <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø¨Ø¶</th>
          <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¨Ø¶</th>
          <th>Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="payTbody">
        <!-- ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø³ØªØ¶Ø§Ù Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
      </tbody>
    </table>
    <div style="margin:32px 0 0 0; text-align:left;">
      <span style="font-weight:900; color:#1a3b50; font-size:1.15rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
      <span id="totalValue" style="font-weight:900; color:#2e8ca3; font-size:1.15rem;">0</span>
    </div>
    <div style="margin:20px 0; text-align:center;">
      <button onclick="window.history.back()" class="back-btn">Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù‚Ø¨Ø¶ -->
  <div id="payModalOverlay" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:#0006; z-index:2000; align-items:center; justify-content:center;">
    <form id="payModal" style="background:#fff; border-radius:16px; box-shadow:0 8px 32px #1a3b5044; padding:32px 32px 24px 32px; min-width:420px; max-width:99vw; width:520px; display:flex; flex-direction:column; gap:18px; font-family:'Cairo',Arial,sans-serif;">
      <div style="display:flex; gap:18px; flex-wrap:wrap;">
        <div style="flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label>
          <input type="text" id="payWorkerName" readonly required style="padding:7px 12px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; background:#f8fafb; cursor:pointer; width:100%;" placeholder="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù…Ù„">
        </div>
        <div style="flex:1 1 180px; min-width:140px; display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
          <input type="text" id="payWorkerPlace" readonly style="padding:7px 12px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; background:#f8fafb; width:100%;">
        </div>
      </div>
      <div style="display:flex; gap:18px; flex-wrap:wrap;">
        <div style="flex:1 1 120px; min-width:100px; display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
          <input type="number" id="payDayValue" required min="0" style="padding:7px 12px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; width:100%;">
        </div>
        <div style="flex:1 1 120px; min-width:100px; display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; color:#1a3b50; font-size:1.1rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</label>
          <input type="number" id="payDaysCount" required min="1" style="padding:7px 12px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; width:100%;">
        </div>
      </div>
      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
      <div style="margin:18px 0 0 0;">
        <div style="font-weight:900; color:#1a3b50; font-size:1.08rem; margin-bottom:8px; text-align:right;">Ø£ÙˆÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
        <table style="width:100%; border-collapse:collapse; background:#f8fafb; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px #2e8ca311;">
          <thead>
            <tr>
              <th style="background:#2e8ca3; color:#fff; font-weight:bold;">Ø§Ø®ØªÙŠØ§Ø±</th>
              <th style="background:#2e8ca3; color:#fff; font-weight:bold;">Ø¹Ø¯Ø¯</th>
              <th style="background:#2e8ca3; color:#fff; font-weight:bold;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
              <th style="background:#2e8ca3; color:#fff; font-weight:bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th style="background:#2e8ca3; color:#fff; font-weight:bold;">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="extraRowsTbody">
            <!-- ØµÙÙˆÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø³ØªØ¶Ø§Ù Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
          </tbody>
        </table>
        <button type="button" id="addExtraRowBtn" style="margin-top:6px; border:1.5px solid #2e8ca3; background:#fff; color:#2e8ca3; font-weight:700; font-size:0.98rem; padding:4px 14px; border-radius:6px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¥Ø¶Ø§ÙÙŠ</button>
      </div>
      <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
      <div id="modalTotalRow" style="margin-top:10px; text-align:left; font-weight:900; color:#1a3b50; font-size:1.08rem;">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="modalTotalValue" style="color:#2e8ca3;">0</span>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:8px;">
        <button type="button" id="cancelPayModalBtn" style="border:none; background:#c5d6db; color:#1a3b50; font-weight:700; font-size:1rem; padding:8px 22px; border-radius:6px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" style="border:none; background:#2e8ca3; color:#fff; font-weight:700; font-size:1rem; padding:8px 22px; border-radius:6px; cursor:pointer;">Ø­ÙØ¸</button>
      </div>
    </form>
  </div>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ù…Ù„ -->
  <div id="workerSelectOverlay" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:#0006; z-index:2100; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; box-shadow:0 8px 32px #1a3b5044; padding:22px 18px 18px 18px; min-width:320px; max-width:95vw; width:340px; display:flex; flex-direction:column; gap:10px; font-family:'Cairo',Arial,sans-serif;">
      <input type="text" id="workerSearchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø§Ù…Ù„..." style="padding:6px 10px; border:1.5px solid #c5d6db; border-radius:6px; font-size:1rem; margin-bottom:8px;">
      <div id="workerList" style="max-height:220px; overflow-y:auto; border:1px solid #eee; border-radius:6px; background:#f8fafb;"></div>
      <button type="button" id="cancelWorkerSelectBtn" style="margin-top:8px; border:none; background:#c5d6db; color:#1a3b50; font-weight:700; font-size:1rem; padding:7px 18px; border-radius:6px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
  <div class="footer">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2025 Ø³Ø¹ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ø§Ù„Ø¨ÙŠØ¯
  </div>
  <!-- Ø£Ø¶Ù Ù…ÙƒØªØ¨Ø© SheetJS Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    if (!localStorage.getItem('user')) {
      window.location.href = 'login.html';
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    function hasPermission(permission) {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.permissions) return false;
      return user.permissions.includes(permission);
    }
    
    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ---
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || '';
    }
    const monthName = getQueryParam('name');
    const monthDate = getQueryParam('date');
    document.getElementById('monthName').textContent = 'Ø´Ù‡Ø± ' + monthName;
    document.getElementById('monthDate').textContent = monthDate;

    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    let payRows = [];
    let hasUnsavedChanges = false; // ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    let isInEditMode = false; // ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const editModeBtn = document.getElementById('editModeBtn');
    const saveModeBtn = document.getElementById('saveModeBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const addPayBtn = document.getElementById('addPayBtn');
    const addSeparatorBtn = document.getElementById('addSeparatorBtn');
    const draftIndicator = document.getElementById('draftIndicator');

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    let isDraftData = false; // ØªØªØ¨Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ÙˆØ¯Ø©
    
    async function fetchPays() {
      try {
        console.log('Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ Ù„Ù„Ø´Ù‡Ø±:', monthDate);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹
        try {
          const draftResponse = await fetch(`/pays/draft/${encodeURIComponent(monthDate)}`);
          if (draftResponse.ok) {
            const draftData = await draftResponse.json();
            if (draftData.rows && draftData.rows.length > 0) {
              // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø³Ø¤Ø§Ù„
              payRows = draftData.rows;
              isDraftData = true; // Ù‡Ø°Ù‡ Ù…Ø³ÙˆØ¯Ø©
              console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${payRows.length} ØµÙ Ù…Ù† Ø§Ù„Ù…Ø³ÙˆØ¯Ø©`);
              renderTablesAndTotal();
              return;
            }
          }
        } catch (draftError) {
          // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø©ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
          console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©');
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
        const res = await fetch(`/pays?month=${encodeURIComponent(monthDate)}`);
        if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶');
        payRows = await res.json();
        isDraftData = false; // Ù‡Ø°Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©
        
        console.log(`ØªÙ… Ø¬Ù„Ø¨ ${payRows.length} ØµÙ`);
        console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù„Ø¨Ø©:', payRows.map(r => ({ 
          id: r._id, 
          name: r.name || r.separatorName,
          isSeparator: r.isSeparator,
          order: r.order 
        })));
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        payRows = [];
      }
      renderTablesAndTotal();
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶
    fetchPays().then(() => {
      // Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ø­Ø¯Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø³ÙˆØ¯Ø© Ø£Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ©)
      const hasData = payRows.length > 0;
      const hasEditPermission = hasPermission('workers-monthly-pay-edit');
      
      if (isDraftData) {
        // Ù…Ø³ÙˆØ¯Ø© - Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ±
        isInEditMode = true;
        draftIndicator.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
        editModeBtn.style.display = 'none';
        saveModeBtn.style.display = 'inline-block';
        saveDraftBtn.style.display = 'inline-block';
        addPayBtn.style.display = 'inline-block';
        addSeparatorBtn.style.display = 'inline-block';
      } else if (hasData) {
        // Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© - Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©)
        isInEditMode = false;
        draftIndicator.style.display = 'none';
        saveModeBtn.style.display = 'none';
        saveDraftBtn.style.display = 'none';
        addPayBtn.style.display = 'none';
        addSeparatorBtn.style.display = 'none';
        
        if (hasEditPermission) {
          editModeBtn.style.display = 'inline-block';
        } else {
          editModeBtn.style.display = 'none';
        }
      } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª - Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø­ÙØ¸
        isInEditMode = true;
        draftIndicator.style.display = 'none';
        editModeBtn.style.display = 'none';
        saveModeBtn.style.display = 'inline-block';
        saveDraftBtn.style.display = 'inline-block';
        addPayBtn.style.display = 'inline-block';
        addSeparatorBtn.style.display = 'inline-block';
      }
    });

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    function renderTablesAndTotal() {
      const tbody = document.getElementById('payTbody');
      tbody.innerHTML = '';
      let rowNumber = 1;
      
      payRows.forEach((row, idx) => {
        if (row.isSeparator) {
          // Ø¹Ø±Ø¶ ØµÙ Ø§Ù„ÙØ§ØµÙ„
          const tr = document.createElement('tr');
          tr.style.cssText = 'background: #7a5230 !important; color: #fff; font-weight: bold;';
          
          // Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          if (isInEditMode) {
            tr.draggable = true;
            tr.dataset.index = idx;
            tr.dataset.separator = 'true';
          }
          
          tr.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 8px; background: #7a5230 !important; color: #fff;">
              ${isInEditMode ? '<span class="drag-handle" style="color: #fff; margin-left: 10px;">â‹®â‹®</span>' : ''}
              ${row.separatorName || 'ÙØ§ØµÙ„'}
            </td>
            <td style="background: #7a5230 !important;">
              ${isInEditMode ? `<button class="delete-btn" onclick="deleteSeparatorRow('${row._id || idx}')" style="background: #dc3545; border: none; color: #fff; padding: 3px 8px; border-radius: 4px; cursor: pointer;">Ø­Ø°Ù</button>` : ''}
            </td>
          `;
          
          if (isInEditMode) {
            setupDragAndDrop(tr);
          }
          tbody.appendChild(tr);
        } else {
          // Ø¹Ø±Ø¶ ØµÙ Ø¹Ø§Ø¯ÙŠ
          const totalExtra = Array.isArray(row.extra) ? row.extra.reduce((sum, r) => {
            const c = parseFloat(r.count);
            const v = parseFloat(r.value);
            return sum + (!isNaN(c) && !isNaN(v) ? c * v : 0);
          }, 0) : 0;
          const total = (Number(row.value || 0) + totalExtra);
          const extraDetails = Array.isArray(row.extra) && row.extra.length
            ? `<span style="font-size:0.8rem; color:#2e8ca3;">(${row.extra.map(r => `${r.type} Ã— ${r.count} Ã— ${r.value} = ${(parseFloat(r.count) * parseFloat(r.value)).toLocaleString()}`).join(' | ')})</span>`
            : '';
          const tr = document.createElement('tr');
          
          // Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          if (isInEditMode) {
            tr.draggable = true;
            tr.dataset.index = idx;
          }
          
          tr.innerHTML = `
            <td>${isInEditMode ? '<span class="drag-handle">â‹®â‹®</span> ' : ''}${rowNumber++}</td>
            <td>${row.name}</td>
            <td>${row.place || ''}</td>
            <td>${row.date}</td>
            <td>${Number(row.value || 0).toLocaleString()}</td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
              ${totalExtra ? totalExtra.toLocaleString() : 0} ${extraDetails}
            </td>
            <td>${total.toLocaleString()}</td>
            <td>${isInEditMode ? `<button class="delete-btn" onclick="deletePayRow('${row._id || row.id || idx}')">Ø­Ø°Ù</button>` : ''}</td>
          `;
          
          if (isInEditMode) {
            setupDragAndDrop(tr);
          }
          tbody.appendChild(tr);
        }
      });

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ (ÙÙ‚Ø· Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù„ÙŠØ³ Ø§Ù„ÙÙˆØ§ØµÙ„)
      let totalPay = payRows.reduce((sum, r) => {
        if (r.isSeparator) return sum;
        const totalExtra = Array.isArray(r.extra) ? r.extra.reduce((s, rr) => {
          const c = parseFloat(rr.count);
          const v = parseFloat(rr.value);
          return s + (!isNaN(c) && !isNaN(v) ? c * v : 0);
        }, 0) : 0;
        return sum + Number(r.value || 0) + totalExtra;
      }, 0);
      document.getElementById('totalValue').textContent = totalPay.toLocaleString();
    }

    // Ø­Ø°Ù ØµÙ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¨Ø¶ (Ø­Ø°Ù Ù…Ø­Ù„ÙŠ)
    window.deletePayRow = function(idOrIndex) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ')) return;
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø¨Ø§Ù„ÙÙ‡Ø±Ø³
      const index = payRows.findIndex(r => r._id === idOrIndex || payRows.indexOf(r) == idOrIndex);
      
      if (index !== -1) {
        payRows.splice(index, 1);
        hasUnsavedChanges = true;
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸
        saveModeBtn.style.background = '#ff9800';
        saveModeBtn.style.borderColor = '#ff9800';
        saveModeBtn.innerHTML = 'âš ï¸ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        renderTablesAndTotal();
      }
    };

    // Ø­Ø°Ù ØµÙ ÙØ§ØµÙ„ (Ø­Ø°Ù Ù…Ø­Ù„ÙŠ)
    window.deleteSeparatorRow = function(idOrIndex) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ§ØµÙ„ØŸ')) return;
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØµÙ„ Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø¨Ø§Ù„ÙÙ‡Ø±Ø³
      const index = payRows.findIndex(r => r._id === idOrIndex || payRows.indexOf(r) == idOrIndex);
      
      if (index !== -1) {
        payRows.splice(index, 1);
        hasUnsavedChanges = true;
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸
        saveModeBtn.style.background = '#ff9800';
        saveModeBtn.style.borderColor = '#ff9800';
        saveModeBtn.innerHTML = 'âš ï¸ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        renderTablesAndTotal();
      }
    };

    // Ø¥Ø¶Ø§ÙØ© Ù‚Ø¨Ø¶ (Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·)
    document.getElementById('payModal').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('payWorkerName').value;
      const place = document.getElementById('payWorkerPlace').value;
      const dayValue = Number(document.getElementById('payDayValue').value);
      const daysCount = Number(document.getElementById('payDaysCount').value);
      const date = monthDate;
      let totalExtra = 0;
      extraRowsInModal.forEach(r => {
        const c = parseFloat(r.count);
        const v = parseFloat(r.value);
        if (!isNaN(c) && !isNaN(v)) totalExtra += c * v;
      });
      const newPay = {
        name,
        place,
        date,
        month: monthDate,
        value: dayValue * daysCount,
        extra: JSON.parse(JSON.stringify(extraRowsInModal)),
        total: dayValue * daysCount + totalExtra,
        order: payRows.length
      };
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
      payRows.push(newPay);
      hasUnsavedChanges = true;
      
      // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸
      saveModeBtn.style.background = '#ff9800';
      saveModeBtn.style.borderColor = '#ff9800';
      saveModeBtn.innerHTML = 'âš ï¸ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      document.getElementById('payModalOverlay').style.display = 'none';
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      renderTablesAndTotal();
    };

    // Ø£ÙˆÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    let extraRowsInModal = [];
    const extraRowsTbody = document.getElementById('extraRowsTbody');
    const addExtraRowBtn = document.getElementById('addExtraRowBtn');

    function renderExtraRowsInModal() {
      extraRowsTbody.innerHTML = '';
      extraRowsInModal.forEach((row, idx) => {
        const total = (parseFloat(row.count) || 0) * (parseFloat(row.value) || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <select style="padding:4px 8px; border-radius:6px;">
              <option value="ÙŠÙˆÙ…"${row.type === 'ÙŠÙˆÙ…' ? ' selected' : ''}>ÙŠÙˆÙ…</option>
              <option value="Ø³Ø§Ø¹Ù‡"${row.type === 'Ø³Ø§Ø¹Ù‡' ? ' selected' : ''}>Ø³Ø§Ø¹Ù‡</option>
            </select>
          </td>
          <td>
            <input type="number" min="0" value="${row.count || ''}" style="width:70px; padding:4px 8px; border-radius:6px;">
          </td>
          <td>
            <input type="number" min="0" value="${row.value || ''}" style="width:90px; padding:4px 8px; border-radius:6px;">
          </td>
          <td>
            <span style="color:#2e8ca3; font-weight:700;">
              ${total ? total.toLocaleString() : ''}
            </span>
          </td>
          <td>
            <button type="button" style="border:none; background:#e74c3c; color:#fff; border-radius:4px; padding:2px 10px; font-size:0.95rem; cursor:pointer;" onclick="removeExtraRowInModal(${idx})">Ø­Ø°Ù</button>
          </td>
        `;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
        const selects = tr.querySelectorAll('select');
        const inputs = tr.querySelectorAll('input');
        selects[0].onchange = function() {
          extraRowsInModal[idx].type = this.value;
          renderExtraRowsInModal();
        };
        inputs[0].oninput = function() {
          extraRowsInModal[idx].count = this.value;
          // ÙÙ‚Ø· Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
          updateModalTotal();
          // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙ
          const total = (parseFloat(this.value) || 0) * (parseFloat(inputs[1].value) || 0);
          tr.querySelector('span').textContent = total ? total.toLocaleString() : '';
        };
        inputs[1].oninput = function() {
          extraRowsInModal[idx].value = this.value;
          updateModalTotal();
          const total = (parseFloat(inputs[0].value) || 0) * (parseFloat(this.value) || 0);
          tr.querySelector('span').textContent = total ? total.toLocaleString() : '';
        };
        extraRowsTbody.appendChild(tr);
      });
      updateModalTotal();
    }
    window.removeExtraRowInModal = function(idx) {
      extraRowsInModal.splice(idx, 1);
      renderExtraRowsInModal();
    };
    addExtraRowBtn.onclick = function() {
      extraRowsInModal.push({ type: 'ÙŠÙˆÙ…', count: '', value: '' });
      renderExtraRowsInModal();
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function updateModalTotal() {
      const dayValue = Number(document.getElementById('payDayValue').value) || 0;
      const daysCount = Number(document.getElementById('payDaysCount').value) || 0;
      let totalExtra = 0;
      extraRowsInModal.forEach(r => {
        const c = parseFloat(r.count);
        const v = parseFloat(r.value);
        if (!isNaN(c) && !isNaN(v)) totalExtra += c * v;
      });
      document.getElementById('modalTotalValue').textContent = (dayValue * daysCount + totalExtra).toLocaleString();
    }
    document.getElementById('payDayValue').oninput = updateModalTotal;
    document.getElementById('payDaysCount').oninput = updateModalTotal;

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    // renderTablesAndTotal(); // Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§ Ù„Ø£Ù† fetchPays ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

    const payModalOverlay = document.getElementById('payModalOverlay');
    const payModal = document.getElementById('payModal');
    const cancelPayModalBtn = document.getElementById('cancelPayModalBtn');
    const payWorkerName = document.getElementById('payWorkerName');
    const payWorkerPlace = document.getElementById('payWorkerPlace');
    const workerSelectOverlay = document.getElementById('workerSelectOverlay');
    const workerList = document.getElementById('workerList');
    const workerSearchInput = document.getElementById('workerSearchInput');
    const cancelWorkerSelectBtn = document.getElementById('cancelWorkerSelectBtn');

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    let allWorkers = [];
    async function fetchWorkers() {
      try {
        const res = await fetch('/workers');
        if (!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„');
        allWorkers = await res.json();
      } catch {
        allWorkers = [];
      }
    }
    
    cancelPayModalBtn.onclick = function() {
      payModalOverlay.style.display = 'none';
    };
    payModalOverlay.onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø«
    function renderWorkerList(q) {
      workerList.innerHTML = '';
      let filtered = allWorkers;
      if (q) {
        filtered = allWorkers.filter(w =>
          (w.name || '').includes(q) ||
          (w.place || '').includes(q)
        );
      }
      if (filtered.length === 0) {
        workerList.innerHTML = '<div style="padding:10px; color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„</div>';
        return;
      }
      filtered.forEach(w => {
        const div = document.createElement('div');
        div.textContent = w.name + (w.place ? ' - ' + w.place : '');
        div.style.cssText = 'padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee;';
        div.onmouseover = () => div.style.background = '#e3f3f7';
        div.onmouseout = () => div.style.background = '';
        div.onclick = function() {
          payWorkerName.value = w.name;
          payWorkerPlace.value = w.place || '';
          workerSelectOverlay.style.display = 'none';
        };
        workerList.appendChild(div);
      });
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ù…Ù„
    payWorkerName.onclick = function() {
      renderWorkerList('');
      workerSearchInput.value = '';
      workerSelectOverlay.style.display = 'flex';
      setTimeout(() => workerSearchInput.focus(), 100);
    };
    cancelWorkerSelectBtn.onclick = function() {
      workerSelectOverlay.style.display = 'none';
    };
    workerSelectOverlay.onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };
    workerSearchInput.oninput = function() {
      renderWorkerList(this.value.trim());
    };

    // Ø²Ø± ØªØµØ¯ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± Ø¥Ù„Ù‰ Excel
    document.getElementById('exportExcelBtn').onclick = function() {
      const data = [
        ["Ù…", "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„", "Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø¨Ø¶", "Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¨Ø¶", "Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"]
      ];
      let rowNumber = 1;
      payRows.forEach((row, idx) => {
        if (row.isSeparator) {
          // Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ§ØµÙ„ ÙÙŠ Excel
          data.push([
            "",
            row.separatorName || 'ÙØ§ØµÙ„',
            "",
            "",
            "",
            "",
            ""
          ]);
        } else {
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
          const totalExtra = Array.isArray(row.extra) ? row.extra.reduce((sum, r) => {
            const c = parseFloat(r.count);
            const v = parseFloat(r.value);
            return sum + (!isNaN(c) && !isNaN(v) ? c * v : 0);
          }, 0) : 0;
          // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙƒÙ†Øµ
          const extraDetails = Array.isArray(row.extra) && row.extra.length
            ? row.extra.map(r => `${r.type} Ã— ${r.count} Ã— ${r.value} = ${(parseFloat(r.count) * parseFloat(r.value)).toLocaleString()}`).join(' | ')
            : '';
          const total = (Number(row.value || 0) + totalExtra);
          data.push([
            rowNumber++,
            row.name,
            row.place || '',
            row.date,
            Number(row.value || 0),
            totalExtra ? `${totalExtra} (${extraDetails})` : '0',
            total
          ]);
        }
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±");
      XLSX.writeFile(wb, "month-details.xlsx");
    };

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
    function setupDragAndDrop(tr) {
      tr.addEventListener('dragstart', function(e) {
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
        e.dataTransfer.setData('text/plain', this.dataset.index);
      });

      tr.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
        document.querySelectorAll('tr.drag-over').forEach(row => {
          row.classList.remove('drag-over');
        });
      });

      tr.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ
        if (!this.classList.contains('dragging')) {
          this.classList.add('drag-over');
        }
      });

      tr.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });

      tr.addEventListener('drop', function(e) {
        e.preventDefault();
        
        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const targetIndex = parseInt(this.dataset.index);
        
        if (draggedIndex !== targetIndex) {
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          reorderRows(draggedIndex, targetIndex);
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
        this.classList.remove('drag-over');
        document.querySelectorAll('tr.dragging').forEach(row => {
          row.classList.remove('dragging');
        });
      });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ
    async function reorderRows(fromIndex, toIndex) {
      try {
        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ù†Ù‚Ù„ ØµÙ Ù…Ù† ${fromIndex} Ø¥Ù„Ù‰ ${toIndex}`);
        
        // Ù†Ø³Ø® Ø§Ù„Ù…ØµÙÙˆÙØ©
        const newOrder = [...payRows];
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³
        if (fromIndex < 0 || fromIndex >= newOrder.length || toIndex < 0 || toIndex >= newOrder.length) {
          console.error('ÙÙ‡Ø§Ø±Ø³ ØºÙŠØ± ØµØ­ÙŠØ­Ø©:', { fromIndex, toIndex, arrayLength: newOrder.length });
          return;
        }
        
        // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const draggedItem = newOrder.splice(fromIndex, 1)[0];
        newOrder.splice(toIndex, 0, draggedItem);
        
        // ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        payRows = newOrder;
        hasUnsavedChanges = true; // ØªØ¹Ù„ÙŠÙ… Ø£Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù„ÙŠØ¸Ù‡Ø± Ø£Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
        saveModeBtn.style.background = '#ff9800';
        saveModeBtn.style.borderColor = '#ff9800';
        saveModeBtn.innerHTML = 'âš ï¸ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        renderTablesAndTotal();
        
        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ Ù…Ø­Ù„ÙŠØ§Ù‹ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯)');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨');
      }
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸
    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    editModeBtn.onclick = function() {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ\nØ³ØªØªÙ…ÙƒÙ† Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.')) {
        return;
      }
      hasUnsavedChanges = false;
      isInEditMode = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      
      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      editModeBtn.style.display = 'none';
      saveModeBtn.style.display = 'inline-block';
      saveDraftBtn.style.display = 'inline-block';
      addPayBtn.style.display = 'inline-block';
      addSeparatorBtn.style.display = 'inline-block';
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª ÙˆØ§Ù„Ø­Ø°Ù
      renderTablesAndTotal();
    };

    // Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ - Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    saveModeBtn.onclick = async function() {
      if (payRows.length === 0) {
        alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸');
        return;
      }
      
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ')) {
        return;
      }
      
      try {
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª ÙˆØ§Ù„Ù…Ø­ÙÙˆØ¸Ø©)
        const deleteResponse = await fetch(`/pays/delete-month/${encodeURIComponent(monthDate)}`, {
          method: 'DELETE'
        });
        
        if (!deleteResponse.ok) {
          const errorData = await deleteResponse.json();
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', errorData);
          // Ù†Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©)
        }
        
        // Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒØµÙÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠØ©
        const savePromises = payRows.map(async (row, index) => {
          const rowData = {
            ...row,
            month: monthDate,
            order: index,
            isDraft: false // Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ
          };
          
          // Ø­Ø°Ù Ø§Ù„Ù€ _id Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø¶Ù…Ø§Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
          delete rowData._id;
          
          // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
          const response = await fetch('/pays', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rowData)
          });
          if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ');
          return await response.json();
        });
        
        const savedRows = await Promise.all(savePromises);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        savedRows.forEach((savedRow, index) => {
          payRows[index]._id = savedRow._id;
        });
        
        hasUnsavedChanges = false;
        isInEditMode = false; // Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        isDraftData = false; // Ø§Ù„Ø¢Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø­ÙØ¸ Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠ
        await window.waitForNotificationSystem();
        if (window.sendNotification) {
          const monthName = document.getElementById('monthName').textContent;
          await window.sendNotification(
            'pay-save',
            `ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${monthName} (${payRows.length} ØµÙ)`,
            'monthly-pays',
            monthDate
          );
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø­ÙØ¸
        saveModeBtn.style.background = '#28a745';
        saveModeBtn.style.borderColor = '#28a745';
        saveModeBtn.innerHTML = 'ğŸ’¾ Ø­ÙØ¸';
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        await fetchPays();
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø§Ø¹Ø¯Ø§ ØªØµØ¯ÙŠØ± Excel
        draftIndicator.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
        editModeBtn.style.display = 'none';
        saveModeBtn.style.display = 'none';
        saveDraftBtn.style.display = 'none';
        addPayBtn.style.display = 'none';
        addSeparatorBtn.style.display = 'none';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ©
        if (hasPermission('workers-monthly-pay-edit')) {
          editModeBtn.style.display = 'inline-block';
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø£Ùˆ Ø³Ø­Ø¨
        renderTablesAndTotal();
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
      }
    };

    // Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø© - Ø­ÙØ¸ Ù…Ø¤Ù‚Øª ÙÙŠ localStorage ÙˆØ§Ù„Ø³ÙŠØ±ÙØ±
    saveDraftBtn.onclick = async function() {
      if (payRows.length === 0) {
        alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸');
        return;
      }
      
      try {
        const draftData = {
          month: monthDate,
          monthName: document.getElementById('monthName').textContent,
          rows: payRows.map((row, index) => ({
            ...row,
            order: index,
            isDraft: true
          })),
          savedAt: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ ÙÙŠ localStorage
        localStorage.setItem(`draft_${monthDate}`, JSON.stringify(draftData));
        
        console.log('ğŸ”„ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', draftData);
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙŠØ¶Ø§Ù‹
        const response = await fetch('/pays/draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(draftData)
        });
        
        console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('âŒ Ø®Ø·Ø£ Ø§Ù„Ø³ÙŠØ±ÙØ±:', errorData);
          throw new Error(errorData.error || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
        }
        
        const result = await response.json();
        console.log('âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­ÙØ¸:', result);
        
        hasUnsavedChanges = false;
        isDraftData = true;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
        draftIndicator.style.display = 'inline-block';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø­ÙØ¸
        saveModeBtn.style.background = '#28a745';
        saveModeBtn.style.borderColor = '#28a745';
        saveModeBtn.innerHTML = 'ğŸ’¾ Ø­ÙØ¸';
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©:', error);
        alert('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');
      }
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    addPayBtn.onclick = async function() {
      await fetchWorkers();
      payModal.reset();
      payWorkerName.value = '';
      payWorkerPlace.value = '';
      extraRowsInModal = [];
      renderExtraRowsInModal();
      updateModalTotal();
      payModalOverlay.style.display = 'flex';
    };
    
    addSeparatorBtn.onclick = function() {
      const separatorName = prompt('Ø§Ø³Ù… Ø§Ù„ÙØ§ØµÙ„:');
      if (separatorName && separatorName.trim()) {
        const newSeparator = {
          isSeparator: true,
          separatorName: separatorName.trim(),
          month: monthDate,
          date: monthDate,
          order: payRows.length
        };
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
        payRows.push(newSeparator);
        hasUnsavedChanges = true;
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸
        saveModeBtn.style.background = '#ff9800';
        saveModeBtn.style.borderColor = '#ff9800';
        saveModeBtn.innerHTML = 'âš ï¸ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        renderTablesAndTotal();
      }
    };
  </script>
</body>
</html>