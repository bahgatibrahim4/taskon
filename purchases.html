<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>المشتريات | سعيد أحمد بالبيد</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #2e8ca3;
      --secondary-color: #1a3b50;
      --accent-color: #1976d2;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #e53935;
      --bg-light: #f8f9fa;
      --bg-gradient: linear-gradient(135deg, #2e8ca3 0%, #1976d2 100%);
      direction: rtl;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(135deg, #c5d6db 0%, #e8f4f8 100%);
      min-height: 100vh;
      direction: rtl;
    }

    .container {
      max-width: 1400px;
      margin: 10px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      padding: 15px;
    }

    /* Page Header */
    .page-header {
      background: var(--bg-gradient);
      color: white;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 3px 12px rgba(46, 140, 163, 0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .page-header h2 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }

    .page-header .header-icon {
      font-size: 1.5rem;
      background: rgba(255,255,255,0.2);
      padding: 8px;
      border-radius: 50%;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Statistics Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--bg-gradient);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: var(--primary-color);
    }

    .stat-icon {
      font-size: 1.8rem;
      margin-bottom: 5px;
      color: var(--primary-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--secondary-color);
      margin-bottom: 3px;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.8rem;
    }

    /* Buttons */
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'Cairo', Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: var(--bg-gradient);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
      color: white;
    }

    .btn-secondary {
      background: #fff;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }

    /* Search and Filter */
    .search-filter-section {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--bg-light);
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .search-box {
      flex: 0 0 auto;
      min-width: 180px;
      max-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 6px 30px 6px 10px;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      font-family: 'Cairo', Arial, sans-serif;
    }

    .search-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(46, 140, 163, 0.1);
      outline: none;
    }

    .search-box i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      font-size: 0.85rem;
    }

    .filter-section {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-label {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.85rem;
    }

    .date-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .date-inputs input[type="date"] {
      padding: 6px 10px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.8rem;
      font-family: 'Cairo', Arial, sans-serif;
    }

    /* Table */
    .table-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      border: 2px solid #e9ecef;
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 10px 6px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
    }

    th {
      background: var(--bg-gradient) !important;
      color: white !important;
      font-weight: bold;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    th i {
      margin-left: 3px;
      font-size: 0.85rem;
    }

    tbody tr {
      transition: all 0.3s ease;
    }

    tbody tr:hover {
      background: #f8f9fa !important;
      transform: scale(1.005);
    }

    tbody tr:nth-child(even) {
      background: #fafbfc;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Summary Row */
    .summary-row {
      background: var(--bg-gradient) !important;
      font-weight: bold;
    }

    .summary-row td {
      color: white !important;
      border: none !important;
      padding: 12px 6px !important;
      font-size: 0.95rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 600px;
      max-width: 95vw;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .close-modal {
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      transform: scale(1.1);
      background: #c62828;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .form-group input,
    .form-group select {
      padding: 7px 10px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.8rem;
      font-family: 'Cairo', Arial, sans-serif;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(46, 140, 163, 0.1);
      outline: none;
    }

    .form-group input[readonly] {
      background: #f1f3f4;
      color: #666;
      cursor: not-allowed;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .required {
      color: var(--danger-color);
    }

    /* Action Buttons in Table */
    .action-btns {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }

    .icon-btn {
      background: none;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      border-radius: 6px;
    }

    .icon-btn.delete {
      color: var(--danger-color);
      background: rgba(229, 57, 53, 0.1);
    }

    .icon-btn.delete:hover {
      color: white;
      background: var(--danger-color);
      transform: scale(1.08);
    }

    .icon-btn.edit {
      color: var(--primary-color);
      background: rgba(46, 140, 163, 0.1);
    }

    .icon-btn.edit:hover {
      color: white;
      background: var(--primary-color);
      transform: scale(1.08);
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
    }

    .badge-warning {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
    }

    .badge-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }

    /* No Data Message */
    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .no-data i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .no-data-text {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 8px;
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.85rem;
      z-index: 10000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Responsive Design */
    @media (max-width: 900px) {
      .container {
        padding: 12px;
        margin: 8px;
      }

      .page-header {
        flex-direction: column;
        text-align: center;
      }

      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }

      .search-filter-section {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: 100%;
      }

      th, td {
        padding: 8px 4px;
        font-size: 0.75rem;
      }
    }

    @media (max-width: 600px) {
      .stats-container {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      th, td {
        padding: 6px 2px;
        font-size: 0.7rem;
      }

      .icon-btn {
        padding: 5px 8px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="header-icon">
          <i class="fa fa-shopping-cart"></i>
        </div>
        <h2>إدارة المشتريات</h2>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddPurchaseModal()">
          <i class="fa fa-plus"></i> إضافة شراء جديد
        </button>
        <button class="btn btn-warning" onclick="toggleReturnsView()">
          <i class="fa fa-undo"></i> المرتجعات <span class="badge" id="returnsBadge" style="background: white; color: var(--warning-color); margin-right: 5px; padding: 2px 8px;">0</span>
        </button>
        <button class="btn btn-secondary" onclick="exportToExcel()">
          <i class="fa fa-file-excel"></i> تصدير Excel
        </button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon"><i class="fa fa-shopping-bag"></i></div>
        <div class="stat-value" id="totalPurchases">0</div>
        <div class="stat-label">إجمالي المشتريات</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fa fa-coins"></i></div>
        <div class="stat-value" id="totalAmount">0</div>
        <div class="stat-label">إجمالي المبلغ (جنيه)</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fa fa-boxes"></i></div>
        <div class="stat-value" id="totalQuantity">0</div>
        <div class="stat-label">إجمالي الكمية</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fa fa-calendar-day"></i></div>
        <div class="stat-value" id="todayPurchases">0</div>
        <div class="stat-label">مشتريات اليوم</div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ابحث بالصنف، المحل أو المورد...">
        <i class="fa fa-search"></i>
      </div>
      
      <div class="filter-section">
        <span class="filter-label"><i class="fa fa-filter"></i> فلترة بالتاريخ:</span>
        <div class="date-inputs">
          <input type="date" id="dateFrom" placeholder="من">
          <span>إلى</span>
          <input type="date" id="dateTo" placeholder="إلى">
          <button class="btn btn-info" onclick="applyDateFilter()">
            <i class="fa fa-check"></i> تطبيق
          </button>
          <button class="btn btn-secondary" onclick="clearDateFilter()">
            <i class="fa fa-times"></i> إلغاء
          </button>
        </div>
      </div>
    </div>

    <!-- Purchases Table -->
    <div class="table-container" id="purchasesSection">
      <table id="purchasesTable">
        <thead>
          <tr>
            <th><i class="fa fa-hashtag"></i> #</th>
            <th><i class="fa fa-calendar"></i> التاريخ</th>
            <th><i class="fa fa-store"></i> المحل / المكان</th>
            <th><i class="fa fa-box"></i> الصنف</th>
            <th><i class="fa fa-sort-numeric-up"></i> الكمية</th>
            <th><i class="fa fa-balance-scale"></i> الوحدة</th>
            <th><i class="fa fa-dollar-sign"></i> سعر الوحدة</th>
            <th><i class="fa fa-calculator"></i> الإجمالي</th>
            <th><i class="fa fa-file-invoice"></i> الفاتورة</th>
            <th><i class="fa fa-warehouse"></i> حالة المخزن</th>
            <th><i class="fa fa-cog"></i> إجراءات</th>
          </tr>
        </thead>
        <tbody id="purchasesTableBody">
          <!-- Data will be inserted here -->
        </tbody>
        <tfoot>
          <tr class="summary-row">
            <td colspan="4"><i class="fa fa-chart-bar"></i> الإجماليات</td>
            <td id="footerTotalQuantity">0</td>
            <td></td>
            <td></td>
            <td id="footerTotalAmount">0</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Returns Table (Hidden by default) -->
    <div class="table-container" id="returnsSection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border-radius: 10px 10px 0 0;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <i class="fa fa-undo"></i> سجل المرتجعات
        </h3>
        <button class="btn" style="background: white; color: var(--warning-color);" onclick="exportReturnsToExcel()">
          <i class="fa fa-file-excel"></i> تصدير
        </button>
      </div>
      <table id="returnsTable">
        <thead>
          <tr>
            <th><i class="fa fa-hashtag"></i> #</th>
            <th><i class="fa fa-calendar"></i> تاريخ الإرجاع</th>
            <th><i class="fa fa-calendar-alt"></i> تاريخ الشراء الأصلي</th>
            <th><i class="fa fa-box"></i> الصنف</th>
            <th><i class="fa fa-store"></i> المحل</th>
            <th><i class="fa fa-sort-numeric-down"></i> الكمية المرتجعة</th>
            <th><i class="fa fa-balance-scale"></i> الوحدة</th>
            <th><i class="fa fa-dollar-sign"></i> قيمة الإرجاع</th>
            <th><i class="fa fa-comment"></i> السبب</th>
            <th><i class="fa fa-warehouse"></i> حالة المخزن</th>
            <th><i class="fa fa-cog"></i> إجراءات</th>
          </tr>
        </thead>
        <tbody id="returnsTableBody">
          <!-- Returns data will be inserted here -->
        </tbody>
        <tfoot>
          <tr class="summary-row" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important;">
            <td colspan="5"><i class="fa fa-chart-bar"></i> الإجماليات</td>
            <td id="footerTotalReturnsQuantity">0</td>
            <td></td>
            <td id="footerTotalReturnsAmount">0</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Add Return Modal -->
  <div id="returnModal" class="modal">
    <div class="modal-content" style="width: 650px; max-height: 85vh; overflow-y: auto;">
      <div class="modal-header" style="position: sticky; top: 0; background: white; z-index: 10; margin: -20px -20px 10px -20px; padding: 15px 20px; border-bottom: 2px solid var(--warning-color);">
        <h3 class="modal-title" style="color: var(--warning-color); font-size: 1.1rem;">
          <i class="fa fa-undo"></i> <span>إرجاع مشتريات</span>
        </h3>
        <button class="close-modal" onclick="closeReturnModal()">&times;</button>
      </div>

      <form id="returnForm">
        <div class="form-grid" style="gap: 10px;">
          <div class="form-group full-width" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 10px; border-radius: 8px; border: 2px solid #ff9800;">
            <label style="color: var(--warning-color); font-weight: bold; font-size: 0.75rem; margin-bottom: 3px;">
              <i class="fa fa-shopping-cart"></i> اختر عملية الشراء <span class="required">*</span>
            </label>
            <select name="purchaseId" id="returnPurchaseId" required onchange="fillReturnData()" style="font-weight: 600; color: var(--warning-color); padding: 6px 8px; font-size: 0.75rem;">
              <option value="">-- اختر عملية الشراء --</option>
            </select>
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-calendar"></i> تاريخ الإرجاع <span class="required">*</span></label>
            <input type="date" name="returnDate" id="returnDate" required style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-calendar-alt"></i> تاريخ الشراء</label>
            <input type="date" name="purchaseDate" id="returnPurchaseDate" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-box"></i> الصنف</label>
            <input type="text" name="item" id="returnItem" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-store"></i> المحل / المكان</label>
            <input type="text" name="store" id="returnStore" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-sort-numeric-up"></i> الكمية الأصلية</label>
            <input type="number" name="originalQuantity" id="returnOriginalQuantity" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-balance-scale"></i> الوحدة</label>
            <input type="text" name="unit" id="returnUnit" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="color: var(--danger-color); font-size: 0.75rem;"><i class="fa fa-sort-numeric-down"></i> الكمية المرتجعة <span class="required">*</span></label>
            <input type="number" name="returnedQuantity" id="returnedQuantity" min="0" step="any" required placeholder="0" style="border-color: var(--warning-color); font-weight: bold; padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="font-size: 0.75rem;"><i class="fa fa-dollar-sign"></i> سعر الوحدة</label>
            <input type="number" name="unitPrice" id="returnUnitPrice" readonly style="padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group">
            <label style="color: var(--warning-color); font-size: 0.75rem;"><i class="fa fa-calculator"></i> قيمة الإرجاع</label>
            <input type="number" name="returnValue" id="returnValue" readonly style="background: #fff3e0; font-weight: bold; color: var(--warning-color); padding: 6px 8px; font-size: 0.75rem;">
          </div>

          <div class="form-group full-width">
            <label style="font-size: 0.75rem;"><i class="fa fa-comment"></i> سبب الإرجاع <span class="required">*</span></label>
            <select name="reason" id="returnReason" required style="color: var(--warning-color); font-weight: 600; padding: 6px 8px; font-size: 0.75rem;">
              <option value="">-- اختر السبب --</option>
              <option value="عيب في المنتج">عيب في المنتج</option>
              <option value="مقاسات خاطئة">مقاسات خاطئة</option>
              <option value="كمية زائدة">كمية زائدة</option>
              <option value="تغيير في المواصفات">تغيير في المواصفات</option>
              <option value="عدم الحاجة للصنف">عدم الحاجة للصنف</option>
              <option value="منتج تالف">منتج تالف</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label style="font-size: 0.75rem;"><i class="fa fa-sticky-note"></i> ملاحظات إضافية</label>
            <textarea name="notes" id="returnNotes" rows="2" style="padding: 6px 8px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.75rem; font-family: 'Cairo', Arial, sans-serif; resize: vertical;" placeholder="أي ملاحظات إضافية..."></textarea>
          </div>
        </div>

        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 8px; border-radius: 8px; margin-bottom: 12px; border-right: 4px solid var(--warning-color); font-size: 0.75rem;">
          <i class="fa fa-exclamation-triangle" style="color: var(--warning-color);"></i>
          <strong style="color: var(--warning-color);">تنبيه:</strong> سيتم خصم الكمية من المخزن تلقائياً
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-warning" style="padding: 7px 15px; font-size: 0.8rem;">
            <i class="fa fa-save"></i> تسجيل الإرجاع
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeReturnModal()" style="padding: 7px 15px; font-size: 0.8rem;">
            <i class="fa fa-times"></i> إلغاء
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Purchase Modal -->
  <div id="purchaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fa fa-plus-circle"></i> <span id="modalTitle">إضافة عملية شراء جديدة</span>
        </h3>
        <button class="close-modal" onclick="closePurchaseModal()">&times;</button>
      </div>

      <form id="purchaseForm">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fa fa-calendar"></i> تاريخ الشراء <span class="required">*</span></label>
            <input type="date" name="date" id="purchaseDate" required>
          </div>

          <div class="form-group">
            <label><i class="fa fa-store"></i> اسم المحل / المكان <span class="required">*</span></label>
            <input type="text" name="store" id="purchaseStore" required placeholder="اسم المحل">
          </div>

          <div class="form-group">
            <label><i class="fa fa-box"></i> الصنف <span class="required">*</span></label>
            <input type="text" name="item" id="purchaseItem" required placeholder="اسم الصنف" list="itemsList">
            <datalist id="itemsList"></datalist>
          </div>

          <div class="form-group">
            <label><i class="fa fa-sort-numeric-up"></i> الكمية <span class="required">*</span></label>
            <input type="number" name="quantity" id="purchaseQuantity" min="0" step="any" required placeholder="0">
          </div>

          <div class="form-group">
            <label><i class="fa fa-balance-scale"></i> الوحدة <span class="required">*</span></label>
            <input type="text" name="unit" id="purchaseUnit" required placeholder="طن، متر، كيلو...">
          </div>

          <div class="form-group">
            <label><i class="fa fa-dollar-sign"></i> سعر الوحدة <span class="required">*</span></label>
            <input type="number" name="unitPrice" id="purchaseUnitPrice" min="0" step="any" required placeholder="0">
          </div>

          <div class="form-group">
            <label><i class="fa fa-calculator"></i> الإجمالي</label>
            <input type="number" name="total" id="purchaseTotal" readonly placeholder="0">
          </div>

          <div class="form-group">
            <label><i class="fa fa-user"></i> اسم المورد</label>
            <input type="text" name="supplier" id="purchaseSupplier" placeholder="اسم المورد (اختياري)">
          </div>

          <div class="form-group full-width">
            <label><i class="fa fa-file-invoice"></i> فاتورة الشراء (PDF أو صورة)</label>
            <input type="file" name="invoice" id="purchaseInvoice" accept=".pdf,image/*">
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">
            <i class="fa fa-save"></i> حفظ الشراء
          </button>
          <button type="button" class="btn btn-secondary" onclick="closePurchaseModal()">
            <i class="fa fa-times"></i> إلغاء
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    // Global Variables
    let purchases = [];
    let returns = [];
    let currentEditId = null;
    let dateFilter = { from: '', to: '' };
    let showingReturns = false;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await loadPurchases();
      await loadReturns();
      setupEventListeners();
      
      // Set today's date as default
      document.getElementById('purchaseDate').valueAsDate = new Date();
      document.getElementById('returnDate').valueAsDate = new Date();
    });

    // Setup Event Listeners
    function setupEventListeners() {
      // Search
      document.getElementById('searchInput').addEventListener('input', filterPurchases);
      
      // Auto-calculate total
      document.getElementById('purchaseQuantity').addEventListener('input', calculateTotal);
      document.getElementById('purchaseUnitPrice').addEventListener('input', calculateTotal);
      
      // Form submission
      document.getElementById('purchaseForm').addEventListener('submit', handleFormSubmit);
      
      // Return form
      document.getElementById('returnForm').addEventListener('submit', handleReturnSubmit);
      document.getElementById('returnedQuantity').addEventListener('input', calculateReturnValue);
    }

    // Load Purchases from Server
    async function loadPurchases() {
      try {
        const response = await fetch('/purchases');
        if (response.ok) {
          purchases = await response.json();
          renderPurchases();
          updateStatistics();
          populateReturnPurchasesList();
        } else {
          console.error('فشل في تحميل المشتريات');
          showNotification('حدث خطأ في تحميل البيانات', 'error');
        }
      } catch (error) {
        console.error('خطأ في الاتصال:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
      }
    }

    // Load Returns from Server
    async function loadReturns() {
      try {
        const response = await fetch('/returns');
        if (response.ok) {
          returns = await response.json();
          updateReturnsBadge();
          if (showingReturns) {
            renderReturns();
          }
        } else {
          console.error('فشل في تحميل المرتجعات');
        }
      } catch (error) {
        console.error('خطأ في الاتصال:', error);
      }
    }

    // Render Purchases Table
    function renderPurchases() {
      const tbody = document.getElementById('purchasesTableBody');
      tbody.innerHTML = '';

      let filtered = getFilteredPurchases();

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="no-data">
              <i class="fa fa-inbox"></i>
              <div class="no-data-text">لا توجد مشتريات</div>
              <div>قم بإضافة أول عملية شراء</div>
            </td>
          </tr>
        `;
        updateFooter([], 0, 0);
        return;
      }

      let totalQty = 0;
      let totalAmount = 0;

      filtered.forEach((purchase, index) => {
        totalQty += parseFloat(purchase.quantity) || 0;
        totalAmount += parseFloat(purchase.total) || 0;

        const row = document.createElement('tr');
        
        // Check if item is in store
        const storeStatus = purchase.addedToStore ? 
          '<span class="badge badge-success"><i class="fa fa-check"></i> تم الإضافة</span>' :
          '<span class="badge badge-warning"><i class="fa fa-clock"></i> معلق</span>';

        row.innerHTML = `
          <td style="font-weight: bold; color: var(--primary-color);">${index + 1}</td>
          <td>${purchase.date || '-'}</td>
          <td>${purchase.store || '-'}</td>
          <td style="font-weight: 600;">${purchase.item || '-'}</td>
          <td>${purchase.quantity || 0}</td>
          <td>${purchase.unit || '-'}</td>
          <td>${purchase.category || purchase.unitPrice || 0}</td>
          <td style="font-weight: bold; color: var(--success-color);">${parseFloat(purchase.total || 0).toFixed(2)}</td>
          <td>${purchase.invoice ? '<i class="fa fa-file-pdf" style="color: var(--danger-color);"></i>' : '-'}</td>
          <td>${storeStatus}</td>
          <td class="action-btns">
            <button class="icon-btn edit" onclick="editPurchase('${purchase._id}')" title="تعديل">
              <i class="fa fa-edit"></i>
            </button>
            <button class="icon-btn" onclick="openReturnModal('${purchase._id}')" title="إرجاع" style="color: var(--warning-color); background: rgba(255, 152, 0, 0.1);">
              <i class="fa fa-undo"></i>
            </button>
            <button class="icon-btn delete" onclick="deletePurchase('${purchase._id}')" title="حذف">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });

      updateFooter(filtered, totalQty, totalAmount);
    }

    // Update Footer Totals
    function updateFooter(data, totalQty, totalAmount) {
      document.getElementById('footerTotalQuantity').textContent = totalQty.toFixed(2);
      document.getElementById('footerTotalAmount').textContent = totalAmount.toFixed(2);
    }

    // Update Statistics
    function updateStatistics() {
      const totalPurchases = purchases.length;
      const totalAmount = purchases.reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
      const totalQuantity = purchases.reduce((sum, p) => sum + (parseFloat(p.quantity) || 0), 0);
      
      const today = new Date().toISOString().split('T')[0];
      const todayPurchases = purchases.filter(p => p.date === today).length;

      document.getElementById('totalPurchases').textContent = totalPurchases;
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
      document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
      document.getElementById('todayPurchases').textContent = todayPurchases;
    }

    // Get Filtered Purchases
    function getFilteredPurchases() {
      let filtered = [...purchases];

      // Search filter
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(p =>
          (p.item && p.item.toLowerCase().includes(searchTerm)) ||
          (p.store && p.store.toLowerCase().includes(searchTerm)) ||
          (p.supplier && p.supplier.toLowerCase().includes(searchTerm))
        );
      }

      // Date filter
      if (dateFilter.from) {
        filtered = filtered.filter(p => p.date >= dateFilter.from);
      }
      if (dateFilter.to) {
        filtered = filtered.filter(p => p.date <= dateFilter.to);
      }

      return filtered;
    }

    // Filter Purchases
    function filterPurchases() {
      renderPurchases();
    }

    // Apply Date Filter
    function applyDateFilter() {
      dateFilter.from = document.getElementById('dateFrom').value;
      dateFilter.to = document.getElementById('dateTo').value;
      renderPurchases();
      showNotification('تم تطبيق الفلتر بنجاح', 'success');
    }

    // Clear Date Filter
    function clearDateFilter() {
      dateFilter = { from: '', to: '' };
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      renderPurchases();
      showNotification('تم إلغاء الفلتر', 'info');
    }

    // Toggle Returns View
    function toggleReturnsView() {
      showingReturns = !showingReturns;
      const purchasesSection = document.getElementById('purchasesSection');
      const returnsSection = document.getElementById('returnsSection');
      
      if (showingReturns) {
        purchasesSection.style.display = 'none';
        returnsSection.style.display = 'block';
        renderReturns();
      } else {
        purchasesSection.style.display = 'block';
        returnsSection.style.display = 'none';
      }
    }

    // Render Returns Table
    function renderReturns() {
      const tbody = document.getElementById('returnsTableBody');
      tbody.innerHTML = '';

      if (returns.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="no-data">
              <i class="fa fa-undo"></i>
              <div class="no-data-text">لا توجد مرتجعات</div>
              <div>لم يتم تسجيل أي عمليات إرجاع بعد</div>
            </td>
          </tr>
        `;
        updateReturnsFooter(0, 0);
        return;
      }

      let totalQty = 0;
      let totalAmount = 0;

      returns.forEach((ret, index) => {
        totalQty += parseFloat(ret.returnedQuantity) || 0;
        totalAmount += parseFloat(ret.returnValue) || 0;

        const row = document.createElement('tr');
        
        const storeStatus = ret.deductedFromStore ? 
          '<span class="badge badge-success"><i class="fa fa-check"></i> تم الخصم</span>' :
          '<span class="badge badge-warning"><i class="fa fa-clock"></i> معلق</span>';

        row.innerHTML = `
          <td style="font-weight: bold; color: var(--warning-color);">${index + 1}</td>
          <td>${ret.returnDate || '-'}</td>
          <td>${ret.purchaseDate || '-'}</td>
          <td style="font-weight: 600;">${ret.item || '-'}</td>
          <td>${ret.store || '-'}</td>
          <td style="font-weight: bold; color: var(--danger-color);">${ret.returnedQuantity || 0}</td>
          <td>${ret.unit || '-'}</td>
          <td style="font-weight: bold; color: var(--warning-color);">${parseFloat(ret.returnValue || 0).toFixed(2)}</td>
          <td><span class="badge badge-warning">${ret.reason || '-'}</span></td>
          <td>${storeStatus}</td>
          <td class="action-btns">
            <button class="icon-btn delete" onclick="deleteReturn('${ret._id}')" title="حذف">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });

      updateReturnsFooter(totalQty, totalAmount);
    }

    // Update Returns Footer
    function updateReturnsFooter(totalQty, totalAmount) {
      document.getElementById('footerTotalReturnsQuantity').textContent = totalQty.toFixed(2);
      document.getElementById('footerTotalReturnsAmount').textContent = totalAmount.toFixed(2);
    }

    // Update Returns Badge
    function updateReturnsBadge() {
      document.getElementById('returnsBadge').textContent = returns.length;
    }

    // Populate Return Purchases List
    function populateReturnPurchasesList() {
      const select = document.getElementById('returnPurchaseId');
      select.innerHTML = '<option value="">-- اختر عملية الشراء --</option>';
      
      purchases.forEach(purchase => {
        const option = document.createElement('option');
        option.value = purchase._id;
        option.textContent = `${purchase.item} - ${purchase.store} - ${purchase.date} (${purchase.quantity} ${purchase.unit})`;
        option.dataset.purchase = JSON.stringify(purchase);
        select.appendChild(option);
      });
    }

    // Open Return Modal
    function openReturnModal(purchaseId) {
      document.getElementById('returnModal').style.display = 'flex';
      document.getElementById('returnForm').reset();
      document.getElementById('returnDate').valueAsDate = new Date();
      
      if (purchaseId) {
        document.getElementById('returnPurchaseId').value = purchaseId;
        fillReturnData();
      }
    }

    // Close Return Modal
    function closeReturnModal() {
      document.getElementById('returnModal').style.display = 'none';
      document.getElementById('returnForm').reset();
    }

    // Fill Return Data
    function fillReturnData() {
      const select = document.getElementById('returnPurchaseId');
      const selectedOption = select.options[select.selectedIndex];
      
      if (!selectedOption.value) {
        // Clear form
        document.getElementById('returnItem').value = '';
        document.getElementById('returnStore').value = '';
        document.getElementById('returnOriginalQuantity').value = '';
        document.getElementById('returnUnit').value = '';
        document.getElementById('returnUnitPrice').value = '';
        document.getElementById('returnPurchaseDate').value = '';
        document.getElementById('returnedQuantity').value = '';
        document.getElementById('returnValue').value = '';
        return;
      }

      const purchase = JSON.parse(selectedOption.dataset.purchase);
      
      document.getElementById('returnItem').value = purchase.item || '';
      document.getElementById('returnStore').value = purchase.store || '';
      document.getElementById('returnOriginalQuantity').value = purchase.quantity || '';
      document.getElementById('returnUnit').value = purchase.unit || '';
      document.getElementById('returnUnitPrice').value = purchase.category || purchase.unitPrice || '';
      document.getElementById('returnPurchaseDate').value = purchase.date || '';
      
      // Set max for returned quantity
      const qtyInput = document.getElementById('returnedQuantity');
      qtyInput.max = purchase.quantity;
      qtyInput.value = '';
      document.getElementById('returnValue').value = '';
    }

    // Calculate Return Value
    function calculateReturnValue() {
      const quantity = parseFloat(document.getElementById('returnedQuantity').value) || 0;
      const unitPrice = parseFloat(document.getElementById('returnUnitPrice').value) || 0;
      const maxQty = parseFloat(document.getElementById('returnOriginalQuantity').value) || 0;
      
      if (quantity > maxQty) {
        showNotification(`الكمية المرتجعة لا يمكن أن تتجاوز ${maxQty}`, 'warning');
        document.getElementById('returnedQuantity').value = maxQty;
        document.getElementById('returnValue').value = (maxQty * unitPrice).toFixed(2);
        return;
      }
      
      const returnValue = quantity * unitPrice;
      document.getElementById('returnValue').value = returnValue.toFixed(2);
    }

    // Handle Return Submit
    async function handleReturnSubmit(e) {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalContent = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> جاري الحفظ...';

      const formData = new FormData(e.target);
      const purchaseId = formData.get('purchaseId');
      const purchase = purchases.find(p => p._id === purchaseId);
      
      const data = {
        purchaseId: purchaseId,
        returnDate: formData.get('returnDate'),
        purchaseDate: formData.get('purchaseDate'),
        item: formData.get('item'),
        store: formData.get('store'),
        originalQuantity: formData.get('originalQuantity'),
        returnedQuantity: formData.get('returnedQuantity'),
        unit: formData.get('unit'),
        unitPrice: formData.get('unitPrice'),
        returnValue: formData.get('returnValue'),
        reason: formData.get('reason'),
        notes: formData.get('notes') || '',
        deductedFromStore: false
      };

      try {
        const response = await fetch('/returns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          await loadReturns();
          closeReturnModal();
          
          // إرسال إشعار
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            await window.sendNotification(
              'purchase-return-add', 
              `تم تسجيل مرتجع لمادة: ${data.item}`, 
              'purchases', 
              ''
            );
          }
          
          showNotification('تم تسجيل الإرجاع بنجاح وخصمه من المخزن', 'success');
        } else {
          const errorData = await response.json();
          showNotification('حدث خطأ: ' + (errorData.error || 'خطأ غير معروف'), 'error');
        }
      } catch (error) {
        console.error('خطأ:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    }

    // Delete Return
    async function deleteReturn(id) {
      if (!confirm('هل أنت متأكد من حذف هذا الإرجاع؟\nسيتم إعادة الكمية للمخزن.')) return;

      // الحصول على معلومات المرتجع قبل الحذف
      const returnItem = returns.find(r => r._id === id);
      const itemName = returnItem ? returnItem.item : 'مرتجع';

      try {
        const response = await fetch(`/returns/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
          await loadReturns();
          
          // إرسال إشعار
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            await window.sendNotification('purchase-return-delete', `تم حذف مرتجع: ${itemName}`, 'purchases', id);
          }
          
          showNotification('تم حذف الإرجاع بنجاح', 'success');
        } else {
          const errorData = await response.json();
          showNotification('حدث خطأ: ' + (errorData.error || 'خطأ غير معروف'), 'error');
        }
      } catch (error) {
        console.error('خطأ:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
      }
    }

    // Export Returns to Excel
    function exportReturnsToExcel() {
      if (returns.length === 0) {
        showNotification('لا توجد مرتجعات للتصدير', 'warning');
        return;
      }

      const data = [
        ['#', 'تاريخ الإرجاع', 'تاريخ الشراء الأصلي', 'الصنف', 'المحل', 'الكمية المرتجعة', 'الوحدة', 'قيمة الإرجاع', 'السبب', 'الملاحظات', 'حالة المخزن']
      ];

      returns.forEach((ret, idx) => {
        data.push([
          idx + 1,
          ret.returnDate || '',
          ret.purchaseDate || '',
          ret.item || '',
          ret.store || '',
          ret.returnedQuantity || 0,
          ret.unit || '',
          ret.returnValue || 0,
          ret.reason || '',
          ret.notes || '',
          ret.deductedFromStore ? 'تم الخصم' : 'معلق'
        ]);
      });

      // Add totals
      const totalQty = returns.reduce((sum, r) => sum + (parseFloat(r.returnedQuantity) || 0), 0);
      const totalAmount = returns.reduce((sum, r) => sum + (parseFloat(r.returnValue) || 0), 0);
      data.push([]);
      data.push(['الإجماليات', '', '', '', '', totalQty.toFixed(2), '', totalAmount.toFixed(2), '', '', '']);

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'المرتجعات');
      
      const fileName = `returns_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      showNotification('تم تصدير بيانات المرتجعات بنجاح', 'success');
    }

    // Calculate Total
    function calculateTotal() {
      const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
      const unitPrice = parseFloat(document.getElementById('purchaseUnitPrice').value) || 0;
      const total = quantity * unitPrice;
      document.getElementById('purchaseTotal').value = total.toFixed(2);
    }

    // Open Add Purchase Modal
    function openAddPurchaseModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'إضافة عملية شراء جديدة';
      document.getElementById('purchaseForm').reset();
      document.getElementById('purchaseDate').valueAsDate = new Date();
      document.getElementById('purchaseModal').style.display = 'flex';
    }

    // Close Purchase Modal
    function closePurchaseModal() {
      document.getElementById('purchaseModal').style.display = 'none';
      currentEditId = null;
      document.getElementById('purchaseForm').reset();
    }

    // Handle Form Submit
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalContent = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> جاري الحفظ...';

      const formData = new FormData(e.target);
      const data = {
        date: formData.get('date'),
        store: formData.get('store'),
        item: formData.get('item'),
        quantity: formData.get('quantity'),
        unit: formData.get('unit'),
        category: formData.get('unitPrice'),
        unitPrice: formData.get('unitPrice'),
        total: formData.get('total'),
        supplier: formData.get('supplier') || formData.get('store'),
        invoice: formData.get('invoice') && formData.get('invoice').name ? formData.get('invoice').name : ''
      };

      try {
        const url = currentEditId ? `/purchases/${currentEditId}` : '/purchases';
        const method = currentEditId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          await loadPurchases();
          closePurchaseModal();
          
          // إرسال إشعار
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            const notifType = currentEditId ? 'purchase-edit' : 'purchase-add';
            const notifMsg = currentEditId 
              ? `تم تعديل مشترى: ${data.item}` 
              : `تم إضافة مشترى جديد: ${data.item}`;
            await window.sendNotification(notifType, notifMsg, 'purchases', currentEditId || '');
          }
          
          showNotification(
            currentEditId ? 'تم تحديث الشراء بنجاح' : 'تم إضافة الشراء بنجاح وإضافته للمخزن',
            'success'
          );
        } else {
          const errorData = await response.json();
          showNotification('حدث خطأ: ' + (errorData.error || 'خطأ غير معروف'), 'error');
        }
      } catch (error) {
        console.error('خطأ:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    }

    // Edit Purchase
    function editPurchase(id) {
      const purchase = purchases.find(p => p._id === id);
      if (!purchase) return;

      currentEditId = id;
      document.getElementById('modalTitle').textContent = 'تعديل عملية الشراء';
      
      document.getElementById('purchaseDate').value = purchase.date || '';
      document.getElementById('purchaseStore').value = purchase.store || '';
      document.getElementById('purchaseItem').value = purchase.item || '';
      document.getElementById('purchaseQuantity').value = purchase.quantity || '';
      document.getElementById('purchaseUnit').value = purchase.unit || '';
      document.getElementById('purchaseUnitPrice').value = purchase.category || purchase.unitPrice || '';
      document.getElementById('purchaseTotal').value = purchase.total || '';
      document.getElementById('purchaseSupplier').value = purchase.supplier || '';

      document.getElementById('purchaseModal').style.display = 'flex';
    }

    // Delete Purchase
    async function deletePurchase(id) {
      if (!confirm('هل أنت متأكد من حذف هذا الشراء؟\nسيتم أيضاً حذفه من المخزن.')) return;

      // الحصول على معلومات المشترى قبل الحذف
      const purchase = purchases.find(p => p._id === id);
      const itemName = purchase ? purchase.item : 'مشترى';

      try {
        const response = await fetch(`/purchases/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
          await loadPurchases();
          
          // إرسال إشعار
          await window.waitForNotificationSystem();
          if (window.sendNotification) {
            await window.sendNotification('purchase-delete', `تم حذف مشترى: ${itemName}`, 'purchases', id);
          }
          
          showNotification('تم حذف الشراء بنجاح', 'success');
        } else {
          const errorData = await response.json();
          showNotification('حدث خطأ: ' + (errorData.error || 'خطأ غير معروف'), 'error');
        }
      } catch (error) {
        console.error('خطأ:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
      }
    }

    // Export to Excel
    function exportToExcel() {
      const filtered = getFilteredPurchases();
      
      if (filtered.length === 0) {
        showNotification('لا توجد بيانات للتصدير', 'warning');
        return;
      }

      const data = [
        ['#', 'التاريخ', 'المحل/المكان', 'الصنف', 'الكمية', 'الوحدة', 'سعر الوحدة', 'الإجمالي', 'المورد', 'الفاتورة', 'حالة المخزن']
      ];

      filtered.forEach((p, idx) => {
        data.push([
          idx + 1,
          p.date || '',
          p.store || '',
          p.item || '',
          p.quantity || 0,
          p.unit || '',
          p.category || p.unitPrice || 0,
          p.total || 0,
          p.supplier || '',
          p.invoice || '',
          p.addedToStore ? 'تم الإضافة' : 'معلق'
        ]);
      });

      // Add totals
      const totalQty = filtered.reduce((sum, p) => sum + (parseFloat(p.quantity) || 0), 0);
      const totalAmount = filtered.reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
      data.push([]);
      data.push(['الإجماليات', '', '', '', totalQty.toFixed(2), '', '', totalAmount.toFixed(2), '', '', '']);

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'المشتريات');
      
      const fileName = `purchases_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      showNotification('تم تصدير البيانات بنجاح', 'success');
    }

    // Show Notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification';
      
      let bgColor, icon;
      if (type === 'success') {
        bgColor = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)';
        icon = 'check-circle';
      } else if (type === 'error') {
        bgColor = 'linear-gradient(135deg, #e53935 0%, #c62828 100%)';
        icon = 'exclamation-circle';
      } else if (type === 'warning') {
        bgColor = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
        icon = 'exclamation-triangle';
      } else {
        bgColor = 'linear-gradient(135deg, #2e8ca3 0%, #1976d2 100%)';
        icon = 'info-circle';
      }

      notification.style.background = bgColor;
      notification.style.color = 'white';
      notification.innerHTML = `<i class="fa fa-${icon}"></i> ${message}`;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('purchaseModal');
        if (modal.style.display === 'flex') {
          closePurchaseModal();
        }
      }
    });

    // Close modal on background click
    document.getElementById('purchaseModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closePurchaseModal();
      }
    });

    document.getElementById('returnModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeReturnModal();
      }
    });
  </script>

  <script>
    // دالة مساعدة للانتظار حتى يتم تحميل نظام الإشعارات
    window.waitForNotificationSystem = function() {
      return new Promise((resolve) => {
        if (window.sendNotification) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.sendNotification) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    };

    // Load Navbar
    fetch('components/main-navbar.html')
      .then(res => res.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(s => s.parentNode.removeChild(s));
        document.getElementById('navbar-container').innerHTML = tempDiv.innerHTML;
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });
      })
      .catch(error => {
        console.error('خطأ في تحميل الشريط العلوي:', error);
      });
  </script>
</body>
</html>
